# ═══════════════════════════════════════════════════════════════════════════════
# SHDWXBT / BENNY - Nginx Security Configuration
# Protege arquivos JavaScript e pasta dist contra download direto
# ═══════════════════════════════════════════════════════════════════════════════

# Bloquear acesso direto à pasta dist/
location /dist/ {
    deny all;
    return 403;
}

# Proteger arquivos JavaScript - permitir apenas quando referenciados pelo site
location ~* \.(js)$ {
    # Headers de segurança
    add_header X-Content-Type-Options "nosniff" always;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header X-Robots-Tag "noindex, nofollow, noarchive, nosnippet" always;
    
    # Bloquear se não vier de referer válido (mesmo domínio)
    valid_referers server_names;
    if ($invalid_referer) {
        return 403;
    }
}

# Proteger arquivos críticos de metodologia
location ~* (smc-precision-engine|master-precision-system|fibonacci-precision-engine|institutional-engine|ml-adaptive-engine|confluence-thermometer|technical-analysis|advanced-analysis|app|config|supabase-integration|binance-api|auto-scanner|backtester|hot-signals|smart-risk-manager|smart-alerts|opportunities-service|panels-logic|ai-signal-validator|institutional-scanner|institutional-dashboard)\.js$ {
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header X-Robots-Tag "noindex, nofollow, noarchive, nosnippet" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    valid_referers server_names;
    if ($invalid_referer) {
        return 403;
    }
}

# Headers de segurança globais
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;

# Desabilitar listagem de diretórios
autoindex off;

# Proteger arquivos de configuração e ocultos
location ~ /\. {
    deny all;
    return 404;
}

location ~* (config\.local\.js|\.env|\.git) {
    deny all;
    return 404;
}
