/**
 * SHDWXBT - supabase-integration.js
 * Copyright (c) 2024-2026 SHDWXBT. All rights reserved.
 * 
 * PROPRIETARY AND CONFIDENTIAL
 * Unauthorized copying, modification, distribution, or use is strictly prohibited.
 * This code is protected by intellectual property laws.
 * 
 * Build: 2026-01-28T12:08:12.068Z
 * Checksum: SHDW-7738D41F
 */
let supabaseClient=null,initAttempts=0;const MAX_INIT_ATTEMPTS=5;function getConfig(){return"undefined"!=typeof SHDWXBT_CONFIG?{url:SHDWXBT_CONFIG.SUPABASE_URL,anonKey:SHDWXBT_CONFIG.SUPABASE_ANON_KEY}:(console.warn("‚ö†Ô∏è SHDWXBT_CONFIG not found"),{url:"",anonKey:""})}function initSupabase(){try{initAttempts++,console.log(`üîß Supabase init attempt ${initAttempts}/5`);const e=getConfig();if(!e.url||!e.anonKey)return console.warn("‚ö†Ô∏è Supabase config missing"),!1;let t=null;return void 0!==window.supabase&&window.supabase.createClient?(t=window.supabase,console.log("‚úÖ Found window.supabase")):void 0!==window.supabasejs&&window.supabasejs.createClient?(t=window.supabasejs,console.log("‚úÖ Found window.supabasejs")):"undefined"!=typeof supabase&&supabase.createClient&&(t=supabase,console.log("‚úÖ Found global supabase")),t&&t.createClient?(supabaseClient=t.createClient(e.url,e.anonKey),console.log("‚úÖ Supabase client initialized successfully"),!0):(console.warn("‚ö†Ô∏è Supabase library not found - will retry"),!1)}catch(e){return console.error("‚ùå Supabase init error:",e),!1}}async function ensureSupabaseInit(){if(supabaseClient)return!0;for(let e=0;e<5;e++){if(initSupabase())return!0;await new Promise(e=>setTimeout(e,500))}return!1}const SupabaseService={opportunitiesBySymbol:new Map,monitoringInterval:null,presenceChannel:null,getOpportunity(e){return this.opportunitiesBySymbol.get(e)},updateOpportunitiesCache(e){e&&Array.isArray(e)&&e.forEach(e=>{e&&e.symbol&&this.opportunitiesBySymbol.set(e.symbol,e)})},async getOpportunities(){try{if(!await ensureSupabaseInit())return console.error("‚ùå getOpportunities: Could not initialize Supabase after retries"),[];const e=2e3;console.log(`üì° Fetching opportunities (limit: ${e})...`);const{data:t,error:n}=await supabaseClient.functions.invoke("get-opportunities",{body:{isActive:!0,limit:e}});if(n)throw console.error("‚ùå getOpportunities error:",n),n;const i=t?.data||[];return console.log(`‚úÖ Fetched ${i.length} opportunities (total available: ${t?.total||"unknown"})`),this.updateOpportunitiesCache(i),i}catch(e){return console.error("‚ùå getOpportunities catch:",e),[]}},async getWatchlist(){try{if(!await ensureSupabaseInit())return console.error("‚ùå getWatchlist: Could not initialize Supabase after retries"),[];console.log("üì° Fetching watchlist from Edge Function...");const{data:e,error:t}=await supabaseClient.functions.invoke("get-watchlist",{body:{limit:500}});if(t)throw console.error("‚ùå getWatchlist error:",t),t;const n=e?.data||[];return console.log(`‚úÖ Fetched ${n.length} watchlist items`),n}catch(e){return console.error("‚ùå getWatchlist catch:",e),[]}},createOpportunity:async e=>null,createWatchlistItem:async e=>null,updateTargets:async(e,t)=>null,async markTargetHit(e,t,n,i){if(!e)return null;if(![-1,0,1,2,3].includes(Number(t)))return null;try{supabaseClient||initSupabase();const a=this.getOpportunity(e);if(!a)return null;if(t>0){if(!0===a[`tp_hit_${t}`])return a}if(-1===t&&(!0===a.zone_hit||!0===a.entry_zone_hit))return a;if(0===t&&(!0===a.sl_hit||!0===a.is_stopped))return a;const{data:o,error:s}=await supabaseClient.functions.invoke("mark-target",{body:{symbol:e,tp_index:t,hit_price:n,direction:i||a.trend||"bullish",hit_type:-1===t?"zone":0===t?"stop_loss":"take_profit"}});return s?(s.message?.includes("404")||s.message?.includes("not found")||console.warn(`‚òÅÔ∏è markTargetHit error for ${e}:`,s),null):(o?.updated&&o.row&&this.opportunitiesBySymbol.set(e,o.row),o?.row||null)}catch(e){return null}},closeOpportunity:async e=>null,syncOpportunities:async e=>[],setupRealtime:e=>null,async monitorTargets(){try{supabaseClient||initSupabase();const{data:e,error:t}=await supabaseClient.functions.invoke("get-opportunities",{body:{isActive:!0,limit:2e3}});if(t)throw t;const n=e?.data||[];if(!n||0===n.length)return[];this.updateOpportunitiesCache(n);const i=[];for(const e of n){const t=e.current_price,n=e.direction||e.trend,a=e.fibonacci_extensions||[1.272,1.618,2],o=e.entry_price,s=e.stop_loss;if(!t||!o||!s)continue;const r=Math.abs(o-s),c={};a.forEach((t,i)=>{const a=i+1;let s="bullish"===n?o+r*t:o-r*t;c[`tp${a}`]={price:s,hit:e[`tp_hit_${a}`]||e.targets?.[`tp${a}Hit`]||!1}});for(let a=1;a<=3;a++){const o=c[`tp${a}`];if(!o||o.hit)continue;const s=.001*o.price;("bullish"===n?t>=o.price-s:t<=o.price+s)&&(await this.markTargetHit(e.symbol,a,t,n),i.push({symbol:e.symbol,target:`TP${a}`,targetPrice:o.price,currentPrice:t,timestamp:(new Date).toISOString()}))}}return i}catch(e){return[]}},startTargetMonitoring(e=3e4){if(this.monitoringInterval)return;this.monitorTargets().catch(e=>{});const t=this;this.monitoringInterval=setInterval(function(){t.monitorTargets().then(function(e){e&&e.length>0&&"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("targetHit",{detail:e}))}).catch(function(e){})},e)},stopTargetMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null)},async startPresenceTracking(){try{if(!supabaseClient)return;let e="anonymous_"+Date.now();const t="undefined"!=typeof SHDWXBT_CONFIG?SHDWXBT_CONFIG.SESSION_KEY:"shdwxbt_auth",n=sessionStorage.getItem(t);if(n)try{const t=JSON.parse(n);e=t.wallet||e}catch(e){}this.presenceChannel=supabaseClient.channel("dashboard_presence",{config:{presence:{key:e}}});const i=this;this.presenceChannel.on("presence",{event:"sync"},function(){}).subscribe(async function(t){"SUBSCRIBED"===t&&await i.presenceChannel.track({wallet:e,page:"dashboard",joined_at:(new Date).toISOString()})})}catch(e){}},async stopPresenceTracking(){this.presenceChannel&&(await this.presenceChannel.untrack(),await supabaseClient.removeChannel(this.presenceChannel),this.presenceChannel=null)}};if("undefined"!=typeof window){window.SupabaseService=SupabaseService,window.supabaseIntegration=SupabaseService;const e=async function(){console.log("üîß Starting SupabaseService initialization...");await ensureSupabaseInit()?console.log("‚úÖ SupabaseService ready"):console.error("‚ùå SupabaseService failed to initialize after all retries")};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):setTimeout(e,100),window.addEventListener("beforeunload",function(){SupabaseService.presenceChannel&&SupabaseService.stopPresenceTracking()})}"undefined"!=typeof module&&module.exports&&(module.exports=SupabaseService);