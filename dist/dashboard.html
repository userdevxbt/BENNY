<!DOCTYPE html>
<html lang="en" class="dark"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>$BENNY Terminal | AI-Powered Trading Signals</title>

<!-- Security Headers -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta name="robots" content="noindex, nofollow, noarchive, nosnippet">

<!-- üõ°Ô∏è Security Shield - MUST LOAD FIRST -->
<script src="security-shield.js"></script>

<!-- Favicon - previne erro 404 -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ÔøΩ</text></svg>">

<!-- PERFORMANCE: DNS Prefetch & Preconnect para CDNs cr√≠ticos -->
<link rel="dns-prefetch" href="https://assets.coincap.io">
<link rel="dns-prefetch" href="https://s2.coinmarketcap.com">
<link rel="dns-prefetch" href="https://fapi.binance.com">
<link rel="dns-prefetch" href="https://fstream.binance.com">
<link rel="preconnect" href="https://dbxzwynknesxuvtlissd.supabase.co" crossorigin>

<!-- AUTH CHECK - Verifica login antes de carregar dashboard -->
<script>
    (function() {
        // =====================================================
        // FREE TRIAL VALIDATION
        // =====================================================
        const TRIAL_KEY = 'shdwxbt_free_trial';
        
        function getTrialInfo() {
            try {
                const trialStr = localStorage.getItem(TRIAL_KEY);
                if (!trialStr) return null;
                return JSON.parse(trialStr);
            } catch (e) {
                return null;
            }
        }
        
        function isTrialValid() {
            const trial = getTrialInfo();
            if (!trial) return false;
            const expiresAt = new Date(trial.expiresAt).getTime();
            return Date.now() < expiresAt;
        }
        
        function getTrialDaysRemaining() {
            const trial = getTrialInfo();
            if (!trial) return 0;
            const expiresAt = new Date(trial.expiresAt).getTime();
            const remaining = Math.ceil((expiresAt - Date.now()) / (24 * 60 * 60 * 1000));
            return Math.max(0, remaining);
        }
        
        try {
            // Test if sessionStorage is available
            const testKey = '__test__';
            sessionStorage.setItem(testKey, '1');
            sessionStorage.removeItem(testKey);
        } catch (e) {
            // sessionStorage blocked (private mode) - allow access anyway
            console.warn('‚ö†Ô∏è sessionStorage not available, continuing without auth check');
            window.SHDW_AUTH = { wallet: 'guest', authenticated: true };
            return;
        }
        
        const authData = sessionStorage.getItem('shdwxbt_auth');
        
        // Check if user has valid trial
        if (!authData && isTrialValid()) {
            const daysLeft = getTrialDaysRemaining();
            window.SHDW_AUTH = { 
                wallet: 'trial_user', 
                authenticated: true, 
                isTrial: true, 
                trialDaysRemaining: daysLeft 
            };
            console.log('‚úÖ Trial access:', daysLeft, 'days remaining');
            return;
        }
        
        if (!authData) {
            window.location.replace('login.html');
            return;
        }
        
        try {
            const auth = JSON.parse(authData);
            const isValid = auth.authenticated === true || auth.isAuthenticated === true;
            
            // For trial users, check if trial is still valid
            if (auth.isTrial) {
                if (!isTrialValid()) {
                    sessionStorage.removeItem('shdwxbt_auth');
                    window.location.replace('login.html');
                    return;
                }
                // Update days remaining
                auth.trialDaysRemaining = getTrialDaysRemaining();
            }
            
            const isExpired = Date.now() - auth.timestamp > (24 * 60 * 60 * 1000); // 24h
            
            if (!isValid || isExpired) {
                sessionStorage.removeItem('shdwxbt_auth');
                window.location.replace('login.html');
                return;
            }
            
            // Auth OK - save for other scripts
            window.SHDW_AUTH = auth;
            console.log('‚úÖ Auth verified:', auth.wallet, auth.isTrial ? `(Trial: ${auth.trialDaysRemaining} days)` : '');
        } catch (e) {
            sessionStorage.removeItem('shdwxbt_auth');
            window.location.replace('login.html');
        }
    })();
</script>

<!-- Fonts: Inter & JetBrains Mono -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500;700&amp;display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- TradingView Chart Widget -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<!-- Binance API Integration (with rate limiting & caching) -->
<script src="binance-api.js"></script>
<!-- Supabase JavaScript Client Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Verificar se Supabase carregou corretamente
    if (typeof window.supabase === 'undefined') {
        console.error('‚ùå Supabase library failed to load from CDN');
    } else {
        console.log('‚úÖ Supabase library loaded successfully');
    }
</script>
<!-- Configuration (loads credentials) -->
<script src="config.local.js" onerror="console.warn('config.local.js not found, using defaults')"></script>
<script src="config.js"></script>
<!-- Supabase Integration Layer -->
<script src="supabase-integration.js"></script>
<!-- Edge Functions Client (Metodologia Protegida no Servidor) -->
<script src="supabase-functions.js"></script>
<!-- Context Library (Padr√£o Institucional de Textos) -->
<script src="shdwxbt-context-library.js"></script>
<!-- Auto Scanner for Market Monitoring -->
<script src="auto-scanner.js"></script>
<!-- Hot Signals - Real-time Movement Detection -->
<script src="hot-signals.js"></script>
<!-- Advanced Analysis - MTF, SMC, Volume Profile -->
<script src="advanced-analysis.js"></script>
<!-- Backtesting Engine -->
<script src="backtester.js"></script>
<!-- Smart Alerts System -->
<script src="smart-alerts.js"></script>
<!-- ===== INSTITUTIONAL TRADING SYSTEM ===== -->
<!-- 
    DISABLED: The Institutional system was overwriting the main Supabase grid.
    These modules are available but not auto-initialized.
    To use them manually, call: window.InstitutionalDashboard.init()
-->
<!-- üÜï SMC Precision Engine - Order Blocks, FVG, Premium/Discount -->
<script src="smc-precision-engine.js?v=1"></script>
<!-- üÜï Fibonacci Precision Engine - OTE, Golden Pocket, Premium/Discount -->
<script src="fibonacci-precision-engine.js?v=1"></script>
<!-- Institutional Engine - Multi-Timeframe, SMC, Risk Management -->
<script src="institutional-engine.js?v=2.1"></script>
<!-- Institutional Scanner - Automatic Market Scanner -->
<script src="institutional-scanner.js?v=2"></script>
<!-- Institutional Dashboard - UI Integration (DISABLED AUTO-INIT) -->
<script src="institutional-dashboard.js?v=2"></script>

<!-- ===== ADVANCED AI & ML SYSTEMS v3.0 ===== -->
<!-- ML Adaptive Engine - Neural Networks, Patterns, Wyckoff, Elliott Wave -->
<script src="ml-adaptive-engine.js"></script>
<!-- Smart Risk Manager - Kelly Criterion, Optimal F, Position Sizing -->
<script src="smart-risk-manager.js"></script>
<!-- AI Signal Validator - Multi-criteria Validation, Backtesting -->
<script src="ai-signal-validator.js"></script>

<!-- ===== üéØ MASTER PRECISION SYSTEM v1.0 ===== -->
<!-- Integrates ALL engines for maximum confluence and surgical entries -->
<script src="master-precision-system.js?v=1"></script>

<!-- ===== üå°Ô∏è CONFLUENCE THERMOMETER v1.0 ===== -->
<!-- Visual thermometer scoring system with weighted categories -->
<script src="confluence-thermometer.js?v=1"></script>

<!-- Main App (UI only - methodology is protected on Supabase Edge Functions) -->
<script src="app.js"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
fontFamily: {
sans: ['Inter', 'sans-serif'],
mono: ['JetBrains Mono', 'monospace'],
},
animation: {
'text-shimmer': 'textShimmer 2.5s linear infinite',
'scan': 'scan 4s linear infinite',
'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
'flash-green': 'flashGreen 1s ease-out forwards',
},
keyframes: {
textShimmer: {
'0%': { backgroundPosition: '200% center' },
'100%': { backgroundPosition: '-200% center' },
},
scan: {
'0%': { transform: 'translateY(-100%)' },
'100%': { transform: 'translateY(200%)' },
},
flashGreen: {
'0%': { color: '#ffffff', textShadow: '0 0 10px #ffffff' },
'100%': { color: '#34d399', textShadow: 'none' }
}
},
colors: {
gray: {
900: '#111',
950: '#050505',
}
}
}
}
}
</script>
<style>
/* ========================================
   RESPONSIVE LAYOUT - Desktop & Mobile
   ======================================== */

/* Chart containers default height */
#chart-container,
#tradingview-widget,
.tradingview-widget-container,
#tradingview_chart {
    min-height: 500px;
}

/* Hot signals badge - hidden by default */
#hot-signals-count {
    display: none;
}

/* Modal hidden state - MUST be respected */
#detail-modal.hidden-modal {
    display: none !important;
}

/* Chart Levels Card - cor s√≥lida global */
#chart-levels-card {
    background: #0a0a0c !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

/* ========================================
   DESKTOP STYLES (min-width: 769px)
   TELA CHEIA
   ======================================== */
@media (min-width: 769px) {
    /* Modal - full screen */
    #detail-modal:not(.hidden-modal) {
        background: #050505 !important;
    }
    
    /* Modal container - FULL SCREEN */
    #modal-container {
        background: #09090b !important;
        border-radius: 0 !important;
        border: none !important;
        box-shadow: none !important;
        width: 100vw !important;
        height: 100vh !important;
        max-width: none !important;
        max-height: none !important;
        overflow: hidden !important;
    }
    
    /* Chart panel - lado esquerdo */
    #chart-panel {
        flex: 1 !important;
        min-width: 0 !important;
        border-radius: 0 !important;
    }
    
    /* Sidebar panel - lado direito */
    #sidebar-panel {
        width: 420px !important;
        min-width: 420px !important;
        max-width: 420px !important;
        height: 100% !important;
        border-radius: 0 !important;
    }
    
    /* Chart container - altura proporcional */
    #chart-container {
        min-height: 400px !important;
    }
    
    /* Chart Levels Card - Desktop: cor s√≥lida */
    #chart-levels-card {
        width: 280px !important;
        font-size: 10px !important;
        background: #0a0a0c !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
    }
}

/* ========================================
   TABLET STYLES (769px - 1024px)
   ======================================== */
@media (min-width: 769px) and (max-width: 1024px) {
    #sidebar-panel {
        width: 380px !important;
        min-width: 380px !important;
        max-width: 380px !important;
    }
    
    #chart-levels-card {
        width: 220px !important;
        font-size: 9px !important;
        padding: 10px !important;
    }
    
    #chart-levels-card .text-\[10px\],
    #chart-levels-card .text-\[9px\] {
        font-size: 8px !important;
    }
}

/* ========================================
   MOBILE STYLES (max-width: 768px)
   Full screen, vertical layout
   ======================================== */
@media (max-width: 768px) {
    /* Full screen modal on mobile */
    #detail-modal {
        padding: 0 !important;
        background: #050505 !important;
    }
    
    /* Modal container - full screen on mobile */
    #modal-container {
        width: 100vw !important;
        height: 100dvh !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        border: none !important;
        flex-direction: column !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
    }
    
    /* Chart panel - altura fixa no mobile */
    #chart-panel {
        width: 100vw !important;
        height: 50dvh !important;
        min-height: 320px !important;
        max-height: 400px !important;
        border-right: none !important;
        border-bottom: 1px solid rgba(255,255,255,0.05) !important;
        flex-shrink: 0 !important;
        position: relative !important;
        overflow: hidden !important;
        border-radius: 0 !important;
    }
    
    /* Chart container - altura dispon√≠vel menos toolbar */
    #chart-container {
        height: calc(50dvh - 48px) !important;
        min-height: 272px !important;
        max-height: 352px !important;
        position: relative !important;
        flex-shrink: 0 !important;
        overflow: hidden !important;
        padding-top: 0 !important;
    }
    
    /* TradingView chart - ensure single widget, full size */
    #tradingview-widget {
        min-height: 0 !important;
        position: absolute !important;
        inset: 0 !important;
    }
    
    #detail-modal #tradingview-widget,
    #detail-modal .tradingview-widget-container,
    #detail-modal #tradingview_chart {
        width: 100% !important;
        height: 100% !important;
    }
    
    /* Hide any duplicate TradingView elements */
    #tradingview_chart > div:not(:first-child) {
        display: none !important;
    }
    
    /* Chart toolbar - compact */
    #detail-modal .h-14 {
        height: 48px !important;
        padding: 0 0.5rem !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        flex-shrink: 0 !important;
    }
    
    #detail-modal .h-14 button {
        padding: 4px 8px !important;
        font-size: 9px !important;
        white-space: nowrap !important;
        min-width: 36px !important;
    }
    
    /* Chart Levels Card - Mobile: canto superior direito, arrast√°vel */
    #chart-levels-card {
        display: block !important;
        position: absolute !important;
        top: 8px !important;
        right: 8px !important;
        bottom: auto !important;
        left: auto !important;
        width: 150px !important;
        z-index: 100 !important;
        max-height: none !important;
        overflow: visible !important;
        border-radius: 10px !important;
        background: #0a0a0c !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
        font-size: 8px !important;
        padding: 8px !important;
        touch-action: none !important;
        cursor: grab !important;
    }
    
    #chart-levels-card:active {
        cursor: grabbing !important;
    }
    
    /* Show drag icon on mobile */
    #chart-levels-card #chart-levels-header svg.lucide-grip {
        display: block !important;
        opacity: 0.5 !important;
    }
    
    /* Hide mobile hint text */
    #chart-levels-card #chart-levels-header .md\\:hidden {
        display: none !important;
    }
    
    /* Compact header */
    #chart-levels-card #chart-levels-header {
        cursor: grab !important;
        margin-bottom: 6px !important;
        padding-bottom: 6px !important;
        border-bottom: 1px solid rgba(255,255,255,0.1) !important;
    }
    
    #chart-levels-card #chart-levels-header:active {
        cursor: grabbing !important;
    }
    
    /* Header text smaller */
    #chart-levels-card #chart-levels-header span {
        font-size: 8px !important;
    }
    
    /* Show all content - compact */
    #chart-levels-card > * {
        display: block !important;
    }
    
    #chart-levels-card #chart-levels-header {
        display: flex !important;
    }
    
    /* Compact margins */
    #chart-levels-card .mb-3,
    #chart-levels-card .mb-4 {
        margin-bottom: 4px !important;
    }
    
    #chart-levels-card .p-2 {
        padding: 4px !important;
    }
    
    /* Smaller text */
    #chart-levels-card .text-\\[10px\\],
    #chart-levels-card .text-\\[9px\\] {
        font-size: 8px !important;
    }

    #chart-levels-card .text-xs {
        font-size: 9px !important;
    }
    
    /* Hide capital input, leverage, and scaled orders on mobile */
    #chart-levels-card .mb-3:has(#overlay-capital-input),
    #chart-levels-card .mb-4:has(.leverage-btn),
    #chart-levels-card .mb-3:has(#toggle-scaled-orders),
    #chart-levels-card #scaled-orders-detail {
        display: none !important;
    }
    
    /* Direction badge compact */
    #chart-levels-card #overlay-direction {
        padding: 4px !important;
        margin-bottom: 6px !important;
    }
    
    #chart-levels-card #overlay-direction span {
        font-size: 9px !important;
    }
    
    /* Space between items */
    #chart-levels-card .space-y-2 > * + * {
        margin-top: 3px !important;
    }
    
    /* Hide close button on mobile overlay */
    #chart-levels-card #chart-levels-header button {
        display: none !important;
    }
    
    /* Sidebar (com id) - √°rea de an√°lise scroll√°vel */
    #sidebar-panel {
        width: 100vw !important;
        min-height: 50dvh !important;
        border-left: none !important;
        flex: 1 1 auto !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        border-top: 1px solid rgba(255,255,255,0.05) !important;
        scroll-behavior: smooth !important;
        -webkit-overflow-scrolling: touch !important;
        background: #09090b !important;
        border-radius: 0 !important;
    
    /* Sidebar header - mais compacto no mobile */
    #sidebar-panel .h-20 {
        height: auto !important;
        padding: 12px 16px !important;
        flex-shrink: 0 !important;
        position: sticky !important;
        top: 0 !important;
        background: #09090b !important;
        z-index: 10 !important;
        border-bottom: 1px solid rgba(255,255,255,0.05) !important;
    }
    
    /* Scrollable content area */
    #sidebar-panel .flex-1.overflow-y-auto {
        padding: 16px !important;
        padding-top: 12px !important;
        padding-bottom: 120px !important;
        overflow: visible !important;
        height: auto !important;
    }
    
    /* Context text - leg√≠vel e com padding adequado */
    #sidebar-context {
        font-size: 14px !important;
        line-height: 1.85 !important;
        color: rgba(255,255,255,0.92) !important;
        padding: 0 4px !important;
    }
    
    #sidebar-context p {
        margin-bottom: 16px !important;
        text-align: left !important;
        word-wrap: break-word !important;
    }
    
    /* Headlines */
    #sidebar-headline {
        font-size: 17px !important;
        margin-bottom: 16px !important;
        font-weight: 600 !important;
        padding: 0 4px !important;
    }
    
    /* Analysis text blocks - colored indicators */
    #sidebar-panel .text-emerald-400 {
        font-size: 14px !important;
        line-height: 1.8 !important;
        display: block !important;
        margin-bottom: 14px !important;
        padding: 12px !important;
        background: rgba(16, 185, 129, 0.08) !important;
        border-radius: 8px !important;
        border-left: 3px solid #10b981 !important;
    }
    
    #sidebar-panel .text-red-400 {
        font-size: 14px !important;
        line-height: 1.8 !important;
        display: block !important;
        margin-bottom: 14px !important;
        padding: 12px !important;
        background: rgba(239, 68, 68, 0.08) !important;
        border-radius: 8px !important;
        border-left: 3px solid #ef4444 !important;
    }
    
    #sidebar-panel .text-yellow-400,
    #sidebar-panel .text-amber-400 {
        font-size: 14px !important;
        line-height: 1.8 !important;
        display: block !important;
        margin-bottom: 14px !important;
        padding: 12px !important;
        background: rgba(245, 158, 11, 0.08) !important;
        border-radius: 8px !important;
        border-left: 3px solid #f59e0b !important;
    }
    
    #sidebar-panel .text-cyan-400 {
        font-size: 14px !important;
        line-height: 1.8 !important;
        display: block !important;
        margin-bottom: 14px !important;
        padding: 12px !important;
        background: rgba(6, 182, 212, 0.08) !important;
        border-radius: 8px !important;
        border-left: 3px solid #06b6d4 !important;
    }
    
    /* Confidence score section */
    #sidebar-panel .confidence-bar,
    #sidebar-panel [class*="confidence"] {
        margin: 20px 4px !important;
    }
    
    /* Context section */
    .context-section {
        padding: 0 !important;
    }
    
    /* Close button - always visible */
    #detail-modal .close-btn,
    #detail-modal button[onclick*='closeDetail'] {
        position: fixed !important;
        top: 0.5rem !important;
        right: 0.5rem !important;
        width: 40px !important;
        height: 40px !important;
        font-size: 1.5rem !important;
        z-index: 9999 !important;
        background: rgba(0,0,0,0.8) !important;
        border-radius: 50% !important;
        border: 1px solid rgba(255,255,255,0.1) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    /* Content area */
    #detail-modal .modal-content,
    #sidebar-content {
        padding: 16px !important;
        font-size: 13px !important;
    }
    
    #detail-modal h2, #detail-modal h3 {
        font-size: 15px !important;
        margin-bottom: 12px !important;
    }
    
    #detail-modal p, #detail-modal li {
        font-size: 13px !important;
        line-height: 1.7 !important;
    }
    
    /* Analysis context - better readability */
    #sidebar-panel .space-y-6 > div {
        margin-bottom: 20px !important;
    }
    
    /* Technical data table - compact */
    #sidebar-panel .border.border-white\/5.rounded-lg .p-3 {
        padding: 10px 12px !important;
    }
    
    #sidebar-panel .border.border-white\/5.rounded-lg .text-\[10px\] {
        font-size: 11px !important;
    }
    
    /* Confidence bar */
    .confidence-bar {
        font-size: 0.9rem !important;
        margin: 1rem 0 !important;
    }
    
    /* Ensure all interactive elements are touch-friendly */
    #detail-modal button,
    #detail-modal a {
        min-height: 44px !important;
        min-width: 44px !important;
    }
}

/* Extra small screens (iPhone SE, etc) */
@media (max-width: 380px) {
    #detail-modal .h-14 button {
        padding: 4px 6px !important;
        font-size: 8px !important;
        min-width: 32px !important;
    }
    
    #detail-modal > div:first-child {
        height: 50dvh !important;
        min-height: 280px !important;
    }
    
    #chart-container {
        min-height: 232px !important;
        height: calc(50dvh - 48px) !important;
    }
    
    #chart-levels-card {
        bottom: calc(50dvh + 8px) !important;
        max-height: 160px !important;
        font-size: 9px !important;
        padding: 0.75rem !important;
    }
    
    #sidebar-panel {
        height: calc(100dvh - 50dvh) !important;
    }
}

body {
background-color: #050505;
color: #fff;
-webkit-font-smoothing: antialiased;
}
/* Benny Style Panels - Red Theme */
.card-panel {
background: linear-gradient(180deg, rgba(20, 10, 10, 0.95) 0%, rgba(10, 5, 5, 0.95) 100%);
border: 1px solid rgba(239, 68, 68, 0.25);
box-shadow: 0 0 60px rgba(239, 68, 68, 0.15), 0 24px 48px -16px rgba(8, 8, 12, 0.7);
cursor: pointer;
}
.glass-panel {
background: rgba(30, 15, 15, 0.65);
-webkit-backdrop-filter: blur(18px);
backdrop-filter: blur(18px);
border: 1px solid rgba(239, 68, 68, 0.25);
}
.benny-cta {
background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 50%, rgba(185, 28, 28, 0.95) 100%);
color: #ffffff;
border: 1px solid rgba(239, 68, 68, 0.5);
box-shadow: 0 10px 30px -12px rgba(239, 68, 68, 0.6), 0 0 60px rgba(239, 68, 68, 0.2);
}
.benny-cta:hover {
filter: brightness(1.15);
transform: translateY(-1px);
box-shadow: 0 10px 40px -10px rgba(239, 68, 68, 0.8), 0 0 80px rgba(239, 68, 68, 0.3);
}
.benny-ca {
background: rgba(20, 10, 10, 0.7);
border: 1px solid rgba(239, 68, 68, 0.35);
}
.benny-logo {
background: radial-gradient(circle at 30% 30%, #ef4444 0%, #dc2626 45%, #b91c1c 100%);
color: #ffffff;
font-weight: 800;
box-shadow: 0 0 40px rgba(239, 68, 68, 0.4);
}
.benny-badge {
background: rgba(239, 68, 68, 0.15);
border: 1px solid rgba(239, 68, 68, 0.4);
color: #fca5a5;
}
.benny-access {
background: linear-gradient(90deg, rgba(239, 68, 68, 0.2) 0%, rgba(185, 28, 28, 0.2) 100%);
border: 1px solid rgba(239, 68, 68, 0.3);
}
.watchlist-card {
background: rgba(24, 10, 10, 0.7);
border: 1px solid rgba(239, 68, 68, 0.15);
transition: all 0.2s ease;
}
.watchlist-card:hover {
background: rgba(239, 68, 68, 0.08);
border-color: rgba(239, 68, 68, 0.3);
}

/* DexScreener Chart */
.dexscreener-chart {
width: 100%;
height: 500px;
border-radius: 12px;
border: 1px solid rgba(239, 68, 68, 0.25);
background: rgba(10, 5, 5, 0.6);
overflow: hidden;
}
@media (min-width: 768px) {
.dexscreener-chart {
height: 600px;
}
}
@media (min-width: 1024px) {
.dexscreener-chart {
height: 700px;
}
}
@media (min-width: 1440px) {
.dexscreener-chart {
height: 800px;
}
}
.glass-btn {
background: rgba(255, 255, 255, 0.03);
border: 1px solid rgba(255, 255, 255, 0.1);
transition: all 0.2s ease;
}
.glass-btn:hover {
background: rgba(255, 255, 255, 0.08);
border-color: rgba(255, 255, 255, 0.2);
}
.glass-btn.active {
background: rgba(255, 255, 255, 0.15);
border-color: rgba(255, 255, 255, 0.3);
color: white;
}
.noise-bg {
background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
mix-blend-mode: overlay;
}
.shimmer-text {
background: linear-gradient(to right, #fff 20%, #71717a 30%, #d4d4d8 40%, #fff 50%);
background-size: 200% auto;
-webkit-background-clip: text;
background-clip: text;
color: transparent;
animation: textShimmer 2.5s linear infinite;
}
@keyframes textShimmer {
0% { background-position: 200% center; }
100% { background-position: -200% center; }
}
/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #050505; }
::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
/* Custom Progress Bar */
.progress-grad-bull {
background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
}
.progress-grad-bear {
background: linear-gradient(90deg, #f43f5e 0%, #fb7185 100%);
box-shadow: 0 0 10px rgba(244, 63, 94, 0.3);
}
/* TP Hit Animation */
.tp-hit {
color: #34d399 !important;
opacity: 1 !important;
font-weight: 700 !important;
text-shadow: 0 0 10px rgba(52, 211, 153, 0.2);
}
.tp-icon-hit {
opacity: 1 !important;
transform: scale(1);
}
/* Modal Transitions */
#detail-modal {
transition: opacity 0.3s ease, visibility 0.3s ease;
}
#detail-modal.hidden-modal {
opacity: 0;
visibility: hidden;
pointer-events: none;
}
#detail-modal.visible-modal {
opacity: 1;
visibility: visible;
pointer-events: auto;
}
.chart-grid {
background-image:
linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
background-size: 40px 40px;
}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
    /* Timeframe buttons mobile */
    .h-14 {
        flex-wrap: wrap !important;
        height: auto !important;
        padding: 8px !important;
        gap: 4px !important;
    }
    .h-14 > div:first-child {
        flex-wrap: wrap !important;
        gap: 4px !important;
    }
    .h-14 > div:last-child {
        display: none !important;
    }
    .h-14 button {
        padding: 6px 10px !important;
        font-size: 9px !important;
    }
    
    /* Chart levels card mobile - now shown as bottom sheet (defined in first mobile media query) */

    /* Opportunities grid mobile */
    #opportunities-grid {
        grid-template-columns: 1fr !important;
        padding: 10px !important;
    }
    
    /* Card panels mobile */
    .card-panel {
        padding: 16px !important;
        border-radius: 16px !important;
    }
    .card-panel h3 {
        font-size: 16px !important;
    }
    .card-panel .text-4xl {
        font-size: 24px !important;
    }
    
    /* Watchlist grid mobile */
    #watchlist-grid {
        grid-template-columns: 1fr !important;
    }
    
    /* Stats section mobile */
    .grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    /* Main layout mobile */
    .flex.h-screen {
        flex-direction: column !important;
        height: auto !important;
        min-height: 100vh !important;
    }
    
    /* Sidebar mobile */
    .w-80 {
        width: 100% !important;
        max-height: none !important;
    }
    
    /* Hide unnecessary elements on mobile */
    .hidden-mobile {
        display: none !important;
    }
}

@media (max-width: 480px) {
    /* Extra small screens - adjust chart levels position */
    #chart-levels-card {
        right: 4px !important;
        left: 4px !important;
        bottom: 4px !important;
        max-height: 140px !important;
        font-size: 9px !important;
        padding: 8px !important;
    }
    
    #chart-levels-card.collapsed {
        max-height: 40px !important;
    }
    
    /* Even smaller leverage buttons */
    #chart-levels-card .leverage-btn {
        font-size: 8px !important;
        padding: 3px 0 !important;
    }
    
    .card-panel {
        padding: 12px !important;
    }
    
    .h-14 button {
        padding: 4px 8px !important;
        font-size: 8px !important;
    }
    
    /* Improve card padding on mobile */
    #opportunities-grid > div {
        padding: 1rem !important;
    }
    
    /* Stack header elements on mobile */
    header {
        flex-direction: column !important;
        gap: 1rem !important;
    }
    
    /* Make stats grid 2 columns on mobile */
    .grid-cols-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    }
}

/* Landscape mobile optimization */
@media (max-width: 768px) and (orientation: landscape) {
    #detail-modal > div:first-child {
        height: 60dvh !important;
        min-height: 200px !important;
    }
    
    #chart-container {
        height: calc(60dvh - 40px) !important;
        min-height: 160px !important;
    }
    
    #chart-levels-card {
        display: block !important;
        position: absolute !important;
        width: 180px !important;
        right: 10px !important;
        top: 10px !important;
        bottom: auto !important;
        left: auto !important;
        font-size: 9px !important;
        padding: 0.5rem !important;
        max-height: calc(60dvh - 60px) !important;
        z-index: 50 !important;
    }
    
    #detail-modal .h-14 {
        height: 40px !important;
    }
    
    #sidebar-panel {
        height: calc(100dvh - 60dvh) !important;
    }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
    /* Increase touch targets on mobile */
    button, a, [onclick] {
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Improve spacing */
    .space-y-2 > * + * {
        margin-top: 0.75rem !important;
    }
}
</style><link id="all-fonts-link-font-geist" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-geist">.font-geist { font-family: 'Geist', sans-serif !important; }</style><link id="all-fonts-link-font-roboto" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-roboto">.font-roboto { font-family: 'Roboto', sans-serif !important; }</style><link id="all-fonts-link-font-montserrat" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-montserrat">.font-montserrat { font-family: 'Montserrat', sans-serif !important; }</style><link id="all-fonts-link-font-poppins" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-poppins">.font-poppins { font-family: 'Poppins', sans-serif !important; }</style><link id="all-fonts-link-font-playfair" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;900&amp;display=swap"><style id="all-fonts-style-font-playfair">.font-playfair { font-family: 'Playfair Display', serif !important; }</style><link id="all-fonts-link-font-instrument-serif" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Instrument+Serif:wght@400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-instrument-serif">.font-instrument-serif { font-family: 'Instrument Serif', serif !important; }</style><link id="all-fonts-link-font-merriweather" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&amp;display=swap"><style id="all-fonts-style-font-merriweather">.font-merriweather { font-family: 'Merriweather', serif !important; }</style><link id="all-fonts-link-font-bricolage" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-bricolage">.font-bricolage { font-family: 'Bricolage Grotesque', sans-serif !important; }</style><link id="all-fonts-link-font-jakarta" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-jakarta">.font-jakarta { font-family: 'Plus Jakarta Sans', sans-serif !important; }</style><link id="all-fonts-link-font-manrope" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-manrope">.font-manrope { font-family: 'Manrope', sans-serif !important; }</style><link id="all-fonts-link-font-space-grotesk" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-space-grotesk">.font-space-grotesk { font-family: 'Space Grotesk', sans-serif !important; }</style><link id="all-fonts-link-font-work-sans" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-work-sans">.font-work-sans { font-family: 'Work Sans', sans-serif !important; }</style><link id="all-fonts-link-font-pt-serif" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&amp;display=swap"><style id="all-fonts-style-font-pt-serif">.font-pt-serif { font-family: 'PT Serif', serif !important; }</style><link id="all-fonts-link-font-geist-mono" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-geist-mono">.font-geist-mono { font-family: 'Geist Mono', monospace !important; }</style><link id="all-fonts-link-font-space-mono" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&amp;display=swap"><style id="all-fonts-style-font-space-mono">.font-space-mono { font-family: 'Space Mono', monospace !important; }</style><link id="all-fonts-link-font-quicksand" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-quicksand">.font-quicksand { font-family: 'Quicksand', sans-serif !important; }</style><link id="all-fonts-link-font-nunito" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&amp;display=swap"><style id="all-fonts-style-font-nunito">.font-nunito { font-family: 'Nunito', sans-serif !important; }</style><link id="all-fonts-link-font-newsreader" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Newsreader:opsz,wght@6..72,400..800&amp;display=swap"><style id="all-fonts-style-font-newsreader">.font-newsreader { font-family: 'Newsreader', serif !important; }</style><link id="all-fonts-link-font-google-sans-flex" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-google-sans-flex">.font-google-sans-flex { font-family: 'Google Sans Flex', sans-serif !important; }</style><link id="all-fonts-link-font-oswald" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-oswald">.font-oswald { font-family: 'Oswald', sans-serif !important; }</style><link id="all-fonts-link-font-dm-sans" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-dm-sans">.font-dm-sans { font-family: 'DM Sans', sans-serif !important; }</style><link id="all-fonts-link-font-cormorant" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&amp;display=swap"><style id="all-fonts-style-font-cormorant">.font-cormorant { font-family: 'Cormorant Garamond', serif !important; }</style></head>
<body class="min-h-screen relative selection:bg-white/20 selection:text-white pb-20 overflow-x-hidden font-sans bg-[#050505]">

    <!-- üéâ BENNY IS NOW PUBLIC - Trial banner disabled -->
    <!-- FREE TRIAL BANNER (Hidden - BENNY is now free for everyone!) -->
    <div id="trial-banner" class="hidden fixed top-0 left-0 right-0 z-[100] bg-gradient-to-r from-emerald-600 via-emerald-500 to-emerald-600 text-white text-center py-2 px-4 transform -translate-y-full transition-transform duration-500" style="display: none;">
        <div class="flex items-center justify-center gap-3 max-w-screen-xl mx-auto">
            <span class="text-sm font-medium">üéÅ <span id="trial-banner-text">Welcome to BENNY!</span></span>
        </div>
    </div>
    <script>
        // üéâ BENNY is now PUBLIC - Trial banner disabled
        // All users have full access!
        (function() {
            console.log('üéâ BENNY is PUBLIC - All wallets welcome!');
        })();
    </script>

    <!-- Video Background -->
    <div class="fixed inset-0 z-0 select-none pointer-events-none bg-[#050505]">
        <video id="bg-video" class="w-full h-full object-cover grayscale opacity-20" autoplay="" muted="" loop="" playsinline="" src="blob:https://www.aura.build/b0b390ef-0b1d-4989-8ecd-c0db49a0a3b9"></video>
        <div class="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/95 to-[#050505]/80"></div>
        <div class="absolute inset-0 noise-bg z-10"></div>
    </div>

    <!-- Main Content -->
    

    <!-- FULL SCREEN DETAIL MODAL -->
    <div id="detail-modal" class="fixed inset-0 z-50 bg-[#050505]/95 flex items-center justify-center hidden-modal">
        
        <!-- Modal Container (centralizado) -->
        <div id="modal-container" class="flex w-full h-full md:w-auto md:h-auto md:max-w-[1400px] md:max-h-[90vh] md:rounded-2xl overflow-hidden md:border md:border-white/10 md:shadow-2xl">
        
        <!-- Left Column: Chart Area -->
        <div id="chart-panel" class="flex-1 flex flex-col relative border-r border-white/5 bg-[#050505]">
            <!-- Top Chart Nav -->
            <div class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-[#050505]">
                <div class="flex items-center gap-1">
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">5m</button>
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">15m</button>
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">30m</button>
                    <button class="px-3 py-1 rounded bg-white/10 text-[10px] font-mono text-white font-medium">1h</button>
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">4h</button>
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">12h</button>
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">1D</button>
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">1W</button>
                    <button class="px-3 py-1 rounded text-[10px] font-mono text-zinc-500 hover:text-white transition-colors">1M</button>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-[10px] font-mono">
                        <span class="w-2 h-2 rounded-full bg-yellow-400"></span> <span class="text-zinc-400">EMA 12</span>
                    </div>
                    <div class="flex items-center gap-2 text-[10px] font-mono">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span> <span class="text-zinc-400">EMA 26</span>
                    </div>
                    <div class="flex items-center gap-2 text-[10px] font-mono">
                        <span class="w-2 h-2 rounded-full bg-purple-500"></span> <span class="text-zinc-400">EMA 200</span>
                    </div>
                </div>
            </div>

            <!-- Chart Canvas Area -->
            <div class="flex-1 relative chart-grid overflow-hidden" id="chart-container">
                <!-- TradingView Widget - Real-time Bybit Chart -->
                <div id="tradingview-widget" class="absolute inset-0 w-full h-full">
                    <div class="tradingview-widget-container h-full w-full">
                        <div id="tradingview_chart" class="h-full w-full"></div>
                    </div>
                </div>
                
                <!-- Chart Levels Floating Card (Draggable) -->
                <div id="chart-levels-card" class="absolute top-10 right-10 w-72 glass-panel rounded-lg border border-white/10 p-4 shadow-2xl cursor-move z-50 select-none">
                    <div id="chart-levels-header" class="flex items-center justify-between mb-4 border-b border-white/5 pb-2 cursor-grab active:cursor-grabbing">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-grip text-zinc-500 hidden md:block"><circle cx="12" cy="5" r="1"></circle><circle cx="19" cy="5" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="19" cy="19" r="1"></circle><circle cx="5" cy="19" r="1"></circle></svg>
                            <!-- Mobile expand/collapse indicator -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-up-down text-zinc-500 md:hidden"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
                            <span data-key="overlay_levels" class="text-[10px] font-mono tracking-widest text-zinc-400 uppercase">CHART LEVELS</span>
                            <!-- Mobile hint -->
                            <span class="text-[8px] text-zinc-600 md:hidden">(toque para expandir)</span>
                        </div>
                        <button class="text-zinc-500 hover:text-white hidden md:block"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button>
                    </div>

                    <!-- Capital Input -->
                    <div class="mb-3 p-2 rounded bg-white/5 border border-white/10">
                        <label class="text-[9px] font-mono text-zinc-500 uppercase tracking-wider mb-1 block">Capital (USD)</label>
                        <div class="flex items-center gap-2">
                            <span class="text-zinc-400 text-sm">$</span>
                            <input 
                                type="number" 
                                id="overlay-capital-input" 
                                placeholder="100" 
                                min="1"
                                class="w-full bg-transparent border-none text-white text-sm font-mono focus:outline-none focus:ring-0 placeholder-zinc-600"
                                oninput="window.calculateScaledOrders()"
                            />
                            <span class="text-[9px] text-zinc-500">USD</span>
                        </div>
                    </div>

                    <!-- Scaled Orders Toggle -->
                    <div class="mb-3 p-2 rounded bg-white/5 border border-white/10">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-[9px] font-mono text-zinc-500 uppercase tracking-wider">Ordens Escalonadas (10x)</label>
                            <button id="toggle-scaled-orders" onclick="window.toggleScaledOrdersView()" class="text-[8px] font-mono text-amber-400 hover:text-amber-300 transition-colors">
                                <span id="scaled-orders-toggle-text">MOSTRAR</span>
                            </button>
                        </div>
                        <!-- PM (Pre√ßo M√©dio) -->
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-mono text-amber-500">PM (Pre√ßo M√©dio)</span>
                            <span id="overlay-pm" class="text-[10px] font-mono font-bold text-amber-400">--</span>
                        </div>
                    </div>

                    <!-- Scaled Orders Detail (Collapsible) -->
                    <div id="scaled-orders-detail" class="hidden mb-3 p-2 rounded bg-amber-500/5 border border-amber-500/20 max-h-32 overflow-y-auto">
                        <div class="text-[8px] font-mono text-amber-500/70 uppercase tracking-wider mb-2">Distribui√ß√£o de Ordens</div>
                        <div id="scaled-orders-list" class="space-y-1">
                            <!-- Orders will be populated by JS -->
                        </div>
                    </div>

                    <!-- Leverage Selector -->
                    <div class="mb-4 p-2 rounded bg-white/5 border border-white/10">
                        <label class="text-[9px] font-mono text-zinc-500 uppercase tracking-wider mb-2 block">Alavancagem</label>
                        <div class="flex items-center gap-1">
                            <button onclick="window.setLeverage(1)" data-leverage="1" class="leverage-btn flex-1 py-1 text-[10px] font-mono rounded bg-yellow-500/20 text-yellow-500 border border-yellow-500/30">1x</button>
                            <button onclick="window.setLeverage(2)" data-leverage="2" class="leverage-btn flex-1 py-1 text-[10px] font-mono rounded bg-white/5 text-zinc-400 border border-white/10 hover:bg-white/10">2x</button>
                            <button onclick="window.setLeverage(3)" data-leverage="3" class="leverage-btn flex-1 py-1 text-[10px] font-mono rounded bg-white/5 text-zinc-400 border border-white/10 hover:bg-white/10">3x</button>
                            <button onclick="window.setLeverage(5)" data-leverage="5" class="leverage-btn flex-1 py-1 text-[10px] font-mono rounded bg-white/5 text-zinc-400 border border-white/10 hover:bg-white/10">5x</button>
                            <button onclick="window.setLeverage(10)" data-leverage="10" class="leverage-btn flex-1 py-1 text-[10px] font-mono rounded bg-white/5 text-zinc-400 border border-white/10 hover:bg-white/10">10x</button>
                        </div>
                        <div class="mt-2 text-center">
                            <span class="text-[9px] text-zinc-500">Posi√ß√£o efetiva: </span>
                            <span id="overlay-effective-position" class="text-[10px] font-mono text-yellow-500">$0</span>
                        </div>
                    </div>

                    <!-- Direction Badge -->
                    <div id="overlay-direction" class="w-full py-1.5 mb-4 rounded bg-emerald-500/10 border border-emerald-500/20 text-center flex items-center justify-center gap-2">
                        <svg id="overlay-direction-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up text-emerald-500"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
                        <span id="overlay-direction-text" class="text-xs font-mono font-bold text-emerald-500 tracking-widest">LONG</span>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span data-key="overlay_entry" class="text-[10px] font-mono text-emerald-500">Entry Zone</span>
                            <span id="overlay-entry-zone" class="text-[10px] font-mono text-white">--</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-mono text-emerald-500 flex items-center gap-1">
                                TP1
                                <span id="overlay-tp1-status" class="hidden text-emerald-400 font-bold animate-pulse">‚úì HIT</span>
                            </span>
                            <div class="flex items-center gap-2">
                                <span id="overlay-tp1" class="text-[10px] font-mono text-white">--</span>
                                <span id="overlay-tp1-pnl" class="text-[9px] font-mono text-emerald-400 hidden">+$0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-mono text-emerald-500 flex items-center gap-1">
                                TP2
                                <span id="overlay-tp2-status" class="hidden text-emerald-400 font-bold animate-pulse">‚úì HIT</span>
                            </span>
                            <div class="flex items-center gap-2">
                                <span id="overlay-tp2" class="text-[10px] font-mono text-white">--</span>
                                <span id="overlay-tp2-pnl" class="text-[9px] font-mono text-emerald-400 hidden">+$0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-mono text-emerald-500 flex items-center gap-1">
                                TP3
                                <span id="overlay-tp3-status" class="hidden text-emerald-400 font-bold animate-pulse">‚úì HIT</span>
                            </span>
                            <div class="flex items-center gap-2">
                                <span id="overlay-tp3" class="text-[10px] font-mono text-white">--</span>
                                <span id="overlay-tp3-pnl" class="text-[9px] font-mono text-emerald-400 hidden">+$0</span>
                            </div>
                        </div>
                        <div class="h-px w-full bg-white/5 my-2"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-mono text-rose-500 flex items-center gap-1">
                                <span data-key="overlay_stoploss">Stop Loss</span>
                                <span id="overlay-sl-status" class="hidden text-rose-400 font-bold animate-pulse">‚úó STOP</span>
                            </span>
                            <div class="flex items-center gap-2">
                                <span id="overlay-stoploss" class="text-[10px] font-mono text-white">--</span>
                                <span id="overlay-sl-pnl" class="text-[9px] font-mono text-rose-400 hidden">-$0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span data-key="overlay_current" class="text-[10px] font-mono text-zinc-500">Current</span>
                            <span id="overlay-current" class="text-xs font-mono font-bold text-white">--</span>
                        </div>
                         <div class="flex justify-between items-center">
                            <span data-key="overlay_rr" class="text-[10px] font-mono text-zinc-500">R:R (TP1)</span>
                            <span id="overlay-rr" class="text-[10px] font-mono text-yellow-500">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Sidebar -->
        <div class="w-[400px] bg-[#09090b] border-l border-white/5 flex flex-col h-full" id="sidebar-panel">
            
            <!-- Sidebar Header -->
            <div class="h-20 px-6 border-b border-white/5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="sidebar-icon-container" class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center bg-white/[0.02]">
                        <svg id="modal-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle w-5 h-5 text-white"><circle cx="12" cy="12" r="10"></circle></svg>
                    </div>
                    <div>
                        <h2 class="text-base font-bold text-white tracking-tight" id="modal-title">--</h2>
                        <span class="text-[10px] font-mono text-zinc-500" id="sidebar-symbol">--</span>
                    </div>
                </div>
                <button onclick="closeDetail()" class="text-zinc-500 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
                
                <!-- Trade Status Box (TPs/SL Hit) -->
                <div id="trade-status-box" class="hidden">
                    <div id="trade-status-content" class="p-4 rounded-lg border animate-pulse">
                        <!-- Conte√∫do din√¢mico via JS -->
                    </div>
                </div>
                
                <!-- Warning Box -->
                <div id="sidebar-warning" class="p-4 rounded-lg bg-yellow-500/5 border border-yellow-500/20 hidden">
                    <h4 data-key="warn_title" class="text-xs font-bold text-yellow-500 mb-2">Aten√ß√£o: Timeframes em dire√ß√µes opostas</h4>
                    <p id="sidebar-warning-text" data-key="warn_text" class="text-[11px] leading-relaxed text-yellow-500/80">Timeframes menores e maiores apontam dire√ß√µes opostas. Ambos est√£o corretos conforme a metodologia. Aviso criado apenas para dar mais contexto √† sua decis√£o.</p>
                </div>

                <!-- Description -->
                <div class="context-section">
                    <h3 id="sidebar-headline" class="text-sm md:text-sm font-semibold text-white mb-3">Carregando an√°lise...</h3>
                    <div id="sidebar-context" class="space-y-3 text-xs md:text-[11px] leading-relaxed text-zinc-300 md:text-zinc-400">
                        <p id="sidebar-context-placeholder" class="text-white/50">Aguardando sele√ß√£o de ativo...</p>
                    </div>
                </div>

                <!-- Technical Data Table -->
                <div>
                    <h4 data-key="sidebar_tech_data" class="text-sm font-semibold text-white mb-4">Dados t√©cnicos</h4>
                    <div class="border border-white/5 rounded-lg overflow-hidden">
                        <div class="flex justify-between p-3 border-b border-white/5 bg-white/[0.02]">
                            <span data-key="sidebar_trend" class="text-[10px] text-zinc-500">Tend√™ncia do alvo</span>
                            <span id="sidebar-trend" class="text-[10px] font-mono font-bold">--</span>
                        </div>
                        <div class="flex justify-between p-3 border-b border-white/5">
                            <span data-key="sidebar_tf_signal" class="text-[10px] text-zinc-500">Timeframe (sinal)</span>
                            <span id="sidebar-tf-signal" class="text-[10px] font-mono text-white">--</span>
                        </div>
                        <div class="flex justify-between p-3 border-b border-white/5 bg-white/[0.02]">
                            <span data-key="sidebar_tf_target" class="text-[10px] text-zinc-500">Timeframe alvo</span>
                            <span id="sidebar-tf-target" class="text-[10px] font-mono text-white">--</span>
                        </div>
                        <div class="flex justify-between p-3 border-b border-white/5">
                            <span data-key="sidebar_fibo_382" class="text-[10px] text-zinc-500">Fibo 0.382</span>
                            <span id="sidebar-fibo-382" class="text-[10px] font-mono text-white">--</span>
                        </div>
                        <div class="flex justify-between p-3 border-b border-white/5 bg-white/[0.02]">
                            <span data-key="sidebar_fibo_5" class="text-[10px] text-zinc-500">Fibo 0.5</span>
                            <span id="sidebar-fibo-5" class="text-[10px] font-mono text-white">--</span>
                        </div>
                        <div class="flex justify-between p-3">
                            <span data-key="sidebar_fibo_618" class="text-[10px] text-zinc-500">Fibo 0.618</span>
                            <span id="sidebar-fibo-618" class="text-[10px] font-mono text-white">--</span>
                        </div>
                    </div>
                </div>

                <!-- Trade Timeline -->
                <div id="trade-timeline-section">
                    <h4 data-key="timeline_title" class="text-sm font-semibold text-white mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        Timeline do Trade
                    </h4>
                    <div class="border border-white/5 rounded-lg overflow-hidden">
                        <!-- Signal Created Time -->
                        <div class="flex justify-between p-3 border-b border-white/5 bg-white/[0.02]">
                            <span class="text-[10px] text-zinc-500 flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                                <span data-key="timeline_signal">Sinal Criado</span>
                            </span>
                            <span id="timeline-entry" class="text-[10px] font-mono text-blue-400">--</span>
                        </div>
                        <!-- Entry Zone Hit Time -->
                        <div id="timeline-zone-row" class="flex justify-between p-3 border-b border-white/5 hidden">
                            <span class="text-[10px] text-zinc-500 flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                                <span data-key="timeline_zone">Entrou na Zona</span>
                            </span>
                            <span id="timeline-zone" class="text-[10px] font-mono text-amber-400">--</span>
                        </div>
                        <!-- TP1 Hit Time -->
                        <div id="timeline-tp1-row" class="flex justify-between p-3 border-b border-white/5 hidden">
                            <span class="text-[10px] text-zinc-500 flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span data-key="timeline_tp1">TP1 Atingido</span>
                            </span>
                            <span id="timeline-tp1" class="text-[10px] font-mono text-emerald-400">--</span>
                        </div>
                        <!-- TP2 Hit Time -->
                        <div id="timeline-tp2-row" class="flex justify-between p-3 border-b border-white/5 bg-white/[0.02] hidden">
                            <span class="text-[10px] text-zinc-500 flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span data-key="timeline_tp2">TP2 Atingido</span>
                            </span>
                            <span id="timeline-tp2" class="text-[10px] font-mono text-emerald-400">--</span>
                        </div>
                        <!-- TP3 Hit Time -->
                        <div id="timeline-tp3-row" class="flex justify-between p-3 border-b border-white/5 hidden">
                            <span class="text-[10px] text-zinc-500 flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span data-key="timeline_tp3">TP3 Atingido</span>
                            </span>
                            <span id="timeline-tp3" class="text-[10px] font-mono text-emerald-400">--</span>
                        </div>
                        <!-- Stop Loss Hit Time -->
                        <div id="timeline-sl-row" class="flex justify-between p-3 hidden">
                            <span class="text-[10px] text-zinc-500 flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-rose-500"></span>
                                <span data-key="timeline_sl">Stop Loss Atingido</span>
                            </span>
                            <span id="timeline-sl" class="text-[10px] font-mono text-rose-400">--</span>
                        </div>
                    </div>
                </div>

                <!-- Confluences -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h4 data-key="sidebar_conf_title" class="text-sm font-semibold text-white">Conflu√™ncias do Term√¥metro</h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle text-zinc-600"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span data-key="sidebar_conf_positive" class="text-[9px] font-bold text-emerald-500 uppercase tracking-wide mb-2 block">Conflu√™ncias Positivas</span>
                            <ul id="sidebar-confluences-positive" class="space-y-1.5">
                                <li class="flex items-start gap-1.5 text-[10px] text-zinc-400">
                                    <span class="w-1 h-1 rounded-full bg-emerald-500 mt-1.5"></span>
                                    <span data-key="waiting_data">Aguardando dados...</span>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <span data-key="sidebar_conf_negative" class="text-[9px] font-bold text-rose-500 uppercase tracking-wide mb-2 block">Conflu√™ncias Negativas</span>
                            <ul id="sidebar-confluences-negative" class="space-y-1.5">
                                <li class="flex items-start gap-1.5 text-[10px] text-zinc-400">
                                    <span class="w-1 h-1 rounded-full bg-rose-500 mt-1.5"></span>
                                    <span data-key="waiting_data">Aguardando dados...</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Advanced Market Data (Long/Short, Structure, Fib Zone) -->
                <div class="mt-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 data-key="sidebar_advanced_title" class="text-sm font-semibold text-white">Dados Avan√ßados</h4>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity text-zinc-600"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    </div>
                    <div class="glass-panel rounded-lg overflow-hidden divide-y divide-white/5">
                        <!-- Fibonacci Zone -->
                        <div class="p-3 border-b border-white/5">
                            <div class="flex justify-between items-center">
                                <span data-key="sidebar_fib_zone" class="text-[10px] text-zinc-500">Zona Fibonacci</span>
                                <span id="sidebar-fib-zone" class="text-[10px] font-mono text-white flex items-center gap-1">
                                    <span id="sidebar-fib-zone-icon">‚öñÔ∏è</span>
                                    <span id="sidebar-fib-zone-text">--</span>
                                </span>
                            </div>
                            <div class="mt-1 h-1.5 w-full bg-zinc-800 rounded-full overflow-hidden">
                                <div id="sidebar-fib-zone-bar" class="h-full w-[50%] bg-gradient-to-r from-emerald-500 via-amber-500 to-rose-500 rounded-full transition-all"></div>
                            </div>
                        </div>
                        <!-- Market Structure -->
                        <div class="flex justify-between p-3 border-b border-white/5 bg-white/[0.02]">
                            <span data-key="sidebar_structure" class="text-[10px] text-zinc-500">Estrutura (AlphaDesk)</span>
                            <span id="sidebar-structure" class="text-[10px] font-mono text-white">--</span>
                        </div>
                        <!-- Long/Short Ratio -->
                        <div class="p-3 border-b border-white/5">
                            <div class="flex justify-between items-center mb-1">
                                <span data-key="sidebar_ls_ratio" class="text-[10px] text-zinc-500">Long/Short Ratio</span>
                                <span id="sidebar-ls-ratio" class="text-[10px] font-mono text-white">--</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex-1 h-2 bg-zinc-800 rounded-full overflow-hidden flex">
                                    <div id="sidebar-long-bar" class="h-full bg-emerald-500 transition-all w-1/2"></div>
                                    <div id="sidebar-short-bar" class="h-full bg-rose-500 transition-all w-1/2"></div>
                                </div>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span id="sidebar-long-pct" class="text-[9px] font-mono text-emerald-400">50% Long</span>
                                <span id="sidebar-short-pct" class="text-[9px] font-mono text-rose-400">50% Short</span>
                            </div>
                        </div>
                        <!-- Funding Rate -->
                        <div class="flex justify-between p-3 border-b border-white/5 bg-white/[0.02]">
                            <span data-key="sidebar_funding" class="text-[10px] text-zinc-500">Funding Rate</span>
                            <span id="sidebar-funding" class="text-[10px] font-mono text-white">--</span>
                        </div>
                        <!-- Open Interest -->
                        <div class="flex justify-between p-3">
                            <span data-key="sidebar_oi" class="text-[10px] text-zinc-500">Open Interest 24h</span>
                            <span id="sidebar-oi" class="text-[10px] font-mono text-white">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-6 border-t border-white/5 bg-[#09090b]">
                <div class="flex items-center justify-between mb-2">
                    <span data-key="sidebar_conf_score" class="text-[10px] font-mono text-zinc-500 tracking-widest uppercase">Confidence Score</span>
                    <span id="sidebar-confidence-value" class="text-sm font-mono font-bold text-white">--%</span>
                </div>
                <div class="h-1.5 w-full bg-zinc-800 rounded-full overflow-hidden">
                    <div id="sidebar-confidence-bar" class="h-full w-[0%] bg-gradient-to-r from-emerald-500 via-yellow-500 to-rose-500 rounded-full"></div>
                </div>
            </div>

        </div>
        </div><!-- End modal-container -->
    </div><!-- End detail-modal -->
    
    <div class="sm:px-6 lg:px-8 z-20 max-w-[1600px] mr-auto ml-auto pr-4 pl-4 relative" id="card-xrp">
        
        <!-- Navbar -->
        <header class="pt-4 md:pt-8 pb-4 md:pb-6 border-b border-rose-500/10">
            <!-- BENNY Hero Section -->
            <div class="flex flex-col lg:flex-row items-center justify-between gap-4 md:gap-6 mb-4 md:mb-6">
                <div class="flex items-center gap-3 md:gap-6">
                    <!-- Logo BENNY Grande -->
                    <div class="w-14 h-14 md:w-20 md:h-20 rounded-xl md:rounded-2xl flex items-center justify-center shadow-lg shadow-rose-500/30 overflow-hidden relative group flex-shrink-0">
                        <img src="https://i.ibb.co/27kB19BM/photo-2026-01-27-18-04-37.jpg" alt="BENNY" class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-300" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ctext y=%27.9em%27 font-size=%2790%27%3Eüêï%3C/text%3E%3C/svg%3E'" />
                        <div class="absolute inset-0 bg-gradient-to-t from-rose-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-4xl font-black tracking-tight mb-1 md:mb-2" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 40px rgba(239, 68, 68, 0.3);">
                            $BENNY TERMINAL
                        </h1>
                        <div class="flex flex-wrap items-center gap-2 md:gap-3">
                            <span class="benny-badge text-[9px] md:text-[10px] font-mono px-2 md:px-3 py-1 rounded-full uppercase tracking-wide md:tracking-widest text-white" data-key="benny_analysis">AI-Powered Signals</span>
                            <div class="flex items-center gap-1.5">
                                <div class="w-1.5 h-1.5 md:w-2 md:h-2 bg-rose-500 rounded-full animate-pulse"></div>
                                <span data-key="sys_op" class="text-[9px] md:text-[11px] uppercase tracking-wide text-rose-400 font-mono">Live Market Data</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trial Status Banner (mostrado apenas para usu√°rios em trial) -->
                <div id="trialBanner" class="hidden w-full lg:w-auto px-4 md:px-6 py-2 rounded-xl bg-amber-500/10 border border-amber-500/30 flex items-center gap-2 text-xs md:text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400 flex-shrink-0">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="text-amber-300 font-medium">
                        <span data-key="trial_access">Trial Access</span>: 
                        <span id="trialDaysText" class="font-bold text-amber-400"></span>
                    </span>
                </div>
                
                <!-- Buy BENNY CTA Destacado -->
                <a href="https://pancakeswap.finance/swap?outputCurrency=0x13Bab38Dc7eBEB07424f9fCbA5F0701547Bf4444&chain=bsc" target="_blank" rel="noopener noreferrer" class="benny-cta w-full lg:w-auto px-6 md:px-8 py-2.5 md:py-3 rounded-xl flex items-center justify-center gap-2 md:gap-3 text-xs md:text-sm font-semibold tracking-wider uppercase transition-all hover:scale-105 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="8" cy="8" r="6"></circle>
                        <path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path>
                        <path d="M7 6h1v4"></path>
                        <path d="m16.71 13.88.7.71-2.82 2.82"></path>
                    </svg>
                    <span data-key="buy_benny">Buy $BENNY</span>
                </a>
            </div>
            
            <!-- Token Info Bar -->
            <div class="glass-panel p-3 md:p-4 rounded-xl mb-4 md:mb-6 flex flex-col md:flex-row flex-wrap items-stretch md:items-center justify-between gap-3 md:gap-4">
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 md:gap-4">
                    <!-- Contract Address -->
                    <div class="benny-ca px-3 md:px-4 py-2 rounded-lg flex flex-wrap items-center gap-2 md:gap-3">
                        <span data-key="benny_ca_label" class="text-[10px] md:text-[11px] font-mono text-white/70 uppercase font-semibold">Contract</span>
                        <span id="benny-ca" class="text-[10px] md:text-[11px] font-mono text-white font-semibold">0x13Ba...4444</span>
                        <button id="copy-benny-ca" onclick="window.copyBennyCA && window.copyBennyCA()" class="text-[10px] md:text-[11px] font-mono text-white font-semibold hover:text-rose-300 transition-colors px-2 py-1 bg-rose-500/10 rounded" data-key="copy">Copy Full</button>
                    </div>
                    
                    <!-- Chain Badge -->
                    <div class="glass-panel px-3 py-2 rounded-lg flex items-center gap-2">
                        <div class="w-1.5 h-1.5 md:w-2 md:h-2 bg-yellow-500 rounded-full"></div>
                        <span class="text-[10px] md:text-[11px] font-mono text-yellow-400 uppercase tracking-wide font-semibold">BSC</span>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-2 md:gap-3 w-full md:w-auto">
                    <!-- Wallet Display -->
                    <div class="glass-panel px-3 md:px-4 py-2 rounded-lg flex items-center gap-2 flex-1 md:flex-initial">
                        <div class="w-1.5 h-1.5 md:w-2 md:h-2 bg-rose-500 rounded-full"></div>
                        <span id="connected-wallet" class="text-[10px] md:text-[11px] font-mono text-white/80 truncate">0x...</span>
                        <button onclick="handleLogout()" class="ml-1 md:ml-2 text-white/40 hover:text-rose-400 transition-colors flex-shrink-0" title="Disconnect">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:w-[14px] md:h-[14px]"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        </button>
                    </div>
                    
                    <!-- Language Selector -->
                    <div class="relative" id="lang-selector-container">
                        <button id="lang-toggle" onclick="toggleLanguageMenu()" class="glass-panel px-2.5 md:px-3 py-2 rounded-lg flex items-center gap-1.5 md:gap-2 hover:bg-white/10 transition-colors cursor-pointer" title="Select Language">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400 md:w-[14px] md:h-[14px]">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                            </svg>
                            <span id="current-lang" class="text-[9px] md:text-[10px] font-mono text-zinc-300 tracking-wide md:tracking-widest uppercase">üá∫üá∏ EN</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-zinc-500">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div id="lang-dropdown" class="hidden absolute right-0 top-full mt-2 bg-zinc-900/95 border border-zinc-700 rounded-lg shadow-2xl backdrop-blur-sm overflow-hidden z-[9999] min-w-[150px]">
                            <button onclick="setLanguage('en')" data-lang="en" class="w-full px-4 py-2.5 text-left text-sm font-mono hover:bg-zinc-800 transition-colors flex items-center gap-2 text-white">üá∫üá∏ English</button>
                            <button onclick="setLanguage('zh')" data-lang="zh" class="w-full px-4 py-2.5 text-left text-sm font-mono hover:bg-zinc-800 transition-colors flex items-center gap-2 text-white">üá®üá≥ ‰∏≠Êñá</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Bar -->
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-2">

                    <!-- Scan Button -->
                    <button onclick="window.forceScan && window.forceScan()" class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-rose-500/10 transition-colors cursor-pointer" title="Force market scan">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-400">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                        </svg>
                        <span class="text-[11px] font-mono text-rose-400 tracking-wider uppercase hidden sm:inline">Scan Market</span>
                    </button>

                    <!-- Hot Signals Button -->
                    <button onclick="window.toggleHotSignalsPanel && window.toggleHotSignalsPanel()" class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-orange-500/10 transition-colors cursor-pointer relative" title="Hot Signals - Real-time alerts">
                        <span class="text-lg">üî•</span>
                        <span class="text-[11px] font-mono text-orange-400 tracking-wider uppercase hidden sm:inline">Hot Signals</span>
                        <span id="hot-signals-count" class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs font-bold rounded-full min-w-[20px] h-[20px] flex items-center justify-center shadow-lg">0</span>
                    </button>
                </div>
                
                <div class="text-right">
                    <div class="text-[10px] text-white/60 font-mono mb-1 uppercase tracking-wide">Access Status</div>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-rose-500 rounded-full animate-pulse"></div>
                        <span class="text-[11px] font-mono text-rose-400 uppercase tracking-wide font-semibold">Active ‚Ä¢ 7-Day Trial</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- DexScreener Chart - BENNY Token -->
        <div class="mt-6 glass-panel p-4 rounded-xl">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-mono font-semibold text-white/90 flex items-center gap-2">
                    <span class="text-lg">üìà</span>
                    <span data-key="benny_chart_title">BENNY Live Chart</span>
                </h2>
                <a href="https://dexscreener.com/bsc/0x13Bab38Dc7eBEB07424f9fCbA5F0701547Bf4444" target="_blank" rel="noopener noreferrer" class="text-[10px] font-mono text-white/50 hover:text-white transition-colors flex items-center gap-1">
                    <span data-key="view_on_dex">View on DexScreener</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                </a>
            </div>
            <iframe 
                class="dexscreener-chart" 
                src="https://dexscreener.com/bsc/0x13Bab38Dc7eBEB07424f9fCbA5F0701547Bf4444?embed=1&theme=dark&trades=0&info=0"
                frameborder="0"
                allowfullscreen>
            </iframe>
        </div>

        <!-- Page Navigation Tabs -->
        <nav class="mt-6 flex items-center gap-2 border-b border-white/5 pb-4">
            <a href="dashboard.html" class="px-4 py-2 rounded-lg bg-white/10 text-white font-medium text-sm flex items-center gap-2 border border-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="7" height="9" x="3" y="3" rx="1"></rect>
                    <rect width="7" height="5" x="14" y="3" rx="1"></rect>
                    <rect width="7" height="9" x="14" y="12" rx="1"></rect>
                    <rect width="7" height="5" x="3" y="16" rx="1"></rect>
                </svg>
                <span data-key="nav_dashboard">Dashboard</span>
            </a>

            <a href="https://pancakeswap.finance/swap?outputCurrency=0x13Bab38Dc7eBEB07424f9fCbA5F0701547Bf4444&chain=bsc" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-lg text-white/50 hover:text-white hover:bg-rose-500/10 font-medium text-sm flex items-center gap-2 transition-colors border border-rose-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-400">
                    <circle cx="8" cy="8" r="6"></circle>
                    <path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path>
                    <path d="M7 6h1v4"></path>
                    <path d="m16.71 13.88.7.71-2.82 2.82"></path>
                </svg>
                <span data-key="nav_buy_benny">Buy the BENNY</span>
            </a>

            <a href="admin.html" class="px-4 py-2 rounded-lg text-white/50 hover:text-white hover:bg-white/5 font-medium text-sm flex items-center gap-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span data-key="nav_admin">Admin</span>
            </a>
        </nav>

        <!-- Stats Row (Clickable Filters) -->
        <div class="grid grid-cols-2 lg:grid-cols-6 gap-4 mt-8" id="stats-filter-row">
            <div id="filter-all" onclick="window.filterOpportunities('all')" class="glass-panel p-4 rounded-xl flex flex-col items-center text-center group cursor-pointer hover:bg-white/5 transition-all duration-200 ring-2 ring-rose-500/50" data-filter="all">
                <span data-key="stat_active" class="text-[10px] uppercase tracking-widest text-white/40 font-mono mb-1">Active Signals</span>
                <span id="stat-active" class="text-3xl font-mono font-medium text-white group-hover:text-rose-400 transition-colors">--</span>
            </div>
            <div id="filter-bullish" onclick="window.filterOpportunities('bullish')" class="glass-panel p-4 rounded-xl flex flex-col items-center text-center group cursor-pointer hover:bg-rose-500/10 transition-all duration-200 ring-0 ring-rose-500/50" data-filter="bullish">
                <span data-key="stat_bullish" class="text-[10px] uppercase tracking-widest text-white/40 font-mono mb-1">Bullish Bias</span>
                <span id="stat-bullish" class="text-3xl font-mono font-medium text-rose-400">--</span>
            </div>
            <div id="filter-bearish" onclick="window.filterOpportunities('bearish')" class="glass-panel p-4 rounded-xl flex flex-col items-center text-center group cursor-pointer hover:bg-rose-500/10 transition-all duration-200 ring-0 ring-rose-500/50" data-filter="bearish">
                <span data-key="stat_bearish" class="text-[10px] uppercase tracking-widest text-white/40 font-mono mb-1">Bearish Bias</span>
                <span id="stat-bearish" class="text-3xl font-mono font-medium text-rose-400">--</span>
            </div>
            <div id="filter-watchlist" onclick="window.filterOpportunities('watchlist')" class="glass-panel p-4 rounded-xl flex flex-col items-center text-center group cursor-pointer hover:bg-purple-500/10 transition-all duration-200 ring-0 ring-purple-500/50" data-filter="watchlist">
                <span data-key="stat_watchlist" class="text-[10px] uppercase tracking-widest text-white/40 font-mono mb-1">Watchlist</span>
                <span id="stat-watchlist" class="text-3xl font-mono font-medium text-purple-400">--</span>
            </div>
            <!-- NEW: Take Profit History Tab -->
            <div id="filter-tp-history" onclick="window.filterOpportunities('tp-history')" class="glass-panel p-4 rounded-xl flex flex-col items-center text-center group cursor-pointer hover:bg-rose-500/10 transition-all duration-200 ring-0 ring-rose-500/50 border border-rose-500/20" data-filter="tp-history">
                <span data-key="tab_tp_history" class="text-[10px] uppercase tracking-widest text-rose-400/60 font-mono mb-1 flex items-center gap-1">
                    <span>üéØ</span> TP Hit (24h)
                </span>
                <span id="stat-tp-history" class="text-3xl font-mono font-medium text-rose-400">0</span>
            </div>
            <!-- NEW: Stop Loss History Tab -->
            <div id="filter-sl-history" onclick="window.filterOpportunities('sl-history')" class="glass-panel p-4 rounded-xl flex flex-col items-center text-center group cursor-pointer hover:bg-rose-500/10 transition-all duration-200 ring-0 ring-rose-500/50 border border-rose-500/20" data-filter="sl-history">
                <span data-key="tab_sl_history" class="text-[10px] uppercase tracking-widest text-rose-400/60 font-mono mb-1 flex items-center gap-1">
                    <span>‚ùå</span> SL Hit (24h)
                </span>
                <span id="stat-sl-history" class="text-3xl font-mono font-medium text-rose-400">0</span>
            </div>
        </div>

        <!-- MY TRADES Section (separate row) -->
        <div class="mt-4">
            <div id="filter-my-trades" onclick="window.filterOpportunities('my-trades')" class="glass-panel p-4 rounded-xl flex items-center justify-between group cursor-pointer hover:bg-cyan-500/10 transition-all duration-200 ring-0 ring-cyan-500/50 border border-cyan-500/30" data-filter="my-trades">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div>
                        <span data-key="tab_my_trades" class="text-sm font-medium text-white">Minhas Opera√ß√µes</span>
                        <p class="text-[10px] text-cyan-400/60 font-mono uppercase tracking-wide" data-key="tab_my_trades_desc">Acompanhe seus trades ativos</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <span id="stat-my-trades" class="text-2xl font-mono font-medium text-cyan-400">0</span>
                        <span class="text-xs text-zinc-500 font-mono ml-1" data-key="trades_active">ativos</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs font-mono">
                        <span class="text-emerald-400">+<span id="my-trades-profit">0</span>%</span>
                        <span class="text-zinc-600">|</span>
                        <span class="text-rose-400">-<span id="my-trades-loss">0</span>%</span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400/50 group-hover:text-cyan-400 transition-colors">
                        <path d="m9 18 6-6-6-6"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- SEARCH BAR Section -->
        <div class="mt-6" id="search-section">
            <div class="glass-panel p-4 rounded-xl border border-white/10">
                <div class="flex flex-col lg:flex-row items-stretch lg:items-center gap-4">
                    <!-- Search Input -->
                    <div class="relative flex-1">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.3-4.3"></path>
                            </svg>
                        </div>
                        <input 
                            type="text" 
                            id="asset-search-input" 
                            placeholder="Buscar ativo... (ex: BTC, ETH, SOL)" 
                            data-key-placeholder="search_placeholder"
                            class="w-full bg-black/40 border border-white/10 rounded-xl py-3 pl-12 pr-12 text-white font-mono text-sm placeholder:text-zinc-600 focus:outline-none focus:border-emerald-500/50 focus:ring-1 focus:ring-emerald-500/30 transition-all"
                            oninput="window.handleAssetSearch(this.value)"
                            autocomplete="off"
                        />
                        <!-- Clear button -->
                        <button 
                            id="clear-search-btn"
                            onclick="window.clearAssetSearch()" 
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-600 hover:text-white transition-colors hidden"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 6 6 18"></path>
                                <path d="m6 6 12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Quick Search Chips -->
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="text-[10px] text-zinc-600 font-mono uppercase tracking-wide mr-1">Popular:</span>
                        <button onclick="window.quickSearchAsset('BTC')" class="quick-search-chip px-3 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-400 text-xs font-mono hover:bg-amber-500/20 transition-all">
                            BTC
                        </button>
                        <button onclick="window.quickSearchAsset('ETH')" class="quick-search-chip px-3 py-1.5 bg-purple-500/10 border border-purple-500/30 rounded-lg text-purple-400 text-xs font-mono hover:bg-purple-500/20 transition-all">
                            ETH
                        </button>
                        <button onclick="window.quickSearchAsset('SOL')" class="quick-search-chip px-3 py-1.5 bg-rose-500/10 border border-rose-500/30 rounded-lg text-rose-400 text-xs font-mono hover:bg-rose-500/20 transition-all">
                            SOL
                        </button>
                        <button onclick="window.quickSearchAsset('XRP')" class="quick-search-chip px-3 py-1.5 bg-blue-500/10 border border-blue-500/30 rounded-lg text-blue-400 text-xs font-mono hover:bg-blue-500/20 transition-all">
                            XRP
                        </button>
                        <button onclick="window.quickSearchAsset('DOGE')" class="quick-search-chip px-3 py-1.5 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-yellow-400 text-xs font-mono hover:bg-yellow-500/20 transition-all">
                            DOGE
                        </button>
                    </div>
                </div>
                
                <!-- Search Results Info -->
                <div id="search-results-info" class="mt-3 hidden">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-zinc-500 font-mono">
                            <span id="search-results-count">0</span> <span data-key="search_results_found">resultados encontrados para</span> "<span id="search-query-display" class="text-rose-400"></span>"
                        </span>
                        <button onclick="window.clearAssetSearch()" class="text-xs text-zinc-500 hover:text-rose-400 font-mono transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 6 6 18"></path>
                                <path d="m6 6 12 12"></path>
                            </svg>
                            <span data-key="clear_search">Limpar busca</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Header -->
        <div class="flex mt-12 mb-8 relative items-center justify-center" id="section-header-confirmed">
            <div class="h-px z-0 bg-gradient-to-r from-transparent via-white/10 to-transparent w-full absolute top-1/2 left-0"></div>
            <div class="bg-[#050505] px-6 relative z-10 flex flex-col items-center">
                <div class="flex items-center gap-4">
                    <h2 data-key="sec_confirmed" class="text-xl font-medium text-white tracking-tight font-mono">CONFIRMED OPPORTUNITIES</h2>
                    <!-- Trading Type Filter -->
                    <div id="trading-type-filter" class="flex items-center gap-1 bg-white/5 rounded-lg p-1 border border-white/10">
                        <button onclick="window.filterByTradingType('all')" data-type="all" class="px-3 py-1 text-[10px] font-mono uppercase tracking-wide rounded transition-all duration-200 bg-white/10 text-white">
                            All
                        </button>
                        <button onclick="window.filterByTradingType('scalping')" data-type="scalping" class="px-3 py-1 text-[10px] font-mono uppercase tracking-wide rounded transition-all duration-200 text-zinc-500 hover:text-white hover:bg-white/5">
                            Scalp
                        </button>
                        <button onclick="window.filterByTradingType('day')" data-type="day" class="px-3 py-1 text-[10px] font-mono uppercase tracking-wide rounded transition-all duration-200 text-zinc-500 hover:text-white hover:bg-white/5">
                            Day
                        </button>
                        <button onclick="window.filterByTradingType('swing')" data-type="swing" class="px-3 py-1 text-[10px] font-mono uppercase tracking-wide rounded transition-all duration-200 text-zinc-500 hover:text-white hover:bg-white/5">
                            Swing
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARDS GRID -->
        <div id="opportunities-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
            <!-- Loading State -->
            <div class="card-panel rounded-[24px] p-8 flex flex-col items-center justify-center min-h-[400px]">
                <div class="w-8 h-8 border-2 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin mb-4"></div>
                <span data-key="loading" class="text-sm text-zinc-500 font-mono">Loading opportunities...</span>
                <span class="text-xs text-zinc-600 font-mono mt-1">Connecting to Supabase</span>
            </div>
        </div>

        <!-- TP HISTORY SECTION (Hidden by default) -->
        <div id="tp-history-section" class="hidden mt-8">
            <div class="flex flex-col items-center mb-8">
                <div class="flex items-center gap-3 mb-1">
                    <span class="text-2xl">üéØ</span>
                    <h2 data-key="tp_history_title" class="text-lg font-mono font-medium text-emerald-400 tracking-widest uppercase">TAKE PROFITS ATINGIDOS</h2>
                </div>
                <p data-key="tp_appear_here" class="text-[11px] font-mono text-emerald-500/60 tracking-wide">Take Profits aparecer√£o aqui quando atingidos</p>
            </div>
            <div id="tp-history-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="glass-panel rounded-xl p-6 flex items-center justify-center border border-emerald-500/20 min-h-[200px]">
                    <span data-key="no_tp_24h" class="text-xs text-emerald-500/50 font-mono">Nenhum TP registrado nas √∫ltimas 24h</span>
                </div>
            </div>
        </div>

        <!-- SL HISTORY SECTION (Hidden by default) -->
        <div id="sl-history-section" class="hidden mt-8">
            <div class="flex flex-col items-center mb-8">
                <div class="flex items-center gap-3 mb-1">
                    <span class="text-2xl">‚ùå</span>
                    <h2 data-key="sl_history_title" class="text-lg font-mono font-medium text-rose-400 tracking-widest uppercase">STOP LOSSES ATINGIDOS</h2>
                </div>
                <p data-key="sl_appear_here" class="text-[11px] font-mono text-rose-500/60 tracking-wide">Stop Losses aparecer√£o aqui quando atingidos</p>
            </div>
            <div id="sl-history-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="glass-panel rounded-xl p-6 flex items-center justify-center border border-rose-500/20 min-h-[200px]">
                    <span data-key="no_sl_24h" class="text-xs text-rose-500/50 font-mono">Nenhum SL registrado nas √∫ltimas 24h</span>
                </div>
            </div>
        </div>

        <!-- MY TRADES SECTION (Hidden by default) -->
        <div id="my-trades-section" class="hidden mt-8">
            <div class="flex flex-col items-center mb-8">
                <div class="flex items-center gap-3 mb-1">
                    <span class="text-2xl">üìä</span>
                    <h2 data-key="my_trades_title" class="text-lg font-mono font-medium text-cyan-400 tracking-widest uppercase">MINHAS OPERA√á√ïES ATIVAS</h2>
                </div>
                <p data-key="no_trades_desc" class="text-[11px] font-mono text-cyan-500/60 tracking-wide">Clique em "Entrar na Opera√ß√£o" em qualquer oportunidade para acompanhar aqui</p>
            </div>
            <div id="my-trades-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="glass-panel rounded-xl p-6 flex items-center justify-center border border-cyan-500/20 min-h-[200px]">
                    <span data-key="no_trades" class="text-xs text-cyan-500/50 font-mono">Nenhuma opera√ß√£o ativa</span>
                </div>
            </div>
        </div>

        <!-- PROTOCOL WATCHLIST SECTION -->
        <div id="watchlist-section" class="mt-20 mb-8">
            <div class="flex flex-col items-center mb-8">
                <h2 data-key="sec_whitelist" class="text-lg font-mono font-medium text-white tracking-widest uppercase mb-1">PROTOCOLO WATCHLIST</h2>
                <p data-key="sub_whitelist" class="text-[11px] font-mono text-zinc-500 tracking-wide">Monitorando sinais de confirma√ß√£o</p>
            </div>

            <div id="watchlist-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Watchlist items will be rendered here -->
                <div class="watchlist-card p-4 rounded-xl flex items-center justify-center">
                    <span class="text-xs text-zinc-500 font-mono">Loading watchlist...</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // =====================================================
        // PERFORMANCE OPTIMIZATION SYSTEM
        // =====================================================
        
        // === DOM CACHE - Evita querySelector repetitivo ===
        window.DOMCache = {
            _cache: new Map(),
            _maxSize: 100,
            
            get(selector) {
                if (this._cache.has(selector)) {
                    return this._cache.get(selector);
                }
                const el = document.querySelector(selector);
                if (el && this._cache.size < this._maxSize) {
                    this._cache.set(selector, el);
                }
                return el;
            },
            
            getById(id) {
                const key = `#${id}`;
                if (this._cache.has(key)) {
                    return this._cache.get(key);
                }
                const el = document.getElementById(id);
                if (el && this._cache.size < this._maxSize) {
                    this._cache.set(key, el);
                }
                return el;
            },
            
            invalidate(selector) {
                if (selector) {
                    this._cache.delete(selector);
                } else {
                    this._cache.clear();
                }
            }
        };
        
        // === THROTTLE - Limita execu√ß√£o por intervalo ===
        window.throttle = function(fn, limit) {
            let inThrottle = false;
            let lastArgs = null;
            
            return function(...args) {
                if (!inThrottle) {
                    fn.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => {
                        inThrottle = false;
                        if (lastArgs) {
                            fn.apply(this, lastArgs);
                            lastArgs = null;
                        }
                    }, limit);
                } else {
                    lastArgs = args;
                }
            };
        };
        
        // === DEBOUNCE - Aguarda pausa antes de executar ===
        window.debounce = function(fn, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), delay);
            };
        };
        
        // === RAF BATCH - Agrupa updates de DOM em um frame ===
        window.RAFBatch = {
            _queue: [],
            _scheduled: false,
            
            add(fn) {
                this._queue.push(fn);
                if (!this._scheduled) {
                    this._scheduled = true;
                    requestAnimationFrame(() => this._flush());
                }
            },
            
            _flush() {
                const queue = this._queue;
                this._queue = [];
                this._scheduled = false;
                queue.forEach(fn => {
                    try { fn(); } catch (e) { console.warn('RAFBatch error:', e); }
                });
            }
        };
        
        // === MEMORY MANAGER - Previne memory leaks ===
        window.MemoryManager = {
            _intervals: [],
            _timeouts: [],
            _listeners: [],
            
            setInterval(fn, ms) {
                const id = setInterval(fn, ms);
                this._intervals.push(id);
                return id;
            },
            
            setTimeout(fn, ms) {
                const id = setTimeout(() => {
                    fn();
                    this._timeouts = this._timeouts.filter(t => t !== id);
                }, ms);
                this._timeouts.push(id);
                return id;
            },
            
            addListener(el, event, fn, options) {
                if (!el) return;
                el.addEventListener(event, fn, options);
                this._listeners.push({ el, event, fn, options });
            },
            
            cleanup() {
                this._intervals.forEach(clearInterval);
                this._timeouts.forEach(clearTimeout);
                this._listeners.forEach(({ el, event, fn, options }) => {
                    el?.removeEventListener(event, fn, options);
                });
                this._intervals = [];
                this._timeouts = [];
                this._listeners = [];
                window.DOMCache.invalidate();
            }
        };
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => window.MemoryManager.cleanup());
        
        // === LAZY COMPONENT LOADER ===
        window.LazyLoader = {
            _loaded: new Set(),
            
            async loadWhenVisible(selector, loader) {
                if (this._loaded.has(selector)) return;
                
                const el = document.querySelector(selector);
                if (!el) return;
                
                const observer = new IntersectionObserver(async (entries) => {
                    if (entries[0].isIntersecting) {
                        observer.disconnect();
                        this._loaded.add(selector);
                        await loader();
                    }
                }, { threshold: 0.1 });
                
                observer.observe(el);
            }
        };
        
        // === PERFORMANCE METRICS ===
        window.PerfMetrics = {
            _marks: {},
            
            start(name) {
                this._marks[name] = performance.now();
            },
            
            end(name) {
                if (!this._marks[name]) return 0;
                const duration = performance.now() - this._marks[name];
                delete this._marks[name];
                if (duration > 100) {
                    console.warn(`‚ö†Ô∏è Slow operation: ${name} took ${duration.toFixed(1)}ms`);
                }
                return duration;
            }
        };
        
        console.log('‚ö° Performance optimizations loaded');

        // === GLOBAL ERROR HANDLER ===
        // Suppress non-critical errors and warnings
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const msg = args[0]?.toString?.() || '';
            // Suppress specific non-critical warnings
            if (msg.includes('defineLocaleLocale') ||
                msg.includes('labelTtack') ||
                msg.includes('labelLtack') ||
                msg.includes('WebSocket')) {
                return; // Silent
            }
            originalWarn.apply(console, args);
        };
        
        const originalError = console.error;
        console.error = function(...args) {
            const msg = args[0]?.toString?.() || '';
            // Suppress TradingView internal errors
            if (msg.includes('labelLtack') || 
                msg.includes('labelTtack') ||
                (msg.includes('Cannot set property') && msg.includes('which has only a getter'))) {
                return; // Silent
            }
            originalError.apply(console, args);
        };

        // Suppress WebSocket and TradingView errors
        window.addEventListener('error', (e) => {
            if (e.message?.includes('WebSocket') || 
                e.message?.includes('Ping received') ||
                e.message?.includes('Failed to fetch') ||
                e.message?.includes('labelLtack') ||
                e.message?.includes('labelTtack') ||
                (e.message?.includes('Cannot set property') && e.message?.includes('which has only a getter'))) {
                e.preventDefault();
                return false;
            }
        }, true);

        // GLOBAL formatPrice function - MUST be defined early for WebSocket handlers
        window.formatPrice = function(price) {
            if (!price || isNaN(price)) return '--';
            const num = parseFloat(price);
            if (num >= 1000) return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (num >= 1) return num.toFixed(2);
            if (num >= 0.01) return num.toFixed(4);
            return num.toFixed(6);
        };
        
        // GLOBAL formatTimestamp function - formats timestamps for Timeline
        window.formatTimestamp = function(timestamp) {
            if (!timestamp) return '--';
            
            let date;
            if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else if (typeof timestamp === 'number') {
                // Handle both milliseconds and seconds
                date = new Date(timestamp > 9999999999 ? timestamp : timestamp * 1000);
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                return '--';
            }
            
            if (isNaN(date.getTime())) return '--';
            
            // Format: DD/MM HH:mm
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day}/${month} ${hours}:${minutes}`;
        };

        // Background Video Logic (aguarda HLS carregar)
        function initBackgroundVideo() {
            const video = document.getElementById('bg-video');
            if (!video) return;
            
            const videoSrc = 'https://customer-cbeadsgr09pnsezs.cloudflarestream.com/b17f76a1270818e8cdc55e8719b9ace8/manifest/video.m3u8';

            if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                const hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => {}));
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc;
                video.addEventListener('loadedmetadata', () => video.play());
            }
        }
        
        // Aguarda HLS carregar (defer) ou executa imediatamente se j√° dispon√≠vel
        if (typeof Hls !== 'undefined') {
            initBackgroundVideo();
        } else {
            window.addEventListener('load', initBackgroundVideo);
        }

        // --- LANGUAGE SELECTOR DROPDOWN ---
        window.copyBennyCA = function() {
            const ca = '0x13Bab38Dc7eBEB07424f9fCbA5F0701547Bf4444';
            const button = document.getElementById('copy-benny-ca');
            const originalText = button ? button.textContent : '';
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(ca).catch(() => {});
            }
            if (button) {
                button.textContent = 'Copied';
                setTimeout(() => { button.textContent = originalText || 'Copy'; }, 1200);
            }
        };

        function toggleLanguageMenu() {
            const dropdown = document.getElementById('lang-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }
        
        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            const container = document.getElementById('lang-selector-container');
            const dropdown = document.getElementById('lang-dropdown');
            if (container && dropdown && !container.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // --- TRANSLATION LOGIC ---
        let currentLanguage = 'en';
        const translations = {
            'en': {
                // Header & System
                'sys_op': 'System Operational',
                'live_data': 'Live Data',
                'updating': 'Updating...',
                'buy_benny': 'Buy BENNY',
                'trial_access': 'Trial Access',
                'access_info': '7-day free trial. Access stays active while your wallet holds BENNY.',
                'benny_analysis': 'BENNY Analysis',
                'benny_ca_label': 'CA',
                'copy': 'Copy',
                'benny_chart_title': 'BENNY Live Chart',
                'view_on_dex': 'View on DexScreener',
                
                // Navigation
                'nav_dashboard': 'Dashboard',
                'nav_buy_benny': 'Buy the BENNY',
                'nav_admin': 'Admin',
                
                // Stats
                'stat_active': 'Active Signals',
                'stat_bullish': 'Bullish Bias',
                'stat_bearish': 'Bearish Bias',
                'stat_watchlist': 'Watchlist',
                
                // Sections
                'sec_confirmed': 'CONFIRMED OPPORTUNITIES',
                'sec_bullish': 'BULLISH OPPORTUNITIES',
                'sec_bearish': 'BEARISH OPPORTUNITIES',
                'sec_watchlist_filtered': 'WATCHLIST',
                'sec_whitelist': 'PROTOCOL WATCHLIST',
                'sub_whitelist': 'Monitoring confirmation signals',
                
                // Cards
                'card_zone': 'Tech Zone',
                'card_invalid': 'Invalidation',
                'card_rsi': 'RSI',
                'card_conf': 'Confidence',
                'card_targets': 'Targets',
                'card_entry': 'Entry',
                'card_signal': 'Signal:',
                
                // Badges
                'badge_short': 'SHORT',
                'badge_long': 'LONG',
                'badge_bearish': 'BEARISH',
                'badge_bullish': 'BULLISH',
                'long': 'LONG',
                'short': 'SHORT',
                
                // Warnings
                'warn_volatility': 'HIGH VOLATILITY',
                'warn_conflict': 'Timeframe Conflict',
                'warn_approach': 'Approaching',
                'warn_title': 'Warning: Timeframes in opposite directions',
                'warn_text': 'Smaller and larger timeframes point in opposite directions. Both are correct according to the methodology. Warning created only to give more context to your decision.',
                
                // Zones
                'zone_sell': 'Sell Zone',
                'zone_buy': 'Buy Zone',
                
                // Progress
                'prog_filled': 'Filled',
                
                // Status
                'monitoring_badge': 'Monitoring',
                'standby_badge': 'Standby',
                'no_opps': 'No confirmed opportunities at the moment',
                'monitoring': 'Monitoring 100+ assets...',
                'loading': 'Loading opportunities...',
                'loading_analysis': 'Loading analysis...',
                'waiting_selection': 'Waiting for asset selection...',
                'waiting_data': 'Waiting for data...',
                
                // Technical
                'setup': 'Setup',
                'confluence': 'Confluence',
                'fibo': 'Fibo',
                'trend_up': 'BULLISH',
                'trend_down': 'BEARISH',
                'analysis': 'Analysis',
                
                // Overlay Card
                'overlay_levels': 'CHART LEVELS',
                'overlay_entry': 'Entry Zone',
                'overlay_pm': 'PM (Average Price)',
                'overlay_scaled_orders': 'Scaled Orders (10x)',
                'overlay_show': 'SHOW',
                'overlay_hide': 'HIDE',
                'overlay_current': 'Current',
                'overlay_rr': 'R:R (TP1)',
                'overlay_stoploss': 'Stop Loss',
                
                // Sidebar Modal
                'sidebar_tech_data': 'Technical Data',
                'sidebar_trend': 'Target Trend',
                'sidebar_tf_signal': 'Timeframe (signal)',
                'sidebar_tf_target': 'Target Timeframe',
                'sidebar_fibo_382': 'Fibo 0.382',
                'sidebar_fibo_5': 'Fibo 0.5',
                'sidebar_fibo_618': 'Fibo 0.618',
                'sidebar_conf_title': 'Thermometer Confluences',
                'sidebar_conf_positive': 'Positive Confluences',
                'sidebar_conf_negative': 'Negative Confluences',
                'sidebar_conf_score': 'Confidence Score',
                
                // MTF Setups
                'setup_fundo_ascendente': 'Ascending Bottom',
                'setup_topo_ascendente': 'Ascending Top',
                'setup_topo_descendente': 'Descending Top',
                'setup_fundo_descendente': 'Descending Bottom',
                
                // Trading Profiles
                'profile_scalping': 'Scalping',
                'profile_day_trading': 'Day Trading',
                'profile_swing_trade': 'Swing Trade',
                
                // Trend Directions
                'trend_bullish': 'Bullish Trend',
                'trend_bearish': 'Bearish Trend',
                'searching_for': 'looking for',
                
                // Price Zones
                'premium_zone': 'Premium Zone',
                'discount_zone': 'Discount Zone',
                'above_ema200': 'Above EMA 200',
                'below_ema200': 'Below EMA 200',
                
                // Advanced Data (New)
                'sidebar_advanced_title': 'Advanced Data',
                'sidebar_fib_zone': 'Fibonacci Zone',
                'sidebar_structure': 'Structure (AlphaDesk)',
                'sidebar_ls_ratio': 'Long/Short Ratio',
                'sidebar_funding': 'Funding Rate',
                'sidebar_oi': 'Open Interest 24h',
                'fib_premium': 'Premium',
                'fib_discount': 'Discount',
                'fib_ote': 'OTE',
                'fib_equilibrium': 'Equilibrium',
                'structure_bullish': 'Bullish',
                'structure_bearish': 'Bearish',
                'structure_neutral': 'Neutral',
                'spot_only': 'Spot only',
                
                // Timeline
                'timeline_title': 'Trade Timeline',
                'timeline_signal': 'Signal Created',
                'timeline_zone': 'Entry Zone Hit',
                'timeline_tp1': 'TP1 Hit',
                'timeline_tp2': 'TP2 Hit',
                'timeline_tp3': 'TP3 Hit',
                'timeline_sl': 'Stop Loss Hit',
                
                // History Tabs
                'tab_tp_history': 'TP Hit (24h)',
                'tab_sl_history': 'SL Hit (24h)',
                'tp_history_title': 'TAKE PROFITS HIT',
                'sl_history_title': 'STOP LOSSES HIT',
                'no_tp_24h': 'No TP recorded in the last 24h',
                'no_sl_24h': 'No SL recorded in the last 24h',
                'tp_appear_here': 'Take Profits will appear here when hit',
                'sl_appear_here': 'Stop Losses will appear here when hit',
                
                // History Cards
                'hist_target': 'Target',
                'hist_timeframe': 'Timeframe',
                'hist_signal_time': 'Signal',
                'hist_hit_time': 'Hit',
                'hist_time_ago': 'Time',
                'hist_stop': 'Stop',
                'hist_hit_price': 'Hit Price',
                'trade_success': 'Trade completed successfully',
                'trade_invalidated': 'Trade invalidated',
                
                // Status Messages
                'stop_hit_msg': 'STOP ALREADY HIT',
                'tp_hit_msg': 'ALREADY HIT',
                'stop_hit_notification': 'STOP HIT',
                'target_hit_notification': 'TARGET HIT',
                
                // My Trades
                'tab_my_trades': 'My Trades',
                'tab_my_trades_desc': 'Track your active trades',
                'trades_active': 'active',
                'my_trades_title': 'MY ACTIVE TRADES',
                'btn_enter_trade': 'Enter Trade',
                'btn_exit_trade': 'Exit Trade',
                'btn_in_trade': 'In Trade ‚úì',
                'trade_entry_price': 'Entry Price',
                'trade_current_pnl': 'Current P&L',
                'trade_entered_at': 'Entered',
                'no_trades': 'No active trades',
                'no_trades_desc': 'Click "Enter Trade" on any opportunity to track it here',
                'confirm_exit': 'Exit this trade?',
                'trade_closed': 'Trade closed',
                
                // Search
                'search_placeholder': 'Search asset... (e.g., BTC, ETH, SOL)',
                'search_results_found': 'results found for',
                'clear_search': 'Clear search',
                'no_search_results': 'No assets found matching your search'
            },
            'pt': {
                // Header & System
                'sys_op': 'Sistema Operacional',
                'live_data': 'Dados ao Vivo',
                'updating': 'Atualizando...',
                'buy_benny': 'Comprar BENNY',
                'access_info': 'Teste gr√°tis de 7 dias. O acesso permanece enquanto sua carteira tiver BENNY.',
                'benny_analysis': 'An√°lise BENNY',
                'benny_ca_label': 'CA',
                'copy': 'Copiar',
                'benny_chart_title': 'Gr√°fico BENNY ao Vivo',
                'view_on_dex': 'Ver no DexScreener',
                
                // Navigation
                'nav_dashboard': 'Painel',
                'nav_buy_benny': 'Comprar o BENNY',
                'nav_admin': 'Admin',
                
                // Stats
                'stat_active': 'Sinais Ativos',
                'stat_bullish': 'Vi√©s de Alta',
                'stat_bearish': 'Vi√©s de Baixa',
                'stat_watchlist': 'Lista de Obs.',
                
                // Sections
                'sec_confirmed': 'OPORTUNIDADES CONFIRMADAS',
                'sec_bullish': 'OPORTUNIDADES DE ALTA',
                'sec_bearish': 'OPORTUNIDADES DE BAIXA',
                'sec_watchlist_filtered': 'LISTA DE OBSERVA√á√ÉO',
                'sec_whitelist': 'PROTOCOLO WATCHLIST',
                'sub_whitelist': 'Monitorando sinais de confirma√ß√£o',
                
                // Cards
                'card_zone': 'Zona T√©cnica',
                'card_invalid': 'Invalida√ß√£o',
                'card_rsi': 'IFR',
                'card_conf': 'Confian√ßa',
                'card_targets': 'Alvos',
                'card_entry': 'Entrada',
                'card_signal': 'Sinal:',
                
                // Badges
                'badge_short': 'BAIXA',
                'badge_long': 'ALTA',
                'badge_bearish': 'BAIXA',
                'badge_bullish': 'ALTA',
                'long': 'ALTA',
                'short': 'BAIXA',
                
                // Warnings
                'warn_volatility': 'ALTA VOLATILIDADE',
                'warn_conflict': 'Conflito de Tempo',
                'warn_approach': 'Aproximando',
                'warn_title': 'Aten√ß√£o: Timeframes em dire√ß√µes opostas',
                'warn_text': 'Timeframes menores e maiores apontam dire√ß√µes opostas. Ambos est√£o corretos conforme a metodologia. Aviso criado apenas para dar mais contexto √† sua decis√£o.',
                
                // Zones
                'zone_sell': 'Zona de Venda',
                'zone_buy': 'Zona de Compra',
                
                // Progress
                'prog_filled': 'Preenchido',
                
                // Status
                'monitoring_badge': 'Monitorando',
                'standby_badge': 'Aguardando',
                'no_opps': 'Nenhuma oportunidade confirmada no momento',
                'monitoring': 'Monitorando 100+ ativos...',
                'loading': 'Carregando oportunidades...',
                'loading_analysis': 'Carregando an√°lise...',
                'waiting_selection': 'Aguardando sele√ß√£o de ativo...',
                'waiting_data': 'Aguardando dados...',
                
                // Technical
                'setup': 'Setup',
                'confluence': 'Conflu√™ncia',
                'fibo': 'Fibo',
                'trend_up': 'ALTA',
                'trend_down': 'BAIXA',
                'analysis': 'An√°lise',
                
                // Overlay Card
                'overlay_levels': 'N√çVEIS DO GR√ÅFICO',
                'overlay_entry': 'Zona de Entrada',
                'overlay_pm': 'PM (Pre√ßo M√©dio)',
                'overlay_scaled_orders': 'Ordens Escalonadas (10x)',
                'overlay_show': 'MOSTRAR',
                'overlay_hide': 'OCULTAR',
                'overlay_current': 'Atual',
                'overlay_rr': 'R:R (TP1)',
                'overlay_stoploss': 'Stop Loss',
                
                // Sidebar Modal
                'sidebar_tech_data': 'Dados T√©cnicos',
                'sidebar_trend': 'Tend√™ncia do Alvo',
                'sidebar_tf_signal': 'Timeframe (sinal)',
                'sidebar_tf_target': 'Timeframe Alvo',
                'sidebar_fibo_382': 'Fibo 0.382',
                'sidebar_fibo_5': 'Fibo 0.5',
                'sidebar_fibo_618': 'Fibo 0.618',
                'sidebar_conf_title': 'Conflu√™ncias do Term√¥metro',
                'sidebar_conf_positive': 'Conflu√™ncias Positivas',
                'sidebar_conf_negative': 'Conflu√™ncias Negativas',
                'sidebar_conf_score': '√çndice de Confian√ßa',
                
                // MTF Setups
                'setup_fundo_ascendente': 'Fundo Ascendente',
                'setup_topo_ascendente': 'Topo Ascendente',
                'setup_topo_descendente': 'Topo Descendente',
                'setup_fundo_descendente': 'Fundo Descendente',
                
                // Trading Profiles
                'profile_scalping': 'Scalping',
                'profile_day_trading': 'Day Trading',
                'profile_swing_trade': 'Swing Trade',
                
                // Trend Directions
                'trend_bullish': 'Tend√™ncia de Alta',
                'trend_bearish': 'Tend√™ncia de Baixa',
                'searching_for': 'buscando',
                
                // Price Zones
                'premium_zone': 'Zona Premium',
                'discount_zone': 'Zona de Desconto',
                'above_ema200': 'Acima da EMA 200',
                'below_ema200': 'Abaixo da EMA 200',
                
                // Advanced Data (New)
                'sidebar_advanced_title': 'Dados Avan√ßados',
                'sidebar_fib_zone': 'Zona Fibonacci',
                'sidebar_structure': 'Estrutura (AlphaDesk)',
                'sidebar_ls_ratio': 'Long/Short Ratio',
                'sidebar_funding': 'Taxa de Funding',
                'sidebar_oi': 'Open Interest 24h',
                'fib_premium': 'Pr√™mio',
                'fib_discount': 'Desconto',
                'fib_ote': 'OTE',
                'fib_equilibrium': 'Equil√≠brio',
                'structure_bullish': 'Alta',
                'structure_bearish': 'Baixa',
                'structure_neutral': 'Neutro',
                'spot_only': 'Apenas Spot',
                
                // Timeline
                'timeline_title': 'Timeline do Trade',
                'timeline_signal': 'Sinal Criado',
                'timeline_zone': 'Entrou na Zona',
                'timeline_tp1': 'TP1 Atingido',
                'timeline_tp2': 'TP2 Atingido',
                'timeline_tp3': 'TP3 Atingido',
                'timeline_sl': 'Stop Loss Atingido',
                
                // History Tabs
                'tab_tp_history': 'TP Hit (24h)',
                'tab_sl_history': 'SL Hit (24h)',
                'tp_history_title': 'TAKE PROFITS ATINGIDOS',
                'sl_history_title': 'STOP LOSSES ATINGIDOS',
                'no_tp_24h': 'Nenhum TP registrado nas √∫ltimas 24h',
                'no_sl_24h': 'Nenhum SL registrado nas √∫ltimas 24h',
                'tp_appear_here': 'Take Profits aparecer√£o aqui quando atingidos',
                'sl_appear_here': 'Stop Losses aparecer√£o aqui quando atingidos',
                
                // History Cards
                'hist_target': 'Alvo',
                'hist_timeframe': 'Timeframe',
                'hist_signal_time': 'Sinal',
                'hist_hit_time': 'Hit',
                'hist_time_ago': 'Tempo',
                'hist_stop': 'Stop',
                'hist_hit_price': 'Pre√ßo hit',
                'trade_success': 'Trade conclu√≠do com sucesso',
                'trade_invalidated': 'Opera√ß√£o invalidada',
                
                // Status Messages
                'stop_hit_msg': 'STOP J√Å ATINGIDO',
                'tp_hit_msg': 'J√Å ATINGIDO',
                'stop_hit_notification': 'STOP ATINGIDO',
                'target_hit_notification': 'ALVO ATINGIDO',
                
                // My Trades
                'tab_my_trades': 'Minhas Opera√ß√µes',
                'tab_my_trades_desc': 'Acompanhe seus trades ativos',
                'trades_active': 'ativos',
                'my_trades_title': 'MINHAS OPERA√á√ïES ATIVAS',
                'btn_enter_trade': 'Entrar na Opera√ß√£o',
                'btn_exit_trade': 'Sair da Opera√ß√£o',
                'btn_in_trade': 'Em Opera√ß√£o ‚úì',
                'trade_entry_price': 'Pre√ßo de Entrada',
                'trade_current_pnl': 'P&L Atual',
                'trade_entered_at': 'Entrou em',
                'no_trades': 'Nenhuma opera√ß√£o ativa',
                'no_trades_desc': 'Clique em "Entrar na Opera√ß√£o" em qualquer oportunidade para acompanhar aqui',
                'confirm_exit': 'Sair desta opera√ß√£o?',
                'trade_closed': 'Opera√ß√£o encerrada',
                
                // Search
                'search_placeholder': 'Buscar ativo... (ex: BTC, ETH, SOL)',
                'search_results_found': 'resultados encontrados para',
                'clear_search': 'Limpar busca',
                'no_search_results': 'Nenhum ativo encontrado para sua busca'
            },
            
            // =====================================================
            // ESPA√ëOL (ES)
            // =====================================================
            'es': {
                // Header & System
                'sys_op': 'Sistema Operativo',
                'live_data': 'Datos en Vivo',
                'updating': 'Actualizando...',
                'buy_benny': 'Comprar BENNY',
                'access_info': 'Prueba gratis de 7 d√≠as. El acceso permanece mientras tu billetera tenga BENNY.',
                'benny_analysis': 'An√°lisis BENNY',
                'benny_ca_label': 'CA',
                'copy': 'Copiar',
                'benny_chart_title': 'Gr√°fico BENNY en Vivo',
                'view_on_dex': 'Ver en DexScreener',
                
                // Navigation
                'nav_dashboard': 'Panel',
                'nav_buy_benny': 'Comprar el BENNY',
                'nav_admin': 'Admin',
                
                // Stats
                'stat_active': 'Se√±ales Activas',
                'stat_bullish': 'Sesgo Alcista',
                'stat_bearish': 'Sesgo Bajista',
                'stat_watchlist': 'Lista de Seguimiento',
                
                // Sections
                'sec_confirmed': 'OPORTUNIDADES CONFIRMADAS',
                'sec_bullish': 'OPORTUNIDADES ALCISTAS',
                'sec_bearish': 'OPORTUNIDADES BAJISTAS',
                'sec_watchlist_filtered': 'LISTA DE SEGUIMIENTO',
                'sec_whitelist': 'PROTOCOLO WATCHLIST',
                'sub_whitelist': 'Monitoreando se√±ales de confirmaci√≥n',
                
                // Cards
                'card_zone': 'Zona T√©cnica',
                'card_invalid': 'Invalidaci√≥n',
                'card_rsi': 'RSI',
                'card_conf': 'Confianza',
                'card_targets': 'Objetivos',
                'card_entry': 'Entrada',
                'card_signal': 'Se√±al:',
                
                // Badges
                'badge_short': 'CORTO',
                'badge_long': 'LARGO',
                'badge_bearish': 'BAJISTA',
                'badge_bullish': 'ALCISTA',
                'long': 'LARGO',
                'short': 'CORTO',
                
                // Warnings
                'warn_volatility': 'ALTA VOLATILIDAD',
                'warn_conflict': 'Conflicto Timeframe',
                'warn_approach': 'Acerc√°ndose',
                'warn_title': 'Atenci√≥n: Timeframes en direcciones opuestas',
                'warn_text': 'Los timeframes menores y mayores apuntan en direcciones opuestas. Ambos son correctos seg√∫n la metodolog√≠a.',
                
                // Zones
                'zone_sell': 'Zona de Venta',
                'zone_buy': 'Zona de Compra',
                
                // Progress
                'prog_filled': 'Ejecutado',
                
                // Status
                'monitoring_badge': 'Monitoreando',
                'standby_badge': 'En Espera',
                'no_opps': 'Sin oportunidades confirmadas en este momento',
                'monitoring': 'Monitoreando 100+ activos...',
                'loading': 'Cargando oportunidades...',
                'loading_analysis': 'Cargando an√°lisis...',
                'waiting_selection': 'Esperando selecci√≥n de activo...',
                'waiting_data': 'Esperando datos...',
                
                // Technical
                'setup': 'Configuraci√≥n',
                'confluence': 'Confluencia',
                'fibo': 'Fibo',
                'trend_up': 'ALCISTA',
                'trend_down': 'BAJISTA',
                'analysis': 'An√°lisis',
                
                // Overlay Card
                'overlay_levels': 'NIVELES DEL GR√ÅFICO',
                'overlay_entry': 'Zona de Entrada',
                'overlay_pm': 'PM (Precio Medio)',
                'overlay_scaled_orders': '√ìrdenes Escalonadas (10x)',
                'overlay_show': 'MOSTRAR',
                'overlay_hide': 'OCULTAR',
                'overlay_current': 'Actual',
                'overlay_rr': 'R:R (TP1)',
                'overlay_stoploss': 'Stop Loss',
                
                // Sidebar
                'sidebar_tech_data': 'Datos T√©cnicos',
                'sidebar_trend': 'Tendencia Objetivo',
                'sidebar_tf_signal': 'Timeframe (se√±al)',
                'sidebar_tf_target': 'Timeframe Objetivo',
                'sidebar_fibo_382': 'Fibo 0.382',
                'sidebar_fibo_5': 'Fibo 0.5',
                'sidebar_fibo_618': 'Fibo 0.618',
                'sidebar_conf_title': 'Confluencias del Term√≥metro',
                'sidebar_conf_positive': 'Confluencias Positivas',
                'sidebar_conf_negative': 'Confluencias Negativas',
                'sidebar_conf_score': 'Puntuaci√≥n de Confianza',
                'sidebar_advanced_title': 'Datos Avanzados',
                'sidebar_fib_zone': 'Zona Fibonacci',
                'sidebar_structure': 'Estructura (AlphaDesk)',
                'sidebar_ls_ratio': 'Ratio Long/Short',
                'sidebar_funding': 'Tasa de Funding',
                'sidebar_oi': 'Open Interest 24h',
                
                // Timeline
                'timeline_title': 'L√≠nea de Tiempo',
                'timeline_signal': 'Se√±al Creada',
                'timeline_zone': 'Entr√≥ en Zona',
                'timeline_tp1': 'TP1 Alcanzado',
                'timeline_tp2': 'TP2 Alcanzado',
                'timeline_tp3': 'TP3 Alcanzado',
                'timeline_sl': 'Stop Loss Alcanzado',
                
                // History Tabs
                'tab_tp_history': 'Historial TP',
                'tab_sl_history': 'Historial SL',
                'tp_history_title': 'TAKE PROFITS ALCANZADOS',
                'tp_appear_here': 'Los Take Profits aparecer√°n aqu√≠',
                'no_tp_24h': 'Ning√∫n TP en las √∫ltimas 24h',
                'sl_history_title': 'STOP LOSSES ALCANZADOS',
                'sl_appear_here': 'Los Stop Losses aparecer√°n aqu√≠',
                'no_sl_24h': 'Ning√∫n SL en las √∫ltimas 24h',
                
                // My Trades
                'tab_my_trades': 'Mis Operaciones',
                'tab_my_trades_desc': 'Sigue tus trades activos',
                'trades_active': 'activos',
                'my_trades_title': 'MIS OPERACIONES ACTIVAS',
                'btn_enter_trade': 'Entrar en Operaci√≥n',
                'btn_exit_trade': 'Salir de Operaci√≥n',
                'btn_in_trade': 'En Operaci√≥n ‚úì',
                'no_trades': 'Sin operaciones activas',
                'no_trades_desc': 'Haz clic en "Entrar en Operaci√≥n" en cualquier oportunidad',
                'confirm_exit': '¬øSalir de esta operaci√≥n?',
                'trade_closed': 'Operaci√≥n cerrada'
            },
            
            // =====================================================
            // ‰∏≠Êñá (ZH - Chinese)
            // =====================================================
            'zh': {
                // Header & System
                'sys_op': 'Á≥ªÁªüËøêË°å‰∏≠',
                'live_data': 'ÂÆûÊó∂Êï∞ÊçÆ',
                'updating': 'Êõ¥Êñ∞‰∏≠...',
                'buy_benny': 'Ë¥≠‰π∞ BENNY',
                'trial_access': 'ËØïÁî®ËÆøÈóÆ',
                'access_info': '7 Â§©ÂÖçË¥πËØïÁî®„ÄÇÈí±ÂåÖÊåÅÊúâ BENNY Âç≥ÂèØ‰øùÊåÅËÆøÈóÆ„ÄÇ',
                'benny_analysis': 'BENNY ÂàÜÊûê',
                'benny_ca_label': 'CA',
                'copy': 'Â§çÂà∂',
                'benny_chart_title': 'BENNY ÂÆûÊó∂ÂõæË°®',
                'view_on_dex': 'Âú® DexScreener Êü•Áúã',
                
                // Navigation
                'nav_dashboard': '‰ª™Ë°®Êùø',
                'nav_admin': 'ÁÆ°ÁêÜ',
                
                // Stats
                'stat_active': 'Ê¥ªË∑É‰ø°Âè∑',
                'stat_bullish': 'ÁúãÊ∂®Ë∂ãÂäø',
                'stat_bearish': 'ÁúãË∑åË∂ãÂäø',
                'stat_watchlist': 'ËßÇÂØüÂàóË°®',
                
                // Sections
                'sec_confirmed': 'Â∑≤Á°ÆËÆ§Êú∫‰ºö',
                'sec_bullish': 'ÁúãÊ∂®Êú∫‰ºö',
                'sec_bearish': 'ÁúãË∑åÊú∫‰ºö',
                'sec_watchlist_filtered': 'ËßÇÂØüÂàóË°®',
                'sec_whitelist': 'ËßÇÂØüÂçèËÆÆ',
                'sub_whitelist': 'ÁõëÊéßÁ°ÆËÆ§‰ø°Âè∑',
                
                // Cards
                'card_zone': 'ÊäÄÊúØÂå∫Âüü',
                'card_invalid': 'Êó†ÊïàÂåñ',
                'card_rsi': 'RSI',
                'card_conf': 'ÁΩÆ‰ø°Â∫¶',
                'card_targets': 'ÁõÆÊ†á',
                'card_entry': 'ÂÖ•Âú∫',
                'card_signal': '‰ø°Âè∑:',
                
                // Badges
                'badge_short': 'ÂÅöÁ©∫',
                'badge_long': 'ÂÅöÂ§ö',
                'badge_bearish': 'ÁúãË∑å',
                'badge_bullish': 'ÁúãÊ∂®',
                'long': 'ÂÅöÂ§ö',
                'short': 'ÂÅöÁ©∫',
                
                // Warnings
                'warn_volatility': 'È´òÊ≥¢Âä®',
                'warn_conflict': 'Êó∂Èó¥Ê°ÜÊû∂ÂÜ≤Á™Å',
                'warn_approach': 'Êé•Ëøë',
                'warn_title': 'Ê≥®ÊÑèÔºöÊó∂Èó¥Ê°ÜÊû∂ÊñπÂêëÁõ∏Âèç',
                'warn_text': 'ËæÉÂ∞èÂíåËæÉÂ§ßÁöÑÊó∂Èó¥Ê°ÜÊû∂ÊåáÂêëÁõ∏ÂèçÊñπÂêë„ÄÇÊ†πÊçÆÊñπÊ≥ïËÆ∫‰∏§ËÄÖÈÉΩÊ≠£Á°Æ„ÄÇ',
                
                // Zones
                'zone_sell': 'ÂçñÂá∫Âå∫',
                'zone_buy': '‰π∞ÂÖ•Âå∫',
                
                // Progress
                'prog_filled': 'Â∑≤Êàê‰∫§',
                
                // Status
                'monitoring_badge': 'ÁõëÊéß‰∏≠',
                'standby_badge': 'ÂæÖÂëΩ',
                'no_opps': 'ÂΩìÂâçÊó†Â∑≤Á°ÆËÆ§Êú∫‰ºö',
                'monitoring': 'ÁõëÊéß100+ËµÑ‰∫ß...',
                'loading': 'Âä†ËΩΩÊú∫‰ºö‰∏≠...',
                'loading_analysis': 'Âä†ËΩΩÂàÜÊûê‰∏≠...',
                'waiting_selection': 'Á≠âÂæÖËµÑ‰∫ßÈÄâÊã©...',
                'waiting_data': 'Á≠âÂæÖÊï∞ÊçÆ...',
                
                // Technical
                'setup': 'ËÆæÁΩÆ',
                'confluence': 'Ê±áÊµÅ',
                'fibo': 'ÊñêÊ≥¢ÈÇ£Â•ë',
                'trend_up': 'ÁúãÊ∂®',
                'trend_down': 'ÁúãË∑å',
                'analysis': 'ÂàÜÊûê',
                
                // Overlay Card
                'overlay_levels': 'ÂõæË°®Á∫ßÂà´',
                'overlay_entry': 'ÂÖ•Âú∫Âå∫Âüü',
                'overlay_pm': 'PM (Âπ≥Âùá‰ª∑Ê†º)',
                'overlay_scaled_orders': 'ÂàÜÊâπËÆ¢Âçï (10x)',
                'overlay_show': 'ÊòæÁ§∫',
                'overlay_hide': 'ÈöêËóè',
                'overlay_current': 'ÂΩìÂâç',
                'overlay_rr': 'R:R (TP1)',
                'overlay_stoploss': 'Ê≠¢Êçü',
                
                // Sidebar
                'sidebar_tech_data': 'ÊäÄÊúØÊï∞ÊçÆ',
                'sidebar_trend': 'ÁõÆÊ†áË∂ãÂäø',
                'sidebar_tf_signal': 'Êó∂Èó¥Ê°ÜÊû∂Ôºà‰ø°Âè∑Ôºâ',
                'sidebar_tf_target': 'ÁõÆÊ†áÊó∂Èó¥Ê°ÜÊû∂',
                'sidebar_fibo_382': 'Fibo 0.382',
                'sidebar_fibo_5': 'Fibo 0.5',
                'sidebar_fibo_618': 'Fibo 0.618',
                'sidebar_conf_title': 'Ê∏©Â∫¶ËÆ°Ê±áÊµÅ',
                'sidebar_conf_positive': 'Ê≠£ÂêëÊ±áÊµÅ',
                'sidebar_conf_negative': 'Ë¥üÂêëÊ±áÊµÅ',
                'sidebar_conf_score': 'ÁΩÆ‰ø°Â∫¶ÂæóÂàÜ',
                'sidebar_advanced_title': 'È´òÁ∫ßÊï∞ÊçÆ',
                'sidebar_fib_zone': 'ÊñêÊ≥¢ÈÇ£Â•ëÂå∫Âüü',
                'sidebar_structure': 'ÁªìÊûÑ (AlphaDesk)',
                'sidebar_ls_ratio': 'Â§öÁ©∫ÊØîÁéá',
                'sidebar_funding': 'ËµÑÈáëË¥πÁéá',
                'sidebar_oi': '24hÊú™Âπ≥‰ªìÈáè',
                
                // Timeline
                'timeline_title': '‰ø°Âè∑Êó∂Èó¥Á∫ø',
                'timeline_signal': '‰ø°Âè∑ÂàõÂª∫',
                'timeline_zone': 'ËøõÂÖ•Âå∫Âüü',
                'timeline_tp1': 'TP1ËææÊàê',
                'timeline_tp2': 'TP2ËææÊàê',
                'timeline_tp3': 'TP3ËææÊàê',
                'timeline_sl': 'Ê≠¢ÊçüËß¶Âèë',
                
                // History Tabs
                'tab_tp_history': 'TPÂéÜÂè≤',
                'tab_sl_history': 'SLÂéÜÂè≤',
                'tp_history_title': 'Â∑≤ËææÊàêÊ≠¢Áõà',
                'tp_appear_here': 'Ê≠¢ÁõàËææÊàêÂêéÊòæÁ§∫',
                'no_tp_24h': '24hÂÜÖÊó†TPËÆ∞ÂΩï',
                'sl_history_title': 'Â∑≤Ëß¶ÂèëÊ≠¢Êçü',
                'sl_appear_here': 'Ê≠¢ÊçüËß¶ÂèëÂêéÊòæÁ§∫',
                'no_sl_24h': '24hÂÜÖÊó†SLËÆ∞ÂΩï',
                
                // My Trades
                'tab_my_trades': 'ÊàëÁöÑ‰∫§Êòì',
                'tab_my_trades_desc': 'Ë∑üË∏™Ê¥ªË∑É‰∫§Êòì',
                'trades_active': 'Ê¥ªË∑É',
                'my_trades_title': 'ÊàëÁöÑÊ¥ªË∑É‰∫§Êòì',
                'btn_enter_trade': 'ËøõÂÖ•‰∫§Êòì',
                'btn_exit_trade': 'ÈÄÄÂá∫‰∫§Êòì',
                'btn_in_trade': '‰∫§Êòì‰∏≠ ‚úì',
                'no_trades': 'Êó†Ê¥ªË∑É‰∫§Êòì',
                'no_trades_desc': 'ÁÇπÂáª‰ªª‰ΩïÊú∫‰ºö‰∏äÁöÑ"ËøõÂÖ•‰∫§Êòì"Âú®Ê≠§Ë∑üË∏™',
                'confirm_exit': 'Á°ÆËÆ§ÈÄÄÂá∫Ê≠§‰∫§ÊòìÔºü',
                'trade_closed': '‰∫§ÊòìÂ∑≤ÂÖ≥Èó≠',
                
                // Analysis Context Translations (for sidebar)
                'setup_fundo_ascendente': '‰∏äÂçáÂ∫ïÈÉ®',
                'setup_topo_ascendente': '‰∏äÂçáÈ°∂ÈÉ®',
                'setup_topo_descendente': '‰∏ãÈôçÈ°∂ÈÉ®',
                'setup_fundo_descendente': '‰∏ãÈôçÂ∫ïÈÉ®',
                'trend_bullish': 'ÁúãÊ∂®',
                'trend_bearish': 'ÁúãË∑å',
                'analysis_scalping': 'Ë∂ÖÁü≠Á∫ø',
                'analysis_day_trading': 'Êó•ÂÜÖ‰∫§Êòì',
                'analysis_swing_trade': 'Ê≥¢ÊÆµ‰∫§Êòì',
                'analysis_position': 'ÈïøÁ∫ø‰∫§Êòì',
                'analysis_pullback': 'ÂõûË∞É',
                'analysis_continuation': 'Âª∂Áª≠',
                'analysis_confirmation': 'Á°ÆËÆ§',
                'analysis_invalidation': 'Â§±ÊïàÊù°‰ª∂',
                'analysis_fibonacci_discount': 'ÊäòÊâ£Âå∫',
                'analysis_fibonacci_premium': 'Ê∫¢‰ª∑Âå∫',
                'analysis_fibonacci_equilibrium': 'Âπ≥Ë°°Âå∫',
                'analysis_fibonacci_ote': 'ÊúÄ‰Ω≥ÂÖ•Âú∫Âå∫',
                'analysis_overbought': 'Ë∂Ö‰π∞',
                'analysis_oversold': 'Ë∂ÖÂçñ',
                'analysis_neutral': '‰∏≠ÊÄß',
                'analysis_buying_pressure': '‰π∞ÊñπÂäõÈáè',
                'analysis_selling_pressure': 'ÂçñÊñπÂäõÈáè',
                'analysis_wait_confirmation': 'Á≠âÂæÖÁ°ÆËÆ§',
                'analysis_support': 'ÊîØÊíë',
                'analysis_resistance': 'ÈòªÂäõ',
                'analysis_breakout': 'Á™ÅÁ†¥',
                'analysis_retest': 'ÂõûÊµã'
            },
            
            // =====================================================
            // –†–£–°–°–ö–ò–ô (RU - Russian)
            // =====================================================
            'ru': {
                // Header & System
                'sys_op': '–°–∏—Å—Ç–µ–º–∞ –†–∞–±–æ—Ç–∞–µ—Ç',
                'live_data': '–ñ–∏–≤—ã–µ –î–∞–Ω–Ω—ã–µ',
                'updating': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...',
                'buy_benny': '–ö—É–ø–∏—Ç—å BENNY',
                'access_info': '7-–¥–Ω–µ–≤–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –î–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ–∫–∞ –≤ –∫–æ—à–µ–ª—å–∫–µ –µ—Å—Ç—å BENNY.',
                'benny_analysis': '–ê–Ω–∞–ª–∏–∑ BENNY',
                'benny_ca_label': 'CA',
                'copy': '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
                'benny_chart_title': '–ì—Ä–∞—Ñ–∏–∫ BENNY –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏',
                'view_on_dex': '–°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ DexScreener',
                
                // Navigation
                'nav_dashboard': '–ü–∞–Ω–µ–ª—å',
                'nav_buy_benny': '–ö—É–ø–∏—Ç—å BENNY',
                'nav_admin': '–ê–¥–º–∏–Ω',
                
                // Stats
                'stat_active': '–ê–∫—Ç–∏–≤–Ω—ã–µ –°–∏–≥–Ω–∞–ª—ã',
                'stat_bullish': '–ë—ã—á–∏–π –£–∫–ª–æ–Ω',
                'stat_bearish': '–ú–µ–¥–≤–µ–∂–∏–π –£–∫–ª–æ–Ω',
                'stat_watchlist': '–°–ø–∏—Å–æ–∫ –ù–∞–±–ª—é–¥–µ–Ω–∏—è',
                
                // Sections
                'sec_confirmed': '–ü–û–î–¢–í–ï–†–ñ–î–Å–ù–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò',
                'sec_bullish': '–ë–´–ß–¨–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò',
                'sec_bearish': '–ú–ï–î–í–ï–ñ–¨–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò',
                'sec_watchlist_filtered': '–°–ü–ò–°–û–ö –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø',
                'sec_whitelist': '–ü–†–û–¢–û–ö–û–õ –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø',
                'sub_whitelist': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
                
                // Cards
                'card_zone': '–¢–µ—Ö. –ó–æ–Ω–∞',
                'card_invalid': '–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è',
                'card_rsi': 'RSI',
                'card_conf': '–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å',
                'card_targets': '–¶–µ–ª–∏',
                'card_entry': '–í—Ö–æ–¥',
                'card_signal': '–°–∏–≥–Ω–∞–ª:',
                
                // Badges
                'badge_short': '–®–û–†–¢',
                'badge_long': '–õ–û–ù–ì',
                'badge_bearish': '–ú–ï–î–í–ï–ñ–ò–ô',
                'badge_bullish': '–ë–´–ß–ò–ô',
                'long': '–õ–û–ù–ì',
                'short': '–®–û–†–¢',
                
                // Warnings
                'warn_volatility': '–í–´–°–û–ö–ê–Ø –í–û–õ–ê–¢–ò–õ–¨–ù–û–°–¢–¨',
                'warn_conflict': '–ö–æ–Ω—Ñ–ª–∏–∫—Ç –¢–∞–π–º—Ñ—Ä–µ–π–º–æ–≤',
                'warn_approach': '–ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è',
                'warn_title': '–í–Ω–∏–º–∞–Ω–∏–µ: –¢–∞–π–º—Ñ—Ä–µ–π–º—ã –≤ —Ä–∞–∑–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö',
                'warn_text': '–ú–ª–∞–¥—à–∏–µ –∏ —Å—Ç–∞—Ä—à–∏–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö. –û–±–∞ –≤–µ—Ä–Ω—ã –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.',
                
                // Zones
                'zone_sell': '–ó–æ–Ω–∞ –ü—Ä–æ–¥–∞–∂–∏',
                'zone_buy': '–ó–æ–Ω–∞ –ü–æ–∫—É–ø–∫–∏',
                
                // Progress
                'prog_filled': '–ò—Å–ø–æ–ª–Ω–µ–Ω–æ',
                
                // Status
                'monitoring_badge': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥',
                'standby_badge': '–û–∂–∏–¥–∞–Ω–∏–µ',
                'no_opps': '–ù–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π',
                'monitoring': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 100+ –∞–∫—Ç–∏–≤–æ–≤...',
                'loading': '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π...',
                'loading_analysis': '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...',
                'waiting_selection': '–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∞–∫—Ç–∏–≤–∞...',
                'waiting_data': '–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...',
                
                // Technical
                'setup': '–ù–∞—Å—Ç—Ä–æ–π–∫–∞',
                'confluence': '–ö–æ–Ω—Ñ–ª—é–µ–Ω—Ü–∏—è',
                'fibo': '–§–∏–±–æ',
                'trend_up': '–ë–´–ß–ò–ô',
                'trend_down': '–ú–ï–î–í–ï–ñ–ò–ô',
                'analysis': '–ê–Ω–∞–ª–∏–∑',
                
                // Overlay Card
                'overlay_levels': '–£–†–û–í–ù–ò –ì–†–ê–§–ò–ö–ê',
                'overlay_entry': '–ó–æ–Ω–∞ –í—Ö–æ–¥–∞',
                'overlay_pm': 'PM (–°—Ä–µ–¥–Ω—è—è –¶–µ–Ω–∞)',
                'overlay_scaled_orders': '–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –û—Ä–¥–µ—Ä–∞ (10x)',
                'overlay_show': '–ü–û–ö–ê–ó–ê–¢–¨',
                'overlay_hide': '–°–ö–†–´–¢–¨',
                'overlay_current': '–¢–µ–∫—É—â–∏–π',
                'overlay_rr': 'R:R (TP1)',
                'overlay_stoploss': '–°—Ç–æ–ø –õ–æ—Å—Å',
                
                // Sidebar
                'sidebar_tech_data': '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –î–∞–Ω–Ω—ã–µ',
                'sidebar_trend': '–¶–µ–ª–µ–≤–æ–π –¢—Ä–µ–Ω–¥',
                'sidebar_tf_signal': '–¢–∞–π–º—Ñ—Ä–µ–π–º (—Å–∏–≥–Ω–∞–ª)',
                'sidebar_tf_target': '–¶–µ–ª–µ–≤–æ–π –¢–∞–π–º—Ñ—Ä–µ–π–º',
                'sidebar_fibo_382': '–§–∏–±–æ 0.382',
                'sidebar_fibo_5': '–§–∏–±–æ 0.5',
                'sidebar_fibo_618': '–§–∏–±–æ 0.618',
                'sidebar_conf_title': '–ö–æ–Ω—Ñ–ª—é–µ–Ω—Ü–∏–∏ –¢–µ—Ä–º–æ–º–µ—Ç—Ä–∞',
                'sidebar_conf_positive': '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –ö–æ–Ω—Ñ–ª—é–µ–Ω—Ü–∏–∏',
                'sidebar_conf_negative': '–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ö–æ–Ω—Ñ–ª—é–µ–Ω—Ü–∏–∏',
                'sidebar_conf_score': '–û—Ü–µ–Ω–∫–∞ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏',
                'sidebar_advanced_title': '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –î–∞–Ω–Ω—ã–µ',
                'sidebar_fib_zone': '–ó–æ–Ω–∞ –§–∏–±–æ–Ω–∞—á—á–∏',
                'sidebar_structure': '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ (AlphaDesk)',
                'sidebar_ls_ratio': '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ Long/Short',
                'sidebar_funding': '–°—Ç–∞–≤–∫–∞ –§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è',
                'sidebar_oi': '–û—Ç–∫—Ä—ã—Ç—ã–π –ò–Ω—Ç–µ—Ä–µ—Å 24—á',
                
                // Timeline
                'timeline_title': '–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –°–∏–≥–Ω–∞–ª–∞',
                'timeline_signal': '–°–∏–≥–Ω–∞–ª –°–æ–∑–¥–∞–Ω',
                'timeline_zone': '–í–æ—à—ë–ª –≤ –ó–æ–Ω—É',
                'timeline_tp1': 'TP1 –î–æ—Å—Ç–∏–≥–Ω—É—Ç',
                'timeline_tp2': 'TP2 –î–æ—Å—Ç–∏–≥–Ω—É—Ç',
                'timeline_tp3': 'TP3 –î–æ—Å—Ç–∏–≥–Ω—É—Ç',
                'timeline_sl': '–°—Ç–æ–ø –õ–æ—Å—Å –î–æ—Å—Ç–∏–≥–Ω—É—Ç',
                
                // History Tabs
                'tab_tp_history': '–ò—Å—Ç–æ—Ä–∏—è TP',
                'tab_sl_history': '–ò—Å—Ç–æ—Ä–∏—è SL',
                'tp_history_title': '–î–û–°–¢–ò–ì–ù–£–¢–´–ï TAKE PROFITS',
                'tp_appear_here': 'Take Profits –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å',
                'no_tp_24h': '–ù–µ—Ç TP –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á',
                'sl_history_title': '–î–û–°–¢–ò–ì–ù–£–¢–´–ï STOP LOSSES',
                'sl_appear_here': 'Stop Losses –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å',
                'no_sl_24h': '–ù–µ—Ç SL –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á',
                
                // My Trades
                'tab_my_trades': '–ú–æ–∏ –°–¥–µ–ª–∫–∏',
                'tab_my_trades_desc': '–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏',
                'trades_active': '–∞–∫—Ç–∏–≤–Ω—ã—Ö',
                'my_trades_title': '–ú–û–ò –ê–ö–¢–ò–í–ù–´–ï –°–î–ï–õ–ö–ò',
                'btn_enter_trade': '–í–æ–π—Ç–∏ –≤ –°–¥–µ–ª–∫—É',
                'btn_exit_trade': '–í—ã–π—Ç–∏ –∏–∑ –°–¥–µ–ª–∫–∏',
                'btn_in_trade': '–í –°–¥–µ–ª–∫–µ ‚úì',
                'no_trades': '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫',
                'no_trades_desc': '–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ –≤ –°–¥–µ–ª–∫—É" –Ω–∞ –ª—é–±–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏',
                'confirm_exit': '–í—ã–π—Ç–∏ –∏–∑ —ç—Ç–æ–π —Å–¥–µ–ª–∫–∏?',
                'trade_closed': '–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞'
            }
        };

        // Helper function to get translated text
        function t(key) {
            return translations[currentLanguage][key] || translations['en'][key] || key;
        }

        // Comprehensive PT -> EN/ZH mapper for methodology/context text
        function translateContextText(text) {
            if (!text) return text;
            
            // Se o idioma for portugu√™s, n√£o traduz
            if (currentLanguage === 'pt' || currentLanguage === 'pt-br') return text;
            
            // Tradu√ß√£o para chin√™s
            if (currentLanguage === 'zh') {
                let translated = text;
                const zhReplacements = [
                    // =====================================================
                    // FRASES COMPLETAS INSTITUCIONAIS (chin√™s)
                    // =====================================================
                    
                    // Configura√ß√µes/Setups
                    [/Configura√ß√£o de Fundo Ascendente identificada/gi, '‰∏äÂçáÂ∫ïÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    [/Configura√ß√£o de Topo Ascendente identificada/gi, '‰∏äÂçáÈ°∂ÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    [/Configura√ß√£o de Topo Descendente identificada/gi, '‰∏ãÈôçÈ°∂ÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    [/Configura√ß√£o de Fundo Descendente identificada/gi, '‰∏ãÈôçÂ∫ïÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    [/Setup of Ascending Bottom identified/gi, '‰∏äÂçáÂ∫ïÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    [/Setup of Ascending Top identified/gi, '‰∏äÂçáÈ°∂ÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    [/Setup of Descending Top identified/gi, '‰∏ãÈôçÈ°∂ÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    [/Setup of Descending Bottom identified/gi, '‰∏ãÈôçÂ∫ïÈÉ®ÂΩ¢ÊÄÅÂ∑≤ËØÜÂà´'],
                    
                    // Tend√™ncia √¢ncora
                    [/Tend√™ncia no tempo gr√°fico √¢ncora \(([^)]+)\): alta/gi, 'ÈîöÂÆöÊó∂Èó¥Ê°ÜÊû∂ ($1) Ë∂ãÂäøÔºöÁúãÊ∂®'],
                    [/Tend√™ncia no tempo gr√°fico √¢ncora \(([^)]+)\): baixa/gi, 'ÈîöÂÆöÊó∂Èó¥Ê°ÜÊû∂ ($1) Ë∂ãÂäøÔºöÁúãË∑å'],
                    [/Tend√™ncia no tempo gr√°fico √¢ncora \(([^)]+)\): indefinida/gi, 'ÈîöÂÆöÊó∂Èó¥Ê°ÜÊû∂ ($1) Ë∂ãÂäøÔºöÊú™Á°ÆÂÆö'],
                    [/Trend in the timeframe anchor \(([^)]+)\): bullish/gi, 'ÈîöÂÆöÊó∂Èó¥Ê°ÜÊû∂ ($1) Ë∂ãÂäøÔºöÁúãÊ∂®'],
                    [/Trend in the timeframe anchor \(([^)]+)\): bearish/gi, 'ÈîöÂÆöÊó∂Èó¥Ê°ÜÊû∂ ($1) Ë∂ãÂäøÔºöÁúãË∑å'],
                    [/Trend in anchor timeframe \(([^)]+)\): bullish/gi, 'ÈîöÂÆöÊó∂Èó¥Ê°ÜÊû∂ ($1) Ë∂ãÂäøÔºöÁúãÊ∂®'],
                    [/Trend in anchor timeframe \(([^)]+)\): bearish/gi, 'ÈîöÂÆöÊó∂Èó¥Ê°ÜÊû∂ ($1) Ë∂ãÂäøÔºöÁúãË∑å'],
                    
                    // Estado do timeframe (corre√ß√£o/continuidade)
                    [/O tempo gr√°fico ([^ ]+) est√° em corre√ß√£o, buscando formar ([^.]+)/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®ÂõûË∞ÉÔºåÂØªÊâæÂΩ¢Êàê$2'],
                    [/O tempo gr√°fico ([^ ]+) est√° em continuidade, buscando formar ([^.]+)/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®Âª∂Áª≠ÔºåÂØªÊâæÂΩ¢Êàê$2'],
                    [/O tempo gr√°fico ([^ ]+) est√° em corre√ß√£o/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®ÂõûË∞É'],
                    [/O tempo gr√°fico ([^ ]+) est√° em continuidade/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®Âª∂Áª≠'],
                    [/The ([^ ]+) timeframe is in pullback, seeking to form ([^.]+)/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®ÂõûË∞ÉÔºåÂØªÊâæÂΩ¢Êàê$2'],
                    [/The ([^ ]+) timeframe is in continuation, seeking to form ([^.]+)/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®Âª∂Áª≠ÔºåÂØªÊâæÂΩ¢Êàê$2'],
                    [/The ([^ ]+) timeframe is in pullback/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®ÂõûË∞É'],
                    [/The ([^ ]+) timeframe is in continuation/gi, '$1Êó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®Âª∂Áª≠'],
                    [/Target timeframe in pullback/gi, 'ÁõÆÊ†áÊó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®ÂõûË∞É'],
                    [/Target timeframe in continuation/gi, 'ÁõÆÊ†áÊó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®Âª∂Áª≠'],
                    [/Tempo gr√°fico alvo em corre√ß√£o/gi, 'ÁõÆÊ†áÊó∂Èó¥Ê°ÜÊû∂Ê≠£Âú®ÂõûË∞É'],
                    
                    // Zonas Fibonacci
                    [/Pre√ßo atual na zona de pr√™mio \(favor√°vel para venda\) da retra√ß√£o de Fibonacci/gi, '‚óÜ ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÊñêÊ≥¢ÈÇ£Â•ëÂõûÊí§ÁöÑÊ∫¢‰ª∑Âå∫ÔºàÊúâÂà©‰∫éÂÅöÁ©∫Ôºâ'],
                    [/Pre√ßo atual na zona de desconto \(favor√°vel para compra\) da retra√ß√£o de Fibonacci/gi, '‚óÜ ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÊñêÊ≥¢ÈÇ£Â•ëÂõûÊí§ÁöÑÊäòÊâ£Âå∫ÔºàÊúâÂà©‰∫éÂÅöÂ§öÔºâ'],
                    [/Pre√ßo atual na zona de entrada √≥tima \(OTE\) da retra√ß√£o de Fibonacci/gi, '‚óÜ ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÊñêÊ≥¢ÈÇ£Â•ëÂõûÊí§ÁöÑÊúÄ‰Ω≥ÂÖ•Âú∫Âå∫ÔºàOTEÔºâ'],
                    [/Pre√ßo atual na zona de equil√≠brio da retra√ß√£o de Fibonacci/gi, 'ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÊñêÊ≥¢ÈÇ£Â•ëÂõûÊí§ÁöÑÂπ≥Ë°°Âå∫'],
                    [/Pre√ßo atual na zona de equil√≠brio de Fibonacci/gi, 'ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÊñêÊ≥¢ÈÇ£Â•ëÁöÑÂπ≥Ë°°Âå∫'],
                    [/price current in the zone of premium \(favorable for short\)/gi, '‚óÜ ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÊ∫¢‰ª∑Âå∫ÔºàÊúâÂà©‰∫éÂÅöÁ©∫Ôºâ'],
                    [/price current in the zone of discount \(favorable for long\)/gi, '‚óÜ ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÊäòÊâ£Âå∫ÔºàÊúâÂà©‰∫éÂÅöÂ§öÔºâ'],
                    [/Price in discount zone \(favorable for buy\)/gi, '‚óÜ ‰ª∑Ê†º‰Ωç‰∫éÊäòÊâ£Âå∫ÔºàÊúâÂà©‰∫é‰π∞ÂÖ•Ôºâ'],
                    [/Price in premium zone \(favorable for sell\)/gi, '‚óÜ ‰ª∑Ê†º‰Ωç‰∫éÊ∫¢‰ª∑Âå∫ÔºàÊúâÂà©‰∫éÂçñÂá∫Ôºâ'],
                    [/Price in equilibrium zone of Fibonacci/gi, '‰ª∑Ê†º‰Ωç‰∫éÊñêÊ≥¢ÈÇ£Â•ëÁöÑÂπ≥Ë°°Âå∫'],
                    
                    // EMA 200
                    [/Pre√ßo acima da m√©dia m√≥vel exponencial de 200 per√≠odos no ([^.]+)/gi, '‰ª∑Ê†ºÈ´ò‰∫é$1ÁöÑ200Âë®ÊúüÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫ø'],
                    [/Pre√ßo abaixo da m√©dia m√≥vel exponencial de 200 per√≠odos no ([^.]+)/gi, '‰ª∑Ê†º‰Ωé‰∫é$1ÁöÑ200Âë®ÊúüÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫ø'],
                    [/price above the exponential moving average of 200 periods/gi, '‰ª∑Ê†ºÈ´ò‰∫é200Âë®ÊúüÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫ø'],
                    [/price below the exponential moving average of 200 periods/gi, '‰ª∑Ê†º‰Ωé‰∫é200Âë®ÊúüÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫ø'],
                    [/Price above EMA 200/gi, '‰ª∑Ê†ºÈ´ò‰∫éEMA 200'],
                    [/Price below EMA 200/gi, '‰ª∑Ê†º‰Ωé‰∫éEMA 200'],
                    [/Pre√ßo acima da EMA 200/gi, '‰ª∑Ê†ºÈ´ò‰∫éEMA 200'],
                    [/Pre√ßo abaixo da EMA 200/gi, '‰ª∑Ê†º‰Ωé‰∫éEMA 200'],
                    
                    // RSI
                    [/√çndice de for√ßa relativa \(14\): ([0-9.]+) \(for√ßa compradora\) no ([^.]+)/gi, 'Áõ∏ÂØπÂº∫Âº±ÊåáÊï∞(14)Ôºö$1Ôºà‰π∞ÊñπÂäõÈáèÔºâÂú®$2'],
                    [/√çndice de for√ßa relativa \(14\): ([0-9.]+) \(for√ßa vendedora\) no ([^.]+)/gi, 'Áõ∏ÂØπÂº∫Âº±ÊåáÊï∞(14)Ôºö$1ÔºàÂçñÊñπÂäõÈáèÔºâÂú®$2'],
                    [/RSI\(14\): ([0-9.]+) \(sobrecompra\)/gi, '‚óÜ RSI(14)Ôºö$1ÔºàË∂Ö‰π∞Ôºâ'],
                    [/RSI\(14\): ([0-9.]+) \(sobrevenda\)/gi, '‚óÜ RSI(14)Ôºö$1ÔºàË∂ÖÂçñÔºâ'],
                    [/RSI\(14\): ([0-9.]+) \(neutro\)/gi, '‚óÜ RSI(14)Ôºö$1Ôºà‰∏≠ÊÄßÔºâ'],
                    [/RSI\(14\): ([0-9.]+) \(overbought\)/gi, '‚óÜ RSI(14)Ôºö$1ÔºàË∂Ö‰π∞Ôºâ'],
                    [/RSI\(14\): ([0-9.]+) \(oversold\)/gi, '‚óÜ RSI(14)Ôºö$1ÔºàË∂ÖÂçñÔºâ'],
                    [/RSI\(14\): ([0-9.]+) \(neutral\)/gi, '‚óÜ RSI(14)Ôºö$1Ôºà‰∏≠ÊÄßÔºâ'],
                    
                    // A√ß√£o recomendada
                    [/Aguardar confirma[c√ß][a√£]o de ([^.]+) para entrada em compra/gi, 'Á≠âÂæÖ$1Á°ÆËÆ§ÂêéÂÅöÂ§öÂÖ•Âú∫'],
                    [/Aguardar confirma[c√ß][a√£]o de ([^.]+) para entrada em venda/gi, 'Á≠âÂæÖ$1Á°ÆËÆ§ÂêéÂÅöÁ©∫ÂÖ•Âú∫'],
                    [/Wait for confirmation of ([^.]+) for entry in long/gi, 'Á≠âÂæÖ$1Á°ÆËÆ§ÂêéÂÅöÂ§öÂÖ•Âú∫'],
                    [/Wait for confirmation of ([^.]+) for entry in short/gi, 'Á≠âÂæÖ$1Á°ÆËÆ§ÂêéÂÅöÁ©∫ÂÖ•Âú∫'],
                    [/RSI j√° em regi√£o favor√°vel/gi, 'RSIÂ∑≤Âú®ÊúâÂà©Âå∫Âüü'],
                    [/RSI already in favorable region/gi, 'RSIÂ∑≤Âú®ÊúâÂà©Âå∫Âüü'],
                    
                    // Invalida√ß√£o
                    [/An[a√°]lise invalidada se o pre[c√ß]o perder o fundo anterior/gi, 'Â¶ÇÊûú‰ª∑Ê†ºË∑åÁ†¥Ââç‰ΩéÔºåÂàÜÊûêÂ∞ÜÂ§±Êïà'],
                    [/An[a√°]lise invalidada se o pre[c√ß]o superar o topo anterior/gi, 'Â¶ÇÊûú‰ª∑Ê†ºÁ™ÅÁ†¥ÂâçÈ´òÔºåÂàÜÊûêÂ∞ÜÂ§±Êïà'],
                    [/Analysis invalidated if price loses the previous bottom/gi, 'Â¶ÇÊûú‰ª∑Ê†ºË∑åÁ†¥Ââç‰ΩéÔºåÂàÜÊûêÂ∞ÜÂ§±Êïà'],
                    [/Analysis invalidated if price breaks the previous top/gi, 'Â¶ÇÊûú‰ª∑Ê†ºÁ™ÅÁ†¥ÂâçÈ´òÔºåÂàÜÊûêÂ∞ÜÂ§±Êïà'],
                    [/Invalida√ß√£o/gi, 'Â§±ÊïàÊù°‰ª∂'],
                    [/Invalidation/gi, 'Â§±ÊïàÊù°‰ª∂'],
                    
                    // =====================================================
                    // TERMOS COMPOSTOS (chin√™s)
                    // =====================================================
                    
                    // Setups e estruturas
                    [/fundo descendente/gi, '‰∏ãÈôçÂ∫ïÈÉ®'],
                    [/topo descendente/gi, '‰∏ãÈôçÈ°∂ÈÉ®'],
                    [/fundo ascendente/gi, '‰∏äÂçáÂ∫ïÈÉ®'],
                    [/topo ascendente/gi, '‰∏äÂçáÈ°∂ÈÉ®'],
                    [/descending bottom/gi, '‰∏ãÈôçÂ∫ïÈÉ®'],
                    [/descending top/gi, '‰∏ãÈôçÈ°∂ÈÉ®'],
                    [/ascending bottom/gi, '‰∏äÂçáÂ∫ïÈÉ®'],
                    [/ascending top/gi, '‰∏äÂçáÈ°∂ÈÉ®'],
                    
                    // Tend√™ncias
                    [/tend[e√™]ncia de baixa/gi, '‰∏ãË∑åË∂ãÂäø'],
                    [/tend[e√™]ncia de alta/gi, '‰∏äÊ∂®Ë∂ãÂäø'],
                    [/Tend√™ncia de alta/gi, '‰∏äÊ∂®Ë∂ãÂäø'],
                    [/Tend√™ncia de baixa/gi, '‰∏ãË∑åË∂ãÂäø'],
                    [/bearish trend/gi, '‰∏ãË∑åË∂ãÂäø'],
                    [/bullish trend/gi, '‰∏äÊ∂®Ë∂ãÂäø'],
                    
                    // Trading profiles
                    [/Escalping/gi, 'Ë∂ÖÁü≠Á∫ø'],
                    [/Scalping/gi, 'Ë∂ÖÁü≠Á∫ø'],
                    [/Day Trading/gi, 'Êó•ÂÜÖ‰∫§Êòì'],
                    [/Day_Trading/gi, 'Êó•ÂÜÖ‰∫§Êòì'],
                    [/Swing Trade/gi, 'Ê≥¢ÊÆµ‰∫§Êòì'],
                    [/Swing_Trade/gi, 'Ê≥¢ÊÆµ‰∫§Êòì'],
                    [/Position/gi, 'ÈïøÁ∫ø‰∫§Êòì'],
                    [/Posi√ß√£o/gi, 'ÈïøÁ∫ø‰∫§Êòì'],
                    
                    // Indicadores e m√©dias
                    [/m[e√©]dia m[o√≥]vel exponencial/gi, 'ÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫ø'],
                    [/exponential moving average/gi, 'ÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫ø'],
                    [/[i√≠]ndice de for[c√ß]a relativa/gi, 'Áõ∏ÂØπÂº∫Âº±ÊåáÊï∞'],
                    [/Relative Strength Index/gi, 'Áõ∏ÂØπÂº∫Âº±ÊåáÊï∞'],
                    [/for[c√ß]a compradora/gi, '‰π∞ÊñπÂäõÈáè'],
                    [/for[c√ß]a vendedora/gi, 'ÂçñÊñπÂäõÈáè'],
                    [/buying pressure/gi, '‰π∞ÊñπÂäõÈáè'],
                    [/selling pressure/gi, 'ÂçñÊñπÂäõÈáè'],
                    
                    // Fibonacci e zonas
                    [/retra[c√ß][a√£]o de Fibonacci/gi, 'ÊñêÊ≥¢ÈÇ£Â•ëÂõûÊí§'],
                    [/Fibonacci retracement/gi, 'ÊñêÊ≥¢ÈÇ£Â•ëÂõûÊí§'],
                    [/zona de pr[e√™]mio/gi, 'Ê∫¢‰ª∑Âå∫'],
                    [/zona de desconto/gi, 'ÊäòÊâ£Âå∫'],
                    [/premium zone/gi, 'Ê∫¢‰ª∑Âå∫'],
                    [/discount zone/gi, 'ÊäòÊâ£Âå∫'],
                    [/entrada [o√≥]tima/gi, 'ÊúÄ‰Ω≥ÂÖ•Âú∫'],
                    [/optimal trade entry/gi, 'ÊúÄ‰Ω≥ÂÖ•Âú∫'],
                    
                    // Termos t√©cnicos
                    [/Configura[c√ß][a√£]o/gi, 'ÂΩ¢ÊÄÅ'],
                    [/Setup/gi, 'ÂΩ¢ÊÄÅ'],
                    [/Tend[e√™]ncia/gi, 'Ë∂ãÂäø'],
                    [/Trend/gi, 'Ë∂ãÂäø'],
                    [/tempo gr[a√°]fico/gi, 'Êó∂Èó¥Ê°ÜÊû∂'],
                    [/timeframe/gi, 'Êó∂Èó¥Ê°ÜÊû∂'],
                    [/ancora|√¢ncora|anchor/gi, 'ÈîöÂÆö'],
                    [/corre[c√ß][a√£]o/gi, 'ÂõûË∞É'],
                    [/pullback/gi, 'ÂõûË∞É'],
                    [/continuidade/gi, 'Âª∂Áª≠'],
                    [/continuation/gi, 'Âª∂Áª≠'],
                    [/confirma[c√ß][a√£]o/gi, 'Á°ÆËÆ§'],
                    [/confirmation/gi, 'Á°ÆËÆ§'],
                    [/sobrecompra/gi, 'Ë∂Ö‰π∞'],
                    [/overbought/gi, 'Ë∂Ö‰π∞'],
                    [/sobrevenda/gi, 'Ë∂ÖÂçñ'],
                    [/oversold/gi, 'Ë∂ÖÂçñ'],
                    [/neutro/gi, '‰∏≠ÊÄß'],
                    [/neutral/gi, '‰∏≠ÊÄß'],
                    [/ret[e√™]ste/gi, 'ÂõûÊµã'],
                    [/retest/gi, 'ÂõûÊµã'],
                    [/volatilidade/gi, 'Ê≥¢Âä®ÊÄß'],
                    [/volatility/gi, 'Ê≥¢Âä®ÊÄß'],
                    [/liqui?dez/gi, 'ÊµÅÂä®ÊÄß'],
                    [/liquidity/gi, 'ÊµÅÂä®ÊÄß'],
                    [/resist[e√™]ncia/gi, 'ÈòªÂäõ'],
                    [/resistance/gi, 'ÈòªÂäõ'],
                    [/suporte/gi, 'ÊîØÊíë'],
                    [/support/gi, 'ÊîØÊíë'],
                    [/rompimento/gi, 'Á™ÅÁ†¥'],
                    [/breakout/gi, 'Á™ÅÁ†¥'],
                    [/consolida[c√ß][a√£]o/gi, 'ÁõòÊï¥'],
                    [/consolidation/gi, 'ÁõòÊï¥'],
                    
                    // Dire√ß√µes e posi√ß√µes
                    [/favor[a√°]vel para short/gi, 'ÊúâÂà©‰∫éÂÅöÁ©∫'],
                    [/favor[a√°]vel para long/gi, 'ÊúâÂà©‰∫éÂÅöÂ§ö'],
                    [/favor[a√°]vel para venda/gi, 'ÊúâÂà©‰∫éÂÅöÁ©∫'],
                    [/favor[a√°]vel para compra/gi, 'ÊúâÂà©‰∫éÂÅöÂ§ö'],
                    [/favorable for short/gi, 'ÊúâÂà©‰∫éÂÅöÁ©∫'],
                    [/favorable for long/gi, 'ÊúâÂà©‰∫éÂÅöÂ§ö'],
                    [/favorable for buy/gi, 'ÊúâÂà©‰∫éÂÅöÂ§ö'],
                    [/favorable for sell/gi, 'ÊúâÂà©‰∫éÂÅöÁ©∫'],
                    [/desconto/gi, 'ÊäòÊâ£'],
                    [/discount/gi, 'ÊäòÊâ£'],
                    [/pr[e√™]mio/gi, 'Ê∫¢‰ª∑'],
                    [/premium/gi, 'Ê∫¢‰ª∑'],
                    
                    // A√ß√µes
                    [/Aguardar/gi, 'Á≠âÂæÖ'],
                    [/Wait for/gi, 'Á≠âÂæÖ'],
                    [/buscando/gi, 'ÂØªÊâæ'],
                    [/seeking/gi, 'ÂØªÊâæ'],
                    [/formar/gi, 'ÂΩ¢Êàê'],
                    [/form/gi, 'ÂΩ¢Êàê'],
                    [/identificada/gi, 'Â∑≤ËØÜÂà´'],
                    [/identified/gi, 'Â∑≤ËØÜÂà´'],
                    [/monitorar/gi, 'ÁõëÊéß'],
                    [/monitor/gi, 'ÁõëÊéß'],
                    [/observar/gi, 'ËßÇÂØü'],
                    [/observe/gi, 'ËßÇÂØü'],
                    
                    // Dire√ß√µes simples
                    [/\bbaixa\b/gi, 'ÁúãË∑å'],
                    [/\balta\b/gi, 'ÁúãÊ∂®'],
                    [/\bbearish\b/gi, 'ÁúãË∑å'],
                    [/\bbullish\b/gi, 'ÁúãÊ∂®'],
                    [/\bcompra\b/gi, 'ÂÅöÂ§ö'],
                    [/\bvenda\b/gi, 'ÂÅöÁ©∫'],
                    [/\blong\b/gi, 'ÂÅöÂ§ö'],
                    [/\bshort\b/gi, 'ÂÅöÁ©∫'],
                    
                    // Unidades de tempo
                    [/per[i√≠]odos/gi, 'Âë®Êúü'],
                    [/periods/gi, 'Âë®Êúü'],
                    [/minutos/gi, 'ÂàÜÈíü'],
                    [/minutes/gi, 'ÂàÜÈíü'],
                    [/horas/gi, 'Â∞èÊó∂'],
                    [/hours/gi, 'Â∞èÊó∂'],
                    [/hora/gi, 'Â∞èÊó∂'],
                    [/hour/gi, 'Â∞èÊó∂'],
                    [/di[a√°]rio/gi, 'Êó•Á∫ø'],
                    [/daily/gi, 'Êó•Á∫ø'],
                    [/semanal/gi, 'Âë®Á∫ø'],
                    [/weekly/gi, 'Âë®Á∫ø'],
                    [/mensal/gi, 'ÊúàÁ∫ø'],
                    [/monthly/gi, 'ÊúàÁ∫ø'],
                    
                    // Outros termos
                    [/\bzona\b/gi, 'Âå∫Âüü'],
                    [/\bzone\b/gi, 'Âå∫Âüü'],
                    [/\bpre[c√ß]o\b/gi, '‰ª∑Ê†º'],
                    [/\bprice\b/gi, '‰ª∑Ê†º'],
                    [/\bacima\b/gi, '‰∏äÊñπ'],
                    [/\babove\b/gi, '‰∏äÊñπ'],
                    [/\babaixo\b/gi, '‰∏ãÊñπ'],
                    [/\bbelow\b/gi, '‰∏ãÊñπ'],
                    [/\balvo\b/gi, 'ÁõÆÊ†á'],
                    [/\btarget\b/gi, 'ÁõÆÊ†á'],
                    [/\bentrada\b/gi, 'ÂÖ•Âú∫'],
                    [/\bentry\b/gi, 'ÂÖ•Âú∫'],
                    
                    // Conflu√™ncias
                    [/EMAs coerentes com o contexto/gi, 'EMA‰∏éË∂ãÂäø‰∏ÄËá¥'],
                    [/EMAs consistent with context/gi, 'EMA‰∏éË∂ãÂäø‰∏ÄËá¥'],
                    [/RSI do ([^ ]+) alinhado ao movimento do pre√ßo/gi, '$1ÁöÑRSI‰∏é‰ª∑Ê†ºËµ∞Âäø‰∏ÄËá¥'],
                    [/RSI of ([^ ]+) aligned with price movement/gi, '$1ÁöÑRSI‰∏é‰ª∑Ê†ºËµ∞Âäø‰∏ÄËá¥'],
                    [/Rea√ß√£o desfavor√°vel na EMA/gi, 'EMAÂ§ÑÂá∫Áé∞‰∏çÂà©ÂèçÂ∫î'],
                    [/Unfavorable reaction at EMA/gi, 'EMAÂ§ÑÂá∫Áé∞‰∏çÂà©ÂèçÂ∫î'],
                    [/Pre√ßo longe das zonas de Fibo/gi, '‰ª∑Ê†ºËøúÁ¶ªÊñêÊ≥¢ÈÇ£Â•ëÂå∫Âüü'],
                    [/Price far from Fibo zones/gi, '‰ª∑Ê†ºËøúÁ¶ªÊñêÊ≥¢ÈÇ£Â•ëÂå∫Âüü'],
                    [/RSI desfavor√°vel ao trade/gi, 'RSIÂØπ‰∫§Êòì‰∏çÂà©'],
                    [/RSI unfavorable for trade/gi, 'RSIÂØπ‰∫§Êòì‰∏çÂà©'],
                    [/Monitorar volatilidade/gi, 'ÁõëÊéßÊ≥¢Âä®ÊÄß'],
                    [/Monitor volatility/gi, 'ÁõëÊéßÊ≥¢Âä®ÊÄß'],
                    [/Tempos gr√°ficos em dire√ß√µes opostas/gi, 'Êó∂Èó¥Ê°ÜÊû∂ÊñπÂêëÁõ∏Âèç'],
                    [/Timeframes in opposite directions/gi, 'Êó∂Èó¥Ê°ÜÊû∂ÊñπÂêëÁõ∏Âèç']
                ];
                zhReplacements.forEach(([pattern, replacement]) => {
                    translated = translated.replace(pattern, replacement);
                });
                return translated;
            }
            
            // Se n√£o for ingl√™s, retorna texto original
            if (currentLanguage !== 'en') return text;
            let translated = text;
            const replacements = [
                // =====================================================
                // FRASES COMPLETAS INSTITUCIONAIS (mais espec√≠ficas primeiro)
                // =====================================================
                
                // Configura√ß√µes/Setups
                [/Configura√ß√£o de Fundo Ascendente identificada/gi, 'Setup of Ascending Bottom identified'],
                [/Configura√ß√£o de Topo Ascendente identificada/gi, 'Setup of Ascending Top identified'],
                [/Configura√ß√£o de Topo Descendente identificada/gi, 'Setup of Descending Top identified'],
                [/Configura√ß√£o de Fundo Descendente identificada/gi, 'Setup of Descending Bottom identified'],
                
                // Tend√™ncia √¢ncora
                [/Tend√™ncia no tempo gr√°fico √¢ncora \(([^)]+)\): alta/gi, 'Trend in the timeframe anchor ($1): bullish'],
                [/Tend√™ncia no tempo gr√°fico √¢ncora \(([^)]+)\): baixa/gi, 'Trend in the timeframe anchor ($1): bearish'],
                [/Tend√™ncia no tempo gr√°fico √¢ncora \(([^)]+)\): indefinida/gi, 'Trend in the timeframe anchor ($1): undefined'],
                
                // Estado do timeframe (corre√ß√£o/continuidade)
                [/O tempo gr√°fico ([^ ]+) est√° em corre√ß√£o, buscando formar ([^.]+)/gi, 'The $1 timeframe is in pullback, seeking to form $2'],
                [/O tempo gr√°fico ([^ ]+) est√° em continuidade, buscando formar ([^.]+)/gi, 'The $1 timeframe is in continuation, seeking to form $2'],
                
                // Zonas Fibonacci
                [/Pre√ßo atual na zona de pr√™mio \(favor√°vel para venda\) da retra√ß√£o de Fibonacci/gi, 'price current in the zone of premium (favorable for short) of the Fibonacci retracement'],
                [/Pre√ßo atual na zona de desconto \(favor√°vel para compra\) da retra√ß√£o de Fibonacci/gi, 'price current in the zone of discount (favorable for long) of the Fibonacci retracement'],
                [/Pre√ßo atual na zona de entrada √≥tima \(OTE\) da retra√ß√£o de Fibonacci/gi, 'price current in the optimal trade entry (OTE) zone of the Fibonacci retracement'],
                [/Pre√ßo atual na zona de equil√≠brio da retra√ß√£o de Fibonacci/gi, 'price current in the equilibrium zone of the Fibonacci retracement'],
                
                // EMA 200
                [/Pre√ßo acima da m√©dia m√≥vel exponencial de 200 per√≠odos no ([^.]+)/gi, 'price above the exponential moving average of 200 periods in the $1'],
                [/Pre√ßo abaixo da m√©dia m√≥vel exponencial de 200 per√≠odos no ([^.]+)/gi, 'price below the exponential moving average of 200 periods in the $1'],
                
                // RSI
                [/√çndice de for√ßa relativa \(14\): ([0-9.]+) \(for√ßa compradora\) no ([^.]+)/gi, 'Relative Strength Index (14): $1 (buying pressure) in the $2'],
                [/√çndice de for√ßa relativa \(14\): ([0-9.]+) \(for√ßa vendedora\) no ([^.]+)/gi, 'Relative Strength Index (14): $1 (selling pressure) in the $2'],
                
                // A√ß√£o recomendada (formas mais flex√≠veis)
                [/Aguardar confirma[c√ß][a√£]o de ([^.]+) para entrada em compra/gi, 'Wait for confirmation of $1 for entry in long'],
                [/Aguardar confirma[c√ß][a√£]o de ([^.]+) para entrada em venda/gi, 'Wait for confirmation of $1 for entry in short'],
                
                // Invalida√ß√£o
                [/An[a√°]lise invalidada se o pre[c√ß]o perder o fundo anterior no ([^,]+), confirmando perda de estrutura de ([^.]+)/gi, 'Analysis invalidated if price loses the previous bottom in the $1, confirming loss of $2 structure'],
                [/An[a√°]lise invalidada se o pre[c√ß]o superar o topo anterior no ([^,]+), confirmando perda de estrutura de ([^.]+)/gi, 'Analysis invalidated if price breaks the previous top in the $1, confirming loss of $2 structure'],
                
                // Novos padr√µes da vers√£o 3.0
                [/O tempo gr[a√°]fico ([^ ]+) est[a√°] em corre[c√ß][a√£]o/gi, 'The $1 timeframe is in pullback'],
                [/O tempo gr[a√°]fico ([^ ]+) est[a√°] em continuidade/gi, 'The $1 timeframe is in continuation'],
                [/Pre[c√ß]o acima da m[e√©]dia m[o√≥]vel exponencial/gi, 'Price above the exponential moving average'],
                [/Pre[c√ß]o abaixo da m[e√©]dia m[o√≥]vel exponencial/gi, 'Price below the exponential moving average'],
                [/buscando formar ([^.]+)/gi, 'seeking to form $1'],
                [/topo confirmado/gi, 'confirmed top'],
                [/fundo confirmado/gi, 'confirmed bottom'],
                
                // =====================================================
                // TERMOS COMPOSTOS (ordem espec√≠fica para n√£o quebrar)
                // =====================================================
                
                // Setups e estruturas
                [/fundo descendente/gi, 'descending bottom'],
                [/topo descendente/gi, 'descending top'],
                [/fundo ascendente/gi, 'ascending bottom'],
                [/topo ascendente/gi, 'ascending top'],
                [/tend[e√™]ncia de baixa/gi, 'bearish trend'],
                [/tend[e√™]ncia de alta/gi, 'bullish trend'],
                [/tend[e√™]ncia baixa/gi, 'bearish trend'],
                [/tend[e√™]ncia alta/gi, 'bullish trend'],
                
                // Indicadores e m√©dias
                [/m[e√©]dia m[o√≥]vel exponencial/gi, 'exponential moving average'],
                [/[i√≠]ndice de for[c√ß]a relativa/gi, 'Relative Strength Index'],
                [/for[c√ß]a compradora/gi, 'buying pressure'],
                [/for[c√ß]a vendedora/gi, 'selling pressure'],
                
                // Fibonacci e zonas
                [/retra[c√ß][a√£]o de Fibonacci/gi, 'Fibonacci retracement'],
                [/zona de pr[e√™]mio/gi, 'premium zone'],
                [/zona de desconto/gi, 'discount zone'],
                [/entrada [o√≥]tima/gi, 'optimal trade entry'],
                [/retra[c√ß][a√£]o/gi, 'retracement'],
                [/extens[a√£]o/gi, 'extension'],
                
                // Termos t√©cnicos
                [/Configura[c√ß][a√£]o/gi, 'Setup'],
                [/Tend[e√™]ncia/gi, 'Trend'],
                [/tempo gr[a√°]fico/gi, 'timeframe'],
                [/timeframe anchor/gi, 'anchor timeframe'],
                [/ancora|√¢ncora/gi, 'anchor'],
                [/corre[c√ß][a√£]o/gi, 'pullback'],
                [/continuidade/gi, 'continuation'],
                [/confirma[c√ß][a√£]o/gi, 'confirmation'],
                [/invalida[c√ß][a√£]o/gi, 'invalidation'],
                [/sobrecompra/gi, 'overbought'],
                [/sobrevenda/gi, 'oversold'],
                [/ret[e√™]ste/gi, 'retest'],
                [/volatilidade/gi, 'volatility'],
                [/liqui?dez/gi, 'liquidity'],
                [/resist[e√™]ncia/gi, 'resistance'],
                [/suporte/gi, 'support'],
                [/rompimento/gi, 'breakout'],
                [/consolida[c√ß][a√£]o/gi, 'consolidation'],
                
                // Dire√ß√µes e posi√ß√µes
                [/favor[a√°]vel para short/gi, 'favorable for short'],
                [/favor[a√°]vel para long/gi, 'favorable for long'],
                [/favor[a√°]vel para venda/gi, 'favorable for short'],
                [/favor[a√°]vel para compra/gi, 'favorable for long'],
                [/favor[a√°]vel/gi, 'favorable'],
                [/desconto/gi, 'discount'],
                [/pr[e√™]mio/gi, 'premium'],
                
                // A√ß√µes
                [/Aguardar/gi, 'Wait for'],
                [/buscando/gi, 'seeking'],
                [/formar/gi, 'form'],
                [/identificada/gi, 'identified'],
                [/monitorar/gi, 'monitor'],
                [/observar/gi, 'observe'],
                
                // Conectivos e preposi√ß√µes
                [/\best[a√°] em\b/gi, 'is in'],
                [/\batual\b/gi, 'current'],
                [/\bpara\b/gi, 'for'],
                [/\bno timeframe\b/gi, 'in the timeframe'],
                [/\bno\b/gi, 'in the'],
                [/\bna\b/gi, 'in the'],
                [/\bda\b/gi, 'of the'],
                [/\bdo\b/gi, 'of the'],
                [/\bdos\b/gi, 'of the'],
                [/\bdas\b/gi, 'of the'],
                [/\bde\b/gi, 'of'],
                [/\bem\b/gi, 'in'],
                
                // Unidades de tempo
                [/per[i√≠]odos/gi, 'periods'],
                [/minutos/gi, 'minutes'],
                [/horas/gi, 'hours'],
                [/hora/gi, 'hour'],
                [/di[a√°]rio/gi, 'daily'],
                [/semanal/gi, 'weekly'],
                
                // Dire√ß√µes simples (depois dos compostos)
                [/\bbaixa\b/gi, 'bearish'],
                [/\balta\b/gi, 'bullish'],
                [/\bcompra\b/gi, 'long'],
                [/\bvenda\b/gi, 'short'],
                
                // Outros termos
                [/\bzona\b/gi, 'zone'],
                [/\bpre[c√ß]o\b/gi, 'price'],
                [/\bacima\b/gi, 'above'],
                [/\babaixo\b/gi, 'below'],
                [/\balvo\b/gi, 'target'],
                [/\bentrada\b/gi, 'entry'],
                [/\balinhada\b/gi, 'aligned'],
                [/\balinhado\b/gi, 'aligned'],
                
                // Limpeza de artigos extras resultantes
                [/\bof the the\b/gi, 'of the'],
                [/\bin the the\b/gi, 'in the'],
                [/\bfor the the\b/gi, 'for the']
            ];
            replacements.forEach(([pattern, replacement]) => {
                translated = translated.replace(pattern, replacement);
            });
            return translated;
        }

        function setLanguage(lang) {
            // Mapeamento de c√≥digos curtos para normalizados
            const langMap = {
                'en': 'en',
                'zh': 'zh'
            };
            
            const normalizedLang = langMap[lang] || 'en';
            const shortLang = normalizedLang;
            
            // Usar idioma normalizado para tradu√ß√µes locais
            currentLanguage = translations[shortLang] ? shortLang : 'en';
            localStorage.setItem('shdwxbt_lang', normalizedLang);
            document.documentElement.lang = normalizedLang;
            
            // Atualizar o label do seletor de idioma
            const langLabel = document.getElementById('current-lang');
            const flags = { 'en': 'üá∫üá∏', 'zh': 'üá®üá≥' };
            if (langLabel) {
                langLabel.textContent = `${flags[normalizedLang] || ''} ${normalizedLang.toUpperCase()}`;
            }
            
            // Fechar dropdown
            const dropdown = document.getElementById('lang-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
            
            // Marcar bot√£o ativo no dropdown
            document.querySelectorAll('#lang-dropdown button').forEach(btn => {
                const btnLang = btn.getAttribute('data-lang');
                if (btnLang === shortLang) {
                    btn.classList.add('bg-emerald-500/20', 'text-emerald-400');
                } else {
                    btn.classList.remove('bg-emerald-500/20', 'text-emerald-400');
                }
            });

            // Sincronizar m√≥dulo i18n global para traduzir abas/modais
            if (typeof i18n !== 'undefined' && typeof i18n.setLanguage === 'function') {
                i18n.setLanguage(normalizedLang);
            }

            // Translate static elements with data-key
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[currentLanguage][key]) {
                    el.innerText = translations[currentLanguage][key];
                }
            });

            // Traduzir bot√µes, placeholders e tooltips din√¢micos
            document.querySelectorAll('[data-tooltip-key]').forEach(el => {
                const key = el.getAttribute('data-tooltip-key');
                if (translations[currentLanguage][key]) {
                    el.title = translations[currentLanguage][key];
                }
            });
            document.querySelectorAll('[data-placeholder-key]').forEach(el => {
                const key = el.getAttribute('data-placeholder-key');
                if (translations[currentLanguage][key]) {
                    el.placeholder = translations[currentLanguage][key];
                }
            });

            // Re-render opportunities with new language (respecting current filter)
            if (window.currentOpportunities || window.currentWatchlist) {
                if (typeof window.applyFilter === 'function') {
                    window.applyFilter();
                }
            }

            // Re-render watchlist section
            if (window.currentWatchlist) {
                renderWatchlistSection(window.currentWatchlist);
            }
            
            // Re-render history sections if visible
            if (window.currentFilter === 'tp-history' && typeof window.renderTPHistory === 'function') {
                window.renderTPHistory();
            }
            if (window.currentFilter === 'sl-history' && typeof window.renderSLHistory === 'function') {
                window.renderSLHistory();
            }

            // Atualizar textos de modais abertos
            let modal;
            try {
                modal = document.getElementById('detail-modal');
            } catch (e) {
                modal = null;
            }
            if (modal && modal.classList.contains('visible-modal')) {
                // Re-render overlay and sidebar with new language
                const currentSymbol = window.currentActiveSymbol;
                if (currentSymbol) {
                    const allItems = [...(window.currentOpportunities || []), ...(window.currentWatchlist || [])];
                    const opp = allItems.find(o => o.symbol === currentSymbol);
                    if (opp) {
                        // Re-render overlay with translated direction text
                        if (typeof window.updateChartOverlay === 'function') {
                            window.updateChartOverlay(opp);
                        }
                    }
                }
            }
        }

        // Inicializar idioma com prefer√™ncia salva ou idioma do navegador
        const storedLanguage = localStorage.getItem('shdwxbt_lang');
        function detectBrowserLanguage() {
            const navLang = (navigator.language || 'en').toLowerCase();
            if (navLang.startsWith('zh')) return 'zh';
            return 'en';
        }
        const browserLang = detectBrowserLanguage();
        // Normalizar idioma salvo
        const langMap = { 'en': 'en', 'zh': 'zh' };
        const normalizedStored = langMap[storedLanguage] || null;
        const initialLang = (normalizedStored && translations[normalizedStored]) ? storedLanguage : browserLang;
        setLanguage(initialLang);

        // --- PRICE AUTOMATION LOGIC ---
        // Note: This legacy code is now handled by OpportunitiesService and DashboardRenderer
        // Keeping it as fallback for static demo elements only
        const priceElements = {};
        
        // Only initialize if static elements exist
        ['xrp', 'doge', 'sol'].forEach(coin => {
            const el = document.getElementById('price-' + coin);
            if (el) {
                priceElements[coin] = { 
                    el: el, 
                    val: coin === 'xrp' ? 2.0810 : coin === 'doge' ? 0.1385 : 103.80 
                };
            }
        });

        function checkTargets() {
            document.querySelectorAll('.card-panel').forEach(card => {
                let id = card.id.replace('card-', '');
                if(!priceElements[id]) return;

                let currentPrice = priceElements[id].val;
                
                card.querySelectorAll('.target-row').forEach(row => {
                    let targetPrice = parseFloat(row.getAttribute('data-target'));
                    let type = row.getAttribute('data-type');
                    let isHit = false;

                    if (type === 'long') {
                        if (currentPrice >= targetPrice) isHit = true;
                    } else {
                        if (currentPrice <= targetPrice) isHit = true;
                    }

                    const icon = row.querySelector('.tp-icon');
                    
                    if (isHit) {
                        if (!row.classList.contains('tp-hit')) {
                            row.classList.add('tp-hit');
                            icon.classList.add('tp-icon-hit');
                        }
                    } else {
                        row.classList.remove('tp-hit');
                        icon.classList.remove('tp-icon-hit');
                    }
                });
            });
        }

        // Legacy price update interval - only runs if static elements exist
        if (Object.keys(priceElements).length > 0) {
            setInterval(() => {
                for (let coin in priceElements) {
                    if (!priceElements[coin].el) continue;
                    
                    let change = (Math.random() - 0.5) * (priceElements[coin].val * 0.005);
                    priceElements[coin].val += change;
                    
                    let decimals = priceElements[coin].val < 1 ? 4 : 2;
                    if(coin === 'doge') decimals = 4;
                    if(coin === 'xrp') decimals = 4;
                    
                    priceElements[coin].el.innerText = priceElements[coin].val.toFixed(decimals);
                }
                checkTargets();
            }, 2000);

            checkTargets();
        }

        // --- AUTH & WALLET DISPLAY ---
        (function displayConnectedWallet() {
            // Use pre-validated auth from window.SHDW_AUTH
            const auth = window.SHDW_AUTH || JSON.parse(localStorage.getItem('shdwxbt_auth') || '{}');
            if (auth && auth.wallet) {
                const shortWallet = auth.wallet.slice(0, 6) + '...' + auth.wallet.slice(-4);
                document.getElementById('connected-wallet').innerText = shortWallet;
            }
        })();

        // --- CRYPTO LOGO HELPER ---
        // Uses multiple CDNs with fallback chain
        
        // Manual logo mapping for tokens not available on standard CDNs
        const CUSTOM_LOGOS = {
            'FORM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33498.png',
            'WCT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33073.png',
            'TREE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/31477.png',
            'NEIROETH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32927.png',
            'FHE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34393.png',
            'VIDT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3845.png',
            'SXP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4279.png',
            'WAVES': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1274.png',
            'BERA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29407.png',
            'KAITO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34727.png',
            'IMX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/10603.png',
            'TRUMP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35336.png',
            'MELANIA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35347.png',
            'LAYER': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34753.png',
            'ANIME': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34792.png',
            'TST': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34848.png',
            'SHELL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34720.png',
            'GPS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34754.png',
            'BMT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34855.png',
            'NIL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34930.png',
            'B3': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34823.png',
            'BANANAS31': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35019.png',
            'PARTI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35012.png',
            'PROM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4120.png',
            'EPT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35156.png',
            'BABY': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35187.png',
            'HAEDAL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35258.png',
            'SIGN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35244.png',
            'INIT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35186.png',
            'ONDO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/21159.png',
            'VIRTUAL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28476.png',
            'AI16Z': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34096.png',
            'FARTCOIN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33597.png',
            'MOODENG': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32517.png',
            'GOAT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33033.png',
            'PNUT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33146.png',
            'ACT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33158.png',
            'ZEREBRO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33591.png',
            'GRIFFAIN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34205.png',
            'ARC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34151.png',
            'AIXBT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34230.png',
            'CGPT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/22814.png',
            'COOKIE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34431.png',
            'VINE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/35354.png',
            'BOME': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29870.png',
            'WIF': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28752.png',
            'BONK': 'https://s2.coinmarketcap.com/static/img/coins/64x64/23095.png',
            'PENGU': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34332.png',
            'PEPE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/24478.png',
            'SHIB': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5994.png',
            'DOGE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/74.png',
            'FLOKI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/10804.png',
            'NEIRO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32508.png',
            'SPX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32402.png',
            'POPCAT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28782.png',
            'MOG': 'https://s2.coinmarketcap.com/static/img/coins/64x64/27659.png',
            'MEW': 'https://s2.coinmarketcap.com/static/img/coins/64x64/30126.png',
            'BRETT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29743.png',
            'DOGS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32275.png',
            'NOT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28850.png',
            'TON': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11419.png',
            'SUI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/20947.png',
            'APT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/21794.png',
            'SEI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/23149.png',
            'TIA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/22861.png',
            'INJ': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7226.png',
            'JUP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29210.png',
            'PYTH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28177.png',
            'RENDER': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5690.png',
            'FET': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3773.png',
            'TAO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/22974.png',
            'NEAR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6535.png',
            'OP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11840.png',
            'ARB': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11841.png',
            'MATIC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3890.png',
            'POL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3890.png',
            'AVAX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5805.png',
            'LINK': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1975.png',
            'DOT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6636.png',
            'ATOM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3794.png',
            'ADA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2010.png',
            'SOL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5426.png',
            'ETH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1027.png',
            'BTC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1.png',
            'BNB': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1839.png',
            'XRP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/52.png',
            'LTC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2.png',
            'HBAR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4642.png',
            'STX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4847.png',
            'FIL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2280.png',
            'AAVE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7278.png',
            'UNI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7083.png',
            'MKR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1518.png',
            'CRV': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6538.png',
            'LDO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8000.png',
            'SNX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2586.png',
            'COMP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5692.png',
            'CAKE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7186.png',
            'SUSHI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6758.png',
            'DYDX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11156.png',
            'GMX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11857.png',
            'ENS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/13855.png',
            'SAND': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6210.png',
            'MANA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1966.png',
            'AXS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6783.png',
            'GALA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7080.png',
            'APE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/18876.png',
            'BLUR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/23121.png',
            'STG': 'https://s2.coinmarketcap.com/static/img/coins/64x64/18934.png',
            'WOO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7501.png',
            'SUPER': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8290.png',
            'ILV': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8719.png',
            'MAGIC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/14783.png',
            'RDNT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/21106.png',
            'PENDLE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/9481.png',
            'SSV': 'https://s2.coinmarketcap.com/static/img/coins/64x64/12999.png',
            'MEME': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28301.png',
            'ORDI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/25028.png',
            'SATS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28683.png',
            'RATS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28990.png',
            'PIXEL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29335.png',
            'STRK': 'https://s2.coinmarketcap.com/static/img/coins/64x64/22691.png',
            'ETHFI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29814.png',
            'ENA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/30171.png',
            'W': 'https://s2.coinmarketcap.com/static/img/coins/64x64/30353.png',
            'OMNI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/30424.png',
            'REZ': 'https://s2.coinmarketcap.com/static/img/coins/64x64/30698.png',
            'BB': 'https://s2.coinmarketcap.com/static/img/coins/64x64/30822.png',
            'ZK': 'https://s2.coinmarketcap.com/static/img/coins/64x64/24091.png',
            'LISTA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/31326.png',
            'ZRO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/26997.png',
            'IO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/31234.png',
            'BANANA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/28066.png',
            'AERO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29270.png',
            'TURBO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/24911.png',
            'PEOPLE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/14806.png',
            '1000CAT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33617.png',
            'EIGEN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/29998.png',
            'SCR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32880.png',
            'CATI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32648.png',
            'HMSTR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32195.png',
            'KAIA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4256.png',
            'COW': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11748.png',
            'CETUS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/25114.png',
            'USUAL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34107.png',
            'THE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33517.png',
            'ACX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/15165.png',
            'ORCA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11165.png',
            'MOVE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/32452.png',
            'ME': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34133.png',
            'VANA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34247.png',
            'VELODROME': 'https://s2.coinmarketcap.com/static/img/coins/64x64/21116.png',
            'HYPE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/33878.png',
            'BIO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/34433.png',
            'SOL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5426.png',
            'XLM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/512.png',
            'TRX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1958.png',
            'ETC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1321.png',
            'BCH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1831.png',
            'XMR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/328.png',
            'ALGO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4030.png',
            'VET': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3077.png',
            'ICP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8916.png',
            'RUNE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4157.png',
            'FTM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3513.png',
            'THETA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2416.png',
            'KAVA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4846.png',
            'MINA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8646.png',
            'FLOW': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4558.png',
            'ROSE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7653.png',
            'ZIL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2469.png',
            'CELO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5567.png',
            'ONE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3945.png',
            'ZEN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1698.png',
            'KDA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5647.png',
            'QTUM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1684.png',
            'ICX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2099.png',
            'ONT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2566.png',
            'IOTA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1720.png',
            'XTZ': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2011.png',
            'EOS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1765.png',
            'NEO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1376.png',
            'WAVES': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1274.png',
            'ZEC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1437.png',
            'DASH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/131.png',
            'XEM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/873.png',
            'DCR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1168.png',
            'LSK': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1214.png',
            'SC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1042.png',
            'DGB': 'https://s2.coinmarketcap.com/static/img/coins/64x64/109.png',
            'RVN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2577.png',
            'ANKR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3783.png',
            'STORJ': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1772.png',
            'CHZ': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4066.png',
            'ENJ': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2130.png',
            'BAT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1697.png',
            'ZRX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1896.png',
            'KNC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/9444.png',
            'GRT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6719.png',
            '1INCH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8104.png',
            'OCEAN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3911.png',
            'RSR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3964.png',
            'CKB': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4948.png',
            'SKL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5691.png',
            'CELR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3814.png',
            'COTI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/3992.png',
            'RLC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1637.png',
            'OGN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5117.png',
            'NKN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2780.png',
            'BAND': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4679.png',
            'AGIX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2424.png',
            'AR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5632.png',
            'JASMY': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8425.png',
            'GMT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/18069.png',
            'LUNC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4172.png',
            'USTC': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7129.png',
            'LUNA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/20314.png',
            'CFX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7334.png',
            'GMX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11857.png',
            'FXS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6953.png',
            'RPL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2943.png',
            'OSMO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/12220.png',
            'AGLD': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11568.png',
            'MASK': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8536.png',
            'YFI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5864.png',
            'ALPHA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7232.png',
            'REEF': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6951.png',
            'DENT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1886.png',
            'HOT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2682.png',
            'CTSI': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5444.png',
            'BICO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/9543.png',
            'API3': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7737.png',
            'LQTY': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7429.png',
            'UMA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5617.png',
            'TRB': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4944.png',
            'HIGH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11232.png',
            'AUCTION': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8602.png',
            'LOOM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2588.png',
            'MTL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1788.png',
            'SYS': 'https://s2.coinmarketcap.com/static/img/coins/64x64/541.png',
            'STMX': 'https://s2.coinmarketcap.com/static/img/coins/64x64/2297.png',
            'LEVER': 'https://s2.coinmarketcap.com/static/img/coins/64x64/19621.png',
            'LINA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7102.png',
            'LIT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7941.png',
            'SPELL': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11289.png',
            'JOE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11396.png',
            'RARE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11294.png',
            'DUSK': 'https://s2.coinmarketcap.com/static/img/coins/64x64/4092.png',
            'DAR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/11374.png',
            'ACA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6756.png',
            'GLMR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6836.png',
            'ASTR': 'https://s2.coinmarketcap.com/static/img/coins/64x64/12885.png',
            'T': 'https://s2.coinmarketcap.com/static/img/coins/64x64/17751.png',
            'ACH': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6958.png',
            'XNO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/1567.png',
            'WLD': 'https://s2.coinmarketcap.com/static/img/coins/64x64/13502.png',
            'CYBER': 'https://s2.coinmarketcap.com/static/img/coins/64x64/24781.png',
            'ARKM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/27565.png',
            'NTRN': 'https://s2.coinmarketcap.com/static/img/coins/64x64/26680.png',
            'TWT': 'https://s2.coinmarketcap.com/static/img/coins/64x64/5964.png',
            'C98': 'https://s2.coinmarketcap.com/static/img/coins/64x64/10903.png',
            'SFP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8119.png',
            'BAKE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7964.png',
            'ALPHA': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7232.png',
            'TLM': 'https://s2.coinmarketcap.com/static/img/coins/64x64/9119.png',
            'ALICE': 'https://s2.coinmarketcap.com/static/img/coins/64x64/8766.png',
            'DODO': 'https://s2.coinmarketcap.com/static/img/coins/64x64/7224.png',
            'PERP': 'https://s2.coinmarketcap.com/static/img/coins/64x64/6950.png'
        };
        
        // === LOGO CACHE - Evita requests repetidos ===
        const _logoCache = new Map();
        
        function getCryptoLogoUrl(symbol) {
            const base = symbol.replace('USDT', '').replace('BUSD', '').replace('USD', '').toUpperCase();
            
            // Check cache first
            if (_logoCache.has(base)) {
                return _logoCache.get(base);
            }
            
            let url;
            // Check custom logos first
            if (CUSTOM_LOGOS[base]) {
                url = CUSTOM_LOGOS[base];
            } else {
                // Fallback to CoinCap CDN
                url = `https://assets.coincap.io/assets/icons/${base.toLowerCase()}@2x.png`;
            }
            
            // Cache for future use
            _logoCache.set(base, url);
            return url;
        }
        
        // Make available globally
        window.getCryptoLogoUrl = getCryptoLogoUrl;
        
        // Alternative logos for specific coins (if primary fails)
        function getAlternativeLogoUrl(symbol) {
            const base = symbol.toUpperCase();
            // CoinMarketCap static fallback
            return `https://s2.coinmarketcap.com/static/img/coins/64x64/1.png`; // BTC as default
        }

        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to disconnect your wallet?')) {
                localStorage.removeItem('shdwxbt_auth');
                window.location.href = 'login.html';
            }
        }

        // --- MODAL LOGIC ---

        function openDetail(coin) {
            const modal = document.getElementById('detail-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');

            // Buscar a oportunidade ativa (coin pode ser s√≠mbolo ou objeto)
            let opp = null;
            if (typeof coin === 'object' && coin !== null) {
                opp = coin;
            } else if (typeof coin === 'string') {
                // Buscar nas oportunidades carregadas
                if (window.currentOpportunities && Array.isArray(window.currentOpportunities)) {
                    opp = window.currentOpportunities.find(o => o.symbol === coin || o.symbol?.replace('USDT','') === coin);
                }
            }
            // Atualiza o Chart Overlay com a mesma an√°lise do modal
            if (opp) {
                window.updateChartOverlay(opp);
            }

            // Mobile: scroll modal e sidebar para topo
            if (window.innerWidth < 768) {
                setTimeout(() => {
                    modal.scrollTop = 0;
                    // Tamb√©m resetar scroll do sidebar content
                    const sidebarPanel = document.getElementById('sidebar-panel');
                    if (sidebarPanel) {
                        sidebarPanel.scrollTop = 0;
                    }
                    const sidebarContent = sidebarPanel?.querySelector('.flex-1.overflow-y-auto');
                    if (sidebarContent) {
                        sidebarContent.scrollTop = 0;
                    }
                }, 150);
            }
        }

        function closeDetail() {
            const modal = document.getElementById('detail-modal');
            modal.classList.remove('visible-modal');
            modal.classList.add('hidden-modal');
            
            // Re-enable body scroll on mobile
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
        }

        // --- REAL-TIME PRICE WEBSOCKET ---
        // Global state for WebSocket management
        window.realtimePriceState = {
            subscribedSymbols: new Set(),
            callback: null,
            priceBuffer: new Map() // Buffer para agregar updates
        };
        
        // === OPTIMIZED PRICE UPDATE HANDLER ===
        // Usando throttle + RAF para evitar layout thrashing
        window.priceUpdateCount = 0;
        window._priceUpdateQueue = new Map();
        window._priceFlushScheduled = false;
        
        // Flush price updates em batch usando RAF
        window._flushPriceUpdates = function() {
            if (window._priceUpdateQueue.size === 0) return;
            
            window.RAFBatch.add(() => {
                window._priceUpdateQueue.forEach((ticker, symbol) => {
                    window._processPriceUpdate(ticker);
                });
                window._priceUpdateQueue.clear();
                window._priceFlushScheduled = false;
            });
        };
        
        // Handler principal - agrega updates antes de processar
        window.handlePriceUpdate = function(ticker) {
            // Agregar no buffer (√∫ltimo pre√ßo ganha)
            window._priceUpdateQueue.set(ticker.symbol, ticker);
            
            // Agendar flush se n√£o estiver agendado
            if (!window._priceFlushScheduled) {
                window._priceFlushScheduled = true;
                // Flush a cada 100ms para evitar sobrecarga
                setTimeout(window._flushPriceUpdates, 100);
            }
        };
        
        // Processamento real do update (chamado em batch)
        window._processPriceUpdate = function(ticker) {
                // Count updates for debugging
                window.priceUpdateCount++;
                
                // === MY TRADES P&L UPDATE ===
                // Atualizar P&L em tempo real dos trades ativos
                if (window.myTrades && window.myTrades.length > 0 && typeof window.updateTradePrices === 'function') {
                    const activeTrades = window.myTrades.filter(t => t.status === 'active');
                    // S√≥ processa se tiver trades ativos que precisam desse s√≠mbolo
                    const hasRelevantTrade = activeTrades.some(t => 
                        t.symbol === ticker.symbol || 
                        t.symbol + 'USDT' === ticker.symbol ||
                        t.symbol === ticker.symbol.replace('USDT', '')
                    );
                    
                    if (hasRelevantTrade) {
                        const priceMap = {};
                        priceMap[ticker.symbol] = ticker.lastPrice;
                        window.updateTradePrices(priceMap);
                    }
                }
                
                // === HOT SIGNALS INTEGRATION ===
                // Enviar dados de pre√ßo para o HotSignals
                if (window.HotSignals && window.HotSignals.state.isActive) {
                    window.HotSignals.recordPriceUpdate(ticker.symbol, {
                        price: ticker.lastPrice,
                        volume: ticker.quoteVolume || ticker.volume,
                        change: ticker.priceChangePercent
                    });
                }
                
                // Flash the "Live Data" indicator on price updates (muito throttled)
                if (window.priceUpdateCount % 50 === 0) {
                    const liveIndicator = window.DOMCache.get('[data-key="live_data"]');
                    if (liveIndicator) {
                        liveIndicator.classList.add('animate-pulse', 'text-emerald-400');
                        setTimeout(() => {
                            liveIndicator.classList.remove('animate-pulse', 'text-emerald-400');
                        }, 200);
                    }
                }
                
                // Update any cards showing this symbol (usando cache)
                const cardId = `card-${ticker.symbol.toLowerCase()}`;
                const card = window.DOMCache.getById(cardId) || document.getElementById(cardId);
                if (card) {
                    const newPrice = ticker.lastPrice;
                    
                    // Update main price display (cache selector dentro do card)
                    const priceEl = card._priceEl || (card._priceEl = card.querySelector('.text-5xl.font-mono'));
                    if (priceEl) {
                        const oldText = priceEl.textContent;
                        const newText = window.formatPrice(newPrice);
                        
                        // S√≥ atualiza se mudou (evita reflow desnecess√°rio)
                        if (oldText !== newText) {
                            priceEl.textContent = newText;
                            // Anima√ß√£o leve s√≥ se mudan√ßa significativa
                            if (!priceEl._animating) {
                                priceEl._animating = true;
                                priceEl.classList.add('animate-pulse');
                                setTimeout(() => {
                                    priceEl.classList.remove('animate-pulse');
                                    priceEl._animating = false;
                                }, 300);
                            }
                        }
                    }
                    
                    // Update 24h change (com cache e skip se igual)
                    const changeEl = card._changeEl || (card._changeEl = card.querySelector('.text-sm.font-mono'));
                    if (changeEl && ticker.price24hPcnt !== undefined) {
                        const prefix = ticker.price24hPcnt >= 0 ? '+' : '';
                        const newPct = `${prefix}${ticker.price24hPcnt.toFixed(2)}%`;
                        
                        // Skip update se n√£o mudou
                        if (changeEl._lastPct !== newPct) {
                            changeEl._lastPct = newPct;
                            const color = ticker.price24hPcnt >= 0 ? 'text-emerald-500' : 'text-rose-500';
                            changeEl.className = `text-sm font-mono ${color} mt-2 flex items-center justify-center gap-1`;
                            changeEl.innerHTML = `${newPct} <span class="text-gray-600">(24h)</span>`;
                        }
                    }
                    
                    // Update RSI if available (simulated - in production would come from backend)
                    const rsiEl = card.querySelector('.rsi-value');
                    if (rsiEl) {
                        // Get current RSI from data attribute
                        let currentRSI = parseFloat(rsiEl.getAttribute('data-rsi')) || 50;
                        
                        // Simulate RSI movement based on price momentum
                        // In production, this should come from the backend with real calculation
                        if (ticker.price24hPcnt !== undefined) {
                            const priceChange = ticker.price24hPcnt;
                            
                            // Adjust RSI based on price momentum (simplified)
                            if (priceChange > 5) {
                                currentRSI = Math.min(85, currentRSI + 0.5);
                            } else if (priceChange > 2) {
                                currentRSI = Math.min(75, currentRSI + 0.3);
                            } else if (priceChange < -5) {
                                currentRSI = Math.max(15, currentRSI - 0.5);
                            } else if (priceChange < -2) {
                                currentRSI = Math.max(25, currentRSI - 0.3);
                            } else {
                                // Slight mean reversion towards 50
                                currentRSI = currentRSI > 50 ? currentRSI - 0.1 : currentRSI + 0.1;
                            }
                            
                            // Update RSI display
                            rsiEl.setAttribute('data-rsi', currentRSI.toFixed(1));
                            rsiEl.textContent = currentRSI.toFixed(1);
                            rsiEl.className = `text-sm ${currentRSI > 70 ? 'text-red-400' : currentRSI < 30 ? 'text-emerald-400' : 'text-white'} font-mono rsi-value`;
                        }
                    }
                    
                    // Update invalidation percentage
                    const invalidationEl = card.querySelector('.invalidation-price span');
                    if (invalidationEl) {
                        const invalidationPriceText = invalidationEl.parentElement.textContent.split(' ')[0];
                        const invalidationPrice = parseFloat(invalidationPriceText.replace(/[^0-9.-]/g, ''));
                        if (invalidationPrice) {
                            const percentDiff = Math.abs(((invalidationPrice - newPrice) / newPrice) * 100).toFixed(1);
                            invalidationEl.textContent = `(${percentDiff}%)`;
                        }
                    }
                    
                    // Check and update targets
                    const cardSymbol = ticker.symbol;
                    
                    // Initialize global targets tracking if not exists
                    if (!window.targetsHitState) {
                        window.targetsHitState = {};
                    }
                    if (!window.targetsHitState[cardSymbol]) {
                        window.targetsHitState[cardSymbol] = { tp1: false, tp2: false, tp3: false };
                    }
                    
                    // TP1
                    const tp1Line = card.querySelector('.target-tp1');
                    if (tp1Line) {
                        const tp1Price = parseFloat(tp1Line.getAttribute('data-target'));
                        const tp1Type = tp1Line.getAttribute('data-type');
                        const tp1Hit = tp1Line.getAttribute('data-hit') === 'true' || window.targetsHitState[cardSymbol].tp1;
                        
                        if (!tp1Hit && tp1Price) {
                            const hit = tp1Type === 'long' ? newPrice >= tp1Price : newPrice <= tp1Price;
                            if (hit) {
                                tp1Line.setAttribute('data-hit', 'true');
                                tp1Line.classList.remove('text-emerald-500/50');
                                tp1Line.classList.add('text-emerald-400');
                                const checkIcon = tp1Line.querySelector('.target-check');
                                if (checkIcon) {
                                    checkIcon.classList.remove('hidden');
                                    checkIcon.classList.add('animate-pulse');
                                    setTimeout(() => checkIcon.classList.remove('animate-pulse'), 2000);
                                }
                                
                                // Sync with global state and overlay
                                window.targetsHitState[cardSymbol].tp1 = true;
                                if (window.activeTargets && window.currentActiveSymbol === cardSymbol) {
                                    window.activeTargets.tp1Hit = true;
                                    const tp1StatusEl = document.getElementById('overlay-tp1-status');
                                    if (tp1StatusEl) {
                                        tp1StatusEl.classList.remove('hidden');
                                        tp1StatusEl.classList.add('animate-pulse');
                                    }
                                    const tp1El = document.getElementById('overlay-tp1');
                                    if (tp1El) tp1El.classList.add('line-through', 'opacity-50');
                                }
                                
                                // Save to history and update timeline
                                const opp1 = window.currentOpportunities?.find(o => o.symbol === cardSymbol);
                                if (typeof window.addTPToHistory === 'function') {
                                    window.addTPToHistory(cardSymbol, 'TP1', tp1Price, { ...opp1, currentPrice: newPrice });
                                }
                                
                                console.log(`üéØ TP1 HIT for ${ticker.symbol}!`);
                            }
                        }
                        
                        // Update percentage
                        const percentEl = tp1Line.querySelector('.target-percent');
                        if (percentEl && tp1Price) {
                            const diff = Math.abs(((tp1Price - newPrice) / newPrice) * 100).toFixed(1);
                            percentEl.textContent = `(${diff}%)`;
                        }
                    }
                    
                    // TP2
                    const tp2Line = card.querySelector('.target-tp2');
                    if (tp2Line) {
                        const tp2Price = parseFloat(tp2Line.getAttribute('data-target'));
                        const tp2Type = tp2Line.getAttribute('data-type');
                        const tp2Hit = tp2Line.getAttribute('data-hit') === 'true' || window.targetsHitState[cardSymbol].tp2;
                        
                        if (!tp2Hit && tp2Price) {
                            const hit = tp2Type === 'long' ? newPrice >= tp2Price : newPrice <= tp2Price;
                            if (hit) {
                                tp2Line.setAttribute('data-hit', 'true');
                                tp2Line.classList.remove('text-emerald-500/30');
                                tp2Line.classList.add('text-emerald-400');
                                const checkIcon = tp2Line.querySelector('.target-check');
                                if (checkIcon) {
                                    checkIcon.classList.remove('hidden');
                                    checkIcon.classList.add('animate-pulse');
                                    setTimeout(() => checkIcon.classList.remove('animate-pulse'), 2000);
                                }
                                
                                // Sync with global state and overlay
                                window.targetsHitState[cardSymbol].tp2 = true;
                                if (window.activeTargets && window.currentActiveSymbol === cardSymbol) {
                                    window.activeTargets.tp2Hit = true;
                                    const tp2StatusEl = document.getElementById('overlay-tp2-status');
                                    if (tp2StatusEl) {
                                        tp2StatusEl.classList.remove('hidden');
                                        tp2StatusEl.classList.add('animate-pulse');
                                    }
                                    const tp2El = document.getElementById('overlay-tp2');
                                    if (tp2El) tp2El.classList.add('line-through', 'opacity-50');
                                }
                                
                                // Save to history and update timeline
                                const opp2 = window.currentOpportunities?.find(o => o.symbol === cardSymbol);
                                if (typeof window.addTPToHistory === 'function') {
                                    window.addTPToHistory(cardSymbol, 'TP2', tp2Price, { ...opp2, currentPrice: newPrice });
                                }
                                
                                console.log(`üéØ TP2 HIT for ${ticker.symbol}!`);
                            }
                        }
                        
                        // Update percentage
                        const percentEl = tp2Line.querySelector('.target-percent');
                        if (percentEl && tp2Price) {
                            const diff = Math.abs(((tp2Price - newPrice) / newPrice) * 100).toFixed(1);
                            percentEl.textContent = `(${diff}%)`;
                        }
                    }
                    
                    // TP3
                    const tp3Line = card.querySelector('.target-tp3');
                    if (tp3Line) {
                        const tp3Price = parseFloat(tp3Line.getAttribute('data-target'));
                        const tp3Type = tp3Line.getAttribute('data-type');
                        const tp3Hit = tp3Line.getAttribute('data-hit') === 'true' || window.targetsHitState[cardSymbol].tp3;
                        
                        if (!tp3Hit && tp3Price) {
                            const hit = tp3Type === 'long' ? newPrice >= tp3Price : newPrice <= tp3Price;
                            if (hit) {
                                tp3Line.setAttribute('data-hit', 'true');
                                tp3Line.classList.remove('text-emerald-500/30');
                                tp3Line.classList.add('text-emerald-400');
                                const checkIcon = tp3Line.querySelector('.target-check');
                                if (checkIcon) {
                                    checkIcon.classList.remove('hidden');
                                    checkIcon.classList.add('animate-pulse');
                                    setTimeout(() => checkIcon.classList.remove('animate-pulse'), 2000);
                                }
                                
                                // Sync with global state and overlay
                                window.targetsHitState[cardSymbol].tp3 = true;
                                if (window.activeTargets && window.currentActiveSymbol === cardSymbol) {
                                    window.activeTargets.tp3Hit = true;
                                    const tp3StatusEl = document.getElementById('overlay-tp3-status');
                                    if (tp3StatusEl) {
                                        tp3StatusEl.classList.remove('hidden');
                                        tp3StatusEl.classList.add('animate-pulse');
                                    }
                                    const tp3El = document.getElementById('overlay-tp3');
                                    if (tp3El) tp3El.classList.add('line-through', 'opacity-50');
                                }
                                
                                // Save to history and update timeline
                                const opp3 = window.currentOpportunities?.find(o => o.symbol === cardSymbol);
                                if (typeof window.addTPToHistory === 'function') {
                                    window.addTPToHistory(cardSymbol, 'TP3', tp3Price, { ...opp3, currentPrice: newPrice });
                                }
                                
                                console.log(`üéØ TP3 HIT for ${ticker.symbol}!`);
                                
                                // Mark opportunity as COMPLETED when TP3 is hit
                                window.markOpportunityCompleted(cardSymbol, 'all_targets');
                            }
                        }
                        
                        // Update percentage
                        const percentEl = tp3Line.querySelector('.target-percent');
                        if (percentEl && tp3Price) {
                            const diff = Math.abs(((tp3Price - newPrice) / newPrice) * 100).toFixed(1);
                            percentEl.textContent = `(${diff}%)`;
                        }
                    }
                    
                    // Check STOP LOSS on cards
                    const stopLossEl = card.querySelector('.invalidation-price');
                    if (stopLossEl && !window.targetsHitState[cardSymbol]?.stopHit) {
                        const stopLossText = stopLossEl.textContent.split(' ')[0];
                        const stopPrice = parseFloat(stopLossText.replace(/[^0-9.-]/g, ''));
                        if (stopPrice) {
                            const trend = card.querySelector('[data-lucide="trending-up"]') ? 'long' : 'short';
                            const stopHit = trend === 'long' ? newPrice <= stopPrice : newPrice >= stopPrice;
                            
                            if (stopHit) {
                                console.log(`‚ùå STOP LOSS HIT for ${ticker.symbol}!`);
                                window.targetsHitState[cardSymbol].stopHit = true;
                                
                                // Save to history and update timeline
                                const oppSL = window.currentOpportunities?.find(o => o.symbol === cardSymbol);
                                if (typeof window.addSLToHistory === 'function') {
                                    window.addSLToHistory(cardSymbol, stopPrice, newPrice, oppSL);
                                }
                                
                                // Mark opportunity as STOPPED
                                window.markOpportunityCompleted(cardSymbol, 'stop_loss');
                            }
                        }
                    }
                    
                    // Update signal badge based on proximity to entry
                    const signalBadge = card.querySelector('.signal-badge');
                    if (signalBadge) {
                        const entryPrice = parseFloat(signalBadge.getAttribute('data-entry'));
                        const trend = signalBadge.getAttribute('data-trend');
                        const trendColor = trend === 'bullish' ? 'emerald' : 'rose';
                        
                        if (entryPrice) {
                            const diffPercent = Math.abs((newPrice - entryPrice) / entryPrice);
                            
                            // Check if entered entry zone (within 2%)
                            if (diffPercent < 0.02 && !window.targetsHitState[cardSymbol]?.zoneHit) {
                                // Track that zone was hit
                                window.targetsHitState[cardSymbol].zoneHit = true;
                                window.targetsHitState[cardSymbol].zoneHitTime = Date.now();
                                
                                // Update timeline if modal is open for this symbol
                                if (typeof window.updateTradeTimeline === 'function') {
                                    window.updateTradeTimeline(cardSymbol, 'ZONE', Date.now());
                                }
                                
                                // ===== SYNC ZONE HIT WITH SUPABASE =====
                                if (typeof SupabaseService !== 'undefined' && SupabaseService.markTargetHit) {
                                    // Use tp_index = -1 to indicate zone hit
                                    SupabaseService.markTargetHit(cardSymbol, -1, newPrice, trend)
                                        .then(result => {
                                            if (result) console.log(`‚òÅÔ∏è Supabase: ${cardSymbol} ZONE HIT synced`);
                                        })
                                        .catch(err => console.warn(`‚òÅÔ∏è Supabase zone sync failed:`, err));
                                }
                                
                                console.log(`üìç ENTRY ZONE HIT for ${cardSymbol}!`);
                            }
                            
                            let badgeHTML = '';
                            if (diffPercent < 0.02) {
                                // In zone (within 2%)
                                badgeHTML = `<span class="flex items-center gap-1.5 px-2 py-0.5 rounded bg-${trendColor}-900/20 border border-${trendColor}-500/20 text-[10px] font-mono text-${trendColor}-400 uppercase tracking-wide">
                                    <span class="w-1 h-1 rounded-full bg-${trendColor}-500 animate-pulse"></span>
                                    ${trend === 'bullish' ? t('zone_buy') : t('zone_sell')}
                                </span>`;
                            } else if (diffPercent < 0.05) {
                                // Approaching (within 5%)
                                badgeHTML = `<span class="flex items-center gap-1.5 px-2 py-0.5 rounded bg-amber-900/20 border border-amber-500/20 text-[10px] font-mono text-amber-500 uppercase tracking-wide">
                                    <span class="w-1 h-1 rounded-full bg-amber-500 animate-pulse"></span>
                                    ${t('warn_approach')}
                                </span>`;
                            } else {
                                // Standby
                                badgeHTML = `<span class="flex items-center gap-1.5 px-2 py-0.5 rounded bg-zinc-900/20 border border-zinc-500/20 text-[10px] font-mono text-zinc-400 uppercase tracking-wide">
                                    <span class="w-1 h-1 rounded-full bg-zinc-500"></span>
                                    ${t('standby_badge')}
                                </span>`;
                            }
                            
                            if (signalBadge.innerHTML !== badgeHTML) {
                                signalBadge.innerHTML = badgeHTML;
                            }
                        }
                    }
                }
                
                // Update overlay current price if this is the active symbol
                const currentEl = window.DOMCache.getById('overlay-current');
                if (currentEl) {
                    const activeSymbol = currentEl.dataset.symbol || window.currentActiveSymbol;
                    if (activeSymbol === ticker.symbol || activeSymbol === ticker.symbol.replace('USDT', '')) {
                        const newPriceText = window.formatPrice(ticker.lastPrice);
                        if (currentEl.textContent !== newPriceText) {
                            currentEl.textContent = newPriceText;
                        }
                        
                        // Update overlay target percentages in real-time (cached)
                        const overlayTp1 = window.DOMCache.getById('overlay-tp1');
                        const overlayTp2 = window.DOMCache.getById('overlay-tp2');
                        const overlayTp3 = window.DOMCache.getById('overlay-tp3');
                        const overlayStopLoss = window.DOMCache.getById('overlay-stoploss');
                        
                        if (overlayTp1 && overlayTp1.dataset.price) {
                            const tp1Price = parseFloat(overlayTp1.dataset.price);
                            const tp1Pct = Math.abs(((tp1Price - ticker.lastPrice) / ticker.lastPrice) * 100).toFixed(1);
                            const isBullish = window.activeTargets?.isLong;
                            overlayTp1.innerHTML = `${window.formatPrice(tp1Price)} <span class="${isBullish ? 'text-emerald-500/50' : 'text-rose-500/50'}">(${tp1Pct}%)</span>`;
                        }
                        
                        if (overlayTp2 && overlayTp2.dataset.price) {
                            const tp2Price = parseFloat(overlayTp2.dataset.price);
                            const tp2Pct = Math.abs(((tp2Price - ticker.lastPrice) / ticker.lastPrice) * 100).toFixed(1);
                            const isBullish = window.activeTargets?.isLong;
                            overlayTp2.innerHTML = `${window.formatPrice(tp2Price)} <span class="${isBullish ? 'text-emerald-500/50' : 'text-rose-500/50'}">(${tp2Pct}%)</span>`;
                        }
                        
                        if (overlayTp3 && overlayTp3.dataset.price) {
                            const tp3Price = parseFloat(overlayTp3.dataset.price);
                            const tp3Pct = Math.abs(((tp3Price - ticker.lastPrice) / ticker.lastPrice) * 100).toFixed(1);
                            const isBullish = window.activeTargets?.isLong;
                            overlayTp3.innerHTML = `${window.formatPrice(tp3Price)} <span class="${isBullish ? 'text-emerald-500/50' : 'text-rose-500/50'}">(${tp3Pct}%)</span>`;
                        }
                        
                        if (overlayStopLoss && overlayStopLoss.dataset.price) {
                            const slPrice = parseFloat(overlayStopLoss.dataset.price);
                            const slPct = Math.abs(((slPrice - ticker.lastPrice) / ticker.lastPrice) * 100).toFixed(1);
                            overlayStopLoss.innerHTML = `${window.formatPrice(slPrice)} <span class="text-rose-500/50">(-${slPct}%)</span>`;
                        }
                        
                        // Flash effect on price update (throttled para evitar spam)
                        if (!currentEl._animating) {
                            currentEl._animating = true;
                            currentEl.classList.add('animate-pulse');
                            setTimeout(() => {
                                currentEl.classList.remove('animate-pulse');
                                currentEl._animating = false;
                            }, 500);
                        }
                        
                        // Fun√ß√£o para atualizar o Trade Status Box no sidebar
                        function updateTradeStatusBox(type, target, price, symbol) {
                            const statusBox = document.getElementById('trade-status-box');
                            const statusContent = document.getElementById('trade-status-content');
                            if (!statusBox || !statusContent) return;
                            
                            statusBox.classList.remove('hidden');
                            
                            if (type === 'stop') {
                                statusContent.className = 'p-4 rounded-lg border border-rose-500/50 bg-rose-500/10';
                                statusContent.innerHTML = `
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">‚ùå</span>
                                        <div>
                                            <div class="text-rose-400 font-bold text-sm">STOP LOSS ATINGIDO</div>
                                            <div class="text-rose-300/70 text-xs">${symbol}</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs mt-3 pt-2 border-t border-rose-500/20">
                                        <span class="text-zinc-400">Stop: <span class="text-rose-400">${target?.toFixed(6) || '--'}</span></span>
                                        <span class="text-zinc-400">Pre√ßo: <span class="text-white">${price?.toFixed(6) || '--'}</span></span>
                                    </div>
                                    <p class="text-[10px] text-rose-300/60 mt-2">Opera√ß√£o invalidada. Removida da lista de oportunidades.</p>
                                `;
                            } else if (type.startsWith('tp')) {
                                const tpNum = type.replace('tp', '');
                                statusContent.className = 'p-4 rounded-lg border border-emerald-500/50 bg-emerald-500/10';
                                statusContent.innerHTML = `
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">üéØ</span>
                                        <div>
                                            <div class="text-emerald-400 font-bold text-sm">ALVO ${tpNum} ATINGIDO!</div>
                                            <div class="text-emerald-300/70 text-xs">${symbol}</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs mt-3 pt-2 border-t border-emerald-500/20">
                                        <span class="text-zinc-400">Target: <span class="text-emerald-400">${target?.toFixed(6) || '--'}</span></span>
                                        <span class="text-zinc-400">Pre√ßo: <span class="text-white">${price?.toFixed(6) || '--'}</span></span>
                                    </div>
                                    <p class="text-[10px] text-emerald-300/60 mt-2">‚úì Parcial realizada. ${tpNum === '3' ? 'Trade conclu√≠do!' : 'Aguardando pr√≥ximos alvos.'}</p>
                                `;
                            }
                        }
                        
                        // Check if targets or stop loss were hit
                        if (window.activeTargets) {
                            const targets = window.activeTargets;
                            const price = ticker.lastPrice;
                            const isLong = targets.isLong;
                            
                            // Check TP1
                            if (targets.tp1 && !targets.tp1Hit) {
                                const tp1Hit = isLong ? price >= targets.tp1 : price <= targets.tp1;
                                if (tp1Hit) {
                                    targets.tp1Hit = true;
                                    const tp1StatusEl = document.getElementById('overlay-tp1-status');
                                    if (tp1StatusEl) {
                                        tp1StatusEl.classList.remove('hidden');
                                        tp1StatusEl.classList.add('animate-pulse');
                                    }
                                    const tp1El = document.getElementById('overlay-tp1');
                                    if (tp1El) tp1El.classList.add('line-through', 'opacity-50');
                                    console.log('üéØ TP1 HIT!');
                                    updateTradeStatusBox('tp1', targets.tp1, price, ticker.symbol);
                                    
                                    // Add to TP history
                                    const currentOpp = (window.currentOpportunities || []).find(o => o.symbol === ticker.symbol);
                                    if (window.addTPToHistory) {
                                        window.addTPToHistory(ticker.symbol, 'TP1', targets.tp1, currentOpp);
                                    }
                                }
                            }
                            
                            // Check TP2
                            if (targets.tp2 && !targets.tp2Hit) {
                                const tp2Hit = isLong ? price >= targets.tp2 : price <= targets.tp2;
                                if (tp2Hit) {
                                    targets.tp2Hit = true;
                                    const tp2StatusEl = document.getElementById('overlay-tp2-status');
                                    if (tp2StatusEl) {
                                        tp2StatusEl.classList.remove('hidden');
                                        tp2StatusEl.classList.add('animate-pulse');
                                    }
                                    const tp2El = document.getElementById('overlay-tp2');
                                    if (tp2El) tp2El.classList.add('line-through', 'opacity-50');
                                    console.log('üéØ TP2 HIT!');
                                    updateTradeStatusBox('tp2', targets.tp2, price, ticker.symbol);
                                    
                                    // Add to TP history
                                    const currentOpp = (window.currentOpportunities || []).find(o => o.symbol === ticker.symbol);
                                    if (window.addTPToHistory) {
                                        window.addTPToHistory(ticker.symbol, 'TP2', targets.tp2, currentOpp);
                                    }
                                }
                            }
                            
                            // Check TP3
                            if (targets.tp3 && !targets.tp3Hit) {
                                const tp3Hit = isLong ? price >= targets.tp3 : price <= targets.tp3;
                                if (tp3Hit) {
                                    targets.tp3Hit = true;
                                    const tp3StatusEl = document.getElementById('overlay-tp3-status');
                                    if (tp3StatusEl) {
                                        tp3StatusEl.classList.remove('hidden');
                                        tp3StatusEl.classList.add('animate-pulse');
                                    }
                                    const tp3El = document.getElementById('overlay-tp3');
                                    if (tp3El) tp3El.classList.add('line-through', 'opacity-50');
                                    console.log('üéØ TP3 HIT! All targets completed!');
                                    updateTradeStatusBox('tp3', targets.tp3, price, ticker.symbol);
                                    
                                    // Add to TP history
                                    const currentOpp = (window.currentOpportunities || []).find(o => o.symbol === ticker.symbol);
                                    if (window.addTPToHistory) {
                                        window.addTPToHistory(ticker.symbol, 'TP3', targets.tp3, currentOpp);
                                    }
                                    
                                    // =====================================================
                                    // ALL TARGETS HIT: Remover oportunidade da lista
                                    // =====================================================
                                    window.markOpportunityCompleted(ticker.symbol, 'all_targets');
                                }
                            }
                            
                            // Check Stop Loss
                            if (targets.stopLoss && !targets.slHit) {
                                const slHit = isLong ? price <= targets.stopLoss : price >= targets.stopLoss;
                                if (slHit) {
                                    targets.slHit = true;
                                    const slStatusEl = document.getElementById('overlay-sl-status');
                                    if (slStatusEl) {
                                        slStatusEl.classList.remove('hidden');
                                        slStatusEl.classList.add('animate-pulse');
                                    }
                                    const stopLossEl = document.getElementById('overlay-stoploss');
                                    if (stopLossEl) stopLossEl.classList.add('line-through', 'opacity-50');
                                    console.log('‚ùå STOP LOSS HIT!');
                                    updateTradeStatusBox('stop', targets.stopLoss, price, ticker.symbol);
                                    
                                    // Add to SL history
                                    const currentOpp = (window.currentOpportunities || []).find(o => o.symbol === ticker.symbol);
                                    if (window.addSLToHistory) {
                                        window.addSLToHistory(ticker.symbol, targets.stopLoss, price, currentOpp);
                                    }
                                    
                                    // =====================================================
                                    // STOP HIT: Remover oportunidade da lista
                                    // =====================================================
                                    window.markOpportunityCompleted(ticker.symbol, 'stop_loss');
                                }
                            }
                        }
                    }
                }
                
                // Update R:R ratio in real-time (prefer backend-calculated values)
                const rrEl = document.getElementById('overlay-rr');
                const stopLossEl = document.getElementById('overlay-stoploss');
                const tp1El = document.getElementById('overlay-tp1');
                if (rrEl && stopLossEl && tp1El && currentEl?.dataset.symbol === ticker.symbol) {
                    // Check if we have pre-calculated R:R from backend
                    const preCalcRR = currentEl.dataset?.rrTp1 || rrEl.dataset?.preCalc;
                    if (preCalcRR && preCalcRR !== '--') {
                        rrEl.textContent = `1:${preCalcRR}`;
                    } else {
                        // Fallback: Calculate R:R in real-time
                        const slPrice = parseFloat(stopLossEl.dataset?.price) || parseFloat(stopLossEl.textContent?.split(' ')[0]?.replace(/[^0-9.-]/g, '')) || 0;
                        const tp1Price = parseFloat(tp1El.dataset?.price) || parseFloat(tp1El.textContent?.split(' ')[0]?.replace(/[^0-9.-]/g, '')) || 0;
                        if (slPrice && tp1Price) {
                            const risk = Math.abs(ticker.lastPrice - slPrice);
                            const reward = Math.abs(tp1Price - ticker.lastPrice);
                            const rr = risk > 0 ? (reward / risk).toFixed(2) : '--';
                            rrEl.textContent = `1:${rr}`;
                        }
                    }
                }
                
                // Notify subscribers (if available)
                // Legacy - no longer using OpportunitiesService
        };
        
        // Function to subscribe to symbols dynamically
        window.subscribeToSymbols = function(symbols) {
            if (typeof BinanceAPI === 'undefined') {
                console.log('‚ö†Ô∏è BinanceAPI not loaded, skipping WebSocket');
                return;
            }
            
            if (!Array.isArray(symbols) || symbols.length === 0) {
                console.log('‚ö†Ô∏è No symbols to subscribe');
                return;
            }
            
            // Normalize symbols (ensure USDT suffix)
            const normalizedSymbols = symbols.map(s => {
                const sym = s.toUpperCase();
                return sym.endsWith('USDT') ? sym : sym + 'USDT';
            });
            
            // Check which symbols are new
            const newSymbols = normalizedSymbols.filter(s => !window.realtimePriceState.subscribedSymbols.has(s));
            
            if (newSymbols.length === 0) {
                console.log('üì° All symbols already subscribed');
                return;
            }
            
            console.log(`üì° Subscribing to ${newSymbols.length} new symbols:`, newSymbols.slice(0, 10), newSymbols.length > 10 ? `... and ${newSymbols.length - 10} more` : '');
            
            // Add to subscribed set
            newSymbols.forEach(s => window.realtimePriceState.subscribedSymbols.add(s));

            // Subscribe/reconnect with all symbols (BinanceAPI handles chunking + reconnection)
            const allSymbols = Array.from(window.realtimePriceState.subscribedSymbols);
            console.log(`üì° Total subscribed symbols: ${allSymbols.length}`);
            BinanceAPI.subscribeToTicker(allSymbols, window.handlePriceUpdate);
        };
        
        // Initial subscription with symbols from Supabase opportunities
        // Will be called after data loads from Supabase
        window.initRealtimePrices = function(symbols) {
            if (typeof BinanceAPI === 'undefined') {
                console.log('‚ö†Ô∏è BinanceAPI not loaded, skipping WebSocket');
                return;
            }
            
            // Use provided symbols or fallback to major ones
            const subscribeSymbols = symbols && symbols.length > 0 ? symbols : [
                'BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT'
            ];
            
            console.log(`üì° Starting Binance Futures WebSocket with ${subscribeSymbols.length} symbols...`);
            window.subscribeToSymbols(subscribeSymbols);
        };
        
        // Start with minimal symbols, will be updated after Supabase data loads
        (function() {
            if (typeof BinanceAPI === 'undefined') {
                console.log('‚ö†Ô∏è BinanceAPI not loaded, skipping WebSocket');
                return;
            }
            // Subscribe to BTC only initially, rest will come from Supabase
            console.log('üì° Starting minimal WebSocket (waiting for Supabase data)...');
            window.subscribeToSymbols(['BTCUSDT']);
        })();

        // --- COMPLETED OPPORTUNITIES MANAGEMENT ---
        // Oportunidades s√£o REMOVIDAS quando batem STOP ou TODOS os ALVOS (TP3)
        window.completedOpportunities = new Map(); // symbol -> { reason: 'stop_loss' | 'all_targets', timestamp: Date }
        
        window.markOpportunityCompleted = function(symbol, reason) {
            if (!symbol) return;
            
            // Evitar duplica√ß√£o
            if (window.completedOpportunities.has(symbol)) {
                console.log(`üìã ${symbol} already marked as completed`);
                return;
            }
            
            const timestamp = new Date().toISOString();
            window.completedOpportunities.set(symbol, { reason, timestamp });
            
            const isStop = reason === 'stop_loss';
            // Notifica√ß√µes removidas
            
            // 2. Remover card da interface com anima√ß√£o
            const card = document.getElementById(`card-${symbol.toLowerCase()}`);
            if (card) {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => card.remove(), 500);
            }
            
            // 3. Remover do array de oportunidades ativas
            if (window.currentOpportunities) {
                window.currentOpportunities = window.currentOpportunities.filter(o => o.symbol !== symbol);
            }
            
            // 4. Atualizar contador de an√°lises
            const statEl = document.getElementById('stat-confirmed');
            if (statEl) {
                statEl.textContent = window.currentOpportunities?.length || 0;
            }
            
            // 5. Fechar modal se este ativo estiver aberto
            if (window.currentActiveSymbol === symbol) {
                setTimeout(() => {
                    if (typeof closeDetail === 'function') closeDetail();
                }, 2000);
            }
            
            console.log(`üìã Opportunity ${symbol} marked as ${reasonLabel} and REMOVED from list`);
            
            // 6. Atualizar no Supabase (marcar como inativo)
            if (typeof SupabaseService !== 'undefined' && SupabaseService.supabase) {
                SupabaseService.supabase
                    .from('opportunities')
                    .update({ 
                        is_active: false, 
                        completed_at: timestamp,
                        completed_reason: reason
                    })
                    .eq('symbol', symbol)
                    .then(({ error }) => {
                        if (error) console.error('Erro ao atualizar status:', error);
                        else console.log(`‚òÅÔ∏è ${symbol} marked as ${reason} in database`);
                    });
            }
        };
        
        // Check if opportunity should be shown (not completed)
        window.isOpportunityActive = function(symbol) {
            return !window.completedOpportunities.has(symbol);
        };

        // --- HELPER FUNCTIONS ---
        // Local alias for convenience (global formatPrice defined at top of script)
        function formatPrice(price) { return window.formatPrice(price); }

        // Store current opportunities for reference
        window.currentOpportunities = [];
        window.currentWatchlist = [];
        
        // Cache for ALL opportunities (unfiltered) - used for modal lookups
        window.allOpportunitiesCache = [];
        window.allWatchlistCache = [];
        
        // DATA ADAPTER: Map Supabase schema to Dashboard format (global function)
        window.adaptOpportunity = function(item) {
                const currentPrice = item.entry_price || item.current_price || 0;
                const rawDirection = item.direction || item.trend || item.signal_direction || item.signal_trend || 'bullish';
                const direction = rawDirection === 'alta' ? 'bullish' : (rawDirection === 'baixa' ? 'bearish' : rawDirection);
                const isLong = direction !== 'bearish';
                    
                    // PRIORIDADE: Usar targets do banco (target_1, target_2, target_3)
                    // Estes s√£o calculados automaticamente pelo trigger SQL
                    let tp1 = item.target_1;
                    let tp2 = item.target_2;
                    let tp3 = item.target_3;
                    
                    // FALLBACK 1: Calcular dos fibonacci_extensions se targets n√£o existem
                    if (!tp1 || !tp2 || !tp3) {
                        // fibonacci_extensions s√£o multiplicadores de Fib (ex: 1.1, 1.272, 1.414)
                        // Aplicar ao range entre entry e stop_loss
                        const fibExtensions = item.fibonacci_extensions || [];
                        const stopLoss = item.stop_loss || item.invalidation || currentPrice * (isLong ? 0.95 : 1.05);
                        const risk = Math.abs(currentPrice - stopLoss);
                        
                        if (fibExtensions.length >= 3 && risk > 0) {
                            // Usar extens√µes Fibonacci corretas (multiplicam o risco)
                            if (isLong) {
                                tp1 = tp1 || currentPrice + risk * fibExtensions[0];
                                tp2 = tp2 || currentPrice + risk * fibExtensions[1];
                                tp3 = tp3 || currentPrice + risk * fibExtensions[2];
                            } else {
                                tp1 = tp1 || currentPrice - risk * fibExtensions[0];
                                tp2 = tp2 || currentPrice - risk * fibExtensions[1];
                                tp3 = tp3 || currentPrice - risk * fibExtensions[2];
                            }
                        } else {
                            // FALLBACK 2: Extens√µes padr√£o baseadas no perfil de trading
                            const profile = item.trading_profile || 'Day Trading';
                            let defaultExtensions;
                            if (profile.includes('Scalping')) {
                                defaultExtensions = [1.1, 1.272, 1.414]; // Alvos curtos
                            } else if (profile.includes('Day')) {
                                defaultExtensions = [1.272, 1.414, 1.618]; // Alvos m√©dios
                            } else {
                                defaultExtensions = [1.272, 1.618, 2.0]; // Alvos longos (Swing)
                            }
                            
                            if (isLong) {
                                tp1 = tp1 || currentPrice + risk * defaultExtensions[0];
                                tp2 = tp2 || currentPrice + risk * defaultExtensions[1];
                                tp3 = tp3 || currentPrice + risk * defaultExtensions[2];
                            } else {
                                tp1 = tp1 || currentPrice - risk * defaultExtensions[0];
                                tp2 = tp2 || currentPrice - risk * defaultExtensions[1];
                                tp3 = tp3 || currentPrice - risk * defaultExtensions[2];
                            }
                        }
                    }
                    
                    // Entry Zone (OTE) - Prioridade: campos do banco > Fibonacci calculado
                    let entryZone = null;
                    if (item.entry_zone_min && item.entry_zone_max) {
                        entryZone = {
                            min: parseFloat(item.entry_zone_min),
                            max: parseFloat(item.entry_zone_max)
                        };
                    } else if (item.entry_zone_start && item.entry_zone_end) {
                        // Usar entry_zone_start e entry_zone_end do banco
                        entryZone = {
                            min: Math.min(parseFloat(item.entry_zone_start), parseFloat(item.entry_zone_end)),
                            max: Math.max(parseFloat(item.entry_zone_start), parseFloat(item.entry_zone_end))
                        };
                    } else if (item.fib_500 && item.fib_618) {
                        // Fallback: calcular a partir de Fibonacci do banco
                        entryZone = {
                            min: Math.min(parseFloat(item.fib_500), parseFloat(item.fib_618)),
                            max: Math.max(parseFloat(item.fib_500), parseFloat(item.fib_618))
                        };
                    }
                    
                    // Fibonacci levels - CALCULAR se n√£o vier do banco
                    const fibonacci = {};
                    let safeRange = 0;
                    
                    // Prioridade 1: usar Fibonacci do banco se dispon√≠vel (nomes corretos: fib_382, fib_500, fib_618)
                    if (item.fib_382 && item.fib_500 && item.fib_618) {
                        // Banco tem Fibonacci - usar direto
                        fibonacci['0.382'] = parseFloat(item.fib_382);
                        fibonacci['0.5'] = parseFloat(item.fib_500);
                        fibonacci['0.618'] = parseFloat(item.fib_618);
                        if (item.fib_786) fibonacci['0.786'] = parseFloat(item.fib_786);
                        safeRange = Math.abs(parseFloat(item.fib_618) - parseFloat(item.fib_382));
                    } else {
                        // Prioridade 2: calcular a partir de stop_loss
                        const stopLoss = item.stop_loss || item.invalidation?.price || item.invalidation || 0;
                        
                        if (stopLoss > 0 && currentPrice > 0 && isFinite(stopLoss) && isFinite(currentPrice)) {
                            const riskDistance = Math.abs(currentPrice - stopLoss);
                            if (riskDistance > 0 && isFinite(riskDistance)) {
                                safeRange = riskDistance * 0.618; // Usar range conservador
                            }
                        }
                        
                        // Prioridade 3: fallback m√≠nimo de 2% do pre√ßo
                        if (safeRange === 0 || !isFinite(safeRange)) {
                            safeRange = Math.max(currentPrice * 0.02, 0.00001); // M√≠nimo v√°lido
                        }
                        
                        // Calcular n√≠veis de Fib baseado no range
                        if (isLong) {
                            fibonacci['0.382'] = currentPrice - (safeRange * 0.382);
                            fibonacci['0.5'] = currentPrice - (safeRange * 0.5);
                            fibonacci['0.618'] = currentPrice - (safeRange * 0.618);
                            fibonacci['0.786'] = currentPrice - (safeRange * 0.786);
                        } else {
                            fibonacci['0.382'] = currentPrice + (safeRange * 0.382);
                            fibonacci['0.5'] = currentPrice + (safeRange * 0.5);
                            fibonacci['0.618'] = currentPrice + (safeRange * 0.618);
                            fibonacci['0.786'] = currentPrice + (safeRange * 0.786);
                        }
                    }
                    
                    // Validar que todos os n√≠veis s√£o n√∫meros v√°lidos
                    Object.keys(fibonacci).forEach(key => {
                        if (!isFinite(fibonacci[key]) || fibonacci[key] <= 0) {
                            fibonacci[key] = currentPrice; // Fallback ao pre√ßo atual
                        }
                    });
                    
                    // Conflu√™ncias do term√¥metro
                    let positiveConf = [];
                    let negativeConf = [];
                    
                    if (item.positive_confluences) {
                        positiveConf = Array.isArray(item.positive_confluences) 
                            ? item.positive_confluences 
                            : (typeof item.positive_confluences === 'string' 
                                ? JSON.parse(item.positive_confluences) 
                                : []);
                    }
                    if (item.negative_confluences) {
                        negativeConf = Array.isArray(item.negative_confluences) 
                            ? item.negative_confluences 
                            : (typeof item.negative_confluences === 'string' 
                                ? JSON.parse(item.negative_confluences) 
                                : []);
                    }
                    
                    const contextLines = (() => {
                            const dbLines = [
                                item.context_line_1,
                                item.context_line_2,
                                item.context_line_3,
                                item.context_line_4
                            ].filter(l => l && l.trim().length > 0);
                            
                            // Se tem linhas do banco, usar
                            if (dbLines.length > 0) return dbLines;
                            
                            // Tentar gerar via biblioteca institucional
                            if (window.SHDWXBTContext && typeof window.SHDWXBTContext.buildContextLines === 'function') {
                                try {
                                    const built = window.SHDWXBTContext.buildContextLines({ ...item, direction });
                                    const mapped = (built || []).map(l => (typeof l === 'string' ? l : l?.text)).filter(Boolean);
                                    if (mapped.length > 0) return mapped;
                                } catch (e) {}
                            }
                            
                            // Sen√£o, gerar linhas baseadas nos dados t√©cnicos dispon√≠veis
                            const generatedLines = [];
                            const tfTarget = item.target_timeframe || '4h';
                            const tfAnchor = item.anchor_timeframe || 'Di√°rio';
                            const setupType = item.setup_type || item.setup || (direction === 'bullish' ? 'fundo ascendente' : 'topo descendente');
                            const tradingProfile = (item.trading_profile || 'day_trading').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                            
                            // Linha 1: Setup identificado
                            generatedLines.push(`${tradingProfile} - Configura√ß√£o de ${setupType} identificada.`);
                            
                            // Linha 2: Tend√™ncia √¢ncora
                            const anchorTrend = direction === 'bullish' ? 'alta' : 'baixa';
                            generatedLines.push(`Tend√™ncia no tempo gr√°fico √¢ncora (${tfAnchor}): ${anchorTrend}. O tempo gr√°fico ${tfTarget} est√° em corre√ß√£o.`);
                            
                            // Linha 3: Fibonacci Zone (se dispon√≠vel)
                            const fibZone = item.premium_discount || item.fib_zone;
                            if (fibZone === 'discount' || fibZone === 'desconto') {
                                generatedLines.push(`‚óÜ Pre√ßo atual na zona de desconto (favor√°vel para compra) da retra√ß√£o de Fibonacci.`);
                            } else if (fibZone === 'premium' || fibZone === 'pr√™mio') {
                                generatedLines.push(`‚óÜ Pre√ßo atual na zona de pr√™mio (favor√°vel para venda) da retra√ß√£o de Fibonacci.`);
                            } else {
                                generatedLines.push(`Pre√ßo atual na zona de equil√≠brio de Fibonacci.`);
                            }
                            
                            // Linha 4: RSI
                            const rsi = item.rsi_value || item.rsi;
                            if (rsi) {
                                const rsiStatus = rsi > 70 ? 'sobrecompra' : rsi < 30 ? 'sobrevenda' : 'neutro';
                                const rsiAction = direction === 'bullish'
                                    ? (rsi < 50 ? 'Aguardar confirma√ß√£o de fundo para entrada em compra.' : 'RSI j√° em regi√£o favor√°vel.')
                                    : (rsi > 50 ? 'Aguardar confirma√ß√£o de topo para entrada em venda.' : 'RSI j√° em regi√£o favor√°vel.');
                                generatedLines.push(`‚óÜ RSI(14): ${Number(rsi).toFixed(1)} (${rsiStatus}). ${rsiAction}`);
                            }
                            
                            return generatedLines;
                        })();

                    let generatedTitle = null;
                    let generatedSummary = null;
                    if (window.SHDWXBTContext) {
                        try {
                            if (typeof window.SHDWXBTContext.buildTitle === 'function') {
                                generatedTitle = window.SHDWXBTContext.buildTitle({ ...item, direction });
                            }
                            if (typeof window.SHDWXBTContext.buildSummaryText === 'function') {
                                generatedSummary = window.SHDWXBTContext.buildSummaryText({ ...item, direction });
                            }
                        } catch (e) {}
                    }

                    const analysisTitle = item.analysis_title || generatedTitle || `${item.symbol} ‚Äî ${item.trading_profile || 'Day Trading'} ‚Äî Tend√™ncia de ${direction === 'bullish' ? 'alta' : 'baixa'}`;
                    const analysisText = item.analysis_text || item.methodology_summary || generatedSummary || (contextLines.length > 0 ? ['Contexto:', ...contextLines].join('\n') : '');

                    return {
                        ...item,
                        currentPrice: currentPrice,
                        trend: direction,
                        setup: item.setup_type || item.methodology_summary?.substring(0, 100) || 'Technical analysis',
                        confluence: {
                            score: item.confluence_score || 0
                        },
                        targets: {
                            entry: currentPrice,
                            tp1: tp1,
                            tp2: tp2,
                            tp3: tp3,
                            stopLoss: item.stop_loss || item.invalidation,
                            // L√≥gica: se TP3 foi atingido, TP1 e TP2 tamb√©m foram
                            // Se TP2 foi atingido, TP1 tamb√©m foi
                            tp1Hit: item.tp_hit_1 === true || item.tp1Hit === true || 
                                    item.tp_hit_2 === true || item.tp2Hit === true ||
                                    item.tp_hit_3 === true || item.tp3Hit === true || false,
                            tp2Hit: item.tp_hit_2 === true || item.tp2Hit === true || 
                                    item.tp_hit_3 === true || item.tp3Hit === true || false,
                            tp3Hit: item.tp_hit_3 === true || item.tp3Hit === true || false
                        },
                        // Stop Loss hit status
                        slHit: item.sl_hit === true || item.slHit === true || item.invalidated === true || false,
                        stopLossHit: item.sl_hit === true || item.slHit === true || item.invalidated === true || false,
                        invalidated: item.is_active === false && item.completed_reason === 'stop_loss_hit',
                        invalidation: {
                            price: item.invalidation || item.stop_loss,
                            tactical: item.stop_loss,
                            text: item.invalidation_text
                        },
                        rsi: item.rsi_value || 50,
                        rsiStatus: item.rsi_status || 'neutro',
                        route: {
                            name: (item.trading_profile || 'day_trading').replace('_', ' ')
                        },
                        timeframe: {
                            trigger: item.trigger_timeframe || '15 minutos',
                            signal: item.signal_timeframe || (item.timeframes && item.timeframes[1]) || '1h',
                            target: item.target_timeframe || (item.timeframes && item.timeframes[2]) || '4h',
                            anchor: item.anchor_timeframe || 'Di√°rio'
                        },
                        // Textos no padr√£o institucional SHDWXBT
                        analysisTitle: analysisTitle,
                        analysisText: analysisText,
                        methodology_summary: item.methodology_summary || item.analysis_text || generatedSummary || analysisText,
                        // Linhas de contexto individuais (metodologia completa)
                        // Se n√£o tiver context_lines do banco, gerar dinamicamente
                        contextLines: contextLines,
                        setup: item.setup || item.setup_type,
                        // Metodologia SHDWXBT
                        metodologia: {
                            acao: item.metodologia_acao,
                            pivotType: item.pivot_type,
                            structure: item.market_structure
                        },
                        // Entry Zone OTE
                        techZone: entryZone,
                        entryZone: entryZone,
                        // Zona de entrada calculada
                        entryZoneCalc: {
                            start: item.entry_zone_start,
                            end: item.entry_zone_end
                        },
                        // Fibonacci levels
                        fibonacci: {
                            ...fibonacci,
                            '0.382': item.fib_382 || fibonacci['0.382'],
                            '0.5': item.fib_500 || fibonacci['0.5'],
                            '0.618': item.fib_618 || fibonacci['0.618']
                        },
                        // Conflu√™ncias do term√¥metro
                        positiveConf: positiveConf,
                        negativeConf: negativeConf,
                        // MTF data
                        mtfAlignment: item.mtf_alignment,
                        premiumDiscount: item.premium_discount,
                        setupType: item.setup_type,
                        // EMAs
                        ema12: item.ema_12 ? parseFloat(item.ema_12) : null,
                        ema26: item.ema_26 ? parseFloat(item.ema_26) : null,
                        ema200: item.ema_200 ? parseFloat(item.ema_200) : null,
                        // ============================================
                        // NOVOS CAMPOS AVAN√áADOS
                        // ============================================
                        // Fibonacci Zone (Premium/Discount/OTE)
                        fibZone: {
                            zone: item.fib_zone || 'equilibrium',
                            zonePct: item.fib_zone_pct || 50,
                            oteMin: item.ote_low,
                            oteMax: item.ote_high,
                            goldenPocketMin: item.golden_pocket_low,
                            goldenPocketMax: item.golden_pocket_high
                        },
                        // Market Structure (AlphaDesk Style)
                        marketStructure: {
                            bias: item.market_structure || item.structure_bias || 'neutral',
                            event: item.structure_event || 'none',
                            swingHigh: item.swing_high,
                            swingLow: item.swing_low,
                            isHH: item.is_hh,
                            isHL: item.is_hl,
                            isLH: item.is_lh,
                            isLL: item.is_ll
                        },
                        // Sentiment Data (Long/Short Ratio)
                        sentiment: {
                            longShortRatio: item.long_short_ratio,
                            longAccountPct: item.long_accounts_pct,
                            shortAccountPct: item.short_accounts_pct,
                            sentiment: item.sentiment,
                            takerBuySellRatio: item.taker_buy_sell_ratio,
                            openInterest: item.open_interest,
                            openInterestChange24h: item.open_interest_change_24h,
                            fundingRate: item.funding_rate,
                            fundingBias: item.funding_sentiment
                        },
                        // Confluence Details (JSONB)
                        confluenceDetails: item.confluence_details,
                        // Timestamps - IMPORTANT for timeline
                        created_at: item.created_at ? new Date(item.created_at).getTime() : null,
                        updated_at: item.updated_at ? new Date(item.updated_at).getTime() : null,
                        analysisTimestamp: item.created_at ? new Date(item.created_at).getTime() : Date.now()
                    };
                };
                
        // --- OPPORTUNITIES SERVICE INITIALIZATION (Using Supabase Only) ---
        // Wait for all dependencies to load
        async function waitForDependencies(maxWaitMs = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitMs) {
                // Check if all required dependencies are loaded
                const hasSupabase = typeof window.supabase !== 'undefined' || 
                                    (typeof window.supabasejs !== 'undefined');
                const hasConfig = typeof SHDWXBT_CONFIG !== 'undefined';
                const hasService = typeof SupabaseService !== 'undefined';
                
                if (hasSupabase && hasConfig && hasService) {
                    console.log('‚úÖ All dependencies loaded');
                    return true;
                }
                
                console.log(`‚è≥ Waiting for dependencies... (supabase: ${hasSupabase}, config: ${hasConfig}, service: ${hasService})`);
                await new Promise(r => setTimeout(r, 500));
            }
            
            console.error('‚ùå Timeout waiting for dependencies');
            return false;
        }
        
        (async function initOpportunitiesFromSupabase() {
            console.log('üöÄ Starting Real-Time Opportunities Service...');
            
            const grid = document.getElementById('opportunities-grid');
            
            // Show loading state
            if (grid) {
                grid.innerHTML = `
                    <div class="card-panel rounded-[24px] p-8 flex flex-col items-center justify-center min-h-[200px] col-span-full">
                        <div class="animate-pulse flex flex-col items-center">
                            <svg class="animate-spin h-8 w-8 text-emerald-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm text-zinc-400 font-mono">Carregando oportunidades...</span>
                        </div>
                    </div>
                `;
            }
            
            // CRITICAL: Wait for all dependencies before proceeding
            const depsLoaded = await waitForDependencies(15000);
            if (!depsLoaded) {
                if (grid) {
                    grid.innerHTML = `
                        <div class="card-panel rounded-[24px] p-8 flex flex-col items-center justify-center min-h-[200px] col-span-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-amber-500 mb-4">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <span class="text-sm text-zinc-400 font-mono mb-2">Carregamento lento detectado</span>
                            <span class="text-xs text-zinc-500 font-mono mb-4">Verifique sua conex√£o</span>
                            <button onclick="location.reload()" class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-500/30 text-xs font-mono text-emerald-400 hover:bg-emerald-500/30 transition-colors">
                                üîÑ Recarregar P√°gina
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            // Retry logic for mobile/slow connections
            const maxRetries = 3;
            let retryCount = 0;
            
            async function loadWithRetry() {
                try {
                    // Load data from Supabase
                    console.log(`üì° Loading data from Supabase (attempt ${retryCount + 1}/${maxRetries})...`);
                    const rawOpportunities = await SupabaseService.getOpportunities() || [];
                    
                    if (rawOpportunities.length === 0 && retryCount < maxRetries - 1) {
                        throw new Error('No opportunities returned');
                    }
                    
                    return rawOpportunities;
                } catch (error) {
                    retryCount++;
                    console.warn(`‚ö†Ô∏è Load attempt ${retryCount} failed:`, error.message);
                    
                    if (retryCount < maxRetries) {
                        console.log(`üîÑ Retrying in 2 seconds...`);
                        await new Promise(r => setTimeout(r, 2000));
                        return loadWithRetry();
                    }
                    throw error;
                }
            }
            
            try {
                const rawOpportunities = await loadWithRetry();
                const rawWatchlist = await SupabaseService.getWatchlist() || [];
                
                console.log('üîÑ Adapting data from Supabase schema...');
                
                const opportunities = rawOpportunities.map(window.adaptOpportunity);
                const watchlist = rawWatchlist.map(w => window.adaptOpportunity({...w, status: 'watchlist'}));
                
                // =====================================================
                // SISTEMA INSTITUCIONAL DE FILTRAGEM E QUALIDADE
                // Apenas os melhores sinais s√£o mostrados como oportunidades
                // =====================================================
                
                // Filter out completed opportunities (all TPs hit or SL hit)
                let activeOpportunities = opportunities.filter(opp => {
                    const allTargetsHit = opp.targets?.tp1Hit && opp.targets?.tp2Hit && opp.targets?.tp3Hit;
                    const stopLossHit = opp.slHit || opp.stopLossHit || opp.invalidated;
                    
                    if (allTargetsHit || stopLossHit) {
                        console.log(`‚è≠Ô∏è Filtering out ${opp.symbol}: ${allTargetsHit ? 'All targets hit' : 'Stop loss hit'}`);
                        
                        // Add to history
                        if (allTargetsHit && typeof window.addTPToHistory === 'function') {
                            window.addTPToHistory(opp.symbol, 'TP1', opp.targets.tp1, opp);
                            window.addTPToHistory(opp.symbol, 'TP2', opp.targets.tp2, opp);
                            window.addTPToHistory(opp.symbol, 'TP3', opp.targets.tp3, opp);
                        }
                        if (stopLossHit && typeof window.addSLToHistory === 'function') {
                            window.addSLToHistory(opp.symbol, opp.invalidation?.price, opp.currentPrice, opp);
                        }
                        
                        return false; // Exclude from active list
                    }
                    return true;
                });
                
                // =====================================================
                // SISTEMA DE FILTRAGEM - SIMPLIFICADO
                // Mostrar todas as oportunidades ordenadas por score
                // =====================================================
                
                // Log para debug
                console.log(`üìä Total oportunidades carregadas: ${activeOpportunities.length}`);
                if (activeOpportunities.length > 0) {
                    console.log(`üìä Amostra de scores:`, activeOpportunities.slice(0, 10).map(o => ({
                        symbol: o.symbol, 
                        score: o.confluence?.score || 0
                    })));
                }
                
                // ============================================
                // INSTITUCIONAL V4: CONFIA 100% NO SUPABASE
                // Supabase j√° aplica os filtros corretos:
                // - Escalping: minScore 88, watchScore 60
                // - Day Trading: minScore 86, watchScore 58
                // - Swing: minScore 84, watchScore 56
                // Dashboard APENAS ordena e limita exibi√ß√£o
                // ============================================
                
                console.log(`üèÜ Oportunidades do Supabase: ${activeOpportunities.length} (j√° filtradas no servidor)`);
                
                // Ordenar por score de conflu√™ncia (maior primeiro)
                activeOpportunities.sort((a, b) => {
                    const scoreA = a.confluence?.score || 0;
                    const scoreB = b.confluence?.score || 0;
                    return scoreB - scoreA;
                });
                
                // Limitar a 300 oportunidades para performance do navegador
                const MAX_OPPORTUNITIES = 300;
                const finalOpportunities = activeOpportunities.slice(0, MAX_OPPORTUNITIES);
                
                // Mover excesso para watchlist (apenas por limite de exibi√ß√£o)
                const excessForWatchlist = activeOpportunities.slice(MAX_OPPORTUNITIES).map(opp => ({
                    ...opp,
                    status: 'watchlist',
                    route: { name: 'Aguardando Slot' }
                }));
                
                // Combinar watchlists (Supabase + excesso de exibi√ß√£o)
                const combinedWatchlist = [...watchlist, ...excessForWatchlist];
                
                // Remover duplicatas da watchlist (manter maior score)
                const watchlistMap = new Map();
                combinedWatchlist.forEach(item => {
                    const existing = watchlistMap.get(item.symbol);
                    if (!existing || (item.confluence?.score || 0) > (existing.confluence?.score || 0)) {
                        watchlistMap.set(item.symbol, item);
                    }
                });
                
                // Ordenar watchlist por score e limitar a 500
                const finalWatchlist = Array.from(watchlistMap.values())
                    .sort((a, b) => (b.confluence?.score || 0) - (a.confluence?.score || 0))
                    .slice(0, 500);
                
                console.log(`üìä RESULTADO FINAL:`);
                console.log(`   üìà Oportunidades: ${finalOpportunities.length} (max ${MAX_OPPORTUNITIES})`);
                console.log(`   üìã Watchlist: ${finalWatchlist.length}`);
                
                window.currentOpportunities = finalOpportunities;
                window.currentWatchlist = finalWatchlist;
                
                // Store ALL opportunities (unfiltered) for modal lookups
                window.allOpportunitiesCache = [...opportunities];
                window.allWatchlistCache = [...watchlist];
                
                // ===== SYNC targetsHitState FROM SUPABASE =====
                if (!window.targetsHitState) window.targetsHitState = {};
                rawOpportunities.forEach(opp => {
                    if (!opp.symbol) return;
                    if (!window.targetsHitState[opp.symbol]) {
                        window.targetsHitState[opp.symbol] = { tp1: false, tp2: false, tp3: false };
                    }
                    
                    // Sync TP hits from Supabase
                    // L√≥gica: se TP3 foi atingido, TP1 e TP2 tamb√©m foram
                    const tp3Hit = opp.tp_hit_3 === true;
                    const tp2Hit = opp.tp_hit_2 === true || tp3Hit;
                    const tp1Hit = opp.tp_hit_1 === true || tp2Hit;
                    
                    if (tp1Hit) window.targetsHitState[opp.symbol].tp1 = true;
                    if (tp2Hit) window.targetsHitState[opp.symbol].tp2 = true;
                    if (tp3Hit) window.targetsHitState[opp.symbol].tp3 = true;
                    
                    // Sync Zone hit from Supabase
                    if (opp.zone_hit === true || opp.entry_zone_hit === true) {
                        window.targetsHitState[opp.symbol].zoneHit = true;
                        window.targetsHitState[opp.symbol].zoneHitTime = opp.zone_hit_at || opp.updated_at;
                    }
                    
                    // Sync SL hit from Supabase
                    if (opp.sl_hit === true || opp.is_stopped === true) {
                        window.targetsHitState[opp.symbol].stopHit = true;
                    }
                });
                console.log('‚òÅÔ∏è Synced targetsHitState from Supabase:', Object.keys(window.targetsHitState).length, 'symbols');
                
                // ===== SYNC TP/SL HISTORY COUNTERS FROM SUPABASE (CROSS-DEVICE) =====
                if (typeof window.syncHistoryFromSupabase === 'function') {
                    await window.syncHistoryFromSupabase(rawOpportunities);
                }
                
                console.log(`‚úÖ Data loaded: ${opportunities.length} opportunities, ${watchlist.length} watchlist`);
                
                // Subscribe to WebSocket for all loaded symbols (Binance Futures)
                const allLoadedSymbols = [...new Set([
                    ...opportunities.map(o => o.symbol),
                    ...watchlist.map(w => w.symbol)
                ])];
                if (allLoadedSymbols.length > 0) {
                    console.log(`üì° Subscribing to ${allLoadedSymbols.length} symbols from Supabase...`);
                    window.initRealtimePrices(allLoadedSymbols);
                }
                
                // Debug first opportunity
                if (opportunities.length > 0) {
                    console.log('üìä Sample opportunity adapted:', {
                        symbol: opportunities[0].symbol,
                        direction: opportunities[0].direction,
                        targets: opportunities[0].targets,
                        confluence: opportunities[0].confluence.score
                    });
                }
                
                // Apply current filter (default: 'all')
                if (typeof window.applyFilter === 'function') {
                    window.applyFilter();
                }
                
                // Update stats
                updateStats({ opportunities, watchlist });
                
                // Subscribe to real-time updates from Supabase
                console.log('üì° Setting up real-time subscriptions...');
                
                // Helper function to show real-time update indicator
                function showRealtimeIndicator() {
                    const indicator = document.querySelector('[data-key="live_data"]');
                    if (indicator) {
                        indicator.textContent = t('updating');
                        indicator.classList.add('text-amber-400');
                        indicator.classList.remove('text-emerald-500');
                        
                        setTimeout(() => {
                            indicator.textContent = t('live_data');
                            indicator.classList.remove('text-amber-400');
                            indicator.classList.add('text-emerald-500');
                        }, 1500);
                    }
                }
                
                // Update UI when opportunities change
                /* Legacy SupabaseClient removed - handled by app.js now */
                
                // Fun√ß√£o global para recarregar o dashboard ap√≥s scan
                window.loadDashboard = async function() {
                    console.log('üîÑ Reloading dashboard data...');
                    const grid = document.getElementById('opportunities-grid');
                    
                    try {
                        showRealtimeIndicator();
                        
                        // Show loading indicator on grid
                        if (grid) {
                            const existingCards = grid.querySelectorAll('.card-panel');
                            if (existingCards.length === 0) {
                                grid.innerHTML = `
                                    <div class="card-panel rounded-[24px] p-8 flex flex-col items-center justify-center min-h-[200px] col-span-full">
                                        <div class="animate-pulse flex flex-col items-center">
                                            <svg class="animate-spin h-8 w-8 text-emerald-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span class="text-sm text-zinc-400 font-mono">Atualizando...</span>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        
                        const newOpportunities = await SupabaseService.getOpportunities() || [];
                        const newWatchlist = await SupabaseService.getWatchlist() || [];
                        
                        console.log(`üì° Loaded: ${newOpportunities.length} opportunities, ${newWatchlist.length} watchlist`);
                        
                        const opportunities = newOpportunities.map(window.adaptOpportunity);
                        const watchlist = newWatchlist.map(w => window.adaptOpportunity({...w, status: 'watchlist'}));
                        
                        // Filter out completed opportunities (all TPs hit or SL hit)
                        let activeOpportunities = opportunities.filter(opp => {
                            const allTargetsHit = opp.targets?.tp1Hit && opp.targets?.tp2Hit && opp.targets?.tp3Hit;
                            const stopLossHit = opp.slHit || opp.stopLossHit || opp.invalidated;
                            
                            if (allTargetsHit || stopLossHit) {
                                console.log(`‚è≠Ô∏è Filtering out ${opp.symbol}: ${allTargetsHit ? 'All targets hit' : 'Stop loss hit'}`);
                                return false;
                            }
                            return true;
                        });
                        
                        // =====================================================
                        // INSTITUCIONAL V4: RESPEITA FILTROS DO SUPABASE (RELOAD)
                        // =====================================================
                        const MAX_OPPORTUNITIES = 300;
                        
                        console.log(`üìä Reload - Total carregado: ${activeOpportunities.length} (j√° filtrado no Supabase)`);
                        
                        // Ordenar por score (maior primeiro)
                        activeOpportunities.sort((a, b) => (b.confluence?.score || 0) - (a.confluence?.score || 0));
                        
                        // Limitar a 300 para performance do navegador
                        const finalOpportunities = activeOpportunities.slice(0, MAX_OPPORTUNITIES);
                        
                        // Mover excesso para watchlist (apenas limite de exibi√ß√£o)
                        const excessForWatchlist = activeOpportunities.slice(MAX_OPPORTUNITIES).map(opp => ({
                            ...opp,
                            status: 'watchlist',
                            route: { name: 'Aguardando Slot' }
                        }));
                        
                        // Combinar watchlists
                        const combinedWatchlist = [...watchlist, ...excessForWatchlist];
                        
                        // Remover duplicatas da watchlist
                        const watchlistMap = new Map();
                        combinedWatchlist.forEach(item => {
                            const existing = watchlistMap.get(item.symbol);
                            if (!existing || (item.confluence?.score || 0) > (existing.confluence?.score || 0)) {
                                watchlistMap.set(item.symbol, item);
                            }
                        });
                        
                        const finalWatchlist = Array.from(watchlistMap.values())
                            .sort((a, b) => (b.confluence?.score || 0) - (a.confluence?.score || 0))
                            .slice(0, 500);
                        
                        console.log(`üìä RELOAD RESULT:`);
                        console.log(`   üìà Oportunidades: ${finalOpportunities.length}`);
                        console.log(`   üìã Watchlist: ${finalWatchlist.length}`);
                        
                        window.currentOpportunities = finalOpportunities;
                        window.currentWatchlist = finalWatchlist;
                        
                        // Update cache for modal lookups
                        window.allOpportunitiesCache = [...opportunities];
                        window.allWatchlistCache = [...watchlist];
                        
                        console.log(`‚úÖ Dashboard reloaded: ${finalOpportunities.length} opportunities, ${finalWatchlist.length} watchlist`);
                        
                        // Apply current filter instead of always showing all
                        if (typeof window.applyFilter === 'function') {
                            window.applyFilter();
                        }
                        
                        updateStats({ opportunities: finalOpportunities, watchlist: finalWatchlist });
                    } catch (error) {
                        console.error('‚ùå Failed to reload dashboard:', error);
                    }
                };
                
                // Fun√ß√£o para for√ßar scan manual
                window.forceScan = async function() {
                    console.log('üîç Starting manual market scan (ALL ROUTES)...');
                    if (typeof SupabaseFunctions !== 'undefined') {
                        try {
                            showRealtimeIndicator();
                            const result = await SupabaseFunctions.scanMarket({
                                profile: { name: 'All' },
                                maxSymbols: 400,
                                minConfluence: 0,  // V4: Sem filtro - Supabase usa thresholds 84-88/56-60
                                minVolume: 3000000,  // 3M USDT (menor para capturar mais pares)
                                route: 'all'  // Scalping + Day Trading + Swing Trade
                            });
                            console.log('‚úÖ Scan complete:', result);
                            // Recarregar ap√≥s 2 segundos para dar tempo do Supabase atualizar
                            setTimeout(() => window.loadDashboard(), 2000);
                            return result;
                        } catch (error) {
                            console.error('‚ùå Scan failed:', error);
                        }
                    } else {
                        console.error('‚ùå SupabaseFunctions not available');
                    }
                };
                
                // Iniciar scan autom√°tico IMEDIATAMENTE se n√£o tiver dados
                if (opportunities.length === 0) {
                    console.log('üì≠ No opportunities found - starting immediate scan...');
                    setTimeout(() => {
                        if (typeof SupabaseFunctions !== 'undefined') {
                            window.forceScan();
                        }
                    }, 2000);
                }
                
                // Iniciar Auto Scanner ap√≥s 30 segundos
                console.log('‚è∞ Auto Scanner will start in 30 seconds...');
                setTimeout(() => {
                    if (typeof AutoScanner !== 'undefined') {
                        // Configurar antes de iniciar
                        AutoScanner.config.minConfluence = 0;       // V4: Sem filtro - Supabase usa thresholds pr√≥prios
                        AutoScanner.config.batchSize = 400;         // 400 s√≠mbolos por scan (todas rotas)
                        AutoScanner.config.minVolume = 3000000;     // 3M USDT volume m√≠nimo
                        AutoScanner.config.batchDelay = 2000;       // 2 segundos entre batches
                        AutoScanner.config.scanInterval = 600000;   // 10 minutos entre scans (600000ms)
                        AutoScanner.config.route = 'all';           // Scalping + Day Trading + Swing Trade
                        
                        console.log('üöÄ Starting Auto Scanner (100 ativos, ALL ROUTES, 10 min interval)...');
                        AutoScanner.start();
                        console.log('‚úÖ Auto Scanner activated!');
                    } else {
                        console.error('‚ùå AutoScanner not found!');
                    }
                }, 30000);
                
            } catch (error) {
                console.error('‚ùå Failed to load opportunities:', error);
                
                if (grid) {
                    grid.innerHTML = `
                        <div class="card-panel rounded-[24px] p-8 flex flex-col items-center justify-center min-h-[200px] col-span-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-amber-500 mb-4">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <span class="text-sm text-zinc-400 font-mono mb-2">Erro ao carregar oportunidades</span>
                            <span class="text-xs text-zinc-500 font-mono mb-4">${error.message}</span>
                            <div class="flex gap-2">
                                <button onclick="location.reload()" class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-500/30 text-xs font-mono text-emerald-400 hover:bg-emerald-500/30 transition-colors">
                                    üîÑ Recarregar
                                </button>
                                <button onclick="window.forceScan && window.forceScan()" class="px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-xs font-mono text-white hover:bg-white/10 transition-colors">
                                    üîç For√ßar Scan
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        })();
        
        // =====================================================================
        // FILTER SYSTEM - Clickable Stats to Filter Opportunities
        // =====================================================================
        window.currentFilter = 'all'; // 'all', 'bullish', 'bearish', 'watchlist'
        window.currentTradingType = 'all'; // 'all', 'scalping', 'day', 'swing'
        
        // Filter by Trading Type (Scalping, Day Trading, Swing)
        window.filterByTradingType = function(type) {
            console.log(`üìä Trading type filter: ${type}`);
            window.currentTradingType = type;
            
            // Update button styles
            const buttons = document.querySelectorAll('#trading-type-filter button');
            buttons.forEach(btn => {
                const btnType = btn.dataset.type;
                if (btnType === type) {
                    btn.classList.add('bg-white/10', 'text-white');
                    btn.classList.remove('text-zinc-500');
                } else {
                    btn.classList.remove('bg-white/10', 'text-white');
                    btn.classList.add('text-zinc-500');
                }
            });
            
            // Re-apply all filters
            window.applyFilter();
        };
        
        // =====================================================
        // HISTORY RENDER FUNCTIONS (defined early for availability)
        // =====================================================
        
        // Helper: Time ago (with translation support)
        window.getTimeAgo = function(timestamp) {
            const isEnglish = (typeof currentLanguage !== 'undefined' && currentLanguage === 'en');
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return isEnglish ? `${seconds}s ago` : `${seconds}s atr√°s`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return isEnglish ? `${minutes}m ago` : `${minutes}m atr√°s`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return isEnglish ? `${hours}h ago` : `${hours}h atr√°s`;
            const days = Math.floor(hours / 24);
            return isEnglish ? `${days}d ago` : `${days}d atr√°s`;
        };
        
        // Render TP History Grid
        window.renderTPHistory = function() {
            const grid = document.getElementById('tp-history-grid');
            if (!grid) {
                console.error('tp-history-grid not found');
                return;
            }
            
            const history = window.tpHistory || [];
            const isEnglish = (typeof currentLanguage !== 'undefined' && currentLanguage === 'en');
            console.log('Rendering TP History:', history.length, 'items');
            
            if (history.length === 0) {
                grid.innerHTML = `
                    <div class="glass-panel rounded-xl p-8 flex flex-col items-center justify-center border border-emerald-500/20 col-span-full min-h-[200px]">
                        <span class="text-4xl mb-4">üéØ</span>
                        <span class="text-sm text-emerald-500/60 font-mono">${isEnglish ? 'No TP recorded in the last 24h' : 'Nenhum TP registrado nas √∫ltimas 24h'}</span>
                        <span class="text-xs text-zinc-600 mt-2">${isEnglish ? 'Take Profits will appear here when hit' : 'Take Profits aparecer√£o aqui quando atingidos'}</span>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = history.map(item => {
                const isLong = item.trend === 'bullish';
                const timeAgo = window.getTimeAgo(item.timestamp);
                const hitTimeFormatted = item.hitTimeFormatted || (window.formatTimestamp ? window.formatTimestamp(item.hitTime || item.timestamp) : '--');
                const entryTimeFormatted = item.entryTimeFormatted || (window.formatTimestamp ? window.formatTimestamp(item.entryTime) : '--');
                const logoUrl = window.getCryptoLogoUrl ? window.getCryptoLogoUrl(item.symbol) : '';
                
                return `
                    <div class="glass-panel rounded-xl p-5 border border-emerald-500/30 bg-emerald-500/5 hover:bg-emerald-500/10 transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center overflow-hidden border border-white/10">
                                    <img src="${logoUrl}" alt="${item.symbol}" class="w-6 h-6 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span class="text-xl hidden">üéØ</span>
                                </div>
                                <div>
                                    <div class="font-bold text-white text-lg">${item.symbol.replace('USDT', '')}</div>
                                    <div class="text-[10px] text-zinc-500 font-mono">${item.symbol}</div>
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded text-[10px] font-mono font-bold ${isLong ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}">
                                ${item.tpLevel.toUpperCase()}
                            </span>
                        </div>
                        
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-zinc-500">${isEnglish ? 'Target:' : 'Alvo:'}</span>
                                <span class="text-emerald-400 font-mono">${window.formatPrice ? window.formatPrice(item.targetPrice) : item.targetPrice}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-zinc-500">Timeframe:</span>
                                <span class="text-white font-mono">${item.timeframe}</span>
                            </div>
                            <div class="flex justify-between border-t border-emerald-500/10 pt-2 mt-2">
                                <span class="text-zinc-500 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                    ${isEnglish ? 'Signal:' : 'Sinal:'}
                                </span>
                                <span class="text-blue-400 font-mono">${entryTimeFormatted}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-zinc-500 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-emerald-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    Hit:
                                </span>
                                <span class="text-emerald-400 font-mono">${hitTimeFormatted}</span>
                            </div>
                            <div class="flex justify-between text-[10px]">
                                <span class="text-zinc-600">${isEnglish ? 'Time:' : 'Tempo:'}</span>
                                <span class="text-zinc-500 font-mono">${timeAgo}</span>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-emerald-500/20">
                            <p class="text-[10px] text-emerald-400/70 line-clamp-2">${item.context || (isEnglish ? 'Trade completed successfully' : 'Trade conclu√≠do com sucesso')}</p>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        // Render SL History Grid
        window.renderSLHistory = function() {
            const grid = document.getElementById('sl-history-grid');
            if (!grid) {
                console.error('sl-history-grid not found');
                return;
            }
            
            const history = window.slHistory || [];
            console.log('Rendering SL History:', history.length, 'items');
            
            const isEnglish = (typeof currentLanguage !== 'undefined' && currentLanguage === 'en');
            
            if (history.length === 0) {
                grid.innerHTML = `
                    <div class="glass-panel rounded-xl p-8 flex flex-col items-center justify-center border border-rose-500/20 col-span-full min-h-[200px]">
                        <span class="text-4xl mb-4">‚úÖ</span>
                        <span class="text-sm text-rose-500/60 font-mono">${isEnglish ? 'No SL recorded in the last 24h' : 'Nenhum SL registrado nas √∫ltimas 24h'}</span>
                        <span class="text-xs text-zinc-600 mt-2">${isEnglish ? 'Stop Losses will appear here when hit' : 'Stop Losses aparecer√£o aqui quando atingidos'}</span>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = history.map(item => {
                const isLong = item.trend === 'bullish';
                const timeAgo = window.getTimeAgo(item.timestamp);
                const hitTimeFormatted = item.hitTimeFormatted || (window.formatTimestamp ? window.formatTimestamp(item.hitTime || item.timestamp) : '--');
                const entryTimeFormatted = item.entryTimeFormatted || (window.formatTimestamp ? window.formatTimestamp(item.entryTime) : '--');
                const logoUrl = window.getCryptoLogoUrl ? window.getCryptoLogoUrl(item.symbol) : '';
                
                // Calcular o risco/perda (% entre pre√ßo de entrada e stop)
                const entryPrice = item.entryPrice || item.entry_price;
                const stopPrice = item.stopPrice || item.stop_price;
                let riskPct = 0;
                if (entryPrice && stopPrice) {
                    riskPct = ((stopPrice - entryPrice) / entryPrice * 100);
                    // Para LONG, loss √© negativo (stop abaixo do entry)
                    // Para SHORT, loss √© positivo (stop acima do entry)
                    if (isLong) {
                        riskPct = Math.abs(riskPct) * -1; // Mostrar como negativo
                    } else {
                        riskPct = Math.abs(riskPct) * -1; // Mostrar como negativo tamb√©m
                    }
                }
                
                return `
                    <div class="glass-panel rounded-xl p-5 border border-rose-500/30 bg-rose-500/5 hover:bg-rose-500/10 transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center overflow-hidden border border-white/10">
                                    <img src="${logoUrl}" alt="${item.symbol}" class="w-6 h-6 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span class="text-xl hidden">‚ùå</span>
                                </div>
                                <div>
                                    <div class="font-bold text-white text-lg">${item.symbol.replace('USDT', '')}</div>
                                    <div class="text-[10px] text-zinc-500 font-mono">${item.symbol}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-mono font-bold text-rose-400">${riskPct.toFixed(2)}%</div>
                                <span class="px-2 py-0.5 rounded text-[9px] font-mono font-bold ${isLong ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}">
                                    ${isLong ? 'LONG' : 'SHORT'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-xs">
                            ${entryPrice ? `
                            <div class="flex justify-between">
                                <span class="text-zinc-500">${isEnglish ? 'Entry:' : 'Entrada:'}</span>
                                <span class="text-white font-mono">${window.formatPrice ? window.formatPrice(entryPrice) : entryPrice}</span>
                            </div>
                            ` : ''}
                            <div class="flex justify-between">
                                <span class="text-zinc-500">Stop:</span>
                                <span class="text-rose-400 font-mono">${window.formatPrice ? window.formatPrice(stopPrice) : stopPrice}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-zinc-500">${isEnglish ? 'Hit Price:' : 'Pre√ßo hit:'}</span>
                                <span class="text-white font-mono">${window.formatPrice ? window.formatPrice(item.hitPrice) : item.hitPrice}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-zinc-500">Timeframe:</span>
                                <span class="text-white font-mono">${item.timeframe}</span>
                            </div>
                            <div class="flex justify-between border-t border-rose-500/10 pt-2 mt-2">
                                <span class="text-zinc-500 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                    ${isEnglish ? 'Signal:' : 'Sinal:'}
                                </span>
                                <span class="text-blue-400 font-mono">${entryTimeFormatted}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-zinc-500 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-rose-500"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                                    Stop Hit:
                                </span>
                                <span class="text-rose-400 font-mono">${hitTimeFormatted}</span>
                            </div>
                            <div class="flex justify-between text-[10px]">
                                <span class="text-zinc-600">${isEnglish ? 'Time:' : 'Tempo:'}</span>
                                <span class="text-zinc-500 font-mono">${timeAgo}</span>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-rose-500/20">
                            <p class="text-[10px] text-rose-400/70 line-clamp-2">${item.context || (isEnglish ? 'Trade invalidated' : 'Opera√ß√£o invalidada')}</p>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        // Initialize history arrays immediately
        window.tpHistory = JSON.parse(localStorage.getItem('shdwxbt_tp_history') || '[]');
        window.slHistory = JSON.parse(localStorage.getItem('shdwxbt_sl_history') || '[]');
        
        // =====================================================
        // MY TRADES - User's Active Trades Management
        // With Supabase persistence + localStorage fallback
        // =====================================================
        
        // Get wallet address from auth
        window.getWalletAddress = function() {
            const auth = window.SHDW_AUTH || JSON.parse(sessionStorage.getItem('shdwxbt_auth') || '{}');
            return auth.wallet || auth.address || null;
        };
        
        // Initialize My Trades from localStorage (will sync with Supabase)
        window.myTrades = JSON.parse(localStorage.getItem('shdwxbt_my_trades') || '[]');
        window.myTradesSynced = false;
        
        // Supabase Edge Function URL
        const USER_TRADES_URL = window.SUPABASE_URL ? `${window.SUPABASE_URL}/functions/v1/user-trades` : null;
        
        // Call user-trades Edge Function
        window.callUserTradesAPI = async function(action, data = {}) {
            const wallet = window.getWalletAddress();
            if (!wallet) {
                console.warn('‚ö†Ô∏è No wallet address for user trades');
                return { error: 'No wallet address' };
            }
            
            if (!USER_TRADES_URL) {
                console.warn('‚ö†Ô∏è Supabase URL not configured');
                return { error: 'Supabase not configured' };
            }
            
            try {
                const response = await fetch(USER_TRADES_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': window.SUPABASE_ANON_KEY || '',
                        'Authorization': `Bearer ${window.SUPABASE_ANON_KEY || ''}`
                    },
                    body: JSON.stringify({
                        wallet_address: wallet,
                        action,
                        ...data
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    console.error('‚ùå User trades API error:', result.error);
                    return { error: result.error };
                }
                
                return result;
            } catch (err) {
                console.error('‚ùå User trades API error:', err);
                return { error: err.message };
            }
        };
        
        // Sync trades from Supabase
        window.syncMyTrades = async function() {
            const result = await window.callUserTradesAPI('list', { status: 'active' });
            
            if (result.trades) {
                // Convert Supabase format to local format
                window.myTrades = result.trades.map(t => ({
                    id: t.id,
                    symbol: t.symbol,
                    name: t.name,
                    direction: t.direction,
                    entryPrice: parseFloat(t.entry_price),
                    currentPrice: parseFloat(t.current_price || t.entry_price),
                    stopLoss: parseFloat(t.stop_loss),
                    targets: {
                        tp1: parseFloat(t.target_1),
                        tp2: parseFloat(t.target_2),
                        tp3: parseFloat(t.target_3),
                        tp1Hit: t.tp1_hit,
                        tp2Hit: t.tp2_hit,
                        tp3Hit: t.tp3_hit
                    },
                    tradingProfile: t.trading_profile,
                    timeframe: t.timeframe,
                    score: t.confluence_score,
                    enteredAt: new Date(t.entered_at).getTime(),
                    status: t.status,
                    pnl: parseFloat(t.pnl_percent || 0)
                }));
                
                // Update localStorage as cache
                localStorage.setItem('shdwxbt_my_trades', JSON.stringify(window.myTrades));
                window.myTradesSynced = true;
                
                console.log(`‚úÖ Synced ${window.myTrades.length} trades from Supabase`);
                window.updateMyTradesStats();
                
                // Re-render if viewing my trades
                if (window.currentFilter === 'my-trades') {
                    window.renderMyTrades();
                }
            }
            
            return result;
        };
        
        // Save My Trades (to both localStorage and Supabase)
        window.saveMyTrades = function() {
            localStorage.setItem('shdwxbt_my_trades', JSON.stringify(window.myTrades));
            window.updateMyTradesStats();
        };
        
        // Check if user is in a trade
        window.isInTrade = function(symbol) {
            return window.myTrades.some(t => t.symbol === symbol && t.status === 'active');
        };
        
        // Enter a trade (with Supabase)
        window.enterTrade = async function(symbol, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // Find the opportunity data
            const allItems = [...(window.currentOpportunities || []), ...(window.currentWatchlist || [])];
            const opp = allItems.find(o => o.symbol === symbol);
            
            if (!opp) {
                console.error('Opportunity not found:', symbol);
                return;
            }
            
            // Check if already in trade
            if (window.isInTrade(symbol)) {
                console.log('Already in trade:', symbol);
                return;
            }
            
            // Disable button while saving
            const btn = document.querySelector(`#enter-trade-btn-${symbol.toLowerCase()}`);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<span class="animate-pulse">...</span>`;
            }
            
            const tradeData = {
                symbol: opp.symbol,
                name: opp.name || opp.symbol.replace('USDT', ''),
                direction: opp.trend,
                entry_price: opp.currentPrice,
                current_price: opp.currentPrice,
                stop_loss: opp.invalidation?.price || opp.targets?.stopLoss || opp.currentPrice * 0.95,
                target_1: opp.targets?.tp1,
                target_2: opp.targets?.tp2,
                target_3: opp.targets?.tp3,
                trading_profile: opp.route?.name || opp.tradingProfile || 'Day Trading',
                timeframe: opp.timeframe?.signal || '15m',
                confluence_score: opp.confluence?.score || 0
            };
            
            // Try to save to Supabase
            const result = await window.callUserTradesAPI('enter', tradeData);
            
            // Create local trade object
            const trade = {
                id: result.trade?.id || Date.now().toString(),
                symbol: opp.symbol,
                name: opp.name || opp.symbol.replace('USDT', ''),
                direction: opp.trend,
                entryPrice: opp.currentPrice,
                currentPrice: opp.currentPrice,
                stopLoss: tradeData.stop_loss,
                targets: {
                    tp1: opp.targets?.tp1,
                    tp2: opp.targets?.tp2,
                    tp3: opp.targets?.tp3,
                    tp1Hit: false,
                    tp2Hit: false,
                    tp3Hit: false
                },
                tradingProfile: tradeData.trading_profile,
                timeframe: tradeData.timeframe,
                score: tradeData.confluence_score,
                enteredAt: Date.now(),
                status: 'active',
                pnl: 0,
                savedToSupabase: !result.error,
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // SALVAR AN√ÅLISE ORIGINAL PARA EXIBIR AO ABRIR O TRADE
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                analysisTitle: opp.analysisTitle || `${opp.name || opp.symbol} ‚Äî ${opp.route?.name || 'Trade'} ‚Äî ${opp.trend === 'bullish' ? 'Tend√™ncia de alta' : 'Tend√™ncia de baixa'}`,
                contextLines: opp.contextLines || [],
                methodology_summary: opp.methodology_summary || opp.analysisText || '',
                setup_type: opp.setup_type || opp.setup || opp.marketStructure?.searchingFor || '',
                fibonacci: opp.fibonacci || {},
                confluence: opp.confluence || {},
                regime: opp.regime || {},
                institutionalReport: opp.institutionalReport || null,
                swingLow: opp.swingLow,
                swingHigh: opp.swingHigh
            };
            
            window.myTrades.push(trade);
            window.saveMyTrades();
            
            // Update the button on the card
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <span>${t('btn_in_trade')}</span>
                `;
                btn.classList.remove('bg-cyan-500/20', 'text-cyan-400', 'hover:bg-cyan-500/30');
                btn.classList.add('bg-emerald-500/20', 'text-emerald-400');
                btn.onclick = (e) => window.exitTrade(symbol, e);
            }
            
            console.log('‚úÖ Entered trade:', symbol, 'at', trade.entryPrice, result.error ? '(localStorage only)' : '(synced to Supabase)');
            
            // Show notification
            if (typeof showNotification === 'function') {
                showNotification(`Entrou em ${symbol}`, 'success');
            }
        };
        
        // Exit a trade (with Supabase)
        window.exitTrade = async function(symbol, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const isEnglish = (typeof currentLanguage !== 'undefined' && currentLanguage === 'en');
            
            if (!confirm(isEnglish ? 'Exit this trade?' : 'Sair desta opera√ß√£o?')) {
                return;
            }
            
            const tradeIndex = window.myTrades.findIndex(t => t.symbol === symbol && t.status === 'active');
            if (tradeIndex === -1) return;
            
            const trade = window.myTrades[tradeIndex];
            
            // Try to close in Supabase
            const result = await window.callUserTradesAPI('exit', {
                trade_id: trade.id,
                symbol: trade.symbol,
                exit_price: trade.currentPrice,
                close_reason: 'manual'
            });
            
            // Update local state
            trade.status = 'closed';
            trade.closedAt = Date.now();
            trade.exitPrice = trade.currentPrice;
            trade.finalPnl = trade.pnl;
            
            // Remove from active trades
            window.myTrades.splice(tradeIndex, 1);
            window.saveMyTrades();
            
            // Update button on card
            const btn = document.querySelector(`#enter-trade-btn-${symbol.toLowerCase()}`);
            if (btn) {
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                    <span>${t('btn_enter_trade')}</span>
                `;
                btn.classList.add('bg-cyan-500/20', 'text-cyan-400', 'hover:bg-cyan-500/30');
                btn.classList.remove('bg-emerald-500/20', 'text-emerald-400');
                btn.onclick = (e) => window.enterTrade(symbol, e);
            }
            
            console.log('‚ùå Exited trade:', symbol, result.error ? '(localStorage only)' : `(P&L: ${result.pnl_realized?.toFixed(2)}%)`);
            
            // Show notification with P&L
            if (typeof showNotification === 'function') {
                const pnlText = result.pnl_realized ? ` (${result.pnl_realized >= 0 ? '+' : ''}${result.pnl_realized.toFixed(2)}%)` : '';
                showNotification(`Saiu de ${symbol}${pnlText}`, result.pnl_realized >= 0 ? 'success' : 'error');
            }
            
            // Re-render if on my-trades section
            if (window.currentFilter === 'my-trades') {
                window.renderMyTrades();
            }
        };
        
        // Update My Trades stats
        window.updateMyTradesStats = function() {
            const activeTrades = window.myTrades.filter(t => t.status === 'active');
            
            // Update count
            const countEl = document.getElementById('stat-my-trades');
            if (countEl) {
                countEl.textContent = activeTrades.length;
            }
            
            // Calculate total P&L
            let totalProfit = 0;
            let totalLoss = 0;
            
            activeTrades.forEach(trade => {
                if (trade.pnl >= 0) {
                    totalProfit += trade.pnl;
                } else {
                    totalLoss += Math.abs(trade.pnl);
                }
            });
            
            const profitEl = document.getElementById('my-trades-profit');
            const lossEl = document.getElementById('my-trades-loss');
            
            if (profitEl) profitEl.textContent = totalProfit.toFixed(1);
            if (lossEl) lossEl.textContent = totalLoss.toFixed(1);
        };
        
        // Update trade prices from WebSocket - com atualiza√ß√£o em tempo real da UI
        window.updateTradePrices = function(priceMap) {
            if (!window.myTrades || window.myTrades.length === 0) return;
            
            let updated = false;
            const activeTrades = window.myTrades.filter(t => t.status === 'active');
            
            activeTrades.forEach(trade => {
                // Tentar encontrar o pre√ßo com diferentes formatos de s√≠mbolo
                let newPrice = priceMap[trade.symbol];
                const symbolKeys = Object.keys(priceMap);
                
                // Se n√£o encontrou, tentar com USDT
                if (!newPrice && !trade.symbol.endsWith('USDT')) {
                    newPrice = priceMap[trade.symbol + 'USDT'];
                }
                
                // Se ainda n√£o encontrou, tentar sem USDT
                if (!newPrice && trade.symbol.endsWith('USDT')) {
                    const baseSymbol = trade.symbol.replace('USDT', '');
                    newPrice = priceMap[baseSymbol];
                }
                
                // Debug log (remover em produ√ß√£o)
                if (newPrice) {
                    const oldPnl = trade.pnl || 0;
                    
                    trade.currentPrice = newPrice;
                    
                    // Calculate P&L
                    if (trade.direction === 'bullish') {
                        trade.pnl = ((newPrice - trade.entryPrice) / trade.entryPrice) * 100;
                    } else {
                        trade.pnl = ((trade.entryPrice - newPrice) / trade.entryPrice) * 100;
                    }
                    
                    // S√≥ atualiza UI se P&L mudou significativamente (evita flicker)
                    if (Math.abs(trade.pnl - oldPnl) > 0.001) {
                        // Atualizar UI em tempo real (sem re-render completo)
                        if (typeof window.updateTradeCardPnL === 'function') {
                            window.updateTradeCardPnL(trade);
                        }
                    }
                    
                    // Check targets
                    if (trade.targets.tp1 && !trade.targets.tp1Hit) {
                        const hitTp1 = trade.direction === 'bullish' 
                            ? newPrice >= trade.targets.tp1 
                            : newPrice <= trade.targets.tp1;
                        if (hitTp1) {
                            trade.targets.tp1Hit = true;
                            trade.targets.tp1HitAt = Date.now();
                        }
                    }
                    if (trade.targets.tp2 && !trade.targets.tp2Hit) {
                        const hitTp2 = trade.direction === 'bullish' 
                            ? newPrice >= trade.targets.tp2 
                            : newPrice <= trade.targets.tp2;
                        if (hitTp2) {
                            trade.targets.tp2Hit = true;
                            trade.targets.tp2HitAt = Date.now();
                        }
                    }
                    if (trade.targets.tp3 && !trade.targets.tp3Hit) {
                        const hitTp3 = trade.direction === 'bullish' 
                            ? newPrice >= trade.targets.tp3 
                            : newPrice <= trade.targets.tp3;
                        if (hitTp3) {
                            trade.targets.tp3Hit = true;
                            trade.targets.tp3HitAt = Date.now();
                        }
                    }
                    
                    updated = true;
                }
            });
            
            if (updated) {
                window.saveMyTrades();
                window.updateMyTradesStats();
            }
        };
        
        // Atualiza P&L diretamente no DOM sem re-render
        window.updateTradeCardPnL = function(trade) {
            // Busca o card pelo s√≠mbolo no onclick
            const allCards = document.querySelectorAll('#my-trades-grid > div[onclick]');
            let targetCard = null;
            
            allCards.forEach(card => {
                const onclick = card.getAttribute('onclick');
                if (onclick && onclick.includes(trade.symbol)) {
                    targetCard = card;
                }
            });
            
            if (!targetCard) return;
            
            const pnlColor = trade.pnl >= 0 ? 'emerald' : 'rose';
            const pnlPrefix = trade.pnl >= 0 ? '+' : '';
            
            // Atualiza o P&L principal (texto grande)
            const pnlElements = targetCard.querySelectorAll('div[class*="text-2xl"][class*="font-mono"]');
            pnlElements.forEach(el => {
                el.textContent = `${pnlPrefix}${trade.pnl.toFixed(2)}%`;
                el.className = el.className.replace(/text-(emerald|rose)-400/g, `text-${pnlColor}-400`);
            });
            
            // Atualiza o pre√ßo atual
            const priceContainers = targetCard.querySelectorAll('div[class*="bg-white/5"][class*="rounded-lg"][class*="p-3"]');
            if (priceContainers.length >= 2) {
                const currentPriceEl = priceContainers[1].querySelector('div[class*="font-mono"]');
                if (currentPriceEl) {
                    currentPriceEl.textContent = window.formatPrice ? window.formatPrice(trade.currentPrice) : trade.currentPrice;
                    currentPriceEl.className = currentPriceEl.className.replace(/text-(emerald|rose|white)-400/g, `text-${pnlColor}-400`);
                }
            }
            
            // Atualiza % at√© TPs/SL
            const targetLines = targetCard.querySelectorAll('div.space-y-2 > div');
            targetLines.forEach((line, index) => {
                const pctSpan = line.querySelector('span:last-child');
                if (!pctSpan) return;
                
                let pctValue = '--';
                let isHit = false;
                
                switch(index) {
                    case 0: // TP1
                        if (trade.targets.tp1) {
                            isHit = trade.targets.tp1Hit;
                            pctValue = isHit ? '‚úì' : Math.abs(((trade.targets.tp1 - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1) + '%';
                        }
                        break;
                    case 1: // TP2
                        if (trade.targets.tp2) {
                            isHit = trade.targets.tp2Hit;
                            pctValue = isHit ? '‚úì' : Math.abs(((trade.targets.tp2 - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1) + '%';
                        }
                        break;
                    case 2: // TP3
                        if (trade.targets.tp3) {
                            isHit = trade.targets.tp3Hit;
                            pctValue = isHit ? '‚úì' : Math.abs(((trade.targets.tp3 - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1) + '%';
                        }
                        break;
                    case 3: // SL (ap√≥s border-t)
                        pctValue = Math.abs(((trade.stopLoss - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1) + '%';
                        break;
                }
                
                if (pctSpan.textContent !== pctValue) {
                    pctSpan.textContent = pctValue;
                }
                
                // Atualiza cor se target foi atingido
                if (isHit && index < 3) {
                    line.classList.remove('text-zinc-400', 'text-zinc-500', 'text-zinc-600');
                    line.classList.add('text-emerald-400');
                }
            });
            
            console.log(`üìä P&L atualizado: ${trade.symbol} ‚Üí ${pnlPrefix}${trade.pnl.toFixed(2)}% @ ${trade.currentPrice}`);
        };
        
        // Render My Trades Grid
        window.renderMyTrades = function() {
            const grid = document.getElementById('my-trades-grid');
            if (!grid) {
                console.error('my-trades-grid not found');
                return;
            }
            
            const trades = window.myTrades.filter(t => t.status === 'active');
            const isEnglish = (typeof currentLanguage !== 'undefined' && currentLanguage === 'en');
            console.log('Rendering My Trades:', trades.length, 'items');
            
            if (trades.length === 0) {
                grid.innerHTML = `
                    <div class="glass-panel rounded-xl p-8 flex flex-col items-center justify-center border border-cyan-500/20 col-span-full min-h-[200px]">
                        <span class="text-4xl mb-4">üìä</span>
                        <span class="text-sm text-cyan-500/60 font-mono">${isEnglish ? 'No active trades' : 'Nenhuma opera√ß√£o ativa'}</span>
                        <span class="text-xs text-zinc-600 mt-2">${isEnglish ? 'Click "Enter Trade" on any opportunity to track it here' : 'Clique em "Entrar na Opera√ß√£o" em qualquer oportunidade para acompanhar aqui'}</span>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = trades.map(trade => {
                const isLong = trade.direction === 'bullish';
                const pnlColor = trade.pnl >= 0 ? 'emerald' : 'rose';
                const pnlPrefix = trade.pnl >= 0 ? '+' : '';
                const timeAgo = window.getTimeAgo(trade.enteredAt);
                const logoUrl = window.getCryptoLogoUrl ? window.getCryptoLogoUrl(trade.symbol) : '';
                
                // Calculate percent to targets
                const pctToTp1 = trade.targets.tp1 ? Math.abs(((trade.targets.tp1 - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1) : '--';
                const pctToTp2 = trade.targets.tp2 ? Math.abs(((trade.targets.tp2 - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1) : '--';
                const pctToTp3 = trade.targets.tp3 ? Math.abs(((trade.targets.tp3 - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1) : '--';
                const pctToSl = Math.abs(((trade.stopLoss - trade.currentPrice) / trade.currentPrice) * 100).toFixed(1);
                
                return `
                    <div class="glass-panel rounded-xl p-5 border border-cyan-500/30 bg-cyan-500/5 hover:bg-cyan-500/10 transition-all cursor-pointer" onclick="openOpportunityModal('${trade.symbol}')">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center overflow-hidden border border-white/10">
                                    <img src="${logoUrl}" alt="${trade.symbol}" class="w-7 h-7 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <span class="text-xl hidden items-center justify-center">üìä</span>
                                </div>
                                <div>
                                    <div class="font-bold text-white text-lg">${trade.name}</div>
                                    <div class="text-[10px] text-zinc-500 font-mono">${trade.tradingProfile} ‚Ä¢ ${trade.timeframe}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-mono font-bold text-${pnlColor}-400">${pnlPrefix}${trade.pnl.toFixed(2)}%</div>
                                <div class="text-[10px] text-zinc-500">${isEnglish ? 'P&L' : 'Lucro/Perda'}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-white/5 rounded-lg p-3 text-center">
                                <div class="text-[10px] text-zinc-500 uppercase tracking-wide mb-1">${isEnglish ? 'Entry' : 'Entrada'}</div>
                                <div class="text-sm text-white font-mono">${window.formatPrice ? window.formatPrice(trade.entryPrice) : trade.entryPrice}</div>
                            </div>
                            <div class="bg-white/5 rounded-lg p-3 text-center">
                                <div class="text-[10px] text-zinc-500 uppercase tracking-wide mb-1">${isEnglish ? 'Current' : 'Atual'}</div>
                                <div class="text-sm text-${pnlColor}-400 font-mono">${window.formatPrice ? window.formatPrice(trade.currentPrice) : trade.currentPrice}</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-xs mb-4">
                            <div class="flex justify-between items-center ${trade.targets.tp1Hit ? 'text-emerald-400' : 'text-zinc-400'}">
                                <span>TP1: ${window.formatPrice ? window.formatPrice(trade.targets.tp1) : trade.targets.tp1 || '--'}</span>
                                <span class="flex items-center gap-1">
                                    ${trade.targets.tp1Hit ? '‚úì' : `${pctToTp1}%`}
                                </span>
                            </div>
                            <div class="flex justify-between items-center ${trade.targets.tp2Hit ? 'text-emerald-400' : 'text-zinc-500'}">
                                <span>TP2: ${window.formatPrice ? window.formatPrice(trade.targets.tp2) : trade.targets.tp2 || '--'}</span>
                                <span class="flex items-center gap-1">
                                    ${trade.targets.tp2Hit ? '‚úì' : `${pctToTp2}%`}
                                </span>
                            </div>
                            <div class="flex justify-between items-center ${trade.targets.tp3Hit ? 'text-emerald-400' : 'text-zinc-600'}">
                                <span>TP3: ${window.formatPrice ? window.formatPrice(trade.targets.tp3) : trade.targets.tp3 || '--'}</span>
                                <span class="flex items-center gap-1">
                                    ${trade.targets.tp3Hit ? '‚úì' : `${pctToTp3}%`}
                                </span>
                            </div>
                            <div class="flex justify-between items-center text-rose-400 pt-2 border-t border-white/5">
                                <span>Stop Loss: ${window.formatPrice ? window.formatPrice(trade.stopLoss) : trade.stopLoss}</span>
                                <span>${pctToSl}%</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-3 border-t border-cyan-500/20">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded text-[10px] font-mono font-bold ${isLong ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}">
                                    ${isLong ? 'LONG' : 'SHORT'}
                                </span>
                                <span class="text-[10px] text-zinc-600 font-mono">${timeAgo}</span>
                            </div>
                            <button onclick="window.exitTrade('${trade.symbol}', event)" class="px-3 py-1.5 rounded-lg bg-rose-500/20 text-rose-400 text-[10px] font-mono uppercase tracking-wide hover:bg-rose-500/30 transition-colors flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                                ${isEnglish ? 'Exit' : 'Sair'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        // Initialize stats on load
        window.updateMyTradesStats();
        
        // Sync trades from Supabase on load (async)
        (async function syncOnLoad() {
            // Wait for Supabase to be ready
            await new Promise(r => setTimeout(r, 1000));
            
            if (window.getWalletAddress()) {
                console.log('üìä Syncing trades from Supabase...');
                await window.syncMyTrades();
            } else {
                console.log('‚ö†Ô∏è No wallet address, using localStorage only');
            }
        })();
        
        // Clean old entries (older than 24h)
        (function cleanOldHistory() {
            const now = Date.now();
            const hours24 = 24 * 60 * 60 * 1000;
            window.tpHistory = window.tpHistory.filter(item => (now - item.timestamp) < hours24);
            window.slHistory = window.slHistory.filter(item => (now - item.timestamp) < hours24);
            localStorage.setItem('shdwxbt_tp_history', JSON.stringify(window.tpHistory));
            localStorage.setItem('shdwxbt_sl_history', JSON.stringify(window.slHistory));
        })();
        
        window.filterOpportunities = function(filter) {
            console.log(`üîç Filter changed to: ${filter}`);
            window.currentFilter = filter;
            
            // Update visual state of filter buttons (stats row)
            const filterButtons = document.querySelectorAll('#stats-filter-row > div[data-filter]');
            filterButtons.forEach(btn => {
                const btnFilter = btn.dataset.filter;
                const isActive = btnFilter === filter;
                
                // Ring highlight for active filter
                if (isActive) {
                    btn.classList.add('ring-2');
                    btn.classList.remove('ring-0');
                } else {
                    btn.classList.remove('ring-2');
                    btn.classList.add('ring-0');
                }
            });
            
            // Update My Trades button highlight
            const myTradesBtn = document.getElementById('filter-my-trades');
            if (myTradesBtn) {
                if (filter === 'my-trades') {
                    myTradesBtn.classList.add('ring-2', 'ring-cyan-500/50');
                } else {
                    myTradesBtn.classList.remove('ring-2', 'ring-cyan-500/50');
                }
            }
            
            // Show/hide history sections
            const tpSection = document.getElementById('tp-history-section');
            const slSection = document.getElementById('sl-history-section');
            const mainGrid = document.getElementById('opportunities-grid');
            const sectionHeader = document.getElementById('section-header-confirmed');
            const watchlistSection = document.getElementById('watchlist-section');
            
            if (filter === 'tp-history') {
                console.log('üìä Showing TP History section');
                if (tpSection) {
                    tpSection.classList.remove('hidden');
                    tpSection.style.display = 'block';
                    console.log('TP Section found and shown');
                } else {
                    console.error('TP Section not found!');
                }
                if (slSection) slSection.classList.add('hidden');
                if (mainGrid) mainGrid.classList.add('hidden');
                if (sectionHeader) sectionHeader.classList.add('hidden');
                if (watchlistSection) watchlistSection.classList.add('hidden');
                if (typeof window.renderTPHistory === 'function') {
                    window.renderTPHistory();
                } else {
                    console.error('renderTPHistory not defined!');
                }
                return;
            } else if (filter === 'sl-history') {
                console.log('üìä Showing SL History section');
                if (slSection) {
                    slSection.classList.remove('hidden');
                    slSection.style.display = 'block';
                    console.log('SL Section found and shown');
                } else {
                    console.error('SL Section not found!');
                }
                if (tpSection) tpSection.classList.add('hidden');
                if (mainGrid) mainGrid.classList.add('hidden');
                if (sectionHeader) sectionHeader.classList.add('hidden');
                if (watchlistSection) watchlistSection.classList.add('hidden');
                if (typeof window.renderSLHistory === 'function') {
                    window.renderSLHistory();
                } else {
                    console.error('renderSLHistory not defined!');
                }
                return;
            } else if (filter === 'my-trades') {
                console.log('üìä Showing My Trades section');
                const myTradesSection = document.getElementById('my-trades-section');
                if (myTradesSection) {
                    myTradesSection.classList.remove('hidden');
                    myTradesSection.style.display = 'block';
                }
                if (tpSection) tpSection.classList.add('hidden');
                if (slSection) slSection.classList.add('hidden');
                if (mainGrid) mainGrid.classList.add('hidden');
                if (sectionHeader) sectionHeader.classList.add('hidden');
                if (watchlistSection) watchlistSection.classList.add('hidden');
                if (typeof window.renderMyTrades === 'function') {
                    window.renderMyTrades();
                }
                return;
            } else {
                const myTradesSection = document.getElementById('my-trades-section');
                if (myTradesSection) {
                    myTradesSection.classList.add('hidden');
                    myTradesSection.style.display = '';
                }
                if (tpSection) {
                    tpSection.classList.add('hidden');
                    tpSection.style.display = '';
                }
                if (slSection) {
                    slSection.classList.add('hidden');
                    slSection.style.display = '';
                }
                if (mainGrid) mainGrid.classList.remove('hidden');
                if (sectionHeader) sectionHeader.classList.remove('hidden');
                if (watchlistSection) watchlistSection.classList.remove('hidden');
            }
            
            // Re-render with filter
            window.applyFilter();
        };
        
        // --- ASSET SEARCH FUNCTIONALITY ---
        window.currentSearchQuery = '';
        
        window.handleAssetSearch = function(query) {
            const trimmedQuery = query.trim().toUpperCase();
            window.currentSearchQuery = trimmedQuery;
            
            const clearBtn = document.getElementById('clear-search-btn');
            const searchInfo = document.getElementById('search-results-info');
            
            if (trimmedQuery.length > 0) {
                if (clearBtn) clearBtn.classList.remove('hidden');
            } else {
                if (clearBtn) clearBtn.classList.add('hidden');
                if (searchInfo) searchInfo.classList.add('hidden');
            }
            
            // Reset to 'all' filter when searching
            if (trimmedQuery.length > 0 && window.currentFilter !== 'all') {
                window.filterOpportunities('all');
            } else {
                window.applyFilter();
            }
        };
        
        window.quickSearchAsset = function(symbol) {
            const input = document.getElementById('asset-search-input');
            if (input) {
                input.value = symbol;
                window.handleAssetSearch(symbol);
                input.focus();
            }
        };
        
        window.clearAssetSearch = function() {
            const input = document.getElementById('asset-search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            const searchInfo = document.getElementById('search-results-info');
            
            if (input) input.value = '';
            if (clearBtn) clearBtn.classList.add('hidden');
            if (searchInfo) searchInfo.classList.add('hidden');
            
            window.currentSearchQuery = '';
            window.applyFilter();
        };
        
        window.applyFilter = function() {
            const filter = window.currentFilter;
            const tradingType = window.currentTradingType || 'all';
            const searchQuery = window.currentSearchQuery || '';
            let opportunities = window.currentOpportunities || [];
            let watchlist = window.currentWatchlist || [];
            
            let filtered = [];
            let sectionKey = 'sec_confirmed';
            
            switch(filter) {
                case 'bullish':
                    filtered = opportunities.filter(o => o.trend === 'bullish');
                    sectionKey = 'sec_bullish';
                    break;
                case 'bearish':
                    filtered = opportunities.filter(o => o.trend === 'bearish');
                    sectionKey = 'sec_bearish';
                    break;
                case 'watchlist':
                    filtered = watchlist.map(w => ({
                        ...w,
                        route: { name: w.reason || 'Em Observa√ß√£o' },
                        confluence: { score: w.confluence || w.score || 0 },
                        fibonacci: w.fibonacci || {},
                        status: 'watchlist'
                    }));
                    sectionKey = 'sec_watchlist_filtered';
                    break;
                default: // 'all'
                    filtered = opportunities;
                    sectionKey = 'sec_confirmed';
            }
            
            // Apply trading type filter (Scalping, Day Trading, Swing)
            if (tradingType !== 'all' && filter !== 'watchlist') {
                filtered = filtered.filter(o => {
                    const profile = (o.route?.name || o.tradingProfile || 'day').toLowerCase();
                    switch(tradingType) {
                        case 'scalping':
                            return profile.includes('scalp');
                        case 'day':
                            return profile.includes('day');
                        case 'swing':
                            return profile.includes('swing');
                        default:
                            return true;
                    }
                });
            }
            
            // Apply asset search filter
            if (searchQuery && searchQuery.length > 0) {
                const beforeCount = filtered.length;
                filtered = filtered.filter(o => {
                    const symbol = (o.symbol || '').toUpperCase();
                    const name = (o.name || '').toUpperCase();
                    // Match by symbol or name (supports partial matches)
                    return symbol.includes(searchQuery) || 
                           name.includes(searchQuery) ||
                           symbol.replace('USDT', '').includes(searchQuery);
                });
                
                // Update search results info
                const searchInfo = document.getElementById('search-results-info');
                const countEl = document.getElementById('search-results-count');
                const queryEl = document.getElementById('search-query-display');
                
                if (searchInfo && countEl && queryEl) {
                    searchInfo.classList.remove('hidden');
                    countEl.textContent = filtered.length;
                    queryEl.textContent = searchQuery;
                }
                
                console.log(`üîç Search "${searchQuery}": ${filtered.length} of ${beforeCount} opportunities`);
            }
            
            // Update section header with translation
            const sectionHeader = document.querySelector('[data-key="sec_confirmed"]');
            if (sectionHeader) {
                sectionHeader.textContent = t(sectionKey);
            }
            
            // Render filtered opportunities
            renderOpportunities(filtered);
            
            console.log(`‚úÖ Showing ${filtered.length} ${filter} opportunities`);
        }
        
        // --- RENDER OPPORTUNITIES (OPTIMIZED) ---
        // Usando batched DOM updates para melhor performance
        function renderOpportunities(opportunities) {
            window.PerfMetrics.start('renderOpportunities');
            
            try {
                const grid = document.getElementById('opportunities-grid');
                if (!grid) return;
                
                // Invalidar cache do grid (cards mudaram)
                window.DOMCache.invalidate('#opportunities-grid');
                
                if (!opportunities || opportunities.length === 0) {
                    grid.innerHTML = `
                        <div class="card-panel rounded-[24px] p-8 flex flex-col items-center justify-center min-h-[200px] col-span-full">
                            <span class="text-sm text-zinc-400 font-mono">${t('no_opps')}</span>
                            <span class="text-xs text-zinc-500 mt-2">${t('monitoring')}</span>
                        </div>
                    `;
                    window.PerfMetrics.end('renderOpportunities');
                    return;
                }
                
                // Render em batch usando DocumentFragment para evitar reflows
                const fragment = document.createDocumentFragment();
                const tempDiv = document.createElement('div');
                
                // Gerar HTML de todos os cards
                const cardsHTML = opportunities.map(opp => renderOpportunityCard(opp)).join('');
                tempDiv.innerHTML = cardsHTML;
                
                // Mover nodes para fragment
                while (tempDiv.firstChild) {
                    fragment.appendChild(tempDiv.firstChild);
                }
                
                // Single DOM operation
                grid.innerHTML = '';
                grid.appendChild(fragment);
                
                // Re-init lucide icons (debounced)
                if (typeof lucide !== 'undefined') {
                    requestAnimationFrame(() => lucide.createIcons());
                }
                
                // Subscribe to real-time price updates for all displayed symbols
                const symbols = opportunities.map(opp => opp.symbol);
                if (window.subscribeToSymbols && symbols.length > 0) {
                    console.log(`üì° Subscribing to ${symbols.length} opportunity symbols for real-time prices`);
                    window.subscribeToSymbols(symbols);
                }
                
                window.PerfMetrics.end('renderOpportunities');
            } catch (e) {
                console.warn('‚ö†Ô∏è Error rendering opportunities:', e.message);
                const grid = document.getElementById('opportunities-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div class="card-panel rounded-[24px] p-8 col-span-full">
                            <span class="text-sm text-zinc-400">Failed to load opportunities</span>
                        </div>
                    `;
                }
                window.PerfMetrics.end('renderOpportunities');
            }
        }
        
        function renderOpportunityCard(opp) {
            // =====================================================
            // SKIP RENDERING IF ALL TARGETS ALREADY HIT
            // =====================================================
            const allTargetsHit = opp.targets?.tp1Hit && opp.targets?.tp2Hit && opp.targets?.tp3Hit;
            const stopLossHit = opp.slHit || opp.stopLossHit || opp.invalidated;
            
            if (allTargetsHit || stopLossHit) {
                console.log(`‚è≠Ô∏è Skipping ${opp.symbol}: ${allTargetsHit ? 'All targets hit' : 'Stop loss hit'}`);
                
                // Add to history if not already
                if (allTargetsHit && typeof window.addTPToHistory === 'function') {
                    if (opp.targets?.tp1Hit) window.addTPToHistory(opp.symbol, 'TP1', opp.targets.tp1, opp);
                    if (opp.targets?.tp2Hit) window.addTPToHistory(opp.symbol, 'TP2', opp.targets.tp2, opp);
                    if (opp.targets?.tp3Hit) window.addTPToHistory(opp.symbol, 'TP3', opp.targets.tp3, opp);
                }
                if (stopLossHit && typeof window.addSLToHistory === 'function') {
                    window.addSLToHistory(opp.symbol, opp.invalidation?.price, opp.currentPrice, opp);
                }
                
                // Mark as completed (won't show notification since card isn't rendered)
                if (!window.completedOpportunities?.has(opp.symbol)) {
                    if (!window.completedOpportunities) window.completedOpportunities = new Map();
                    window.completedOpportunities.set(opp.symbol, { 
                        reason: allTargetsHit ? 'all_targets' : 'stop_loss', 
                        timestamp: new Date().toISOString() 
                    });
                }
                
                return ''; // Don't render card
            }
            
            const isBullish = opp.trend === 'bullish';
            const trendColor = isBullish ? 'emerald' : 'rose';
            const trendIcon = isBullish ? 'trending-up' : 'trending-down';
            const trendLabel = isBullish ? t('trend_up') : t('trend_down');
            
            const priceChange = opp.price24hPcnt || 0;
            const priceChangeColor = priceChange >= 0 ? 'text-emerald-500' : 'text-rose-500';
            const priceChangePrefix = priceChange >= 0 ? '+' : '';
            
            const score = opp.confluence?.score || 0;
            const routeLabel = opp.route?.name || t('analysis');
            
            const fib = opp.fibonacci || {};
            
            // Initialize global targets hit state for this symbol if not exists
            if (!window.targetsHitState) {
                window.targetsHitState = {};
            }
            if (!window.targetsHitState[opp.symbol]) {
                window.targetsHitState[opp.symbol] = {
                    tp1: opp.targets?.tp1Hit || false,
                    tp2: opp.targets?.tp2Hit || false,
                    tp3: opp.targets?.tp3Hit || false
                };
            }
            
            // Get crypto logo URL - using coin-images.com (most reliable)
            const baseSymbol = opp.symbol.replace('USDT', '').toLowerCase();
            const logoUrl = getCryptoLogoUrl(baseSymbol);
            
            // Helper to calculate percent difference
            function calculatePercentDiff(current, target) {
                if (!current || !target) return '0.0';
                const diff = Math.abs(((target - current) / current) * 100);
                return diff.toFixed(1);
            }
            
            // Helper to get signal badge based on price proximity to zone
            function getSignalBadge(opp, trendColor) {
                const isBullish = opp.trend === 'bullish';
                const currentPrice = opp.currentPrice;
                const entryZone = opp.targets?.entry;
                
                if (!entryZone || !currentPrice) {
                    return `<span class="flex items-center gap-1.5 px-2 py-0.5 rounded bg-zinc-900/20 border border-zinc-500/20 text-[10px] font-mono text-zinc-400 uppercase tracking-wide">
                        <span class="w-1 h-1 rounded-full bg-zinc-500 animate-pulse"></span>
                        ${t('monitoring_badge')}
                    </span>`;
                }
                
                // Check if price is in entry zone (within 2%)
                const priceInZone = Math.abs((currentPrice - entryZone) / entryZone) < 0.02;
                
                // Check if approaching (within 5%)
                const approaching = Math.abs((currentPrice - entryZone) / entryZone) < 0.05;
                
                if (priceInZone) {
                    return `<span class="flex items-center gap-1.5 px-2 py-0.5 rounded bg-${trendColor}-900/20 border border-${trendColor}-500/20 text-[10px] font-mono text-${trendColor}-400 uppercase tracking-wide">
                        <span class="w-1 h-1 rounded-full bg-${trendColor}-500 animate-pulse"></span>
                        ${isBullish ? t('zone_buy') : t('zone_sell')}
                    </span>`;
                } else if (approaching) {
                    return `<span class="flex items-center gap-1.5 px-2 py-0.5 rounded bg-amber-900/20 border border-amber-500/20 text-[10px] font-mono text-amber-500 uppercase tracking-wide">
                        <span class="w-1 h-1 rounded-full bg-amber-500 animate-pulse"></span>
                        ${t('warn_approach')}
                    </span>`;
                } else {
                    return `<span class="flex items-center gap-1.5 px-2 py-0.5 rounded bg-zinc-900/20 border border-zinc-500/20 text-[10px] font-mono text-zinc-400 uppercase tracking-wide">
                        <span class="w-1 h-1 rounded-full bg-zinc-500"></span>
                        ${t('standby_badge')}
                    </span>`;
                }
            }
            
            return `
                <div id="card-${opp.symbol.toLowerCase()}" class="group relative bg-[#09090b] border border-white/5 rounded-3xl p-6 md:p-8 hover:border-white/10 transition-colors duration-300 shadow-2xl cursor-pointer" 
                     onclick="openOpportunityModal('${opp.symbol}')">
                    
                    <!-- Header -->
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mb-3 text-gray-400 group-hover:text-white transition-colors border border-white/5 overflow-hidden">
                            <img src="${logoUrl}" 
                                 alt="${opp.symbol}" 
                                 class="w-7 h-7 object-contain"
                                 loading="lazy"
                                 decoding="async"
                                 onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                            <i data-lucide="trending-${isBullish ? 'up' : 'down'}" class="w-5 h-5 hidden" stroke-width="1.5"></i>
                        </div>
                        <h3 class="text-lg font-medium text-white tracking-tight">${opp.name || opp.symbol.replace('USDT', '')}</h3>
                        <span class="text-xs font-mono text-gray-500 uppercase tracking-wider mt-1">${opp.symbol}</span>
                        
                        <div class="flex gap-2 mt-4 items-center">
                            <div class="flex items-center gap-2 bg-white/5 px-2 py-1 rounded text-xs font-mono text-gray-400 border border-white/5">
                                <span>${opp.timeframe?.signal || '15m'}</span>
                                <span class="text-gray-600">|</span>
                                <span>${opp.timeframe?.target || '4h'}</span>
                            </div>
                            <div class="flex items-center gap-1 bg-${trendColor}-500/10 px-2 py-1 rounded text-xs font-mono text-${trendColor}-400 border border-${trendColor}-500/20">
                                <span>${trendLabel}</span>
                                <i data-lucide="trending-${isBullish ? 'up' : 'down'}" class="w-3 h-3" stroke-width="1.5"></i>
                            </div>
                        </div>
                        
                        <!-- Warning Badge (if volatile or conflict) -->
                        ${score > 85 ? `
                        <div class="mt-2 flex items-center gap-1.5 text-xs text-amber-500 font-mono bg-amber-500/10 px-3 py-1 rounded border border-amber-500/20">
                            <i data-lucide="alert-triangle" class="w-3 h-3" stroke-width="1.5"></i>
                            <span>${t('warn_volatility')}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Price -->
                    <div class="text-center mb-8">
                        <div class="text-5xl font-mono text-white tracking-tighter tabular-nums">${formatPrice(opp.currentPrice)}</div>
                        <div class="text-sm font-mono ${priceChangeColor} mt-2 flex items-center justify-center gap-1">
                            ${priceChangePrefix}${priceChange.toFixed(2)}% <span class="text-gray-600">(24h)</span>
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-y-6 gap-x-4 border-t border-b border-white/5 py-6 mb-6">
                        <div class="text-center border-r border-white/5">
                            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-mono mb-1">${t('card_zone')}</div>
                            <div class="text-sm text-gray-200 font-mono">${opp.techZone && opp.techZone.min && opp.techZone.max
                                ? `${formatPrice(opp.techZone.min)} - ${formatPrice(opp.techZone.max)}`
                                : (typeof opp.techZone === 'string' && opp.techZone.trim().length > 0
                                    ? opp.techZone
                                    : formatPrice(opp.currentPrice * 0.98) + ' - ' + formatPrice(opp.currentPrice * 1.02))}
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-mono mb-1">${t('card_invalid')}</div>
                            <div class="text-sm text-red-400 font-mono invalidation-price">${formatPrice(opp.invalidation?.price || opp.invalidation?.tactical || opp.targets?.stopLoss || opp.currentPrice * 0.95)} <span class="text-red-400/60">(${calculatePercentDiff(opp.currentPrice, opp.invalidation?.price || opp.invalidation?.tactical || opp.targets?.stopLoss || opp.currentPrice * 0.95)}%)</span></div>
                        </div>
                        <div class="text-center border-r border-white/5">
                            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-mono mb-1">${t('card_rsi')}</div>
                            <div class="text-sm ${opp.rsi > 70 ? 'text-red-400' : opp.rsi < 30 ? 'text-emerald-400' : 'text-white'} font-mono rsi-value" data-rsi="${opp.rsi || 62.4}">${opp.rsi || '62.4'}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-mono mb-1">${t('card_conf')}</div>
                            <div class="text-sm text-white font-mono">${score}%</div>
                        </div>
                    </div>
                    
                    <!-- Targets -->
                    <div class="mb-8">
                        <div class="text-center text-[10px] uppercase tracking-widest text-gray-600 font-mono mb-4">${t('card_targets')}</div>
                        <div class="space-y-3 font-mono text-xs">
                            ${opp.targets?.tp1 ? `
                            <div class="target-line target-tp1 flex justify-between items-center ${opp.targets.tp1Hit ? 'text-emerald-400' : 'text-emerald-500/50'}" data-target="${opp.targets.tp1}" data-type="${isBullish ? 'long' : 'short'}" data-hit="${opp.targets.tp1Hit || false}">
                                <span class="target-text">TP1: ${formatPrice(opp.targets.tp1)} <span class="opacity-50 target-percent">(${calculatePercentDiff(opp.currentPrice, opp.targets.tp1)}%)</span></span>
                                <i data-lucide="check" class="w-3 h-3 target-check ${opp.targets.tp1Hit ? '' : 'hidden'}" stroke-width="2"></i>
                            </div>
                            ` : `
                            <div class="target-line target-tp1 flex justify-between items-center text-emerald-500/50" data-target="${opp.currentPrice * 1.02}" data-type="${isBullish ? 'long' : 'short'}" data-hit="false">
                                <span class="target-text">TP1: ${formatPrice(opp.currentPrice * 1.02)} <span class="opacity-50 target-percent">(2.0%)</span></span>
                                <i data-lucide="check" class="w-3 h-3 target-check hidden" stroke-width="2"></i>
                            </div>
                            `}
                            ${opp.targets?.tp2 ? `
                            <div class="target-line target-tp2 flex justify-between items-center ${opp.targets.tp2Hit ? 'text-emerald-400' : 'text-emerald-500/30'}" data-target="${opp.targets.tp2}" data-type="${isBullish ? 'long' : 'short'}" data-hit="${opp.targets.tp2Hit || false}">
                                <span class="target-text">TP2: ${formatPrice(opp.targets.tp2)} <span class="opacity-50 target-percent">(${calculatePercentDiff(opp.currentPrice, opp.targets.tp2)}%)</span></span>
                                <i data-lucide="check" class="w-3 h-3 target-check ${opp.targets.tp2Hit ? '' : 'hidden'}" stroke-width="2"></i>
                            </div>
                            ` : `
                            <div class="target-line target-tp2 flex justify-between items-center text-emerald-500/30" data-target="${opp.currentPrice * 1.04}" data-type="${isBullish ? 'long' : 'short'}" data-hit="false">
                                <span class="target-text">TP2: ${formatPrice(opp.currentPrice * 1.04)} <span class="opacity-50 target-percent">(4.0%)</span></span>
                                <i data-lucide="check" class="w-3 h-3 target-check hidden" stroke-width="2"></i>
                            </div>
                            `}
                            ${opp.targets?.tp3 ? `
                            <div class="target-line target-tp3 flex justify-between items-center ${opp.targets.tp3Hit ? 'text-emerald-400' : 'text-emerald-500/30'}" data-target="${opp.targets.tp3}" data-type="${isBullish ? 'long' : 'short'}" data-hit="${opp.targets.tp3Hit || false}">
                                <span class="target-text">TP3: ${formatPrice(opp.targets.tp3)} <span class="opacity-50 target-percent">(${calculatePercentDiff(opp.currentPrice, opp.targets.tp3)}%)</span></span>
                                <i data-lucide="check" class="w-3 h-3 target-check ${opp.targets.tp3Hit ? '' : 'hidden'}" stroke-width="2"></i>
                            </div>
                            ` : `
                            <div class="target-line target-tp3 flex justify-between items-center text-emerald-500/30" data-target="${opp.currentPrice * 1.08}" data-type="${isBullish ? 'long' : 'short'}" data-hit="false">
                                <span class="target-text">TP3: ${formatPrice(opp.currentPrice * 1.08)} <span class="opacity-50 target-percent">(8.0%)</span></span>
                                <i data-lucide="check" class="w-3 h-3 target-check hidden" stroke-width="2"></i>
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Entry Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-[10px] uppercase tracking-wider font-mono text-gray-500 mb-2">
                            <span>${t('card_entry')}</span>
                            <span>${opp.entryFilled || Math.floor(score)}% ${t('prog_filled')}</span>
                        </div>
                        <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-${trendColor}-500 to-${trendColor}-400 rounded-full" style="width: ${opp.entryFilled || score}%"></div>
                        </div>
                    </div>
                    
                    <!-- Enter Trade Button -->
                    ${(() => {
                        const inTrade = window.isInTrade && window.isInTrade(opp.symbol);
                        return `
                        <div class="mb-4">
                            <button id="enter-trade-btn-${opp.symbol.toLowerCase()}" 
                                    onclick="window.${inTrade ? 'exitTrade' : 'enterTrade'}('${opp.symbol}', event)"
                                    class="w-full py-2.5 rounded-xl font-mono text-xs uppercase tracking-wide transition-all duration-200 flex items-center justify-center gap-2 ${inTrade ? 'bg-emerald-500/20 text-emerald-400' : 'bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30'}">
                                ${inTrade ? `
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    <span>${t('btn_in_trade')}</span>
                                ` : `
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                                    <span>${t('btn_enter_trade')}</span>
                                `}
                            </button>
                        </div>
                        `;
                    })()}
                    
                    <!-- Signal Status Badge -->
                    <div class="flex items-center justify-between pt-4 border-t border-white/5">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] uppercase tracking-wider text-gray-500 font-mono">${t('card_signal')}</span>
                            <span class="signal-badge" data-entry="${opp.targets?.entry || opp.currentPrice}" data-trend="${opp.trend}">
                                ${getSignalBadge(opp, trendColor)}
                            </span>
                        </div>
                        <i data-lucide="arrow-right" class="w-4 h-4 text-gray-600 group-hover:text-white transition-colors" stroke-width="1.5"></i>
                    </div>
                </div>
            `;
        }
        
        // --- UPDATE STATS ---
        function updateStats(result) {
            const opps = result.opportunities || [];
            const watchlist = result.watchlist || [];
            
            // When we show watchlist as opportunities, count them as active
            const displayedItems = opps.length > 0 ? opps : watchlist;
            
            // Count by trend from ALL displayed items
            const bullish = displayedItems.filter(o => o.trend === 'bullish').length;
            const bearish = displayedItems.filter(o => o.trend === 'bearish').length;
            const activeCount = displayedItems.length;
            
            console.log(`üìä Stats - Active: ${activeCount}, Bullish: ${bullish}, Bearish: ${bearish}, Watch: ${watchlist.length}`);
            
            // Update stat elements by ID (not data-stat attribute)
            const statActive = document.getElementById('stat-active');
            const statBullish = document.getElementById('stat-bullish');
            const statBearish = document.getElementById('stat-bearish');
            const statWatchlist = document.getElementById('stat-watchlist');
            
            if (statActive) {
                statActive.textContent = activeCount;
            } else {
                console.warn('‚ö†Ô∏è stat-active element not found');
            }
            if (statBullish) statBullish.textContent = bullish;
            if (statBearish) statBearish.textContent = bearish;
            if (statWatchlist) statWatchlist.textContent = watchlist.length;
            
            // Also render watchlist section
            renderWatchlistSection(watchlist);
        }
        
        // --- RENDER WATCHLIST SECTION ---
        function renderWatchlistSection(watchlist) {
            const grid = document.getElementById('watchlist-grid');
            if (!grid) return;
            
            if (!watchlist || watchlist.length === 0) {
                grid.innerHTML = `
                    <div class="watchlist-card p-4 rounded-xl flex items-center justify-center col-span-full">
                        <span class="text-xs text-zinc-500 font-mono">Nenhum ativo em observa√ß√£o</span>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = watchlist.map(item => {
                const isBullish = item.trend === 'bullish';
                const trendColor = isBullish ? 'emerald' : 'rose';
                const trendIcon = isBullish ? '‚Üë' : '‚Üì';
                const score = item.score || item.confluence?.score || item.confluence || 0;
                const baseSymbol = item.symbol.replace('USDT', '').toLowerCase();
                const logoUrl = getCryptoLogoUrl(baseSymbol);
                
                return `
                    <div class="watchlist-card p-4 rounded-xl cursor-pointer hover:border-${trendColor}-500/30 transition-all"
                         onclick="openOpportunityModal('${item.symbol}')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-zinc-800/50 flex items-center justify-center overflow-hidden">
                                    <img src="${logoUrl}" 
                                         alt="${item.symbol}" 
                                         class="w-5 h-5 object-contain"
                                         onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<span class=\\'text-[10px] font-bold text-white/50\\'>${baseSymbol.substring(0,2).toUpperCase()}</span>';">
                                </div>
                                <span class="text-sm font-bold text-white">${item.name || item.symbol.replace('USDT', '')}</span>
                                <span class="text-${trendColor}-500 text-xs">${trendIcon}</span>
                            </div>
                            <span class="px-2 py-0.5 rounded text-[9px] font-bold bg-${trendColor}-500/20 text-${trendColor}-500">
                                ${score}%
                            </span>
                        </div>
                        <div class="text-xs text-zinc-500 font-mono truncate" title="${item.reason || ''}">
                            ${item.reason || item.setup || 'Em observa√ß√£o'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- MODAL FUNCTIONS ---
        window.openOpportunityModal = function(symbol) {
            try {
                // Normalizar o s√≠mbolo
                const normalizedSymbol = symbol.toUpperCase().replace('USDT', '') + 'USDT';
                
                // IMPORTANTE: Buscar em TODAS as oportunidades (cache completo), n√£o apenas nas filtradas
                // Isso garante que a an√°lise correta seja carregada mesmo ap√≥s aplicar filtros/busca
                const allOpportunities = window.allOpportunitiesCache || window.currentOpportunities || [];
                const allWatchlist = window.allWatchlistCache || window.currentWatchlist || [];
                const allItems = [...allOpportunities, ...allWatchlist];
                
                let opp = allItems.find(o => {
                    const oppSymbol = (o.symbol || '').toUpperCase();
                    return oppSymbol === normalizedSymbol || 
                           oppSymbol === symbol.toUpperCase() ||
                           oppSymbol.replace('USDT', '') === symbol.toUpperCase().replace('USDT', '');
                });
                
                // Se n√£o encontrar nas oportunidades, buscar nos myTrades e converter para formato de oportunidade
                if (!opp && window.myTrades) {
                    const trade = window.myTrades.find(t => {
                        const tradeSymbol = (t.symbol || '').toUpperCase();
                        return tradeSymbol === normalizedSymbol || 
                               tradeSymbol === symbol.toUpperCase() ||
                               tradeSymbol.replace('USDT', '') === symbol.toUpperCase().replace('USDT', '');
                    });
                    
                    if (trade) {
                        // Converter trade para formato de oportunidade COM AN√ÅLISE COMPLETA
                        const isLong = trade.direction === 'bullish';
                        const dirLabel = isLong ? 'Tend√™ncia de alta' : 'Tend√™ncia de baixa';
                        const pnlStr = `${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}%`;
                        
                        // Usar dados de an√°lise salvos no trade (se existirem)
                        let contextLines = trade.contextLines || [];
                        
                        // Se n√£o tiver contextLines salvas, gerar baseado nos dados do trade
                        if (contextLines.length === 0) {
                            contextLines = [
                                `${trade.tradingProfile || 'Trade'} - Opera√ß√£o em andamento`,
                                `Entrada: ${window.formatPrice ? window.formatPrice(trade.entryPrice) : trade.entryPrice} ‚Ä¢ P&L: ${pnlStr}`,
                                trade.fibonacci && Object.keys(trade.fibonacci).length > 0 
                                    ? `Fibonacci ativo ‚Ä¢ Zona ${trade.fibonacci['0.618'] ? 'OTE' : 'configurada'}`
                                    : `Timeframe: ${trade.timeframe} ‚Ä¢ Score: ${trade.score || 0}`,
                                `Stop Loss: ${window.formatPrice ? window.formatPrice(trade.stopLoss) : trade.stopLoss}`
                            ];
                        } else {
                            // Adicionar P&L atual √†s contextLines existentes
                            contextLines = [
                                contextLines[0] || `${trade.tradingProfile} - Opera√ß√£o em andamento`,
                                `Entrada: ${window.formatPrice ? window.formatPrice(trade.entryPrice) : trade.entryPrice} ‚Ä¢ P&L atual: ${pnlStr}`,
                                ...contextLines.slice(2)
                            ];
                        }
                        
                        opp = {
                            symbol: trade.symbol,
                            name: trade.name || trade.symbol.replace('USDT', ''),
                            trend: trade.direction,
                            currentPrice: trade.currentPrice,
                            targets: trade.targets,
                            invalidation: { price: trade.stopLoss },
                            confluence: trade.confluence || { score: trade.score || 0 },
                            route: { name: trade.tradingProfile },
                            timeframe: { signal: trade.timeframe },
                            // An√°lise completa
                            analysisTitle: trade.analysisTitle || `${trade.name || trade.symbol} ‚Äî ${trade.tradingProfile} ‚Äî ${dirLabel}`,
                            contextLines: contextLines,
                            methodology_summary: trade.methodology_summary || '',
                            setup_type: trade.setup_type || '',
                            institutionalReport: trade.institutionalReport || null,
                            // Dados t√©cnicos
                            fibonacci: trade.fibonacci || {},
                            regime: trade.regime || {},
                            swingLow: trade.swingLow,
                            swingHigh: trade.swingHigh,
                            // Flag para indicar que veio de myTrades
                            fromMyTrades: true,
                            entryPrice: trade.entryPrice,
                            pnl: trade.pnl
                        };
                        console.log('üìä Trade encontrado em myTrades, convertido para oportunidade com an√°lise completa:', opp.symbol);
                    }
                }
                
                if (!opp) {
                    console.warn(`‚ö†Ô∏è Opportunity not found for: ${symbol} (normalized: ${normalizedSymbol})`);
                    console.log('Available symbols:', allItems.map(o => o.symbol).join(', '));
                    // Mostrar mensagem amig√°vel
                    if (typeof showNotification === 'function') {
                        showNotification(`An√°lise de ${symbol} n√£o dispon√≠vel no momento`, 'warning');
                    }
                    return;
                }
                
                // Store the current opportunity being viewed
                window._currentModalOpp = opp;
                window._currentModalSymbol = opp.symbol;
                
                console.log(`üìä Opening modal for: ${opp.symbol}`, opp.name || opp.symbol);
                
                // 1) Abrir o modal
                const modal = document.getElementById('detail-modal');
                if (modal) {
                    modal.classList.remove('hidden-modal');
                    modal.classList.add('visible-modal');
                    
                    // Prevent body scroll on mobile when modal is open
                    if (window.innerWidth <= 768) {
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                    }
                }
                
                // 2) FOR√áAR update do sidebar (criar c√≥pia do objeto para garantir re-render)
                const oppCopy = JSON.parse(JSON.stringify(opp));
                
                if (typeof window.updateSidebar === 'function') {
                    window.updateSidebar(oppCopy);
                }
                
                if (typeof window.updateChartOverlay === 'function') {
                    window.updateChartOverlay(oppCopy);
                }
                
                // 3) Atualizar o gr√°fico TradingView IMEDIATAMENTE (requestId controla concorr√™ncia)
                if (typeof window.changeChartSymbol === 'function') {
                    window.changeChartSymbol(opp.symbol);
                }
                
            } catch (e) {
                console.error('‚ö†Ô∏è Error opening modal:', e);
            }
        };

        // --- TRADINGVIEW CHART INITIALIZATION ---
        (function initTradingViewChart() {
            // Current state - exposed to window for debugging
            window._tvCurrentSymbol = 'BINANCE:BTCUSDT.P';
            window._tvCurrentInterval = '60';
            window._tvWidget = null;
            window._tvWidgetReady = false;
            window._tvRequestId = 0; // ID para cancelar requisi√ß√µes antigas
            window._tvPendingSymbol = null; // S√≠mbolo pendente de carregamento
            
            // Fun√ß√£o para formatar s√≠mbolo como perp√©tuo
            function formatPerpetualSymbol(symbol) {
                const base = symbol.replace('USDT', '').replace('.P', '').toUpperCase();
                return `BINANCE:${base}USDT.P`;
            }
            
            // Create TradingView widget
            window._createTVWidget = function(symbol, interval, requestId) {
                // Se n√£o foi passado requestId, criar um novo
                if (requestId === undefined) {
                    window._tvRequestId++;
                    requestId = window._tvRequestId;
                }
                
                // Cancelar se h√° requisi√ß√£o mais recente
                if (requestId !== window._tvRequestId) {
                    console.log(`‚è≠Ô∏è TradingView: Ignorando requisi√ß√£o antiga #${requestId} (atual: #${window._tvRequestId})`);
                    return;
                }
                
                const container = document.getElementById('tradingview_chart');
                if (!container) {
                    console.error('‚ùå TradingView container not found');
                    return;
                }
                
                // Garantir que s√≠mbolo seja perp√©tuo
                const perpSymbol = symbol.includes('.P') ? symbol : formatPerpetualSymbol(symbol.replace('BINANCE:', ''));
                
                // Guardar s√≠mbolo pendente
                window._tvPendingSymbol = perpSymbol;
                
                console.log(`üìä TradingView #${requestId}: Carregando ${perpSymbol}...`);
                
                // Wait for TradingView to be ready
                if (typeof TradingView === 'undefined') {
                    console.log('‚è≥ Aguardando TradingView library...');
                    container.innerHTML = '<div class="flex items-center justify-center h-full text-white/50"><span class="animate-pulse">Carregando gr√°fico...</span></div>';
                    setTimeout(() => window._createTVWidget(symbol, interval, requestId), 1000);
                    return;
                }
                
                // Verificar novamente se esta requisi√ß√£o ainda √© v√°lida
                if (requestId !== window._tvRequestId) {
                    console.log(`‚è≠Ô∏è TradingView: Cancelado #${requestId} durante carregamento`);
                    return;
                }
                
                // Destroy previous widget if exists
                if (window._tvWidget) {
                    try { 
                        if (typeof window._tvWidget.remove === 'function') {
                            window._tvWidget.remove();
                        }
                    } catch(e) {
                        console.warn('Warning removing old widget:', e);
                    }
                    window._tvWidget = null;
                    window._tvWidgetReady = false;
                }
                
                // Limpar container e garantir dimens√µes
                container.innerHTML = '';
                container.style.minHeight = '400px';
                
                // Verificar NOVAMENTE se requisi√ß√£o ainda √© v√°lida
                if (requestId !== window._tvRequestId) {
                    console.log(`‚è≠Ô∏è TradingView: Cancelado #${requestId} antes de criar widget`);
                    return;
                }
                
                try {
                    const widgetConfig = {
                        autosize: true,
                        symbol: perpSymbol,
                        interval: interval || '60',
                        timezone: "Etc/UTC",
                        theme: "dark",
                        style: "1",
                        locale: "en",
                        container_id: "tradingview_chart",
                        hide_side_toolbar: false,
                        allow_symbol_change: true,
                        withdateranges: true,
                        save_image: false,
                        studies: [],
                        show_popup_button: true,
                        popup_width: "1000",
                        popup_height: "650",
                        loading_screen: { backgroundColor: "#0a0a0a", foregroundColor: "#10b981" },
                        disabled_features: ["header_symbol_search", "header_screenshot", "header_compare", "use_localstorage_for_settings"],
                        enabled_features: ["hide_left_toolbar_by_default"],
                        overrides: {
                            "paneProperties.background": "#0a0a0a",
                            "paneProperties.backgroundType": "solid"
                        }
                    };
                    
                    window._tvWidget = new TradingView.widget(widgetConfig);
                    
                    // S√≥ atualizar estado se ainda for a requisi√ß√£o v√°lida
                    if (requestId === window._tvRequestId) {
                        window._tvCurrentSymbol = perpSymbol;
                        window._tvWidgetReady = true;
                        window._tvPendingSymbol = null;
                        console.log(`‚úÖ TradingView #${requestId}: ${perpSymbol} carregado`);
                    } else {
                        console.log(`‚è≠Ô∏è TradingView: Widget #${requestId} criado mas j√° obsoleto`);
                        // Destruir este widget pois j√° h√° outro mais recente
                        try { window._tvWidget.remove(); } catch(e) {}
                    }
                    
                } catch (e) {
                    console.error('‚ùå TradingView widget error:', e);
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-white/50 gap-4">
                            <span>Erro ao carregar gr√°fico</span>
                            <button onclick="window._createTVWidget(window._tvCurrentSymbol, window._tvCurrentInterval)" 
                                    class="px-4 py-2 bg-emerald-500/20 text-emerald-400 rounded hover:bg-emerald-500/30 transition">
                                Tentar novamente
                            </button>
                        </div>`;
                }
            };
            
            // Initialize with BTC after page load
            setTimeout(() => window._createTVWidget(window._tvCurrentSymbol, window._tvCurrentInterval), 1000);
            
            // Re-create widget on window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const modal = document.getElementById('detail-modal');
                    if (window._tvWidget && modal && modal.classList.contains('visible-modal')) {
                        window._createTVWidget(window._tvCurrentSymbol, window._tvCurrentInterval);
                    }
                }, 500);
            });
            
            // Timeframe buttons
            const timeframeMap = {
                '5m': '5',
                '15m': '15',
                '30m': '30',
                '1h': '60',
                '4h': '240',
                '12h': '720',
                '1D': 'D',
                '1W': 'W',
                '1M': 'M'
            };
            
            document.querySelectorAll('.h-14 button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tf = this.textContent.trim();
                    if (timeframeMap[tf]) {
                        window._tvCurrentInterval = timeframeMap[tf];
                        window._createTVWidget(window._tvCurrentSymbol, window._tvCurrentInterval);
                        
                        // Update active state
                        document.querySelectorAll('.h-14 button').forEach(b => {
                            b.classList.remove('bg-white/10', 'text-white', 'font-medium');
                            b.classList.add('text-zinc-500');
                        });
                        this.classList.add('bg-white/10', 'text-white', 'font-medium');
                        this.classList.remove('text-zinc-500');
                    }
                });
            });
            
            // Function to change chart symbol (sempre perp√©tuo)
            window.changeChartSymbol = function(symbol) {
                if (!symbol) {
                    console.warn('changeChartSymbol: symbol is empty');
                    return;
                }
                
                const cleanSymbol = symbol.replace('USDT', '').replace('.P', '').toUpperCase();
                const newSymbol = `BINANCE:${cleanSymbol}USDT.P`;
                
                // Incrementar requestId para cancelar requisi√ß√µes anteriores
                window._tvRequestId++;
                const requestId = window._tvRequestId;
                
                console.log(`üîÑ changeChartSymbol #${requestId}: ${symbol} -> ${newSymbol}`);
                
                // Atualizar s√≠mbolo global
                window._tvCurrentSymbol = newSymbol;
                
                // Criar widget com requestId para controle de concorr√™ncia
                window._createTVWidget(newSymbol, window._tvCurrentInterval, requestId);

                // Guarantee real-time feed matches the chart symbol
                if (window.subscribeToSymbols) {
                    window.subscribeToSymbols([cleanSymbol + 'USDT']);
                }
                
                // Update Chart Levels overlay with opportunity data
                if (typeof window.updateChartOverlay === 'function') {
                    const allItems = [...(window.currentOpportunities || []), ...(window.currentWatchlist || [])];
                    const opp = allItems.find(o => {
                        const oppBase = (o.symbol || '').replace('USDT', '').toUpperCase();
                        return oppBase === cleanSymbol;
                    });
                    if (opp) {
                        window.updateChartOverlay(opp);
                    }
                }
            };
            
            // Listen for opportunity card clicks
            document.addEventListener('click', function(e) {
                const card = e.target.closest('.card-panel[id^="card-"]');
                if (card) {
                    const symbol = card.id.replace('card-', '').toUpperCase();
                    if (symbol) {
                        window.changeChartSymbol(symbol);
                    }
                }
            });
        })();

        // --- DRAGGABLE CHART LEVELS CARD (Desktop & Mobile) ---
        (function initDraggableChartLevels() {
            const card = document.getElementById('chart-levels-card');
            const header = document.getElementById('chart-levels-header');
            if (!card || !header) return;
            
            // Check if mobile
            const isMobile = () => window.innerWidth <= 768;
            
            // Dragging state
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            // Get chart container bounds for constraining
            function getChartBounds() {
                const container = document.getElementById('chart-container');
                if (container) {
                    return container.getBoundingClientRect();
                }
                return { left: 0, top: 0, right: window.innerWidth, bottom: window.innerHeight };
            }
            
            // Constrain position within chart bounds
            function constrainPosition(x, y, cardRect) {
                const bounds = getChartBounds();
                const maxX = bounds.right - cardRect.width - 8;
                const maxY = bounds.bottom - cardRect.height - 8;
                const minX = bounds.left + 8;
                const minY = bounds.top + 8;
                
                return {
                    x: Math.max(minX, Math.min(maxX, x)),
                    y: Math.max(minY, Math.min(maxY, y))
                };
            }
            
            // Apply position
            function setCardPosition(x, y) {
                card.style.position = 'fixed';
                card.style.left = x + 'px';
                card.style.top = y + 'px';
                card.style.right = 'auto';
                card.style.bottom = 'auto';
            }
            
            // Desktop mouse events
            header.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = card.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;
                
                setCardPosition(initialX, initialY);
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const cardRect = card.getBoundingClientRect();
                
                const constrained = constrainPosition(initialX + dx, initialY + dy, cardRect);
                setCardPosition(constrained.x, constrained.y);
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            // Touch events for mobile dragging
            header.addEventListener('touchstart', function(e) {
                isDragging = true;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                
                const rect = card.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;
                
                setCardPosition(initialX, initialY);
            }, { passive: true });
            
            document.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                
                const touch = e.touches[0];
                const dx = touch.clientX - startX;
                const dy = touch.clientY - startY;
                const cardRect = card.getBoundingClientRect();
                
                const constrained = constrainPosition(initialX + dx, initialY + dy, cardRect);
                setCardPosition(constrained.x, constrained.y);
            }, { passive: true });
            
            document.addEventListener('touchend', function() {
                isDragging = false;
            }, { passive: true });
            
            // Reset position when modal opens
            window.resetChartLevelsPosition = function() {
                card.style.position = '';
                card.style.left = '';
                card.style.top = '';
                card.style.right = '';
                card.style.bottom = '';
            };
            
            // Update on resize
            window.addEventListener('resize', function() {
                // Reset to CSS defaults on resize
                window.resetChartLevelsPosition();
            });
        })();

        // --- BINANCE FUTURES API - REAL-TIME DATA ---
        window.fetchFuturesData = async function(symbol) {
            try {
                // Remove USDT suffix if present for API call
                const futuresSymbol = symbol.endsWith('USDT') ? symbol : symbol + 'USDT';
                
                const [longShortRes, fundingRes, oiRes] = await Promise.all([
                    // Long/Short Account Ratio (Global) - FUTUROS
                    fetch(`https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=${futuresSymbol}&period=5m&limit=1`),
                    // Funding Rate - FUTUROS
                    fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${futuresSymbol}&limit=1`),
                    // Open Interest History - FUTUROS
                    fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${futuresSymbol}&period=5m&limit=2`)
                ]);
                
                const result = {
                    longShortRatio: null,
                    longAccountPct: null,
                    shortAccountPct: null,
                    fundingRate: null,
                    openInterest: null,
                    openInterestChange24h: null
                };
                
                // Long/Short Ratio
                if (longShortRes.ok) {
                    const lsData = await longShortRes.json();
                    if (lsData && lsData[0]) {
                        result.longShortRatio = parseFloat(lsData[0].longShortRatio) || 1;
                        result.longAccountPct = parseFloat(lsData[0].longAccount) * 100 || 50;
                        result.shortAccountPct = parseFloat(lsData[0].shortAccount) * 100 || 50;
                    }
                }
                
                // Funding Rate
                if (fundingRes.ok) {
                    const fundingData = await fundingRes.json();
                    if (fundingData && fundingData[0]) {
                        result.fundingRate = parseFloat(fundingData[0].fundingRate) || 0;
                    }
                }
                
                // Open Interest
                if (oiRes.ok) {
                    const oiData = await oiRes.json();
                    if (oiData && oiData.length >= 2) {
                        const currentOI = parseFloat(oiData[oiData.length - 1].sumOpenInterest) || 0;
                        const prevOI = parseFloat(oiData[0].sumOpenInterest) || 0;
                        result.openInterest = currentOI;
                        if (prevOI > 0) {
                            result.openInterestChange24h = ((currentOI - prevOI) / prevOI) * 100;
                        }
                    }
                }
                
                console.log(`üìä Futures data for ${futuresSymbol}:`, result);
                return result;
            } catch (error) {
                console.warn(`‚ö†Ô∏è Could not fetch futures data for ${symbol}:`, error);
                return null;
            }
        };
        
        // --- CHART LEVELS OVERLAY - REAL-TIME DATA ---
        (function initChartLevelsOverlay() {
            // Format price based on value - global for sidebar too
            window.formatPrice = function(price) {
                if (!price || isNaN(price)) return '--';
                if (price < 0.001) return price.toFixed(8);
                if (price < 1) return price.toFixed(6);
                if (price < 100) return price.toFixed(4);
                return price.toFixed(2);
            };
            
            // Update overlay with opportunity data
            window.updateChartOverlay = function(opp) {
                if (!opp) return;
                
                const isLong = opp.trend === 'bullish';
                
                // Clear previous hit states and styles
                const tpElements = ['overlay-tp1', 'overlay-tp2', 'overlay-tp3', 'overlay-stoploss'];
                tpElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove('line-through', 'opacity-50');
                    }
                });
                
                // Use targets from database (same as cards)
                const tp1Price = opp.targets?.tp1 || null;
                const tp2Price = opp.targets?.tp2 || null;
                const tp3Price = opp.targets?.tp3 || null;
                
                // Build targets array for compatibility
                let targets = [];
                if (tp1Price) {
                    const tp1Pct = Math.abs(((tp1Price - opp.currentPrice) / opp.currentPrice) * 100);
                    targets.push({ price: tp1Price, pct: tp1Pct });
                }
                if (tp2Price) {
                    const tp2Pct = Math.abs(((tp2Price - opp.currentPrice) / opp.currentPrice) * 100);
                    targets.push({ price: tp2Price, pct: tp2Pct });
                }
                if (tp3Price) {
                    const tp3Pct = Math.abs(((tp3Price - opp.currentPrice) / opp.currentPrice) * 100);
                    targets.push({ price: tp3Price, pct: tp3Pct });
                }
                
                // Direction badge
                const directionEl = document.getElementById('overlay-direction');
                const directionIcon = document.getElementById('overlay-direction-icon');
                const directionText = document.getElementById('overlay-direction-text');
                
                if (directionEl && directionText) {
                    if (isLong) {
                        directionEl.className = 'w-full py-1.5 mb-4 rounded bg-emerald-500/10 border border-emerald-500/20 text-center flex items-center justify-center gap-2';
                        directionText.className = 'text-xs font-mono font-bold text-emerald-500 tracking-widest';
                        directionText.textContent = t('long');
                        if (directionIcon) {
                            directionIcon.innerHTML = '<polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline>';
                            directionIcon.className.baseVal = 'lucide lucide-trending-up text-emerald-500';
                        }
                    } else {
                        directionEl.className = 'w-full py-1.5 mb-4 rounded bg-rose-500/10 border border-rose-500/20 text-center flex items-center justify-center gap-2';
                        directionText.className = 'text-xs font-mono font-bold text-rose-500 tracking-widest';
                        directionText.textContent = t('short');
                        if (directionIcon) {
                            directionIcon.innerHTML = '<polyline points="22 17 13.5 8.5 8.5 13.5 2 6"></polyline><polyline points="16 17 22 17 22 11"></polyline>';
                            directionIcon.className.baseVal = 'lucide lucide-trending-down text-rose-500';
                        }
                    }
                }
                
                // Entry Zone (Tech Zone / OTE) - Generate from Fibonacci if not provided
                const entryZoneEl = document.getElementById('overlay-entry-zone');
                let entryZoneStart = null;
                let entryZoneEnd = null;
                
                if (entryZoneEl) {
                    // DEBUG: Log what we have
                    console.log('üìç Entry Zone Debug:', {
                        techZone: opp.techZone,
                        entryZone: opp.entryZone,
                        fibonacci: opp.fibonacci,
                        currentPrice: opp.currentPrice
                    });
                    
                    // Prioridade 1: techZone do banco de dados
                    if (opp.techZone && opp.techZone.min && opp.techZone.max) {
                        // Usar exatamente como vem do banco (min = menor, max = maior)
                        entryZoneStart = opp.techZone.max; // Pre√ßo maior (topo da zona)
                        entryZoneEnd = opp.techZone.min;   // Pre√ßo menor (fundo da zona)
                        console.log('‚úÖ Using techZone from DB:', entryZoneEnd, '-', entryZoneStart);
                        entryZoneEl.textContent = `${window.formatPrice(entryZoneEnd)} - ${window.formatPrice(entryZoneStart)}`;
                    } 
                    // Prioridade 2: entryZone calculada
                    else if (opp.entryZone && opp.entryZone.min && opp.entryZone.max) {
                        entryZoneStart = opp.entryZone.max;
                        entryZoneEnd = opp.entryZone.min;
                        console.log('‚úÖ Using entryZone:', entryZoneEnd, '-', entryZoneStart);
                        entryZoneEl.textContent = `${window.formatPrice(entryZoneEnd)} - ${window.formatPrice(entryZoneStart)}`;
                    } 
                    // Prioridade 3: Calcular baseado no pre√ßo atual (mesma l√≥gica do card)
                    else {
                        // Usar 2% em torno do pre√ßo atual (mesma l√≥gica do card principal)
                        const priceBasis = opp.currentPrice || 0;
                        if (priceBasis > 0) {
                            entryZoneEnd = priceBasis * 0.98;   // 2% abaixo
                            entryZoneStart = priceBasis * 1.02; // 2% acima
                            console.log('‚ö†Ô∏è Using fallback 2% zone:', entryZoneEnd, '-', entryZoneStart);
                            entryZoneEl.textContent = `${window.formatPrice(entryZoneEnd)} - ${window.formatPrice(entryZoneStart)}`;
                        } else {
                            entryZoneEl.textContent = '--';
                        }
                    }
                }
                
                // Targets - with placeholder handling
                const tp1El = document.getElementById('overlay-tp1');
                const tp2El = document.getElementById('overlay-tp2');
                const tp3El = document.getElementById('overlay-tp3');
                const tp1StatusEl = document.getElementById('overlay-tp1-status');
                const tp2StatusEl = document.getElementById('overlay-tp2-status');
                const tp3StatusEl = document.getElementById('overlay-tp3-status');
                
                // Store targets globally for real-time checking
                // Restore hit state from global tracking if available
                const symbolHitState = window.targetsHitState?.[opp.symbol] || { tp1: false, tp2: false, tp3: false };
                
                window.activeTargets = {
                    isLong: isLong,
                    entryPrice: opp.currentPrice,
                    entryZoneStart: entryZoneStart, // Top of zone (premium price)
                    entryZoneEnd: entryZoneEnd,     // Bottom of zone (discount price)
                    tp1: targets[0]?.price || null,
                    tp2: targets[1]?.price || null,
                    tp3: targets[2]?.price || null,
                    stopLoss: opp.invalidation?.price || opp.invalidation?.tactical || null,
                    tp1Hit: symbolHitState.tp1,
                    tp2Hit: symbolHitState.tp2,
                    tp3Hit: symbolHitState.tp3,
                    slHit: false,
                    pm: null,            // Will be calculated by scaled orders
                    scaledOrders: null   // Will be calculated by scaled orders
                };
                
                // Calculate scaled orders if capital is set
                setTimeout(() => window.calculateScaledOrders(), 100);
                
                // Set status indicators based on existing state
                if (tp1StatusEl) {
                    if (symbolHitState.tp1) {
                        tp1StatusEl.classList.remove('hidden');
                        if (tp1El) tp1El.classList.add('line-through', 'opacity-50');
                    } else {
                        tp1StatusEl.classList.add('hidden');
                    }
                }
                if (tp2StatusEl) {
                    if (symbolHitState.tp2) {
                        tp2StatusEl.classList.remove('hidden');
                        if (tp2El) tp2El.classList.add('line-through', 'opacity-50');
                    } else {
                        tp2StatusEl.classList.add('hidden');
                    }
                }
                if (tp3StatusEl) {
                    if (symbolHitState.tp3) {
                        tp3StatusEl.classList.remove('hidden');
                        if (tp3El) tp3El.classList.add('line-through', 'opacity-50');
                    } else {
                        tp3StatusEl.classList.add('hidden');
                    }
                }
                const slStatusEl = document.getElementById('overlay-sl-status');
                if (slStatusEl) slStatusEl.classList.add('hidden');
                
                // ============================================================
                // VERIFICA√á√ÉO INICIAL: Checar se pre√ßo j√° atingiu alvos/stop
                // ============================================================
                const currentPrice = opp.currentPrice;
                const stopPrice = opp.invalidation?.price || opp.invalidation?.tactical;
                
                // Fun√ß√£o para verificar hits iniciais
                function checkInitialHits() {
                    const statusBox = document.getElementById('trade-status-box');
                    const statusContent = document.getElementById('trade-status-content');
                    
                    // Check Stop Loss hit
                    if (stopPrice) {
                        const stopHit = isLong ? currentPrice <= stopPrice : currentPrice >= stopPrice;
                        if (stopHit) {
                            window.activeTargets.slHit = true;
                            const slEl = document.getElementById('overlay-stoploss');
                            if (slEl) slEl.classList.add('line-through', 'opacity-50');
                            if (slStatusEl) slStatusEl.classList.remove('hidden');
                            
                            // Mostrar status no sidebar
                            if (statusBox && statusContent) {
                                statusBox.classList.remove('hidden');
                                statusContent.className = 'p-4 rounded-lg border border-rose-500/50 bg-rose-500/10';
                                statusContent.innerHTML = `
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">‚ö†Ô∏è</span>
                                        <div>
                                            <div class="text-rose-400 font-bold text-sm">STOP J√Å ATINGIDO</div>
                                            <div class="text-rose-300/70 text-xs">${opp.symbol}</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs mt-3 pt-2 border-t border-rose-500/20">
                                        <span class="text-zinc-400">Stop: <span class="text-rose-400">${window.formatPrice(stopPrice)}</span></span>
                                        <span class="text-zinc-400">Pre√ßo atual: <span class="text-white">${window.formatPrice(currentPrice)}</span></span>
                                    </div>
                                    <p class="text-[10px] text-rose-300/60 mt-2">Esta oportunidade foi invalidada. Pre√ßo ultrapassou o stop loss.</p>
                                `;
                            }
                            console.log('‚ö†Ô∏è Stop j√° atingido ao carregar:', opp.symbol);
                            return true; // Stop hit
                        }
                    }
                    
                    // Check TPs hit
                    const tpsToCheck = [
                        { target: targets[0], key: 'tp1', el: tp1El, statusEl: tp1StatusEl },
                        { target: targets[1], key: 'tp2', el: tp2El, statusEl: tp2StatusEl },
                        { target: targets[2], key: 'tp3', el: tp3El, statusEl: tp3StatusEl }
                    ];
                    
                    let lastHitTP = null;
                    tpsToCheck.forEach(tp => {
                        if (tp.target?.price) {
                            const tpHit = isLong ? currentPrice >= tp.target.price : currentPrice <= tp.target.price;
                            if (tpHit) {
                                window.activeTargets[`${tp.key}Hit`] = true;
                                if (tp.el) tp.el.classList.add('line-through', 'opacity-50');
                                if (tp.statusEl) tp.statusEl.classList.remove('hidden');
                                lastHitTP = tp.key.toUpperCase();
                            }
                        }
                    });
                    
                    if (lastHitTP && statusBox && statusContent) {
                        statusBox.classList.remove('hidden');
                        statusContent.className = 'p-4 rounded-lg border border-emerald-500/50 bg-emerald-500/10';
                        statusContent.innerHTML = `
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-2xl">üéØ</span>
                                <div>
                                    <div class="text-emerald-400 font-bold text-sm">${lastHitTP} J√Å ATINGIDO</div>
                                    <div class="text-emerald-300/70 text-xs">${opp.symbol}</div>
                                </div>
                            </div>
                            <p class="text-[10px] text-emerald-300/60 mt-2">Pre√ßo j√° alcan√ßou este alvo. Considere os pr√≥ximos n√≠veis ou aguarde nova oportunidade.</p>
                        `;
                    }
                    
                    return false;
                }
                
                // Reset status box para nova oportunidade
                const statusBox = document.getElementById('trade-status-box');
                if (statusBox) statusBox.classList.add('hidden');
                
                // Verificar hits iniciais ap√≥s pequeno delay
                setTimeout(checkInitialHits, 200);
                
                if (tp1El) {
                    if (targets[0]) {
                        const rr1 = opp.risk_reward_tp1 || opp.riskRewardTP1 || '';
                        const rrLabel = rr1 ? ` <span class="text-yellow-500/60">[${rr1}R]</span>` : '';
                        tp1El.innerHTML = `${window.formatPrice(targets[0].price)} <span class="${isLong ? 'text-emerald-500/50' : 'text-rose-500/50'}">(${Math.abs(targets[0].pct)?.toFixed(1) || '--'}%)</span>${rrLabel}`;
                        tp1El.dataset.price = targets[0].price;
                    } else {
                        tp1El.textContent = '--';
                        tp1El.dataset.price = '';
                    }
                }
                if (tp2El) {
                    if (targets[1]) {
                        const rr2 = opp.risk_reward_tp2 || opp.riskRewardTP2 || '';
                        const rrLabel = rr2 ? ` <span class="text-yellow-500/60">[${rr2}R]</span>` : '';
                        tp2El.innerHTML = `${window.formatPrice(targets[1].price)} <span class="${isLong ? 'text-emerald-500/50' : 'text-rose-500/50'}">(${Math.abs(targets[1].pct)?.toFixed(1) || '--'}%)</span>${rrLabel}`;
                        tp2El.dataset.price = targets[1].price;
                    } else {
                        tp2El.textContent = '--';
                        tp2El.dataset.price = '';
                    }
                }
                if (tp3El) {
                    if (targets[2]) {
                        const rr3 = opp.risk_reward_tp3 || opp.riskRewardTP3 || '';
                        const rrLabel = rr3 ? ` <span class="text-yellow-500/60">[${rr3}R]</span>` : '';
                        tp3El.innerHTML = `${window.formatPrice(targets[2].price)} <span class="${isLong ? 'text-emerald-500/50' : 'text-rose-500/50'}">(${Math.abs(targets[2].pct)?.toFixed(1) || '--'}%)</span>${rrLabel}`;
                        tp3El.dataset.price = targets[2].price;
                    } else {
                        tp3El.textContent = '--';
                        tp3El.dataset.price = '';
                    }
                }
                
                // Stop Loss / Invalidation
                const stopLossEl = document.getElementById('overlay-stoploss');
                if (stopLossEl && opp.invalidation) {
                    const invalidationPrice = opp.invalidation.price || opp.invalidation.tactical;
                    const slPct = invalidationPrice ? Math.abs((opp.currentPrice - invalidationPrice) / opp.currentPrice * 100) : 0;
                    stopLossEl.innerHTML = `${window.formatPrice(invalidationPrice)} <span class="text-rose-500/50">(-${slPct.toFixed(1)}%)</span>`;
                    stopLossEl.dataset.price = invalidationPrice;
                }
                
                // Current price - SET DATASET.SYMBOL FOR REAL-TIME UPDATES
                const currentEl = document.getElementById('overlay-current');
                if (currentEl) {
                    currentEl.textContent = window.formatPrice(opp.currentPrice);
                    currentEl.dataset.symbol = opp.symbol; // Track which symbol is active
                    window.currentActiveSymbol = opp.symbol; // Global reference
                    console.log('üìç Active symbol set to:', opp.symbol);
                }
                
                // Risk/Reward ratio - prefer pre-calculated from backend
                const rrEl = document.getElementById('overlay-rr');
                const invalidationPrice = opp.invalidation?.price || opp.invalidation?.tactical;
                
                // Check for backend-calculated R:R values
                const backendRR1 = opp.risk_reward_tp1 || opp.riskRewardTP1;
                const backendRR2 = opp.risk_reward_tp2 || opp.riskRewardTP2;
                const backendRR3 = opp.risk_reward_tp3 || opp.riskRewardTP3;
                
                if (rrEl) {
                    if (backendRR1) {
                        // Use pre-calculated R:R from Advanced Risk Management system
                        rrEl.textContent = `1:${backendRR1}`;
                        rrEl.dataset.preCalc = backendRR1;
                        rrEl.title = `TP1: 1:${backendRR1} | TP2: 1:${backendRR2 || '--'} | TP3: 1:${backendRR3 || '--'}`;
                    } else if (invalidationPrice && targets && targets[0]) {
                        // Fallback to manual calculation
                        const risk = Math.abs(opp.currentPrice - invalidationPrice);
                        const reward = Math.abs(targets[0].price - opp.currentPrice);
                        const rr = risk > 0 ? (reward / risk).toFixed(2) : '--';
                        rrEl.textContent = `1:${rr}`;
                        rrEl.dataset.preCalc = '';
                    }
                }
                
                // Also update sidebar
                window.updateSidebar(opp);
                
                // Initialize timeline with existing TP/SL hit timestamps
                if (typeof window.initializeTimeline === 'function') {
                    window.initializeTimeline(opp.symbol, opp);
                }
                
                // Calculate scaled orders and P&L if capital is set
                window.calculateScaledOrders();
                window.calculatePnL();
                
                // Re-apply translations to all modal elements (completar tradu√ß√£o)
                if (typeof i18n !== 'undefined' && i18n.updateUI) {
                    i18n.updateUI();
                }
            };
            
            // =====================================================================
            // P&L CALCULATOR - Calculate profit/loss based on user capital & leverage
            // =====================================================================
            window.currentLeverage = 1; // Default leverage
            
            window.setLeverage = function(leverage) {
                window.currentLeverage = leverage;
                
                // Update button styles
                document.querySelectorAll('.leverage-btn').forEach(btn => {
                    const btnLeverage = parseInt(btn.dataset.leverage);
                    if (btnLeverage === leverage) {
                        btn.classList.remove('bg-white/5', 'text-zinc-400', 'border-white/10');
                        btn.classList.add('bg-yellow-500/20', 'text-yellow-500', 'border-yellow-500/30');
                    } else {
                        btn.classList.remove('bg-yellow-500/20', 'text-yellow-500', 'border-yellow-500/30');
                        btn.classList.add('bg-white/5', 'text-zinc-400', 'border-white/10');
                    }
                });
                
                // Save to localStorage
                localStorage.setItem('shdwxbt_leverage', leverage);
                
                // Recalculate P&L
                window.calculatePnL();
            };
            
            window.calculatePnL = function() {
                const capitalInput = document.getElementById('overlay-capital-input');
                const capital = parseFloat(capitalInput?.value) || 0;
                const leverage = window.currentLeverage || 1;
                const effectiveCapital = capital * leverage;
                
                // Update effective position display
                const effectivePosEl = document.getElementById('overlay-effective-position');
                if (effectivePosEl) {
                    effectivePosEl.textContent = `$${effectiveCapital.toLocaleString()}`;
                }
                
                // Get P&L display elements
                const tp1PnlEl = document.getElementById('overlay-tp1-pnl');
                const tp2PnlEl = document.getElementById('overlay-tp2-pnl');
                const tp3PnlEl = document.getElementById('overlay-tp3-pnl');
                const slPnlEl = document.getElementById('overlay-sl-pnl');
                
                // Hide all P&L if no capital
                if (!capital || capital <= 0) {
                    [tp1PnlEl, tp2PnlEl, tp3PnlEl, slPnlEl].forEach(el => {
                        if (el) el.classList.add('hidden');
                    });
                    return;
                }
                
                // Get active targets
                const targets = window.activeTargets;
                if (!targets || !targets.entryPrice) {
                    return;
                }
                
                // Use PM (Pre√ßo M√©dio) if available from scaled orders, otherwise use entry price
                const entry = targets.pm || targets.entryPrice;
                const isLong = targets.isLong;
                
                // Calculate position size with leverage (using PM for more accurate P&L)
                const positionSize = effectiveCapital / entry;
                
                // Calculate P&L for each target
                const calculateProfit = (targetPrice) => {
                    if (!targetPrice) return null;
                    if (isLong) {
                        return (targetPrice - entry) * positionSize;
                    } else {
                        return (entry - targetPrice) * positionSize;
                    }
                };
                
                // TP1
                if (tp1PnlEl && targets.tp1) {
                    const profit = calculateProfit(targets.tp1);
                    if (profit !== null) {
                        tp1PnlEl.textContent = `+$${profit.toFixed(2)}`;
                        tp1PnlEl.classList.remove('hidden');
                    }
                }
                
                // TP2
                if (tp2PnlEl && targets.tp2) {
                    const profit = calculateProfit(targets.tp2);
                    if (profit !== null) {
                        tp2PnlEl.textContent = `+$${profit.toFixed(2)}`;
                        tp2PnlEl.classList.remove('hidden');
                    }
                }
                
                // TP3
                if (tp3PnlEl && targets.tp3) {
                    const profit = calculateProfit(targets.tp3);
                    if (profit !== null) {
                        tp3PnlEl.textContent = `+$${profit.toFixed(2)}`;
                        tp3PnlEl.classList.remove('hidden');
                    }
                }
                
                // Stop Loss (loss is negative) - with leverage, loss can exceed capital!
                if (slPnlEl && targets.stopLoss) {
                    const sl = targets.stopLoss;
                    let loss;
                    if (isLong) {
                        loss = (entry - sl) * positionSize;
                    } else {
                        loss = (sl - entry) * positionSize;
                    }
                    // Warn if loss exceeds original capital (liquidation risk)
                    const absLoss = Math.abs(loss);
                    if (absLoss > capital) {
                        slPnlEl.textContent = `-$${absLoss.toFixed(2)} ‚ö†Ô∏è`;
                        slPnlEl.title = 'Risco de liquida√ß√£o! Perda excede o capital inicial.';
                    } else {
                        slPnlEl.textContent = `-$${absLoss.toFixed(2)}`;
                        slPnlEl.title = '';
                    }
                    slPnlEl.classList.remove('hidden');
                }
                
                // Save capital to localStorage for persistence
                localStorage.setItem('shdwxbt_capital', capital);
            };
            
            // =====================================================================
            // SCALED ORDERS CALCULATOR - 10 ordens escalonadas (menores‚Üímaiores)
            // =====================================================================
            window.scaledOrdersVisible = false;
            
            window.toggleScaledOrdersView = function() {
                window.scaledOrdersVisible = !window.scaledOrdersVisible;
                const detailEl = document.getElementById('scaled-orders-detail');
                const toggleText = document.getElementById('scaled-orders-toggle-text');
                
                if (detailEl) {
                    if (window.scaledOrdersVisible) {
                        detailEl.classList.remove('hidden');
                        if (toggleText) toggleText.textContent = 'OCULTAR';
                    } else {
                        detailEl.classList.add('hidden');
                        if (toggleText) toggleText.textContent = 'MOSTRAR';
                    }
                }
            };
            
            window.calculateScaledOrders = function() {
                const capitalInput = document.getElementById('overlay-capital-input');
                const capital = parseFloat(capitalInput?.value) || 0;
                const leverage = window.currentLeverage || 1;
                
                const pmEl = document.getElementById('overlay-pm');
                const ordersListEl = document.getElementById('scaled-orders-list');
                
                if (!capital || capital <= 0) {
                    if (pmEl) pmEl.textContent = '--';
                    if (ordersListEl) ordersListEl.innerHTML = '<div class="text-[9px] text-zinc-500">Insira o capital</div>';
                    return;
                }
                
                // Get entry zone from active targets
                const targets = window.activeTargets;
                if (!targets || !targets.entryZoneStart || !targets.entryZoneEnd) {
                    if (pmEl) pmEl.textContent = '--';
                    return;
                }
                
                const entryStart = targets.entryZoneStart; // Top of zone (premium)
                const entryEnd = targets.entryZoneEnd;     // Bottom of zone (discount)
                const isLong = targets.isLong;
                
                // For LONG: Start at top (higher price), end at bottom (lower price) - DCA down
                // For SHORT: Start at bottom (lower price), end at top (higher price) - DCA up
                const priceStart = isLong ? entryStart : entryEnd;
                const priceEnd = isLong ? entryEnd : entryStart;
                const priceRange = Math.abs(priceEnd - priceStart);
                
                // Distribution weights: smaller at start, larger at end
                // Pattern: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 (total = 55 parts)
                const weights = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                const totalWeight = weights.reduce((a, b) => a + b, 0); // 55
                
                // Calculate each order
                const orders = [];
                let totalCost = 0;
                let totalQuantity = 0;
                
                for (let i = 0; i < 10; i++) {
                    // Price for this order (evenly spaced through entry zone)
                    const price = isLong 
                        ? priceStart - (priceRange * i / 9) // Descending for LONG
                        : priceStart + (priceRange * i / 9); // Ascending for SHORT
                    
                    // Capital allocation for this order
                    const orderCapital = (capital * weights[i]) / totalWeight;
                    const effectiveCapital = orderCapital * leverage;
                    const quantity = effectiveCapital / price;
                    
                    orders.push({
                        number: i + 1,
                        price: price,
                        capital: orderCapital,
                        effectiveCapital: effectiveCapital,
                        quantity: quantity,
                        percentage: (weights[i] / totalWeight * 100).toFixed(1)
                    });
                    
                    totalCost += effectiveCapital;
                    totalQuantity += quantity;
                }
                
                // Calculate PM (Pre√ßo M√©dio) = Total Cost / Total Quantity
                const pm = totalCost / totalQuantity;
                
                // Update PM display
                if (pmEl) {
                    pmEl.textContent = window.formatPrice ? window.formatPrice(pm) : pm.toFixed(2);
                }
                
                // Update orders list
                if (ordersListEl) {
                    ordersListEl.innerHTML = orders.map(order => `
                        <div class="flex justify-between items-center text-[9px] font-mono">
                            <span class="text-zinc-500">#${order.number}</span>
                            <span class="text-white">${window.formatPrice ? window.formatPrice(order.price) : order.price.toFixed(4)}</span>
                            <span class="text-amber-400">$${order.capital.toFixed(2)}</span>
                            <span class="text-zinc-400">(${order.percentage}%)</span>
                        </div>
                    `).join('');
                }
                
                // Store PM in activeTargets for P&L calculation
                if (window.activeTargets) {
                    window.activeTargets.pm = pm;
                    window.activeTargets.scaledOrders = orders;
                }
                
                // Recalculate P&L with new PM
                window.calculatePnL();
                
                // Save capital
                localStorage.setItem('shdwxbt_capital', capital);
            };
            
            // Load saved capital and leverage on page load
            document.addEventListener('DOMContentLoaded', function() {
                const savedCapital = localStorage.getItem('shdwxbt_capital');
                if (savedCapital) {
                    const capitalInput = document.getElementById('overlay-capital-input');
                    if (capitalInput) {
                        capitalInput.value = savedCapital;
                    }
                }
                
                const savedLeverage = localStorage.getItem('shdwxbt_leverage');
                if (savedLeverage) {
                    window.setLeverage(parseInt(savedLeverage));
                }
                
                // Initialize history system
                window.initTradeHistory();
            });
            
            // =====================================================
            // TRADE HISTORY SYSTEM - TP & SL History Tracking
            // =====================================================
            
            // Initialize arrays immediately
            window.tpHistory = [];
            window.slHistory = [];
            
            window.initTradeHistory = function() {
                // Load history from localStorage as initial state
                window.tpHistory = JSON.parse(localStorage.getItem('shdwxbt_tp_history') || '[]');
                window.slHistory = JSON.parse(localStorage.getItem('shdwxbt_sl_history') || '[]');
                
                // Clean old entries (older than 24h)
                const now = Date.now();
                const hours24 = 24 * 60 * 60 * 1000;
                
                window.tpHistory = window.tpHistory.filter(item => (now - item.timestamp) < hours24);
                window.slHistory = window.slHistory.filter(item => (now - item.timestamp) < hours24);
                
                // Save cleaned data
                localStorage.setItem('shdwxbt_tp_history', JSON.stringify(window.tpHistory));
                localStorage.setItem('shdwxbt_sl_history', JSON.stringify(window.slHistory));
                
                // Update counters (will be updated again after Supabase sync)
                window.updateHistoryCounters();
                
                console.log(`üìä Trade History (local): ${window.tpHistory.length} TPs, ${window.slHistory.length} SLs`);
            };
            
            // ===== SYNC TP/SL HISTORY FROM SUPABASE (CROSS-DEVICE SYNC) =====
            window.syncHistoryFromSupabase = async function(rawOpportunities) {
                if (!rawOpportunities || rawOpportunities.length === 0) return;
                
                const now = Date.now();
                const hours24 = 24 * 60 * 60 * 1000;
                let tpAdded = 0, slAdded = 0;
                
                // Initialize arrays if not exist
                if (!window.tpHistory) window.tpHistory = [];
                if (!window.slHistory) window.slHistory = [];
                
                rawOpportunities.forEach(opp => {
                    if (!opp.symbol) return;
                    
                    // ===== SYNC TP HITS FROM SUPABASE =====
                    for (let i = 1; i <= 3; i++) {
                        const hitField = `tp_hit_${i}`;
                        const hitTimeField = `tp_hit_${i}_at`;
                        const hitPriceField = `tp_hit_${i}_price`;
                        
                        if (opp[hitField] === true) {
                            const hitTime = opp[hitTimeField] ? new Date(opp[hitTimeField]).getTime() : now;
                            
                            // Skip if older than 24h
                            if ((now - hitTime) >= hours24) continue;
                            
                            // Check if already in local history
                            const tpLevel = `TP${i}`;
                            const exists = window.tpHistory.some(h => h.symbol === opp.symbol && h.tpLevel === tpLevel);
                            
                            if (!exists) {
                                const entry = {
                                    id: `${opp.symbol}-${tpLevel}-${hitTime}`,
                                    symbol: opp.symbol,
                                    tpLevel: tpLevel,
                                    targetPrice: opp[hitPriceField] || opp[`target_${i}`] || 0,
                                    hitPrice: opp[hitPriceField] || 0,
                                    trend: opp.trend || 'bullish',
                                    timestamp: hitTime,
                                    hitTime: hitTime,
                                    hitTimeFormatted: window.formatTimestamp ? window.formatTimestamp(hitTime) : new Date(hitTime).toLocaleString(),
                                    entryTime: opp.created_at ? new Date(opp.created_at).getTime() : now,
                                    entryTimeFormatted: window.formatTimestamp ? window.formatTimestamp(opp.created_at) : '--',
                                    timeframe: opp.timeframe || '1h',
                                    context: opp.context || `${opp.symbol} atingiu ${tpLevel}`,
                                    fromSupabase: true
                                };
                                
                                window.tpHistory.push(entry);
                                tpAdded++;
                            }
                        }
                    }
                    
                    // ===== SYNC SL HITS FROM SUPABASE =====
                    if (opp.sl_hit === true || opp.is_stopped === true || opp.stop_loss_hit === true) {
                        const hitTime = opp.sl_hit_at ? new Date(opp.sl_hit_at).getTime() : 
                                       opp.stopped_at ? new Date(opp.stopped_at).getTime() : now;
                        
                        // Skip if older than 24h
                        if ((now - hitTime) >= hours24) return;
                        
                        // Check if already in local history
                        const exists = window.slHistory.some(h => h.symbol === opp.symbol);
                        
                        if (!exists) {
                            // Calcular pre√ßo de entrada (usar entry_price ou current_price do momento do sinal)
                            const entryPrice = opp.entry_price || opp.currentPrice || opp.current_price || 0;
                            const stopPrice = opp.stop_loss || opp.sl_hit_price || 0;
                            
                            const entry = {
                                id: `${opp.symbol}-SL-${hitTime}`,
                                symbol: opp.symbol,
                                entryPrice: entryPrice, // NOVO: pre√ßo de entrada
                                stopPrice: stopPrice,
                                hitPrice: opp.sl_hit_price || opp.stop_loss || 0,
                                trend: opp.trend || 'bearish',
                                timestamp: hitTime,
                                hitTime: hitTime,
                                hitTimeFormatted: window.formatTimestamp ? window.formatTimestamp(hitTime) : new Date(hitTime).toLocaleString(),
                                entryTime: opp.created_at ? new Date(opp.created_at).getTime() : now,
                                entryTimeFormatted: window.formatTimestamp ? window.formatTimestamp(opp.created_at) : '--',
                                timeframe: opp.timeframe || '1h',
                                context: opp.context || `${opp.symbol} atingiu Stop Loss`,
                                fromSupabase: true
                            };
                            
                            window.slHistory.push(entry);
                            slAdded++;
                        }
                    }
                });
                
                // Sort by timestamp (newest first)
                window.tpHistory.sort((a, b) => b.timestamp - a.timestamp);
                window.slHistory.sort((a, b) => b.timestamp - a.timestamp);
                
                // Save to localStorage for offline access
                localStorage.setItem('shdwxbt_tp_history', JSON.stringify(window.tpHistory));
                localStorage.setItem('shdwxbt_sl_history', JSON.stringify(window.slHistory));
                
                // Update counters
                window.updateHistoryCounters();
                
                if (tpAdded > 0 || slAdded > 0) {
                    console.log(`‚òÅÔ∏è Synced from Supabase: +${tpAdded} TPs, +${slAdded} SLs (Total: ${window.tpHistory.length} TPs, ${window.slHistory.length} SLs)`);
                }
            };
            
            window.updateHistoryCounters = function() {
                const tpCount = document.getElementById('stat-tp-history');
                const slCount = document.getElementById('stat-sl-history');
                
                if (tpCount) tpCount.textContent = window.tpHistory?.length || 0;
                if (slCount) slCount.textContent = window.slHistory?.length || 0;
            };
            
            // Add TP to history
            window.addTPToHistory = function(symbol, tpLevel, price, opp) {
                if (!window.tpHistory) window.tpHistory = [];
                
                // Check if already exists
                const exists = window.tpHistory.some(h => h.symbol === symbol && h.tpLevel === tpLevel);
                if (exists) return;
                
                const now = Date.now();
                const entry = {
                    id: `${symbol}-${tpLevel}-${now}`,
                    symbol: symbol,
                    tpLevel: tpLevel,
                    targetPrice: price,
                    hitPrice: opp?.currentPrice || price,
                    trend: opp?.trend || 'unknown',
                    timestamp: now,
                    hitTime: now,
                    hitTimeFormatted: window.formatTimestamp ? window.formatTimestamp(now) : new Date(now).toLocaleString(),
                    entryTime: opp?.created_at || opp?.analysisTimestamp || now,
                    entryTimeFormatted: window.formatTimestamp ? window.formatTimestamp(opp?.created_at || opp?.analysisTimestamp || now) : '--',
                    timeframe: opp?.signalTimeframe || opp?.timeframe || '1h',
                    context: opp?.analysisTitle || `${symbol} atingiu ${tpLevel}`
                };
                
                window.tpHistory.unshift(entry);
                localStorage.setItem('shdwxbt_tp_history', JSON.stringify(window.tpHistory));
                window.updateHistoryCounters();
                
                // Update timeline in modal if open
                window.updateTradeTimeline(symbol, tpLevel, now);
                
                // ===== SYNC WITH SUPABASE =====
                const tpIndex = parseInt(tpLevel.replace('TP', ''));
                if (typeof SupabaseService !== 'undefined' && SupabaseService.markTargetHit) {
                    SupabaseService.markTargetHit(symbol, tpIndex, opp?.currentPrice || price, opp?.trend || 'bullish')
                        .then(result => {
                            if (result) {
                                console.log(`‚òÅÔ∏è Supabase: ${symbol} ${tpLevel} synced successfully`);
                            }
                        })
                        .catch(err => console.warn(`‚òÅÔ∏è Supabase sync failed for ${symbol} ${tpLevel}:`, err));
                }
                
                console.log(`‚úÖ TP History: Added ${symbol} ${tpLevel} at ${entry.hitTimeFormatted}`);
            };
            
            // Add SL to history
            window.addSLToHistory = function(symbol, stopPrice, currentPrice, opp) {
                if (!window.slHistory) window.slHistory = [];
                
                // Check if already exists
                const exists = window.slHistory.some(h => h.symbol === symbol);
                if (exists) return;
                
                const now = Date.now();
                // Pegar pre√ßo de entrada para calcular o risco
                const entryPrice = opp?.entryPrice || opp?.entry_price || opp?.currentPrice || currentPrice;
                
                const entry = {
                    id: `${symbol}-SL-${now}`,
                    symbol: symbol,
                    entryPrice: entryPrice, // NOVO: pre√ßo de entrada para c√°lculo do risco
                    stopPrice: stopPrice,
                    hitPrice: currentPrice,
                    trend: opp?.trend || 'unknown',
                    timestamp: now,
                    hitTime: now,
                    hitTimeFormatted: window.formatTimestamp ? window.formatTimestamp(now) : new Date(now).toLocaleString(),
                    entryTime: opp?.created_at || opp?.analysisTimestamp || now,
                    entryTimeFormatted: window.formatTimestamp ? window.formatTimestamp(opp?.created_at || opp?.analysisTimestamp || now) : '--',
                    timeframe: opp?.signalTimeframe || opp?.timeframe || '1h',
                    context: opp?.analysisTitle || `${symbol} atingiu Stop Loss`
                };
                
                window.slHistory.unshift(entry);
                localStorage.setItem('shdwxbt_sl_history', JSON.stringify(window.slHistory));
                window.updateHistoryCounters();
                
                // Update timeline in modal if open
                window.updateTradeTimeline(symbol, 'SL', now);
                
                // ===== SYNC WITH SUPABASE - Mark as stopped =====
                if (typeof SupabaseService !== 'undefined' && SupabaseService.markTargetHit) {
                    // Use tp_index = 0 to indicate stop loss hit
                    SupabaseService.markTargetHit(symbol, 0, currentPrice, opp?.trend || 'bullish')
                        .catch(err => console.warn(`‚òÅÔ∏è Supabase SL sync failed for ${symbol}:`, err));
                }
                
                console.log(`‚ùå SL History: Added ${symbol} at ${entry.hitTimeFormatted}`);
            };
            
            // Update trade timeline in modal (shows timestamps for TP/SL hits)
            window.updateTradeTimeline = function(symbol, level, timestamp) {
                // Check if modal is open for this symbol
                const currentSymbol = window.selectedOpportunity?.symbol;
                if (currentSymbol !== symbol) return;
                
                const formattedTime = window.formatTimestamp ? window.formatTimestamp(timestamp) : '--';
                
                if (level === 'ZONE') {
                    const row = document.getElementById('timeline-zone-row');
                    const el = document.getElementById('timeline-zone');
                    if (row) row.classList.remove('hidden');
                    if (el) el.textContent = formattedTime;
                } else if (level === 'tp1' || level === 'TP1') {
                    const row = document.getElementById('timeline-tp1-row');
                    const el = document.getElementById('timeline-tp1');
                    if (row) row.classList.remove('hidden');
                    if (el) el.textContent = formattedTime;
                } else if (level === 'tp2' || level === 'TP2') {
                    const row = document.getElementById('timeline-tp2-row');
                    const el = document.getElementById('timeline-tp2');
                    if (row) row.classList.remove('hidden');
                    if (el) el.textContent = formattedTime;
                } else if (level === 'tp3' || level === 'TP3') {
                    const row = document.getElementById('timeline-tp3-row');
                    const el = document.getElementById('timeline-tp3');
                    if (row) row.classList.remove('hidden');
                    if (el) el.textContent = formattedTime;
                } else if (level === 'SL') {
                    const row = document.getElementById('timeline-sl-row');
                    const el = document.getElementById('timeline-sl');
                    if (row) row.classList.remove('hidden');
                    if (el) el.textContent = formattedTime;
                }
            };
            
            // Initialize timeline from persisted state AND Supabase
            window.initializeTimeline = async function(symbol, opp) {
                // Set entry time (Signal Created)
                const entryEl = document.getElementById('timeline-entry');
                const entryTime = opp?.created_at || opp?.analysisTimestamp || opp?.timestamp;
                if (entryEl && entryTime) {
                    entryEl.textContent = window.formatTimestamp ? window.formatTimestamp(entryTime) : '--';
                } else if (entryEl) {
                    entryEl.textContent = '--';
                }
                
                // Hide all rows initially
                ['timeline-zone-row', 'timeline-tp1-row', 'timeline-tp2-row', 'timeline-tp3-row', 'timeline-sl-row'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                
                // ===== FETCH FROM SUPABASE FIRST =====
                let supabaseOpp = null;
                try {
                    if (typeof SupabaseService !== 'undefined') {
                        // Get fresh data from Supabase
                        supabaseOpp = SupabaseService.getOpportunity(symbol);
                        
                        // If not in cache, fetch from server
                        if (!supabaseOpp) {
                            const opportunities = await SupabaseService.getOpportunities();
                            supabaseOpp = opportunities?.find(o => o.symbol === symbol);
                        }
                        
                        if (supabaseOpp) {
                            console.log(`‚òÅÔ∏è Timeline: Loaded ${symbol} from Supabase`, supabaseOpp);
                            
                            // Check zone_hit from Supabase
                            if (supabaseOpp.zone_hit || supabaseOpp.entry_zone_hit) {
                                const zoneTime = supabaseOpp.zone_hit_at || supabaseOpp.updated_at;
                                if (zoneTime) {
                                    window.updateTradeTimeline(symbol, 'ZONE', zoneTime);
                                }
                            }
                            
                            // Check TP hits from Supabase (tp_hit_1, tp_hit_2, tp_hit_3)
                            for (let i = 1; i <= 3; i++) {
                                const hitField = `tp_hit_${i}`;
                                const hitTimeField = `tp_hit_${i}_at`;
                                if (supabaseOpp[hitField] === true) {
                                    const hitTime = supabaseOpp[hitTimeField] || supabaseOpp.updated_at;
                                    window.updateTradeTimeline(symbol, `TP${i}`, hitTime);
                                }
                            }
                            
                            // Check SL hit from Supabase
                            if (supabaseOpp.sl_hit || supabaseOpp.stop_loss_hit || supabaseOpp.is_stopped) {
                                const slTime = supabaseOpp.sl_hit_at || supabaseOpp.stopped_at || supabaseOpp.updated_at;
                                if (slTime) {
                                    window.updateTradeTimeline(symbol, 'SL', slTime);
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.warn('‚òÅÔ∏è Failed to fetch timeline from Supabase:', err);
                }
                
                // ===== FALLBACK: Check local state =====
                // Check if zone was already hit (from targetsHitState)
                const zoneState = window.targetsHitState?.[symbol];
                if (zoneState?.zoneHit && zoneState?.zoneHitTime) {
                    window.updateTradeTimeline(symbol, 'ZONE', zoneState.zoneHitTime);
                }
                
                // Check TP history for this symbol (localStorage backup)
                const tpHistory = window.tpHistory || [];
                tpHistory.forEach(h => {
                    if (h.symbol === symbol) {
                        const level = h.tpLevel?.toLowerCase();
                        const time = h.hitTime || h.timestamp;
                        if (level && time) {
                            window.updateTradeTimeline(symbol, level, time);
                        }
                    }
                });
                
                // Check SL history for this symbol (localStorage backup)
                const slHistory = window.slHistory || [];
                slHistory.forEach(h => {
                    if (h.symbol === symbol) {
                        const time = h.hitTime || h.timestamp;
                        if (time) {
                            window.updateTradeTimeline(symbol, 'SL', time);
                        }
                    }
                });
            };
            
            // Update sidebar with opportunity data
            window.updateSidebar = function(opp) {
                if (!opp) return;
                
                const isLong = opp.trend === 'bullish';
                
                // Header - Name and Symbol
                const titleEl = document.getElementById('modal-title');
                const symbolEl = document.getElementById('sidebar-symbol');
                if (titleEl) titleEl.textContent = opp.name || opp.symbol.replace('USDT', '');
                if (symbolEl) symbolEl.textContent = opp.symbol;
                
                // Timeframe conflict warning
                const warningEl = document.getElementById('sidebar-warning');
                if (warningEl) {
                    if (opp.hasTimeframeConflict) {
                        warningEl.classList.remove('hidden');
                    } else {
                        warningEl.classList.add('hidden');
                    }
                }
                
                // Headline and Context from institutional model (MTF)
                const headlineEl = document.getElementById('sidebar-headline');
                const contextEl = document.getElementById('sidebar-context');
                
                if (headlineEl) {
                    // Priority: analysisTitle > institutionalReport.title > fallback
                    // IMPORTANTE: verificar se n√£o √© string vazia tamb√©m
                    const hasAnalysisTitle = opp.analysisTitle && opp.analysisTitle.trim().length > 0;
                    const hasInstitutionalTitle = opp.institutionalReport?.title && opp.institutionalReport.title.trim().length > 0;
                    
                    if (hasAnalysisTitle) {
                        headlineEl.textContent = translateContextText(opp.analysisTitle);
                    } else if (hasInstitutionalTitle) {
                        headlineEl.textContent = translateContextText(opp.institutionalReport.title);
                    } else {
                        // Fallback: gerar t√≠tulo baseado nos dados dispon√≠veis
                        const dirLabel = isLong ? t('trend_bullish') : t('trend_bearish');
                        const structure = opp.marketStructure?.searchingFor || 
                                          opp.setup_type || 
                                          opp.setup ||
                                          (isLong ? t('setup_fundo_ascendente').toLowerCase() : t('setup_topo_descendente').toLowerCase());
                        const tfTarget = opp.timeframe?.target || opp.target_timeframe || '4h';
                        headlineEl.textContent = `${opp.symbol} ‚Äî ${dirLabel} ‚Äî ${structure} (${tfTarget})`;
                    }
                }
                
                if (contextEl) {
                    // Remover placeholder se existir
                    const placeholder = document.getElementById('sidebar-context-placeholder');
                    if (placeholder) placeholder.remove();
                    
                    // Priority: contextLines[] > methodology_summary > analysisText > context > fallback
                    const contextLines = (opp.contextLines || []).filter(line => line && line.trim().length > 0);
                    const contextText = opp.methodology_summary || opp.analysisText || opp.analysis_text || opp.context || '';
                    
                    if (contextLines.length > 0) {
                        // Use linhas de contexto individuais (metodologia completa) - PADR√ÉO INSTITUCIONAL
                        contextEl.innerHTML = contextLines.map((line, index) => {
                            const trimmed = line.trim();
                            const translated = translateContextText(trimmed);
                            
                            // Fun√ß√£o para processar textos com ‚óÜ (pode ter m√∫ltiplos ou nenhum)
                            const processWithDiamonds = (text) => {
                                // Separar partes por ‚óÜ e processar cada uma
                                const parts = text.split('‚óÜ');
                                if (parts.length === 1) {
                                    // Sem ‚óÜ, retorna texto normal
                                    return `<span class="text-white/80">${text}</span>`;
                                }
                                
                                // Primeira parte (antes do primeiro ‚óÜ) em cor normal
                                let result = parts[0] ? `<span class="text-white/70">${parts[0]}</span>` : '';
                                
                                // Processar partes com ‚óÜ
                                for (let i = 1; i < parts.length; i++) {
                                    const partText = parts[i].trim();
                                    const partLower = partText.toLowerCase();
                                    
                                    // Determinar cor baseado no conte√∫do
                                    const isNegative = partLower.includes('premium') || partLower.includes('pr√™mio') ||
                                                       partLower.includes('selling') || partLower.includes('vendedora') ||
                                                       partLower.includes('overbought') || partLower.includes('sobrecompra');
                                    const isPositive = partLower.includes('discount') || partLower.includes('desconto') ||
                                                       partLower.includes('buying') || partLower.includes('compradora') ||
                                                       partLower.includes('oversold') || partLower.includes('sobrevenda');
                                    
                                    let colorClass = 'text-amber-400'; // Default
                                    if (isNegative) colorClass = 'text-rose-400';
                                    if (isPositive) colorClass = 'text-emerald-400';
                                    
                                    result += `<span class="${colorClass}">‚óÜ ${partText}</span>`;
                                }
                                
                                return result;
                            };
                            
                            // Linha 0: Setup config (destaque com borda)
                            if (index === 0) {
                                const borderColor = isLong ? 'border-emerald-500/50' : 'border-rose-500/50';
                                return `<blockquote class="border-l-2 ${borderColor} pl-3 mb-3 text-white/90 text-[11px]">${translated}</blockquote>`;
                            }
                            
                            // Linha 1: Tend√™ncia √¢ncora + estado timeframe
                            if (index === 1) {
                                return `<p class="mb-2 text-white/80 text-[11px]">${translated}</p>`;
                            }
                            
                            // Linha 2: Fibonacci + EMA200 (pode ter ‚óÜ)
                            if (index === 2) {
                                return `<p class="mb-3 text-[11px]">${processWithDiamonds(translated)}</p>`;
                            }
                            
                            // Linha 3: RSI + A√ß√£o (tem ‚óÜ)
                            if (index === 3) {
                                return `<p class="mb-2 text-[11px]">${processWithDiamonds(translated)}</p>`;
                            }
                            
                            return `<p class="mb-2 text-white/70 text-[10px]">${translated}</p>`;
                        }).join('');
                        
                        // Adicionar invalida√ß√£o se existir
                        if (opp.invalidation?.text) {
                            contextEl.innerHTML += `
                                <div class="mt-3 pt-2 border-t border-white/10">
                                    <p class="text-rose-400/80 text-[10px] font-medium">‚ö†Ô∏è ${currentLanguage === 'en' ? 'Invalidation' : 'Invalida√ß√£o'}</p>
                                    <p class="text-white/60 text-[10px] mt-1">${translateContextText(opp.invalidation.text)}</p>
                                </div>
                            `;
                        }
                    } else if (contextText && contextText.length > 10) {
                        const normalizedContext = translateContextText(contextText);
                        const paragraphs = normalizedContext.split('\n').filter(p => p.trim());
                        // Formatar com estilos visuais (bullets coloridos para linhas especiais)
                        contextEl.innerHTML = paragraphs.map(p => {
                            const trimmed = p.trim();
                            // Linhas com ‚óÜ = destaque (positivo em verde, negativo em vermelho)
                            if (trimmed.startsWith('‚óÜ')) {
                                const text = trimmed.substring(1).trim();
                                const textLower = text.toLowerCase();
                                const isNegative = textLower.includes('pr√™mio') || textLower.includes('premium') ||
                                                   textLower.includes('sobrecompra') || textLower.includes('overbought') ||
                                                   textLower.includes('for√ßa vendedora') || textLower.includes('selling');
                                const colorClass = isNegative ? 'text-rose-400' : 'text-emerald-400';
                                return `<p class="mb-2 flex items-start gap-2">
                                    <span class="${colorClass}">‚óÜ</span>
                                    <span class="${colorClass}">${text}</span>
                                </p>`;
                            }
                            // Primeira linha = highlight (borda lateral)
                            if (paragraphs.indexOf(p) === 0 && (trimmed.includes('Configura√ß√£o') || trimmed.toLowerCase().includes('setup'))) {
                                return `<blockquote class="border-l-2 border-white/30 pl-3 mb-3 text-white/90">${trimmed}</blockquote>`;
                            }
                            // Linhas normais
                            return `<p class="mb-2 text-white/70">${trimmed}</p>`;
                        }).join('');
                    } else if (opp.institutionalReport?.context) {
                        const normalizedContext = translateContextText(opp.institutionalReport.context);
                        const paragraphs = normalizedContext.split('\n').filter(p => p.trim());
                        contextEl.innerHTML = paragraphs.map(p => `<p class="mb-2">${p}</p>`).join('');
                    } else {
                        // FALLBACK ROBUSTO: gerar contexto baseado nos dados t√©cnicos dispon√≠veis
                        const supportRes = isLong 
                            ? (currentLanguage === 'en' ? 'Supports' : 'Suportes')
                            : (currentLanguage === 'en' ? 'Resistances' : 'Resist√™ncias');
                        
                        // Construir contexto din√¢mico baseado nos dados dispon√≠veis
                        const lines = [];
                        
                        // Linha 1: Setup/Perfil de trading
                        const tradingProfile = opp.route?.name || opp.trading_profile || 'Day Trading';
                        const setupType = opp.setup_type || opp.setup || (isLong ? 'fundo ascendente' : 'topo descendente');
                        lines.push(currentLanguage === 'en'
                            ? `<blockquote class="border-l-2 ${isLong ? 'border-emerald-500/50' : 'border-rose-500/50'} pl-3 mb-3 text-white/90 text-[11px]">${tradingProfile} - Setup: ${setupType}</blockquote>`
                            : `<blockquote class="border-l-2 ${isLong ? 'border-emerald-500/50' : 'border-rose-500/50'} pl-3 mb-3 text-white/90 text-[11px]">${tradingProfile} - Configura√ß√£o: ${setupType}</blockquote>`);
                        
                        // Linha 2: Tend√™ncia √¢ncora
                        const anchorTF = opp.timeframe?.anchor || opp.anchor_timeframe || 'Di√°rio';
                        const anchorTrend = opp.anchor_trend || opp.trend;
                        const anchorLabel = anchorTrend === 'bullish' ? (currentLanguage === 'en' ? 'bullish' : 'alta') : (currentLanguage === 'en' ? 'bearish' : 'baixa');
                        lines.push(currentLanguage === 'en'
                            ? `<p class="mb-2 text-white/80 text-[11px]">Trend in anchor timeframe (${anchorTF}): ${anchorLabel}. Target timeframe in pullback.</p>`
                            : `<p class="mb-2 text-white/80 text-[11px]">Tend√™ncia no tempo gr√°fico √¢ncora (${anchorTF}): ${anchorLabel}. Tempo gr√°fico alvo em corre√ß√£o.</p>`);
                        
                        // Linha 3: Fibonacci Zone (se dispon√≠vel)
                        const fibZone = opp.fibZone?.zone || opp.premium_discount || opp.fib_zone;
                        if (fibZone) {
                            const zoneText = fibZone === 'discount' || fibZone === 'desconto'
                                ? (currentLanguage === 'en' ? '‚óÜ Price in discount zone (favorable for buy)' : '‚óÜ Pre√ßo na zona de desconto (favor√°vel para compra)')
                                : fibZone === 'premium' || fibZone === 'pr√™mio'
                                    ? (currentLanguage === 'en' ? '‚óÜ Price in premium zone (favorable for sell)' : '‚óÜ Pre√ßo na zona de pr√™mio (favor√°vel para venda)')
                                    : (currentLanguage === 'en' ? 'Price in equilibrium zone of Fibonacci' : 'Pre√ßo na zona de equil√≠brio de Fibonacci');
                            const colorClass = (fibZone === 'discount' || fibZone === 'desconto') ? 'text-emerald-400' : 
                                               (fibZone === 'premium' || fibZone === 'pr√™mio') ? 'text-rose-400' : 'text-white/70';
                            lines.push(`<p class="mb-2 ${colorClass} text-[11px]">${zoneText}</p>`);
                        }
                        
                        // Linha 4: RSI (se dispon√≠vel)
                        const rsi = opp.rsi || opp.rsi_value;
                        if (rsi) {
                            const rsiStatus = rsi > 70 ? (currentLanguage === 'en' ? 'overbought' : 'sobrecompra') :
                                              rsi < 30 ? (currentLanguage === 'en' ? 'oversold' : 'sobrevenda') :
                                              (currentLanguage === 'en' ? 'neutral' : 'neutro');
                            const rsiColorClass = rsi > 70 ? 'text-rose-400' : rsi < 30 ? 'text-emerald-400' : 'text-amber-400';
                            const rsiText = currentLanguage === 'en'
                                ? `‚óÜ RSI(14): ${rsi.toFixed(1)} (${rsiStatus})`
                                : `‚óÜ RSI(14): ${rsi.toFixed(1)} (${rsiStatus})`;
                            lines.push(`<p class="mb-2 ${rsiColorClass} text-[11px]">${rsiText}</p>`);
                        }
                        
                        // Linha 5: EMA 200 (se dispon√≠vel)
                        const ema200 = opp.ema200 || opp.ema_200;
                        const currentPrice = opp.currentPrice || opp.current_price;
                        if (ema200 && currentPrice) {
                            const relation = currentPrice > ema200 
                                ? (currentLanguage === 'en' ? 'above' : 'acima')
                                : (currentLanguage === 'en' ? 'below' : 'abaixo');
                            lines.push(currentLanguage === 'en'
                                ? `<p class="mb-2 text-white/70 text-[11px]">Price ${relation} EMA 200</p>`
                                : `<p class="mb-2 text-white/70 text-[11px]">Pre√ßo ${relation} da EMA 200</p>`);
                        }
                        
                        // Se n√£o conseguiu gerar nenhuma linha, usar fallback gen√©rico
                        if (lines.length === 0) {
                            const introLine = currentLanguage === 'en'
                                ? `${opp.symbol} started a pullback and is looking for a retest.`
                                : `${opp.symbol} iniciou uma corre√ß√£o em busca de reteste.`;
                            const supportsLine = currentLanguage === 'en'
                                ? `${supportRes} can align with EMA 12, EMA 26 and Fibonacci zones.`
                                : `${supportRes} importantes podem ser em EMA 12, EMA 26 e regi√µes de Fibo.`;
                            lines.push(`<p class="mb-2">${introLine}</p>`);
                            lines.push(`<p class="mb-2">${supportsLine}</p>`);
                        }
                        
                        contextEl.innerHTML = lines.join('');
                    }
                }
                
                // Technical Data
                const trendEl = document.getElementById('sidebar-trend');
                if (trendEl) {
                    trendEl.textContent = isLong ? t('trend_up') : t('trend_down');
                    trendEl.className = isLong 
                        ? 'text-[10px] font-mono text-emerald-500 font-bold'
                        : 'text-[10px] font-mono text-rose-500 font-bold';
                }
                
                // Timeframe - use MTF timeframeString or fallback
                const tfSignalEl = document.getElementById('sidebar-tf-signal');
                const tfTargetEl = document.getElementById('sidebar-tf-target');
                
                if (opp.timeframeString) {
                    // MTF model format: "4h | Semanal"
                    const parts = opp.timeframeString.split(' | ');
                    if (tfSignalEl) tfSignalEl.textContent = parts[0] || '15m';
                    if (tfTargetEl) tfTargetEl.textContent = parts[1] || '1h';
                } else {
                    if (tfSignalEl) tfSignalEl.textContent = opp.timeframe?.signal || '15m';
                    if (tfTargetEl) tfTargetEl.textContent = opp.timeframe?.target || '1h';
                }
                
                // Fibonacci levels - prioridade: objeto fibonacci > calcular a partir de recent_high/low
                const fib = opp.fibonacci || {};
                const fib382El = document.getElementById('sidebar-fibo-382');
                const fib5El = document.getElementById('sidebar-fibo-5');
                const fib618El = document.getElementById('sidebar-fibo-618');
                
                // Debug
                console.log('üìê Fibonacci levels:', fib);
                
                // Acessar com chave string '0.382' ou n√∫mero 0.382
                const fib382 = fib['0.382'] || fib[0.382] || null;
                const fib5 = fib['0.5'] || fib[0.5] || null;
                const fib618 = fib['0.618'] || fib[0.618] || null;
                
                if (fib382El) fib382El.textContent = fib382 ? window.formatPrice(fib382) : '--';
                if (fib5El) fib5El.textContent = fib5 ? window.formatPrice(fib5) : '--';
                if (fib618El) fib618El.textContent = fib618 ? window.formatPrice(fib618) : '--';
                
                // Confluences - Using MTF institutional model (positiveConf/negativeConf arrays)
                const positiveEl = document.getElementById('sidebar-confluences-positive');
                const negativeEl = document.getElementById('sidebar-confluences-negative');
                const translateIfNeeded = (txt) => translateContextText(txt || '');
                
                // Priority: positiveConf/negativeConf arrays from MTF model OR confluence.positive/negative
                let positiveFactors = opp.positiveConf || opp.confluence?.positive || [];
                let negativeFactors = opp.negativeConf || opp.confluence?.negative || [];
                
                // Fallback to confluence.factors if arrays are empty
                if (positiveFactors.length === 0 && negativeFactors.length === 0 && opp.confluence?.factors) {
                    opp.confluence.factors.forEach(f => {
                        if (f.type === 'positive' || f.positive || f.weight > 0) {
                            positiveFactors.push(f.text || f.label || f.name || 'Conflu√™ncia positiva');
                        } else {
                            negativeFactors.push(f.text || f.label || f.name || 'Conflu√™ncia negativa');
                        }
                    });
                }
                
                // Use thermometer if still empty
                if (positiveFactors.length === 0 && opp.thermometer?.positive) {
                    positiveFactors = opp.thermometer.positive;
                }
                if (negativeFactors.length === 0 && opp.thermometer?.negative) {
                    negativeFactors = opp.thermometer.negative;
                }
                
                // Default factors based on trend if still empty
                if (positiveFactors.length === 0) {
                    positiveFactors.push('M√©dias m√≥veis exponenciais coerentes com o contexto');
                    if (opp.indicators?.rsiStatus?.status) {
                        positiveFactors.push(`√çndice de for√ßa relativa em ${opp.indicators.rsiStatus.status}`);
                    }
                }
                if (negativeFactors.length === 0 && opp.hasTimeframeConflict) {
                    negativeFactors.push('Tempos gr√°ficos em dire√ß√µes opostas');
                }
                if (negativeFactors.length === 0) {
                    negativeFactors.push('Monitorar volatilidade');
                }
                
                if (positiveEl) {
                    positiveEl.innerHTML = positiveFactors.map(f => `
                        <li class="flex items-start gap-1.5 text-[10px] text-zinc-400">
                            <span class="w-1 h-1 rounded-full bg-emerald-500 mt-1.5"></span>
                            ${translateIfNeeded(f)}
                        </li>
                    `).join('');
                }
                
                if (negativeEl) {
                    negativeEl.innerHTML = negativeFactors.map(f => `
                        <li class="flex items-start gap-1.5 text-[10px] text-zinc-400">
                            <span class="w-1 h-1 rounded-full bg-rose-500 mt-1.5"></span>
                            ${translateIfNeeded(f)}
                        </li>
                    `).join('');
                }
                
                // Confidence Score - use MTF confidence or confluence.score
                const score = opp.confidence || opp.confluence?.score || 50;
                const confValueEl = document.getElementById('sidebar-confidence-value');
                const confBarEl = document.getElementById('sidebar-confidence-bar');
                
                if (confValueEl) confValueEl.textContent = `${score}%`;
                if (confBarEl) confBarEl.style.width = `${score}%`;
                
                // ============================================
                // ADVANCED MARKET DATA
                // ============================================
                
                // Fibonacci Zone
                const fibZoneIconEl = document.getElementById('sidebar-fib-zone-icon');
                const fibZoneTextEl = document.getElementById('sidebar-fib-zone-text');
                const fibZoneBarEl = document.getElementById('sidebar-fib-zone-bar');
                
                if (opp.fibZone && fibZoneTextEl) {
                    const zone = opp.fibZone.zone || 'equilibrium';
                    const zonePct = opp.fibZone.zonePct || 50;
                    
                    const zoneLabels = {
                        'premium': 'Premium ‚ö†Ô∏è',
                        'discount': 'Discount üí∞',
                        'ote': 'OTE üéØ',
                        'equilibrium': 'Equil√≠brio ‚öñÔ∏è'
                    };
                    
                    const zoneIcons = {
                        'premium': '‚ö†Ô∏è',
                        'discount': 'üí∞',
                        'ote': 'üéØ',
                        'equilibrium': '‚öñÔ∏è'
                    };
                    
                    if (fibZoneIconEl) fibZoneIconEl.textContent = zoneIcons[zone] || '‚öñÔ∏è';
                    if (fibZoneTextEl) fibZoneTextEl.textContent = `${zoneLabels[zone] || 'Equil√≠brio'} (${zonePct.toFixed(1)}%)`;
                    if (fibZoneBarEl) fibZoneBarEl.style.width = `${Math.min(100, zonePct)}%`;
                }
                
                // Market Structure (AlphaDesk + Metodologia SHDWXBT)
                const structureEl = document.getElementById('sidebar-structure');
                if (structureEl) {
                    // Prioridade: metodologia.structure > marketStructure.bias
                    const metodologia = opp.metodologia || {};
                    const structure = opp.marketStructure || {};
                    
                    // Usar estrutura da metodologia SHDWXBT se dispon√≠vel
                    const structureText = metodologia.structure || structure.bias || 'neutral';
                    const structureLower = structureText.toLowerCase();
                    
                    let biasIcon = 'üìä';
                    let biasLabel = 'Neutro';
                    let colorClass = 'text-zinc-400';
                    
                    if (structureLower.includes('alta') || structureLower.includes('bullish')) {
                        biasIcon = 'üìà';
                        biasLabel = structureText;
                        colorClass = 'text-emerald-400';
                    } else if (structureLower.includes('baixa') || structureLower.includes('bearish')) {
                        biasIcon = 'üìâ';
                        biasLabel = structureText;
                        colorClass = 'text-rose-400';
                    } else if (structureLower.includes('sobrevenda')) {
                        biasIcon = 'üü¢';
                        biasLabel = 'Sobrevenda';
                        colorClass = 'text-emerald-400';
                    } else if (structureLower.includes('sobrecompra')) {
                        biasIcon = 'üî¥';
                        biasLabel = 'Sobrecompra';
                        colorClass = 'text-rose-400';
                    } else {
                        biasLabel = structureText || 'Neutro';
                    }
                    
                    // Adicionar info de piv√¥ se dispon√≠vel
                    const pivotInfo = metodologia.pivotType ? ` <span class="text-zinc-500 text-[9px]">(${metodologia.pivotType.replace('_', ' ')})</span>` : '';
                    
                    // Padr√µes HH/HL/LH/LL se dispon√≠veis
                    const patterns = [];
                    if (structure.isHH) patterns.push('HH');
                    if (structure.isHL) patterns.push('HL');
                    if (structure.isLH) patterns.push('LH');
                    if (structure.isLL) patterns.push('LL');
                    const patternText = patterns.length > 0 ? ` <span class="text-zinc-500 text-[9px]">${patterns.join('+')}</span>` : '';
                    
                    structureEl.innerHTML = `<span class="${colorClass}">${biasIcon} ${biasLabel}</span>${pivotInfo}${patternText}`;
                }
                
                // Long/Short Ratio - BUSCA EM TEMPO REAL SE N√ÉO DISPON√çVEL
                const lsRatioEl = document.getElementById('sidebar-ls-ratio');
                const longBarEl = document.getElementById('sidebar-long-bar');
                const shortBarEl = document.getElementById('sidebar-short-bar');
                const longPctEl = document.getElementById('sidebar-long-pct');
                const shortPctEl = document.getElementById('sidebar-short-pct');
                const fundingEl = document.getElementById('sidebar-funding');
                const oiEl = document.getElementById('sidebar-oi');
                
                // Fun√ß√£o para atualizar UI com dados de futuros
                const updateFuturesUI = (data) => {
                    if (!data) {
                        if (lsRatioEl) lsRatioEl.textContent = '-- (sem dados)';
                        if (longPctEl) longPctEl.textContent = '--% Long';
                        if (shortPctEl) shortPctEl.textContent = '--% Short';
                        if (fundingEl) fundingEl.textContent = '-- (sem dados)';
                        if (oiEl) oiEl.textContent = '-- (sem dados)';
                        return;
                    }
                    
                    // Long/Short Ratio
                    if (data.longShortRatio) {
                        const lsRatio = data.longShortRatio;
                        const longPct = data.longAccountPct || 50;
                        const shortPct = data.shortAccountPct || 50;
                        
                        if (lsRatioEl) {
                            const icon = lsRatio > 1.2 ? 'üêÇ' : lsRatio < 0.8 ? 'üêª' : '‚öñÔ∏è';
                            lsRatioEl.textContent = `${icon} ${lsRatio.toFixed(2)}`;
                        }
                        if (longBarEl) longBarEl.style.width = `${longPct}%`;
                        if (shortBarEl) shortBarEl.style.width = `${shortPct}%`;
                        if (longPctEl) longPctEl.textContent = `${longPct.toFixed(0)}% Long`;
                        if (shortPctEl) shortPctEl.textContent = `${shortPct.toFixed(0)}% Short`;
                    }
                    
                    // Funding Rate
                    if (fundingEl && data.fundingRate !== null && data.fundingRate !== undefined) {
                        const fundingPct = (data.fundingRate * 100).toFixed(4);
                        const fundingIcon = data.fundingRate > 0 ? 'üìà' : data.fundingRate < 0 ? 'üìâ' : '‚ûñ';
                        const fundingColor = data.fundingRate > 0.0005 ? 'text-rose-400' : 
                                            data.fundingRate < -0.0005 ? 'text-emerald-400' : 'text-white';
                        fundingEl.innerHTML = `<span class="${fundingColor}">${fundingIcon} ${fundingPct}%</span>`;
                    }
                    
                    // Open Interest
                    if (oiEl && data.openInterestChange24h !== null && data.openInterestChange24h !== undefined) {
                        const oiChange = data.openInterestChange24h;
                        const oiIcon = oiChange > 0 ? 'üìà' : oiChange < 0 ? 'üìâ' : '‚ûñ';
                        const oiColor = oiChange > 0 ? 'text-emerald-400' : oiChange < 0 ? 'text-rose-400' : 'text-white';
                        oiEl.innerHTML = `<span class="${oiColor}">${oiIcon} ${oiChange > 0 ? '+' : ''}${oiChange.toFixed(1)}%</span>`;
                    }
                };
                
                // Se tem dados no opp, usa, sen√£o busca em tempo real
                if (opp.sentiment && opp.sentiment.longShortRatio) {
                    updateFuturesUI(opp.sentiment);
                } else {
                    // Mostrar loading
                    if (lsRatioEl) lsRatioEl.textContent = '‚è≥ Carregando...';
                    if (fundingEl) fundingEl.textContent = '‚è≥ Carregando...';
                    if (oiEl) oiEl.textContent = '‚è≥ Carregando...';
                    
                    // Buscar dados de futuros em tempo real
                    window.fetchFuturesData(opp.symbol).then(data => {
                        updateFuturesUI(data);
                        // Salvar no objeto para n√£o precisar buscar novamente
                        if (data) {
                            opp.sentiment = { ...opp.sentiment, ...data };
                        }
                    });
                }
            };
            
            // Listen for opportunity card clicks
            document.addEventListener('click', function(e) {
                const card = e.target.closest('.card-panel[id^="card-"]');
                if (card) {
                    const symbol = card.id.replace('card-', '').toUpperCase();
                    
                    // Get opportunity data from local store
                    const allItems = [...(window.currentOpportunities || []), ...(window.currentWatchlist || [])];
                    const opp = allItems.find(o => o.symbol === symbol || o.symbol === symbol + 'USDT');
                    if (opp) {
                        window.updateChartOverlay(opp);
                    }
                }
            });
            
            // Initialize with first opportunity if available
            setTimeout(function() {
                const opps = window.currentOpportunities || [];
                if (opps.length > 0) {
                    window.updateChartOverlay(opps[0]);
                } else {
                    const watch = window.currentWatchlist || [];
                    if (watch.length > 0) {
                        window.updateChartOverlay(watch[0]);
                    }
                }
            }, 3000);
            
            // Ticker updates are handled by WebSocket in the main code
        })();

        // --- HOT SIGNALS PANEL ---
        (function initHotSignalsPanel() {
            // Criar painel lateral
            const panel = document.createElement('div');
            panel.id = 'hot-signals-panel';
            panel.className = 'fixed top-0 right-0 h-full w-80 bg-black/95 backdrop-blur-xl border-l border-white/10 z-50 transform translate-x-full transition-transform duration-300';
            panel.innerHTML = `
                <div class="flex flex-col h-full">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-4 border-b border-white/10">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">üî•</span>
                            <span class="font-bold text-white">Hot Signals</span>
                            <span class="text-xs text-orange-400 animate-pulse">LIVE</span>
                        </div>
                        <button onclick="window.toggleHotSignalsPanel()" class="text-white/50 hover:text-white p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                    
                    <!-- Status Bar -->
                    <div class="px-4 py-2 bg-orange-500/10 border-b border-orange-500/20">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-orange-400">Monitorando movimentos</span>
                            <span class="text-white/50" id="hot-signals-status">Ativo</span>
                        </div>
                        <div class="text-xs text-white/30 mt-1">
                            Threshold: ‚â•2% | Cooldown: 1min
                        </div>
                    </div>
                    
                    <!-- Signals List -->
                    <div class="flex-1 overflow-y-auto p-3 space-y-2" id="hot-signals-list">
                        <div class="text-center text-white/30 py-8">
                            <div class="text-3xl mb-2">üîç</div>
                            <div class="text-sm">Monitorando mercado...</div>
                            <div class="text-xs mt-1">Sinais aparecer√£o aqui</div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="p-3 border-t border-white/10">
                        <button onclick="window.HotSignals && window.HotSignals.clearSignals()" class="w-full py-2 text-xs text-white/50 hover:text-white hover:bg-white/5 rounded transition">
                            Limpar Sinais
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(panel);

            // Toggle function
            window.toggleHotSignalsPanel = function() {
                const p = document.getElementById('hot-signals-panel');
                if (p) {
                    p.classList.toggle('translate-x-full');
                }
            };

            // Fechar ao clicar fora
            document.addEventListener('click', function(e) {
                const panel = document.getElementById('hot-signals-panel');
                const btn = e.target.closest('[onclick*="toggleHotSignalsPanel"]');
                if (panel && !panel.contains(e.target) && !btn && !panel.classList.contains('translate-x-full')) {
                    panel.classList.add('translate-x-full');
                }
            });

            // Iniciar Hot Signals
            setTimeout(function() {
                if (window.HotSignals) {
                    window.HotSignals.start();
                    console.log('üî• Hot Signals initialized');
                }
            }, 3000);
        })();

    </script>

<!-- Hot Signals Panel Backdrop -->
<div id="hot-signals-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="window.toggleHotSignalsPanel && window.toggleHotSignalsPanel()"></div>

</body></html>